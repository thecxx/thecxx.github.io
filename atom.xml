<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>KAMI</title>
  <icon>https://www.gravatar.com/avatar/6c7900dd6f48482682e7479769ab3e63</icon>
  <subtitle>士不可以不弘毅，任重而道远。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://oldchan.net/"/>
  <updated>2023-01-16T13:00:47.263Z</updated>
  <id>https://oldchan.net/</id>
  
  <author>
    <name>Kami</name>
    <email>thecxx@126.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Golang深度解读：启动</title>
    <link href="https://oldchan.net/2023/01/15/notes/golang/advanced/boot/"/>
    <id>https://oldchan.net/2023/01/15/notes/golang/advanced/boot/</id>
    <published>2023-01-15T02:24:24.000Z</published>
    <updated>2023-01-16T13:00:47.263Z</updated>
    
    <content type="html"><![CDATA[<p>当我们运行一个可执行文件时，操作系统会为该可执行文件生成运行环境，即创建新进程，然后将可执行文件中包含的数据，代码等必要数据加载到进程的内存中，再经过各种初始化后，创建一个主线程从程序入口点开始执行。</p><p>通常，操作系统都会制定一套标准的可执行文件格式和对应的程序加载规范，如：Linux的ELF文件格式、Windows的PE文件格式等等。</p><p>不同的文件格式为了满足不同的操作系统特性和功能而不同，但都会为操作系统提供一个可供主线程启动时使用的程序入口点。在不同的编程语言中，要支持在某个操作系统上运行，就需要满足对应操作系统制定的规范。</p><p>在Go内核中，针对不同的操作系统提供了不同的汇编代码，以此来支持不同系统架构下的差异化情况，如：amd64中提供了<code>main()</code>，<code>_rt0_amd64()</code>，<code>_rt0_amd64_lib()</code>等程序入口，而在这些不同场景下，主线程执行经过这些入口之后，就会执行进入到统一的<code>runtime·rt0_go()</code>函数中。</p><a id="more"></a><h2 id="启动Go程序"><a href="#启动Go程序" class="headerlink" title="启动Go程序"></a>启动Go程序</h2><p>起初接收到程序入口点这个概念，还是在学习脱壳技术时，而在此之前，一直都认为程序入口点就是<code>main</code>函数。当真正地去理解，我们新开发一个程序，写下的第一个<code>func main() {}</code>实际上只是用户程序的入口点。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI1MzlweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjE3NjNweDtoZWlnaHQ6NTM5cHg7YmFja2dyb3VuZDojRkZGRkZGOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgMTc2MyA1MzkiIHdpZHRoPSIxNzYzcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNDI1IiB4PSI2NjIiIHk9IjIyLjk5NTEiPuWQr+WKqOi/m+eoiy/lkK/liqhtMOiwg+W6pua1geeoiy/ov5DooYznrKzkuIDkuKrljY/nqIsv5omn6KGM55So5oi3bWFpbuWHveaVsDwvdGV4dD48IS0tZW50aXR5IF9tYWluLS0+PGcgaWQ9ImVsZW1fX21haW4iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNTUiIHg9IjE1Ny41IiB5PSIxNTguODYyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjM1IiB4PSIxNjcuNSIgeT0iMTgxLjg1NzkiPm1haW48L3RleHQ+PC9nPjwhLS1lbnRpdHkgX3J0MF9hbWQ2NC0tPjxnIGlkPSJlbGVtX19ydDBfYW1kNjQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTA0IiB4PSIyNDgiIHk9IjE1OC44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODQiIHg9IjI1OCIgeT0iMTgxLjg1NzkiPl9ydDBfYW1kNjQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgX3J0MF9hbWQ2NF9saWItLT48ZyBpZD0iZWxlbV9fcnQwX2FtZDY0X2xpYiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMjkiIHg9IjM4Ny41IiB5PSIxNTguODYyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwOSIgeD0iMzk3LjUiIHk9IjE4MS44NTc5Ij5fcnQwX2FtZDY0X2xpYjwvdGV4dD48L2c+PCEtLWVudGl0eSBydDBfZ28tLT48ZyBpZD0iZWxlbV9ydDBfZ28iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTI5IiB4PSIyMzUuNSIgeT0iMjcxLjg2MjgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDkiIHg9IjI0NS41IiB5PSIyOTQuODU3OSI+cnVudGltZcK3cnQwX2dvPC90ZXh0PjwvZz48IS0tZW50aXR5IGFyZ3MtLT48ZyBpZD0iZWxlbV9hcmdzIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjExMiIgeD0iNyIgeT0iMzk5Ljg2MjgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5MiIgeD0iMTciIHk9IjQyMi44NTc5Ij5ydW50aW1lwrdhcmdzPC90ZXh0PjwvZz48IS0tZW50aXR5IG9zaW5pdC0tPjxnIGlkPSJlbGVtX29zaW5pdCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMjIiIHg9IjE1NCIgeT0iMzk5Ljg2MjgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDIiIHg9IjE2NCIgeT0iNDIyLjg1NzkiPnJ1bnRpbWXCt29zaW5pdDwvdGV4dD48L2c+PCEtLWVudGl0eSBzY2hlZGluaXQtLT48ZyBpZD0iZWxlbV9zY2hlZGluaXQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQ4IiB4PSIzMTEiIHk9IjM5OS44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI4IiB4PSIzMjEiIHk9IjQyMi44NTc5Ij5ydW50aW1lwrdzY2hlZGluaXQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbmV3cHJvYy0tPjxnIGlkPSJlbGVtX25ld3Byb2MiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQ0IiB4PSI0OTQiIHk9IjM5OS44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI0IiB4PSI1MDQiIHk9IjQyMi44NTc5Ij5ydW50aW1lwrduZXdwcm9jPC90ZXh0PjwvZz48IS0tZW50aXR5IG1haW4tLT48ZyBpZD0iZWxlbV9tYWluIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjExNyIgeD0iMTQ2OC41IiB5PSI0NS44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTciIHg9IjE0NzguNSIgeT0iNjguODU3OSI+cnVudGltZS5tYWluPC90ZXh0PjwvZz48IS0tZW50aXR5IFAtLT48ZyBpZD0iZWxlbV9QIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSIxMTQ5LjUiIHk9IjQ1Ljg2MjgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSIxMTU5LjUiIHk9IjY4Ljg1NzkiPlA8L3RleHQ+PC9nPjwhLS1lbnRpdHkgRy0tPjxnIGlkPSJlbGVtX0ciPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzEiIHg9IjEyMTMuNSIgeT0iNDUuODYyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExIiB4PSIxMjIzLjUiIHk9IjY4Ljg1NzkiPkc8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbWFpbl9tYWluLS0+PGcgaWQ9ImVsZW1fbWFpbl9tYWluIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9Ijk1IiB4PSIxNDc5LjUiIHk9IjE1OC44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzUiIHg9IjE0ODkuNSIgeT0iMTgxLjg1NzkiPm1haW4ubWFpbjwvdGV4dD48L2c+PCEtLWVudGl0eSBtc3RhcnQtLT48ZyBpZD0iZWxlbV9tc3RhcnQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTMxIiB4PSI1NzQuNSIgeT0iMjcxLjg2MjgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEiIHg9IjU4NC41IiB5PSIyOTQuODU3OSI+cnVudGltZS5tc3RhcnQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbXN0YXJ0MC0tPjxnIGlkPSJlbGVtX21zdGFydDAiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSI3NDEiIHk9IjI3MS44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSI3NTEiIHk9IjI5NC44NTc5Ij5ydW50aW1lLm1zdGFydDA8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbXN0YXJ0MS0tPjxnIGlkPSJlbGVtX21zdGFydDEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSI5MTYiIHk9IjI3MS44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSI5MjYiIHk9IjI5NC44NTc5Ij5ydW50aW1lLm1zdGFydDE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgc2NoZWR1bGUtLT48ZyBpZD0iZWxlbV9zY2hlZHVsZSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDUiIHg9IjEwOTEuNSIgeT0iMjcxLjg2MjgiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUiIHg9IjExMDEuNSIgeT0iMjk0Ljg1NzkiPnJ1bnRpbWUuc2NoZWR1bGU8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZmluZHJ1bm5hYmxlLS0+PGcgaWQ9ImVsZW1fZmluZHJ1bm5hYmxlIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE3NyIgeD0iMTA3NS41IiB5PSIxNTguODYyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE1NyIgeD0iMTA4NS41IiB5PSIxODEuODU3OSI+cnVudGltZS5maW5kUnVubmFibGU8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZXhlY3V0ZS0tPjxnIGlkPSJlbGVtX2V4ZWN1dGUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSIxMjcyIiB5PSIyNzEuODYyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMCIgeD0iMTI4MiIgeT0iMjk0Ljg1NzkiPnJ1bnRpbWUuZXhlY3V0ZTwvdGV4dD48L2c+PCEtLWVudGl0eSBnb2dvLS0+PGcgaWQ9ImVsZW1fZ29nbyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMTgiIHg9IjEyODAiIHk9IjM5OS44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTgiIHg9IjEyOTAiIHk9IjQyMi44NTc5Ij5ydW50aW1lLmdvZ288L3RleHQ+PC9nPjwhLS1lbnRpdHkgbG9naWNhbC0tPjxnIGlkPSJlbGVtX2xvZ2ljYWwiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTMyIiB4PSIxMjczIiB5PSI0OTYuODYyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMiIgeD0iMTI4MyIgeT0iNTE5Ljg1NzkiPueUqOaIt+S7o+eggemAu+i+kemDqOWIhjwvdGV4dD48L2c+PCEtLWVudGl0eSBHb3NjaGVkLS0+PGcgaWQ9ImVsZW1fR29zY2hlZCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDQiIHg9IjEwOTQiIHk9IjQ5Ni44NjI4Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI0IiB4PSIxMTA0IiB5PSI1MTkuODU3OSI+cnVudGltZS5Hb3NjaGVkPC90ZXh0PjwvZz48IS0tZW50aXR5IG1jYWxsLS0+PGcgaWQ9ImVsZW1fbWNhbGwiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTIwIiB4PSIxMTA2IiB5PSIzOTkuODYyOCIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwMCIgeD0iMTExNiIgeT0iNDIyLjg1NzkiPnJ1bnRpbWUubWNhbGw8L3RleHQ+PC9nPjwhLS1saW5rIF9tYWluIHRvIHJ0MF9nby0tPjxnIGlkPSJsaW5rX19tYWluX3J0MF9nbyI+PHBhdGggZD0iTTE5Ny41MjIsMTk1LjA4NjggQzIwNy42OSwyMDguNTI1OCAyMjIuNzksMjI3LjI5MjggMjM4LDI0MS44NjI4IEMyNDcuOTg5LDI1MS40MzA4IDI1OS45MDcsMjYwLjg2NDggMjcwLjYxMywyNjguNzQwOCAiIGZpbGw9Im5vbmUiIGlkPSJfbWFpbi10by1ydDBfZ28iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMjc0LjgwNSwyNzEuNzkxOCwyNjkuODgwNywyNjMuMjYyNCwyNzAuNzYxOSwyNjguODUwMiwyNjUuMTc0MSwyNjkuNzMxNCwyNzQuODA1LDI3MS43OTE4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MiIgeD0iMjM5IiB5PSIyMzcuOTI5NyI+56iL5bqP5YWl5Y+jPC90ZXh0PjwvZz48IS0tbGluayBfcnQwX2FtZDY0IHRvIHJ0MF9nby0tPjxnIGlkPSJsaW5rX19ydDBfYW1kNjRfcnQwX2dvIj48cGF0aCBkPSJNMzAwLDE5NS4yMDY4IEMzMDAsMjE0LjQzMDggMzAwLDI0NS40OTI4IDMwMCwyNjYuNTIzOCAiIGZpbGw9Im5vbmUiIGlkPSJfcnQwX2FtZDY0LXRvLXJ0MF9nbyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzMDAsMjcxLjY0MDgsMzA0LDI2Mi42NDA4LDMwMCwyNjYuNjQwOCwyOTYsMjYyLjY0MDgsMzAwLDI3MS42NDA4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI1MiIgeD0iMzAxIiB5PSIyMzcuOTI5NyI+56iL5bqP5YWl5Y+jPC90ZXh0PjwvZz48IS0tbGluayBfcnQwX2FtZDY0X2xpYiB0byBydDBfZ28tLT48ZyBpZD0ibGlua19fcnQwX2FtZDY0X2xpYl9ydDBfZ28iPjxwYXRoIGQ9Ik00MjguNTgzLDE5NC45NjI4IEM0MDEuMzU4LDIxNC44NDQ4IDM1Ni40NzYsMjQ3LjYxOTggMzI3LjU4NiwyNjguNzE3OCAiIGZpbGw9Im5vbmUiIGlkPSJfcnQwX2FtZDY0X2xpYi10by1ydDBfZ28iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzIzLjQ0MywyNzEuNzQyOCwzMzMuMDcsMjY5LjY2NDIsMzI3LjQ4MDYsMjY4Ljc5MzUsMzI4LjM1MTIsMjYzLjIwNDEsMzIzLjQ0MywyNzEuNzQyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNTIiIHg9IjM4NyIgeT0iMjM3LjkyOTciPueoi+W6j+WFpeWPozwvdGV4dD48L2c+PCEtLWxpbmsgcnQwX2dvIHRvIGFyZ3MtLT48ZyBpZD0ibGlua19ydDBfZ29fYXJncyI+PHBhdGggZD0iTTIzNS4xNTEsMzAzLjgwNTggQzIwNi44NDksMzExLjE3ODggMTc0LjAyOSwzMjIuMTU2OCAxNDcsMzM3Ljg2MjggQzEyMC43NjksMzUzLjEwNDggOTYuMTU5MiwzNzcuOTgzOCA4MC40NDI0LDM5NS43NDk4ICIgZmlsbD0ibm9uZSIgaWQ9InJ0MF9nby10by1hcmdzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9Ijc3LjAzMjEsMzk5LjY1MDgsODUuOTY2NCwzOTUuNTA2MSw4MC4zMjIzLDM5NS44ODU5LDc5Ljk0MjUsMzkwLjI0MTgsNzcuMDMyMSwzOTkuNjUwOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzIiIHg9IjE0OCIgeT0iMzU4LjQyOTciPjE6IOWkjeWItmFyZ3Y8L3RleHQ+PC9nPjwhLS1saW5rIHJ0MF9nbyB0byBvc2luaXQtLT48ZyBpZD0ibGlua19ydDBfZ29fb3Npbml0Ij48cGF0aCBkPSJNMjc0Ljc3NywzMDguMDQzOCBDMjY0LjQzLDMxNi4xMTE4IDI1My4wMjQsMzI2LjQ2MTggMjQ1LDMzNy44NjI4IEMyMzIuODMzLDM1NS4xNDk4IDIyNC44NTgsMzc4LjAwNDggMjIwLjIxMSwzOTQuNjgyOCAiIGZpbGw9Im5vbmUiIGlkPSJydDBfZ28tdG8tb3Npbml0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjIxOC44NzUsMzk5LjY0NzgsMjI1LjA3NzIsMzkxLjk5NzEsMjIwLjE3NDksMzk0LjgxOTcsMjE3LjM1MjMsMzg5LjkxNzQsMjE4Ljg3NSwzOTkuNjQ3OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTUiIHg9IjI0NiIgeT0iMzUwLjkyOTciPjI6IOiOt+WPlkNQVeaguOaVsDwvdGV4dD48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI2NSIgeD0iMjYxIiB5PSIzNjYuMDYyNSI+5LiO5YiG6aG15aSn5bCPPC90ZXh0PjwvZz48IS0tbGluayBydDBfZ28gdG8gc2NoZWRpbml0LS0+PGcgaWQ9ImxpbmtfcnQwX2dvX3NjaGVkaW5pdCI+PHBhdGggZD0iTTMxOS4zNTMsMzA3Ljk2MjggQzMyOC4xNzgsMzE2LjM5NDggMzM4LjM0MSwzMjcuMDU3OCAzNDYsMzM3Ljg2MjggQzM1OC42NjUsMzU1LjczMDggMzY5LjM2MywzNzguMzI1OCAzNzYuMzMzLDM5NC43Njk4ICIgZmlsbD0ibm9uZSIgaWQ9InJ0MF9nby10by1zY2hlZGluaXQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzc4LjM3NCwzOTkuNjYzOCwzNzguNTk5MSwzODkuODE3NSwzNzYuNDQ4MywzOTUuMDQ5NSwzNzEuMjE2MywzOTIuODk4NywzNzguMzc0LDM5OS42NjM4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI4MiIgeD0iMzY2IiB5PSIzNTguNDI5NyI+Mzog6LCD5bqm5Yid5aeL5YyWPC90ZXh0PjwvZz48IS0tbGluayBydDBfZ28gdG8gbmV3cHJvYy0tPjxnIGlkPSJsaW5rX3J0MF9nb19uZXdwcm9jIj48cGF0aCBkPSJNMzY0Ljg3MSwzMDUuMDM4OCBDMzkzLjkwOSwzMTIuNjk1OCA0MjguMDUsMzIzLjU1NDggNDU3LDMzNy44NjI4IEM0ODkuMDE3LDM1My42ODY4IDUyMS42NDksMzc4Ljc2NzggNTQyLjc1NCwzOTYuNDE2OCAiIGZpbGw9Im5vbmUiIGlkPSJydDBfZ28tdG8tbmV3cHJvYyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NDYuODE4LDM5OS44NDI4LDU0Mi41MTUyLDM5MC45ODM1LDU0Mi45OTUyLDM5Ni42Miw1MzcuMzU4OCwzOTcuMSw1NDYuODE4LDM5OS44NDI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzODAiIHg9IjUwOSIgeT0iMzU4LjQyOTciPjQ6IOS7pXJ1bnRpbWUubWFpbigp5Li65byA5aeL5Ye95pWw5Yib5bu656ys5LiA5LiqR++8jOWwseaYr+WPs+S4iuinkumCo+S4qkc8L3RleHQ+PC9nPjwhLS1saW5rIHJ0MF9nbyB0byBtc3RhcnQtLT48ZyBpZD0ibGlua19ydDBfZ29fbXN0YXJ0Ij48cGF0aCBkPSJNMzY0Ljc1MiwyODkuODYyOCBDNDIzLjIyMiwyODkuODYyOCA1MDkuMDc3LDI4OS44NjI4IDU2OS4zMTMsMjg5Ljg2MjggIiBmaWxsPSJub25lIiBpZD0icnQwX2dvLXRvLW1zdGFydCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1NzQuMzMxLDI4OS44NjI4LDU2NS4zMzEsMjg1Ljg2MjgsNTY5LjMzMSwyODkuODYyOCw1NjUuMzMxLDI5My44NjI4LDU3NC4zMzEsMjg5Ljg2MjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE2MCIgeD0iMzg5LjUiIHk9IjI1Mi45Mjk3Ij41OiDov5vnqIvnjq/looPliJ3lp4vljJblrozmr5XlkI7vvIw8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTQzIiB4PSIzOTgiIHk9IjI2OC4wNjI1Ij7kuLvnur/nqIvkuI7mma7pgJrnur/nqIvkuIDmoLfvvIw8L3RleHQ+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTczIiB4PSIzODMiIHk9IjI4My4xOTUzIj7pgJrov4dtc3RhcnTlh73mlbDov5vlhaXosIPluqbmtYHnqIs8L3RleHQ+PC9nPjwhLS1saW5rIG1zdGFydCB0byBtc3RhcnQwLS0+PGcgaWQ9ImxpbmtfbXN0YXJ0X21zdGFydDAiPjxwYXRoIGQ9Ik03MDUuNzk1LDI4OS44NjI4IEM3MTUuNzEsMjg5Ljg2MjggNzI1LjYyNiwyODkuODYyOCA3MzUuNTQxLDI4OS44NjI4ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydC10by1tc3RhcnQwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9Ijc0MC43MjYsMjg5Ljg2MjgsNzMxLjcyNiwyODUuODYyOCw3MzUuNzI2LDI4OS44NjI4LDczMS43MjYsMjkzLjg2MjgsNzQwLjcyNiwyODkuODYyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIG1zdGFydDAgdG8gbXN0YXJ0MS0tPjxnIGlkPSJsaW5rX21zdGFydDBfbXN0YXJ0MSI+PHBhdGggZD0iTTg4MS4wNjgsMjg5Ljg2MjggQzg5MC45NTgsMjg5Ljg2MjggOTAwLjg0OCwyODkuODYyOCA5MTAuNzM3LDI4OS44NjI4ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydDAtdG8tbXN0YXJ0MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI5MTUuOTA5LDI4OS44NjI4LDkwNi45MDksMjg1Ljg2MjgsOTEwLjkwOSwyODkuODYyOCw5MDYuOTA5LDI5My44NjI4LDkxNS45MDksMjg5Ljg2MjgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBtc3RhcnQxIHRvIHNjaGVkdWxlLS0+PGcgaWQ9ImxpbmtfbXN0YXJ0MV9zY2hlZHVsZSI+PHBhdGggZD0iTTEwNTYuMjMsMjg5Ljg2MjggQzEwNjYuMTUsMjg5Ljg2MjggMTA3Ni4wNiwyODkuODYyOCAxMDg1Ljk4LDI4OS44NjI4ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydDEtdG8tc2NoZWR1bGUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTA5MS4xNywyODkuODYyOCwxMDgyLjE3LDI4NS44NjI4LDEwODYuMTcsMjg5Ljg2MjgsMTA4Mi4xNywyOTMuODYyOCwxMDkxLjE3LDI4OS44NjI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZmluZHJ1bm5hYmxlIHRvIHNjaGVkdWxlLS0+PGcgaWQ9ImxpbmtfZmluZHJ1bm5hYmxlX3NjaGVkdWxlIj48cGF0aCBkPSJNMTE2NCwyMDAuMzM1OCBDMTE2NCwyMTkuNTk3OCAxMTY0LDI0Ny4yMDI4IDExNjQsMjY2LjQ0NzggIiBmaWxsPSJub25lIiBpZD0iZmluZHJ1bm5hYmxlLXNjaGVkdWxlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjExNjQsMTk1LjIwNjgsMTE2MCwyMDQuMjA2OCwxMTY0LDIwMC4yMDY4LDExNjgsMjA0LjIwNjgsMTE2NCwxOTUuMjA2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMTY0LDI3MS42NDA4LDExNjgsMjYyLjY0MDgsMTE2NCwyNjYuNjQwOCwxMTYwLDI2Mi42NDA4LDExNjQsMjcxLjY0MDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjczIiB4PSIxMTY1IiB5PSIyMzcuOTI5NyI+5p+l5om+5Y+v6L+Q6KGMZzwvdGV4dD48L2c+PCEtLWxpbmsgUCB0byBmaW5kcnVubmFibGUtLT48ZyBpZD0ibGlua19QX2ZpbmRydW5uYWJsZSI+PHBhdGggZD0iTTExNjQsODcuMzM1OCBDMTE2NCwxMDYuNTk3OCAxMTY0LDEzNC4yMDI4IDExNjQsMTUzLjQ0NzggIiBmaWxsPSJub25lIiBpZD0iUC1maW5kcnVubmFibGUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTE2NCw4Mi4yMDY4LDExNjAsOTEuMjA2OCwxMTY0LDg3LjIwNjgsMTE2OCw5MS4yMDY4LDExNjQsODIuMjA2OCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMTY0LDE1OC42NDA4LDExNjgsMTQ5LjY0MDgsMTE2NCwxNTMuNjQwOCwxMTYwLDE0OS42NDA4LDExNjQsMTU4LjY0MDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijc1IiB4PSIxMTY1IiB5PSIxMjQuOTI5NyI+5p+l5om+56ys5LiA5LiqRzwvdGV4dD48L2c+PCEtLWxpbmsgUCB0byBHLS0+PGcgaWQ9ImxpbmtfUF9HIj48cGF0aCBkPSJNMTE3OC43Myw2My44NjI4IEMxMTkwLjI1LDYzLjg2MjggMTIwMS43Nyw2My44NjI4IDEyMTMuMjksNjMuODYyOCAiIGZpbGw9Im5vbmUiIGlkPSJQLUciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Ny4wLDcuMDsiLz48L2c+PCEtLWxpbmsgc2NoZWR1bGUgdG8gZXhlY3V0ZS0tPjxnIGlkPSJsaW5rX3NjaGVkdWxlX2V4ZWN1dGUiPjxwYXRoIGQ9Ik0xMjM2LjY2LDI4OS44NjI4IEMxMjQ2LjU5LDI4OS44NjI4IDEyNTYuNTIsMjg5Ljg2MjggMTI2Ni40NCwyODkuODYyOCAiIGZpbGw9Im5vbmUiIGlkPSJzY2hlZHVsZS10by1leGVjdXRlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjEyNzEuNjQsMjg5Ljg2MjgsMTI2Mi42NCwyODUuODYyOCwxMjY2LjY0LDI4OS44NjI4LDEyNjIuNjQsMjkzLjg2MjgsMTI3MS42NCwyODkuODYyOCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGV4ZWN1dGUgdG8gZ29nby0tPjxnIGlkPSJsaW5rX2V4ZWN1dGVfZ29nbyI+PHBhdGggZD0iTTEzNDEuNTksMzA4LjExODggQzEzNDEuMDUsMzMwLjY0NDggMTM0MC4xMSwzNzAuMTAwOCAxMzM5LjUzLDM5NC43ODM4ICIgZmlsbD0ibm9uZSIgaWQ9ImV4ZWN1dGUtdG8tZ29nbyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMzM5LjQxLDM5OS44MTU4LDEzNDMuNjIyOCwzOTAuOTEzNCwxMzM5LjUyODksMzk0LjgxNzIsMTMzNS42MjUxLDM5MC43MjMyLDEzMzkuNDEsMzk5LjgxNTgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnb2dvIHRvIGxvZ2ljYWwtLT48ZyBpZD0ibGlua19nb2dvX2xvZ2ljYWwiPjxwYXRoIGQ9Ik0xMzM5LDQzNi4yODczIEMxMzM5LDQ1MS44MjEzIDEzMzksNDc0LjY0NTcgMTMzOSw0OTEuNTE4MiAiIGZpbGw9Im5vbmUiIGlkPSJnb2dvLXRvLWxvZ2ljYWwiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTMzOSw0OTYuNTQ4OCwxMzQzLDQ4Ny41NDg4LDEzMzksNDkxLjU0ODgsMTMzNSw0ODcuNTQ4OCwxMzM5LDQ5Ni41NDg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLXJldmVyc2UgbGluayBHb3NjaGVkIHRvIGxvZ2ljYWwtLT48ZyBpZD0ibGlua19Hb3NjaGVkX2xvZ2ljYWwiPjxwYXRoIGQ9Ik0xMjQzLjQ1LDUxNC44NjI4IEMxMjUzLjI3LDUxNC44NjI4IDEyNjMuMSw1MTQuODYyOCAxMjcyLjkyLDUxNC44NjI4ICIgZmlsbD0ibm9uZSIgaWQ9Ikdvc2NoZWQtYmFja3RvLWxvZ2ljYWwiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTIzOC4zMSw1MTQuODYyOCwxMjQ3LjMxLDUxOC44NjI4LDEyNDMuMzEsNTE0Ljg2MjgsMTI0Ny4zMSw1MTAuODYyOCwxMjM4LjMxLDUxNC44NjI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLXJldmVyc2UgbGluayBtY2FsbCB0byBHb3NjaGVkLS0+PGcgaWQ9ImxpbmtfbWNhbGxfR29zY2hlZCI+PHBhdGggZD0iTTExNjYsNDQxLjMyNzYgQzExNjYsNDU4LjIyODMgMTE2Niw0ODEuMDQ5NCAxMTY2LDQ5Ni41NDg4ICIgZmlsbD0ibm9uZSIgaWQ9Im1jYWxsLWJhY2t0by1Hb3NjaGVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjExNjYsNDM2LjI4NzMsMTE2Miw0NDUuMjg3MywxMTY2LDQ0MS4yODczLDExNzAsNDQ1LjI4NzMsMTE2Niw0MzYuMjg3MyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgc2NoZWR1bGUgdG8gbWNhbGwtLT48ZyBpZD0ibGlua19zY2hlZHVsZV9tY2FsbCI+PHBhdGggZD0iTTExNjQuMzUsMzEzLjE3MDggQzExNjQuNzUsMzM3Ljk0NDggMTE2NS4zNywzNzcuMzkzOCAxMTY1LjczLDM5OS44MTU4ICIgZmlsbD0ibm9uZSIgaWQ9InNjaGVkdWxlLWJhY2t0by1tY2FsbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxMTY0LjI3LDMwOC4xMTg4LDExNjAuNDE0NSwzMTcuMTgxNiwxMTY0LjM1LDMxMy4xMTgyLDExNjguNDEzNSwzMTcuMDUzNiwxMTY0LjI3LDMwOC4xMTg4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgRyB0byBtYWluLS0+PGcgaWQ9ImxpbmtfR19tYWluIj48cGF0aCBkPSJNMTI0NC42LDYzLjg2MjggQzEyODEuOTEsNjMuODYyOCAxMzc4LjM2LDYzLjg2MjggMTQ0OC4xNyw2My44NjI4ICIgZmlsbD0ibm9uZSIgaWQ9IkctdG8tbWFpbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7c3Ryb2tlLWRhc2hhcnJheTo3LjAsNy4wOyIvPjxwb2x5Z29uIGZpbGw9Im5vbmUiIHBvaW50cz0iMTQ0OC40Myw1Ni44NjI4LDE0NjguNDMsNjMuODYyOCwxNDQ4LjQzLDcwLjg2MjgsMTQ0OC40Myw1Ni44NjI4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxODciIHg9IjEyNjMiIHk9IjU2LjkyOTciPuWNj+eoi+W8gOWni+WHveaVsOS4unJ1bnRpbWUubWFpbigpPC90ZXh0PjwvZz48IS0tbGluayBtYWluIHRvIG1haW5fbWFpbi0tPjxnIGlkPSJsaW5rX21haW5fbWFpbl9tYWluIj48cGF0aCBkPSJNMTUyNyw4Mi4yMDY4IEMxNTI3LDEwMS40MzA4IDE1MjcsMTMyLjQ5MjggMTUyNywxNTMuNTIzOCAiIGZpbGw9Im5vbmUiIGlkPSJtYWluLXRvLW1haW5fbWFpbiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNTI3LDE1OC42NDA4LDE1MzEsMTQ5LjY0MDgsMTUyNywxNTMuNjQwOCwxNTIzLDE0OS42NDA4LDE1MjcsMTU4LjY0MDgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIyNyIgeD0iMTUyOCIgeT0iMTI0LjkyOTciPuatpOaXtuaJjeecn+ato+WcsOaJp+ihjOWIsOaIkeS7rOeahG1haW7lh73mlbDkuK08L3RleHQ+PC9nPjwhLS1TUkM9W1pQSkZLekQwNUNWbC1JanNFRWMxc1lmd28zWFNGRkpRU1NRUkN2dEdYZjJQRDY3SUwzbnVBQThJZTNKVzIyaFcwMVBpbm01UW51NWNNZ0dwX1l0UEpOaG9OdDFfOUtyaFRDbVhVVmxVUHRWVmxkdFZjN0IxYWRINWF5NUtJTEJyQUkyTEdQdk9XWmNBdjRxaGRQVEFuR1NwQjF1RGF3NnlmaXZEV0NHTFh5c0FSZ2FiLU1VTjQ4ZjFRTU9jS2ZBZmIyYjNaNEoyQUFrd1FiNjZjT2JLa1IwVzVvQ202WU1va2hvcVExZTVJZDh4V0tqNUxQaWlNZXZ3U3Q1TmJoZ29TSFVQRFJ4Njd6TUZUWWZSYWlhb1AtUlZlTklDSWx5VG95SW1KMTk2QXJKSHY1NnZ5MjA5ZDVWcnVrRUFoYWpwNzJPRWFwa0k5aVpGdktCNU9Zb3RhcDM1dUNyMVozWldsc2lYay1scjZfeEh5aDNRM3N3c1hvaWpRQi1YaTZPZVFhN0lhWFJDNmxHT3gyQU9kTFdWRjVyWnJJNk04NVlnSFU5bWdtdE5NeTVXdHN6anQ2NjNLWmhlaEMzVTV0SXZKOXAxTzJpdWhsYmRQdnZSelRvbFNEQ1hOaEpNOTV3UURCYlZrRmUzeE5JYzE4N1VEZldrNmFsd3oyb05XMFptNURYcHVFakp3M0k0YU9oLWJvRGctcFNoQzZ5NDRMczk4MkMyVUI4OXhJaXlWM1E5QzVjOXVBdThXZGVORWhrRlNhX0dhT2tGeUxKdHQzZ2tfVjN1NGZ1cU9TVVBkMWU5SkdKdHk2blFCY1hfV2lxRE1Ea1RYQmRNSDMwWjBnel82alZQaFRrVXN1Rk5MSkFINVgzUS14M1ZZdWdUX05MVFd2cmx3NENSRWp5elRwcmVsWHMtUjkxMGo4Y2ZBV2lNdGVLcmxHWmt1dHBlUlZockRsb3k0Y0s1QnNnZWxHRXR3ZFg5U2h3LXRualcyWHlLVlJtT0xsVjJPSEtUVEljMlZTNVdiSXRCYWlGaHVjaDdjcUNHTTFwR1BvQU5EMC1jYXU4UDdpb0Mxb0Q5WFdROUZmb2tCRThPNkRFVzJEM1hBTGd4V0t3UlRRV1luQ0ZYZjVwOFpNZWd2NDJBUnVYX05WNkRlWkgyMFZDbG92NVY5bktrVUc3LVg4NUdmRnBCT2ZleUpuT0NiU2NfQkNQRm5HSDl0LTZBRjE5TEd5WTI1Q3Fqek1BTV9iRG5OckNUbmRpN2p6OXVSbWJaS2VuLW5SV1l2b1ZlX0hMUXNfR0YzajV2MG52cWM5b1h0SzdzampTX3lfVFVaS0pqa1VVXzBHMDBdLS0+PC9nPjwvc3ZnPg=="><p>大致如图所示，进程由操作系统创建并初始化后，启动主线程，主线程以Go内核提供的程序入口点开始执行，经过<code>runtime·rt0_go()</code>函数对进程中Go内核环境初始化，再通过<code>runtime.mstart</code>函数启动调度流程。</p><h2 id="初始化内核"><a href="#初始化内核" class="headerlink" title="初始化内核"></a>初始化内核</h2><p>主线程在进入调度流程前，会经过<code>runtime·rt0_go()</code>函数对内核环境进行初始化，除了图中标注的一部分之外，还有其他很多处理细节，如：处理g0的堆栈，初始化TLS，绑定m0与g0等等。</p><p>除了未标注出的部分流程之外，<code>runtime·rt0_go()</code>函数的核心工作主要集中在如下代码段中：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span><span class="keyword">runtime</span>·check(SB)</span><br><span class="line"></span><br><span class="line">MOVL<span class="number">24</span>(SP), AX<span class="comment">// copy argc</span></span><br><span class="line">MOVLAX, <span class="number">0</span>(SP)</span><br><span class="line">MOVQ<span class="number">32</span>(SP), AX<span class="comment">// copy argv</span></span><br><span class="line">MOVQAX, <span class="number">8</span>(SP)</span><br><span class="line"><span class="keyword">CALL</span><span class="keyword">runtime</span>·args(SB)</span><br><span class="line"><span class="keyword">CALL</span><span class="keyword">runtime</span>·osinit(SB)</span><br><span class="line"><span class="keyword">CALL</span><span class="keyword">runtime</span>·schedinit(SB)</span><br><span class="line"></span><br><span class="line"><span class="comment">// create a new goroutine to start program</span></span><br><span class="line">MOVQ$<span class="keyword">runtime</span>·mainPC(SB), AX<span class="comment">// entry</span></span><br><span class="line">PUSHQAX</span><br><span class="line"><span class="keyword">CALL</span><span class="keyword">runtime</span>·newproc(SB)</span><br><span class="line">POPQAX</span><br><span class="line"></span><br><span class="line"><span class="comment">// start this M</span></span><br><span class="line"><span class="keyword">CALL</span><span class="keyword">runtime</span>·mstart(SB)</span><br><span class="line"></span><br><span class="line"><span class="keyword">CALL</span><span class="keyword">runtime</span>·abort(SB)<span class="comment">// mstart should never return</span></span><br></pre></td></tr></table></figure></p><ol><li><code>runtime·check</code>：检查内置类型、基础包的功能是否正常</li><li><code>runtime·args</code>: 复制启动参数</li><li><code>runtime·osinit</code>: 获取CPU核数与分页大小</li><li><code>runtime·schedinit</code>: 调度初始化，该函数负责的初始化工作很多，感兴趣可以自己看看，定义在<code>src/runtime/proc.go</code>文件中</li><li><code>runtime·newproc</code>: 以<code>runtime.main()</code>函数地址为参数，创建Goroutine，即第一个可运行G</li><li><code>runtime·mstart</code>: 进入调度流程</li></ol><p><strong>备注：主线程以m0身份，被封装成M进入调度流程后，不会再从<code>runtime·mstart()</code>函数返回，按照Go内核的设计，当m0退出时，会被直接挂起，进入休眠状态</strong></p><h2 id="正式开始工作"><a href="#正式开始工作" class="headerlink" title="正式开始工作"></a>正式开始工作</h2><p>无论是主线程还是普通线程，最终都会经过<code>runtime·mstart</code>函数进入到调度流程中，当调度流程运行起来以后，就是熟悉的查找可运行G的过程，而启动阶段，通过<code>runtime·newproc()</code>函数，程序已经以<code>runtime.main()</code>函数为开始创建了第一个可运行的G，并保存到本地队列中。</p><p>此时，m0的调度流程就只能查找到以<code>runtime.main()</code>函数为开始的可运行G，然后执行查找到的可运行G，直到这里，第一个Goroutine才真正开始执行，不过此时，离执行用户编写的<code>main.main()</code>函数还有一点点距离。</p><p>在这段时间里，程序还得负责启动sysmon线程，执行<code>init()</code>函数，打开GC等等，这一套流程走完，才会正式开始执行<code>main.main()</code>函数。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;当我们运行一个可执行文件时，操作系统会为该可执行文件生成运行环境，即创建新进程，然后将可执行文件中包含的数据，代码等必要数据加载到进程的内存中，再经过各种初始化后，创建一个主线程从程序入口点开始执行。&lt;/p&gt;
&lt;p&gt;通常，操作系统都会制定一套标准的可执行文件格式和对应的程序加载规范，如：Linux的ELF文件格式、Windows的PE文件格式等等。&lt;/p&gt;
&lt;p&gt;不同的文件格式为了满足不同的操作系统特性和功能而不同，但都会为操作系统提供一个可供主线程启动时使用的程序入口点。在不同的编程语言中，要支持在某个操作系统上运行，就需要满足对应操作系统制定的规范。&lt;/p&gt;
&lt;p&gt;在Go内核中，针对不同的操作系统提供了不同的汇编代码，以此来支持不同系统架构下的差异化情况，如：amd64中提供了&lt;code&gt;main()&lt;/code&gt;，&lt;code&gt;_rt0_amd64()&lt;/code&gt;，&lt;code&gt;_rt0_amd64_lib()&lt;/code&gt;等程序入口，而在这些不同场景下，主线程执行经过这些入口之后，就会执行进入到统一的&lt;code&gt;runtime·rt0_go()&lt;/code&gt;函数中。&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="golang" scheme="https://oldchan.net/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Golang深度解读：调度</title>
    <link href="https://oldchan.net/2022/12/10/notes/golang/advanced/schedule/"/>
    <id>https://oldchan.net/2022/12/10/notes/golang/advanced/schedule/</id>
    <published>2022-12-10T05:27:16.000Z</published>
    <updated>2023-01-14T08:21:28.320Z</updated>
    
    <content type="html"><![CDATA[<p>通过对M，P，G的简单介绍，我们大致上了解了这几种概念在Go语言运行机制中的基本作用</p><ul><li>M封装操作系统的线程，提供运行资源</li><li>P封装G运行过程中需要的辅助资源，并为G提供排队管理</li><li>G封装运行上下文，提供运行用户代码的能力</li></ul><p>三者协作，只要有源源不断可运行的G存在，M+P的组合就会不断地循环调度，直到没有可运行的G时，M与P解绑，并进入休眠状态。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIxODJweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjUyNnB4O2hlaWdodDoxODJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA1MjYgMTgyIiB3aWR0aD0iNTI2cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM1IiB4PSIxODguNSIgeT0iMjIuOTk1MSI+5pys5Zyw6Zif5YiX5LiO5YWo5bGA6Zif5YiXPC90ZXh0PjwhLS1lbnRpdHkgcC0tPjxnIGlkPSJlbGVtX3AiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjI5OSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjMwOSIgeT0iNjcuMjkyIj5QPC90ZXh0PjwvZz48IS0tZW50aXR5IG0tLT48ZyBpZD0iZWxlbV9tIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjMyIiB4PSIyOTcuNSIgeT0iMTQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMiIgeD0iMzA3LjUiIHk9IjE2My4yOTIiPk08L3RleHQ+PC9nPjwhLS1lbnRpdHkgZzAtLT48ZyBpZD0iZWxlbV9nMCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzOCIgeD0iMzY0LjUiIHk9IjE0MC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgiIHg9IjM3NC41IiB5PSIxNjMuMjkyIj5nMDwvdGV4dD48L2c+PCEtLWVudGl0eSBnMS0tPjxnIGlkPSJlbGVtX2cxIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSIzNjMiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSIzNzMiIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnMi0tPjxnIGlkPSJlbGVtX2cyIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI0MjciIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSI0MzciIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnMy0tPjxnIGlkPSJlbGVtX2czIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI0OTEiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSI1MDEiIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnbG9iLS0+PGcgaWQ9ImVsZW1fZ2xvYiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI2NCIgeD0iMTk5LjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NCIgeD0iMjA5LjUiIHk9IjY3LjI5MiI+Z2xvYmFsPC90ZXh0PjwvZz48IS0tZW50aXR5IGc0LS0+PGcgaWQ9ImVsZW1fZzQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjEzNSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjE0NSIgeT0iNjcuMjkyIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGc1LS0+PGcgaWQ9ImVsZW1fZzUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjcxIiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iODEiIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnNi0tPjxnIGlkPSJlbGVtX2c2Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iMTciIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnNy0tPjxnIGlkPSJlbGVtX2c3Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI3IiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjE3IiB5PSIxNjMuMjkyIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGc4LS0+PGcgaWQ9ImVsZW1fZzgiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjcxIiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjgxIiB5PSIxNjMuMjkyIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGc5LS0+PGcgaWQ9ImVsZW1fZzkiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjEzNSIgeT0iMTQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSIxNDUiIHk9IjE2My4yOTIiPmc8L3RleHQ+PC9nPjwhLS1saW5rIHAgdG8gZzEtLT48ZyBpZD0ibGlua19wX2cxIj48cGF0aCBkPSJNMzI4LjI1LDYyLjI5NjkgQzMzOS43OTMsNjIuMjk2OSAzNTEuMzM2LDYyLjI5NjkgMzYyLjg3OSw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9InAtZzEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Ny4wLDcuMDsiLz48L2c+PCEtLWxpbmsgZzEgdG8gZzItLT48ZyBpZD0ibGlua19nMV9nMiI+PHBhdGggZD0iTTM5Mi41LDYyLjI5NjkgQzQwMy45ODQsNjIuMjk2OSA0MTUuNDY5LDYyLjI5NjkgNDI2Ljk1Myw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9ImcxLWcyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZzIgdG8gZzMtLT48ZyBpZD0ibGlua19nMl9nMyI+PHBhdGggZD0iTTQ1Niw2Mi4yOTY5IEM0NjcuNjAyLDYyLjI5NjkgNDc5LjIwMyw2Mi4yOTY5IDQ5MC44MDUsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnMi1nMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHAgdG8gbS0tPjxnIGlkPSJsaW5rX3BfbSI+PHBhdGggZD0iTTMxMy41LDgwLjUzNzkgQzMxMy41LDk3LjQ5ODYgMzEzLjUsMTIzLjI0MjQgMzEzLjUsMTQwLjE2NTIgIiBmaWxsPSJub25lIiBpZD0icC1tIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgbSB0byBnMC0tPjxnIGlkPSJsaW5rX21fZzAiPjxwYXRoIGQ9Ik0zMjkuNjMzLDE1OC4yOTY5IEMzNDEuMTM2LDE1OC4yOTY5IDM1Mi42MzksMTU4LjI5NjkgMzY0LjE0MSwxNTguMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtLWcwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PC9nPjwhLS1saW5rIGc0IHRvIGdsb2ItLT48ZyBpZD0ibGlua19nNF9nbG9iIj48cGF0aCBkPSJNMTY0LjIzNCw2Mi4yOTY5IEMxNzUuOTcxLDYyLjI5NjkgMTg3LjcwNyw2Mi4yOTY5IDE5OS40NDQsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnNC1nbG9iIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PC9nPjwhLS1saW5rIGc1IHRvIGc0LS0+PGcgaWQ9ImxpbmtfZzVfZzQiPjxwYXRoIGQ9Ik0xMDAsNjIuMjk2OSBDMTExLjYwMiw2Mi4yOTY5IDEyMy4yMDMsNjIuMjk2OSAxMzQuODA1LDYyLjI5NjkgIiBmaWxsPSJub25lIiBpZD0iZzUtZzQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnNiB0byBnNS0tPjxnIGlkPSJsaW5rX2c2X2c1Ij48cGF0aCBkPSJNMzYuNSw2Mi4yOTY5IEM0Ny45ODQ0LDYyLjI5NjkgNTkuNDY4OCw2Mi4yOTY5IDcwLjk1MzEsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnNi1nNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGc2IHRvIGc3LS0+PGcgaWQ9ImxpbmtfZzZfZzciPjxwYXRoIGQ9Ik0yMS41LDgwLjUzNzkgQzIxLjUsOTcuNDk4NiAyMS41LDEyMy4yNDI0IDIxLjUsMTQwLjE2NTIgIiBmaWxsPSJub25lIiBpZD0iZzYtZzciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnNyB0byBnOC0tPjxnIGlkPSJsaW5rX2c3X2c4Ij48cGF0aCBkPSJNMzYuNSwxNTguMjk2OSBDNDcuOTg0NCwxNTguMjk2OSA1OS40Njg4LDE1OC4yOTY5IDcwLjk1MzEsMTU4LjI5NjkgIiBmaWxsPSJub25lIiBpZD0iZzctZzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnOCB0byBnOS0tPjxnIGlkPSJsaW5rX2c4X2c5Ij48cGF0aCBkPSJNMTAwLDE1OC4yOTY5IEMxMTEuNjAyLDE1OC4yOTY5IDEyMy4yMDMsMTU4LjI5NjkgMTM0LjgwNSwxNTguMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnOC1nOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1TUkM9W1JUMngyaThtNTBSV19KbjV3NXhmX1Y4R1dnekdqSHVCd09LUVM3S0hkNW5yQUJXd0VFWmMwbmQxanAxZlFURDJqbG5WSld4eWdUQ0xJbWdhQUo0TTFhYnNmODlRcVJvYlY0bmVqT1JNMTNrcERVUGVwOEs5cWRBUHFFdjY3M05wZGlQeVpHS1EycEtNUUltNk8xY0p5NnFVbDdkLWhaVC1rZHBVUHR3eXl6VVhZbVAwSE1QY2RVNk1jUjhsc2NIODNnMlphWWo3cE5NdkJxcG5XVmRlYkdLV1VtZ1h3S1EyMS1ZSEZsWTBfWDAybUExVjhmZldnRlA3Vzk1QXlIeTBdLS0+PC9nPjwvc3ZnPg=="><a id="more"></a><h2 id="调度模型"><a href="#调度模型" class="headerlink" title="调度模型"></a>调度模型</h2><h3 id="调度流程"><a href="#调度流程" class="headerlink" title="调度流程"></a>调度流程</h3><p>每一个Worker M在工作时，都会进入到如下的调度流程中</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI0OTBweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjg1MHB4O2hlaWdodDo0OTBweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA4NTAgNDkwIiB3aWR0aD0iODUwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSIzNTguMjUiIHk9IjIyLjk5NTEiPueyvueugOeJiOiwg+W6pua1geeoi+WbvjwvdGV4dD48IS0tZW50aXR5IG1zdGFydC0tPjxnIGlkPSJlbGVtX21zdGFydCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzEiIHg9IjciIHk9IjI1NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExIiB4PSIxNyIgeT0iMjc3LjI5MiI+cnVudGltZS5tc3RhcnQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbXN0YXJ0MC0tPjxnIGlkPSJlbGVtX21zdGFydDAiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSIxNzMuNSIgeT0iMjU0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAiIHg9IjE4My41IiB5PSIyNzcuMjkyIj5ydW50aW1lLm1zdGFydDA8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbXN0YXJ0MS0tPjxnIGlkPSJlbGVtX21zdGFydDEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSIzNDguNSIgeT0iMjU0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAiIHg9IjM1OC41IiB5PSIyNzcuMjkyIj5ydW50aW1lLm1zdGFydDE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgc2NoZWR1bGUtLT48ZyBpZD0iZWxlbV9zY2hlZHVsZSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDUiIHg9IjUyNCIgeT0iMjU0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUiIHg9IjUzNCIgeT0iMjc3LjI5MiI+cnVudGltZS5zY2hlZHVsZTwvdGV4dD48L2c+PCEtLWVudGl0eSBzdG9wbS0tPjxnIGlkPSJlbGVtX3N0b3BtIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyOSIgeD0iNTMyIiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA5IiB4PSI1NDIiIHk9IjY3LjI5MiI+cnVudGltZS5zdG9wbTwvdGV4dD48L2c+PCEtLWVudGl0eSBmaW5kcnVubmFibGUtLT48ZyBpZD0iZWxlbV9maW5kcnVubmFibGUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTc3IiB4PSI1MDgiIHk9IjE0MS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTU3IiB4PSI1MTgiIHk9IjE2NC4yOTIiPnJ1bnRpbWUuZmluZFJ1bm5hYmxlPC90ZXh0PjwvZz48IS0tZW50aXR5IGV4ZWN1dGUtLT48ZyBpZD0iZWxlbV9leGVjdXRlIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE0MCIgeD0iNzA0LjUiIHk9IjI1NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSI3MTQuNSIgeT0iMjc3LjI5MiI+cnVudGltZS5leGVjdXRlPC90ZXh0PjwvZz48IS0tZW50aXR5IGdvZ28tLT48ZyBpZD0iZWxlbV9nb2dvIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjExOCIgeD0iNzEzLjUiIHk9IjM1MS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTgiIHg9IjcyMy41IiB5PSIzNzQuMjkyIj5ydW50aW1lLmdvZ288L3RleHQ+PC9nPjwhLS1lbnRpdHkgbG9naWNhbC0tPjxnIGlkPSJlbGVtX2xvZ2ljYWwiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTMyIiB4PSI3MDYuNSIgeT0iNDQ4LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTIiIHg9IjcxNi41IiB5PSI0NzEuMjkyIj7nlKjmiLfku6PnoIHpgLvovpHpg6jliIY8L3RleHQ+PC9nPjwhLS1lbnRpdHkgR29zY2hlZC0tPjxnIGlkPSJlbGVtX0dvc2NoZWQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQ0IiB4PSI1MjcuNSIgeT0iNDQ4LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjQiIHg9IjUzNy41IiB5PSI0NzEuMjkyIj5ydW50aW1lLkdvc2NoZWQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbWNhbGwtLT48ZyBpZD0iZWxlbV9tY2FsbCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMjAiIHg9IjUzOS41IiB5PSIzNTEuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwMCIgeD0iNTQ5LjUiIHk9IjM3NC4yOTIiPnJ1bnRpbWUubWNhbGw8L3RleHQ+PC9nPjwhLS1saW5rIG1zdGFydCB0byBtc3RhcnQwLS0+PGcgaWQ9ImxpbmtfbXN0YXJ0X21zdGFydDAiPjxwYXRoIGQ9Ik0xMzguMjk1LDI3Mi4yOTY5IEMxNDguMjEsMjcyLjI5NjkgMTU4LjEyNiwyNzIuMjk2OSAxNjguMDQxLDI3Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydC10by1tc3RhcnQwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3My4yMjYsMjcyLjI5NjksMTY0LjIyNiwyNjguMjk2OSwxNjguMjI2LDI3Mi4yOTY5LDE2NC4yMjYsMjc2LjI5NjksMTczLjIyNiwyNzIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIG1zdGFydDAgdG8gbXN0YXJ0MS0tPjxnIGlkPSJsaW5rX21zdGFydDBfbXN0YXJ0MSI+PHBhdGggZD0iTTMxMy41NjgsMjcyLjI5NjkgQzMyMy40NTgsMjcyLjI5NjkgMzMzLjM0OCwyNzIuMjk2OSAzNDMuMjM3LDI3Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydDAtdG8tbXN0YXJ0MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNDguNDA5LDI3Mi4yOTY5LDMzOS40MDksMjY4LjI5NjksMzQzLjQwOSwyNzIuMjk2OSwzMzkuNDA5LDI3Ni4yOTY5LDM0OC40MDksMjcyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBtc3RhcnQxIHRvIHNjaGVkdWxlLS0+PGcgaWQ9ImxpbmtfbXN0YXJ0MV9zY2hlZHVsZSI+PHBhdGggZD0iTTQ4OC43MjcsMjcyLjI5NjkgQzQ5OC42NDUsMjcyLjI5NjkgNTA4LjU2NCwyNzIuMjk2OSA1MTguNDgyLDI3Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydDEtdG8tc2NoZWR1bGUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIzLjY2OSwyNzIuMjk2OSw1MTQuNjY5LDI2OC4yOTY5LDUxOC42NjksMjcyLjI5NjksNTE0LjY2OSwyNzYuMjk2OSw1MjMuNjY5LDI3Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZmluZHJ1bm5hYmxlIHRvIHNjaGVkdWxlLS0+PGcgaWQ9ImxpbmtfZmluZHJ1bm5hYmxlX3NjaGVkdWxlIj48cGF0aCBkPSJNNTk2LjUsMTgyLjc2OTkgQzU5Ni41LDIwMi4wMzE5IDU5Ni41LDIyOS42MzY5IDU5Ni41LDI0OC44ODE5ICIgZmlsbD0ibm9uZSIgaWQ9ImZpbmRydW5uYWJsZS1zY2hlZHVsZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1OTYuNSwxNzcuNjQwOSw1OTIuNSwxODYuNjQwOSw1OTYuNSwxODIuNjQwOSw2MDAuNSwxODYuNjQwOSw1OTYuNSwxNzcuNjQwOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1OTYuNSwyNTQuMDc0OSw2MDAuNSwyNDUuMDc0OSw1OTYuNSwyNDkuMDc0OSw1OTIuNSwyNDUuMDc0OSw1OTYuNSwyNTQuMDc0OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iNzMiIHg9IjU5Ny41IiB5PSIyMjAuMzYzOCI+5p+l5om+5Y+v6L+Q6KGMZzwvdGV4dD48L2c+PCEtLWxpbmsgc3RvcG0gdG8gZmluZHJ1bm5hYmxlLS0+PGcgaWQ9Imxpbmtfc3RvcG1fZmluZHJ1bm5hYmxlIj48cGF0aCBkPSJNNTk2LjUsODUuNzYxOSBDNTk2LjUsMTAwLjgxMzkgNTk2LjUsMTIwLjU2MTkgNTk2LjUsMTM1LjY1MTkgIiBmaWxsPSJub25lIiBpZD0ic3RvcG0tZmluZHJ1bm5hYmxlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU5Ni41LDgwLjcyMDksNTkyLjUsODkuNzIwOSw1OTYuNSw4NS43MjA5LDYwMC41LDg5LjcyMDksNTk2LjUsODAuNzIwOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1OTYuNSwxNDAuOTgyOSw2MDAuNSwxMzEuOTgyOSw1OTYuNSwxMzUuOTgyOSw1OTIuNSwxMzEuOTgyOSw1OTYuNSwxNDAuOTgyOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHNjaGVkdWxlIHRvIGV4ZWN1dGUtLT48ZyBpZD0ibGlua19zY2hlZHVsZV9leGVjdXRlIj48cGF0aCBkPSJNNjY5LjE2LDI3Mi4yOTY5IEM2NzkuMDg4LDI3Mi4yOTY5IDY4OS4wMTYsMjcyLjI5NjkgNjk4Ljk0NSwyNzIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJzY2hlZHVsZS10by1leGVjdXRlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjcwNC4xMzYsMjcyLjI5NjksNjk1LjEzNiwyNjguMjk2OSw2OTkuMTM2LDI3Mi4yOTY5LDY5NS4xMzYsMjc2LjI5NjksNzA0LjEzNiwyNzIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGV4ZWN1dGUgdG8gZ29nby0tPjxnIGlkPSJsaW5rX2V4ZWN1dGVfZ29nbyI+PHBhdGggZD0iTTc3NC4xMzMsMjkwLjcyMDkgQzc3My44MDYsMzA2LjI1NTkgNzczLjMyNiwzMjkuMDc5OSA3NzIuOTcsMzQ1Ljk1MTkgIiBmaWxsPSJub25lIiBpZD0iZXhlY3V0ZS10by1nb2dvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9Ijc3Mi44NjUsMzUwLjk4MjksNzc3LjA1NDQsMzQyLjA2OTUsNzcyLjk3MDcsMzQ1Ljk4NCw3NjkuMDU2MiwzNDEuOTAwMyw3NzIuODY1LDM1MC45ODI5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZ29nbyB0byBsb2dpY2FsLS0+PGcgaWQ9ImxpbmtfZ29nb19sb2dpY2FsIj48cGF0aCBkPSJNNzcyLjUsMzg3LjcyMTQgQzc3Mi41LDQwMy4yNTU0IDc3Mi41LDQyNi4wNzk4IDc3Mi41LDQ0Mi45NTIzICIgZmlsbD0ibm9uZSIgaWQ9ImdvZ28tdG8tbG9naWNhbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3NzIuNSw0NDcuOTgyOSw3NzYuNSw0MzguOTgyOSw3NzIuNSw0NDIuOTgyOSw3NjguNSw0MzguOTgyOSw3NzIuNSw0NDcuOTgyOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR29zY2hlZCB0byBsb2dpY2FsLS0+PGcgaWQ9ImxpbmtfR29zY2hlZF9sb2dpY2FsIj48cGF0aCBkPSJNNjc2Ljk0Niw0NjYuMjk2OSBDNjg2Ljc3MSw0NjYuMjk2OSA2OTYuNTk2LDQ2Ni4yOTY5IDcwNi40MjEsNDY2LjI5NjkgIiBmaWxsPSJub25lIiBpZD0iR29zY2hlZC1iYWNrdG8tbG9naWNhbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NzEuODA5LDQ2Ni4yOTY5LDY4MC44MDksNDcwLjI5NjksNjc2LjgwOSw0NjYuMjk2OSw2ODAuODA5LDQ2Mi4yOTY5LDY3MS44MDksNDY2LjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIG1jYWxsIHRvIEdvc2NoZWQtLT48ZyBpZD0ibGlua19tY2FsbF9Hb3NjaGVkIj48cGF0aCBkPSJNNTk5LjUsMzkyLjc2MTcgQzU5OS41LDQwOS42NjI0IDU5OS41LDQzMi40ODM1IDU5OS41LDQ0Ny45ODI5ICIgZmlsbD0ibm9uZSIgaWQ9Im1jYWxsLWJhY2t0by1Hb3NjaGVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU5OS41LDM4Ny43MjE0LDU5NS41LDM5Ni43MjE0LDU5OS41LDM5Mi43MjE0LDYwMy41LDM5Ni43MjE0LDU5OS41LDM4Ny43MjE0IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLXJldmVyc2UgbGluayBzY2hlZHVsZSB0byBtY2FsbC0tPjxnIGlkPSJsaW5rX3NjaGVkdWxlX21jYWxsIj48cGF0aCBkPSJNNTk3LjIwOSwyOTUuNzYxOSBDNTk3Ljc0MywzMTIuNjYxOSA1OTguNDY0LDMzNS40ODM5IDU5OC45NTMsMzUwLjk4MjkgIiBmaWxsPSJub25lIiBpZD0ic2NoZWR1bGUtYmFja3RvLW1jYWxsIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU5Ny4wNSwyOTAuNzIwOSw1OTMuMzM0OSwyOTkuODQyMiw1OTcuMjA3MiwyOTUuNzE4NCw2MDEuMzMwOSwyOTkuNTkwNyw1OTcuMDUsMjkwLjcyMDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tU1JDPVtUUDdCSWlHbTU4UnRVT2VtLXlmcUEtQk1sTXpHc3FvY2EyUDNjazhpUG5ZRzNXZWdrN0VYOGFmTkFlODgzaklOaVBUdjJ2alJ3SzBjWXZwSl9EeXZJVl8zS0lXMllXYzI4dnZINElWZTg0YjVtQ0s4MVlkS0FVM3hlRjYwNmtfN18wN2NreDBxZEE4ZThxWG56aUM5MlpQQkQyS3A1cEE5UU5JUUtIZ1NjTnhvVzlpM0xtNlFlcDBKY1pNdjJ5Q0NDeU44UDBXcVRxTVRWX3pqZGZsN3ZOUW5RU2xSeFFnZXlXaTU0dVJaQzIya1hZVENfUWQySkV3cWkyaWRzYTJQMEkxWWVReHpCOWt0SFJGRXN1ekx6VkRRVm9zUnVoQXdCcVMwUUFVWE1Yd0Z5TEh1bl9zS0o3STlsWDd6TlI0Vlk0c2FVa0hiaXF3M0VfT1VtbGhYZkx3TnJWTHgtdGxKRmJyWEM5SGphUHhUaTVqX2JuczBZVmVYNEprZGRRUUNibmlxb21oTVAxRXJIajE0RGhKRWNnV3J5dEhqZ0Rmakh3Rk9qX3EzXS0tPjwvZz48L3N2Zz4="><p>以<code>runtime.schedule()</code>函数为核心的调度逻辑，通过<code>runtime.findRunnable()</code>函数查找可运行的G，再进入到一套标准的用户代码执行逻辑中，直到让出执行权(图以执行<code>runtime.Gosched()</code>函数让出执行权举例)。<br>如果调度流程在执行<code>runtime.findRunnable()</code>函数过程中，没有查找到可运行的G，则调用<code>runtime.stopm()</code>函数，将当前M挂起，进入到休眠状态，直到再次被唤醒时，返回到<code>runtime.findRunnable()</code>函数中继续查找可运行的G，并再次回到调度流程。</p><h3 id="简化模型"><a href="#简化模型" class="headerlink" title="简化模型"></a>简化模型</h3><p>对调度流程的进一步简化，可将调度的状态切换理解成如下模型：</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI4NnB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6MjQ0cHg7aGVpZ2h0Ojg2cHg7YmFja2dyb3VuZDojRkZGRkZGOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgMjQ0IDg2IiB3aWR0aD0iMjQ0cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTAiIHg9IjcwLjI1IiB5PSIyMi45OTUxIj7osIPluqbnirbmgIHliIfmjaI8L3RleHQ+PCEtLWVudGl0eSBmaW5kLS0+PGcgaWQ9ImVsZW1fZmluZCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI0OCIgeD0iMTAxLjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOCIgeD0iMTExLjUiIHk9IjY3LjI5MiI+ZmluZDwvdGV4dD48L2c+PCEtLWVudGl0eSBleGVjLS0+PGcgaWQ9ImVsZW1fZXhlYyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI1NCIgeD0iMTg0LjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIzNCIgeD0iMTk0LjUiIHk9IjY3LjI5MiI+ZXhlYzwvdGV4dD48L2c+PCEtLWVudGl0eSBzbGVlcC0tPjxnIGlkPSJlbGVtX3NsZWVwIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjU5IiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzkiIHg9IjE3IiB5PSI2Ny4yOTIiPnNsZWVwPC90ZXh0PjwvZz48IS0tbGluayBmaW5kIHRvIGV4ZWMtLT48ZyBpZD0ibGlua19maW5kX2V4ZWMiPjxwYXRoIGQ9Ik0xNDkuNjg4LDczLjIxMjkgQzE1OS41NTcsNzUuOTI0MSAxNjkuNDI2LDc2LjUwMTggMTc5LjI5Niw3NC45NDU5ICIgZmlsbD0ibm9uZSIgaWQ9ImZpbmQtdG8tZXhlYyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxODQuNDU3LDczLjkzNzgsMTc0Ljg1NzEsNzEuNzM3NCwxNzkuNTQ5Nyw3NC44OTY0LDE3Ni4zOTA4LDc5LjU4OSwxODQuNDU3LDczLjkzNzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIGZpbmQgdG8gZXhlYy0tPjxnIGlkPSJsaW5rX2ZpbmRfZXhlYyI+PHBhdGggZD0iTTE1NC41NzcsNTAuMjEyMyBDMTY0LjUzNyw0OC4xODczIDE3NC40OTcsNDguMzM1MiAxODQuNDU3LDUwLjY1NiAiIGZpbGw9Im5vbmUiIGlkPSJmaW5kLWJhY2t0by1leGVjIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE0OS42ODgsNTEuMzgwOSwxNTkuMzcxLDUzLjE4MDksMTU0LjU1MTIsNTAuMjE5NCwxNTcuNTEyNyw0NS4zOTk3LDE0OS42ODgsNTEuMzgwOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgc2xlZXAgdG8gZmluZC0tPjxnIGlkPSJsaW5rX3NsZWVwX2ZpbmQiPjxwYXRoIGQ9Ik03MS4wMTQ2LDc1LjExNzEgQzgxLjEyNiw3Ni40OTM4IDkxLjIzNzQsNzUuNzc5NCAxMDEuMzQ4OCw3Mi45NzQgIiBmaWxsPSJub25lIiBpZD0ic2xlZXAtYmFja3RvLWZpbmQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjYuMDUwOCw3NC4yNzMzLDc0LjI1MzEsNzkuNzI1Miw3MC45ODAxLDc1LjExMTMsNzUuNTkzOSw3MS44MzgzLDY2LjA1MDgsNzQuMjczMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHNsZWVwIHRvIGZpbmQtLT48ZyBpZD0ibGlua19zbGVlcF9maW5kIj48cGF0aCBkPSJNNjYuMDUwOCw1MC4zMjA0IEM3Ni4xNjIyLDQ4LjI1OTUgODYuMjczNiw0OC4yODk1IDk2LjM4NSw1MC40MTA1ICIgZmlsbD0ibm9uZSIgaWQ9InNsZWVwLXRvLWZpbmQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTAxLjM0ODgsNTEuNjE5OCw5My41NTEzLDQ1LjYwMzIsOTYuNDkwOSw1MC40MzYzLDkxLjY1NzgsNTMuMzc1OSwxMDEuMzQ4OCw1MS42MTk4IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bQXFmREJhZENJeXo5TEwxQW95bkJLTDk4QjVPMENSWUE0MUFmNVFkOU8wYUcwcmNZRTJTcmpHMGkwc1BuU1BMYWJlMzROc25lVmhmaHNWRWtSU3lRNmZ6c2ozX2hOUUo0bkdLb0xLNnRBM0N6ZXFKTjNjOEtZNTNHcEtiRDB1YzBST01nV1dmMUowTUoyOXFXNUcwMF0tLT48L2c+PC9zdmc+"><p>当有可运行的G存在时，调度模型始终在find与exec之间循环切换，直到无可运行G时，进入sleep状态，直到被唤醒。</p><h2 id="进入调度"><a href="#进入调度" class="headerlink" title="进入调度"></a>进入调度</h2><p>无论是进程启动执行(主线程执行)，还是执行过程中创建新的Worker M，执行流程最终都会进入到<code>runtime.mstart()</code>函数中，并按循序执行<code>runtime.mstart()</code> -&gt; <code>runtime.mstart0()</code> -&gt; <code>runtime.mstart1()</code>，最终进入到调度流程中。</p><h2 id="查找可运行G"><a href="#查找可运行G" class="headerlink" title="查找可运行G"></a>查找可运行G</h2><p><strong>每一个可运行的G都是一个待执行的任务</strong>。<br>函数<code>runtime.schedule()</code>作为调度流程的核心，主要负责执行<strong>查找任务</strong>和<strong>执行任务</strong>，其中查找任务的逻辑由<code>runtime.findRunnable()</code>函数来负责完成。<br>忽略与查找可运行G目标不相关的逻辑，可以将查找流程总结为如下几个步骤：</p><ol><li>第一次从全局队列中查找可运行G(每执行61次G，则从全局队列中获取一次)</li><li>从本地队列中查找可运行G</li><li>第二次从全局队列中查找可运行G</li><li>从netpoll中查找可运行G</li><li>从其他P中窃取可运行G</li></ol><p>以上几个步骤都执行完，依然没有查找到可运行的G时，则会进入无事可做的状态，代码里也是这么注释的！<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// We have nothing <span class="keyword">to</span> <span class="keyword">do</span>.</span><br></pre></td></tr></table></figure></p><p>在这种状态下，当前执行的Worker M会与P解绑，并进入休眠状态，但再此之前，还会进行一些其他工作，如：GC扫描。<br>在查找可运行G的流程中，简单说下1和4两个步骤。</p><p><strong>周期性从全局队列中获取G</strong>：根据注释与代码逻辑，这么做的主要目的是为了保证调度的公平性，假如本地队列一直有可运行的G存在，全局队列的G就会长期得不到运行机会。<br><strong>netpoll的G</strong>：当代码中存在网络访问时，负责连接读写的Goroutine就绪时，会被调度，这里后续章节再进一步分析。</p><p>最后的最后，调度流程就会将P解绑，并通过调用<code>runtime.stopm()</code>函数将M挂起，进入休眠状态。</p><h3 id="全局查找"><a href="#全局查找" class="headerlink" title="全局查找"></a>全局查找</h3><p>从全局队列中查找可运行的G，使用的是<code>runtime.globrunqget()</code>函数，因为是操作全局队列，所以调用该函数前，需要对<code>sched.lock</code>全局变量字段加锁。<br>该函数主要用于从全局队列中获取可运行G，根据实际情况，假如获取的数量是1，则直接返回获取到的G；假如获取的数量大于1，则返回其中一个G，并将其他获取到的G保存到本地队列。</p><p>函数原型：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">globrunqget</span><span class="params">(_p_ *p, <span class="built_in">max</span> int32)</span></span> *g</span><br></pre></td></tr></table></figure></p><p><code>max</code>参数用来限制从全局队列获取可运行G的数量。</p><p><strong>备注：第一次和第二次从全局队列中查找可运行的G最大的区别在于，第一次获取时<code>max</code>参数设置的是1，第二次设置的是0，所以第一次最多只会从全局队列中获取1个可运行G，并不会从全局队列中转移可运行的G到本地队列</strong></p><p>接下来，再看看这个函数的具体处理步骤：</p><p><strong>第一步</strong>：使用全局队列的长度 / P的最大数量 = 得到每一个P的平均负载值<code>n</code></p><p>这一步主要计算一个公平的，每一个P除了本地队列中的G之外，全局队列中自己还有多少G需要处理。</p><p><strong>第二步</strong>：计算出负载值<code>n</code>后，再计算本地队列的最大长度除以2，用来限制<code>n</code>的最大值<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> n &gt; <span class="keyword">int32</span>(<span class="built_in">len</span>(_p_.runq))/<span class="number">2</span> &#123;</span><br><span class="line">    n = <span class="keyword">int32</span>(<span class="built_in">len</span>(_p_.runq)) / <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>P中<code>runq</code>字段的结构定义如下，因此<code>n</code>的最大长度为128。<br><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> p struct &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">// <span class="type">Queue</span> of runnable goroutines. <span class="type">Accessed</span> without lock.</span><br><span class="line">runqhead uint32</span><br><span class="line">runqtail uint32</span><br><span class="line">runq     [256]guintptr</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>第三步</strong>：获取一个可运行的G作为返回值，并将<code>n</code>-1个可运行的G保存至本地队列P中</p><h3 id="窃取工作"><a href="#窃取工作" class="headerlink" title="窃取工作"></a>窃取工作</h3><p>当调度流程从哪里都找不到可运行的G时，作为专业打工人，会自觉地尝试从其他的P那找点可运行的G过来。<br>窃取可运行G的主要工作由<code>runtime.stealWork()</code>函数来负责，但这个函数的主要逻辑是在选择目标P，并在确认目标后，交给<code>runtime.runqsteal()</code>函数来完成实际的可运行G的转移。</p><h4 id="选择目标P"><a href="#选择目标P" class="headerlink" title="选择目标P"></a>选择目标P</h4><p>先来看看<code>runtime.stealWork()</code>函数是怎么选择目标P的吧。</p><ol><li>先是选择策略，这里采用的是<strong>随机起始位置，非连续性遍历所有P</strong>的方案，非连续性即为遍历完下标<code>i</code>之后，下一个遍历的下标并不是<code>i</code>+1，而是伪随机的其他位置，直到所有的P都遍历一次</li><li>再是重试机制，在选择策略之外包含一层循环逻辑，循环次数为固定值4，即重试4次</li></ol><h4 id="窃取半数G"><a href="#窃取半数G" class="headerlink" title="窃取半数G"></a>窃取半数G</h4><p>当确定了目标P之后，就会调用<code>runtime.runqsteal()</code>函数来进行实际的转移操作，该函数的内部还会调用另一个<code>runtime.runqgrab()</code>函数来实现半数转移，即<strong>将目标P一半的可运行G转移给当前P</strong>。</p><h2 id="执行可运行G"><a href="#执行可运行G" class="headerlink" title="执行可运行G"></a>执行可运行G</h2><p>现在调度流程中已经存在一个可运行的G了，接下来就需要调用<code>runtime.execute()</code>函数来执行它。<br>这段过程主要对G做一些字段更新，比如：将状态由<code>_Grunnable</code>切换成<code>_Grunning</code>，将G与M绑定等等，最后交给<code>runtime.gogo()</code>函数处理。</p><h2 id="让渡执行权"><a href="#让渡执行权" class="headerlink" title="让渡执行权"></a>让渡执行权</h2><p>当运行中的G因为各种原因，交出运行资源后，调度流程便会再次回到<code>runtime.schedule()</code>函数进入下一轮循环。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通过对M，P，G的简单介绍，我们大致上了解了这几种概念在Go语言运行机制中的基本作用&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;M封装操作系统的线程，提供运行资源&lt;/li&gt;
&lt;li&gt;P封装G运行过程中需要的辅助资源，并为G提供排队管理&lt;/li&gt;
&lt;li&gt;G封装运行上下文，提供运行用户代码的能力&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;三者协作，只要有源源不断可运行的G存在，M+P的组合就会不断地循环调度，直到没有可运行的G时，M与P解绑，并进入休眠状态。&lt;/p&gt;
&lt;img src=&quot;data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIxODJweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjUyNnB4O2hlaWdodDoxODJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA1MjYgMTgyIiB3aWR0aD0iNTI2cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM1IiB4PSIxODguNSIgeT0iMjIuOTk1MSI+5pys5Zyw6Zif5YiX5LiO5YWo5bGA6Zif5YiXPC90ZXh0PjwhLS1lbnRpdHkgcC0tPjxnIGlkPSJlbGVtX3AiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjI5OSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjMwOSIgeT0iNjcuMjkyIj5QPC90ZXh0PjwvZz48IS0tZW50aXR5IG0tLT48ZyBpZD0iZWxlbV9tIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjMyIiB4PSIyOTcuNSIgeT0iMTQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMiIgeD0iMzA3LjUiIHk9IjE2My4yOTIiPk08L3RleHQ+PC9nPjwhLS1lbnRpdHkgZzAtLT48ZyBpZD0iZWxlbV9nMCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzOCIgeD0iMzY0LjUiIHk9IjE0MC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgiIHg9IjM3NC41IiB5PSIxNjMuMjkyIj5nMDwvdGV4dD48L2c+PCEtLWVudGl0eSBnMS0tPjxnIGlkPSJlbGVtX2cxIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSIzNjMiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSIzNzMiIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnMi0tPjxnIGlkPSJlbGVtX2cyIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI0MjciIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSI0MzciIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnMy0tPjxnIGlkPSJlbGVtX2czIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI0OTEiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSI1MDEiIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnbG9iLS0+PGcgaWQ9ImVsZW1fZ2xvYiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSI2NCIgeD0iMTk5LjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI0NCIgeD0iMjA5LjUiIHk9IjY3LjI5MiI+Z2xvYmFsPC90ZXh0PjwvZz48IS0tZW50aXR5IGc0LS0+PGcgaWQ9ImVsZW1fZzQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjEzNSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjE0NSIgeT0iNjcuMjkyIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGc1LS0+PGcgaWQ9ImVsZW1fZzUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjcxIiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iODEiIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnNi0tPjxnIGlkPSJlbGVtX2c2Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iMTciIHk9IjY3LjI5MiI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSBnNy0tPjxnIGlkPSJlbGVtX2c3Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI3IiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjE3IiB5PSIxNjMuMjkyIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGc4LS0+PGcgaWQ9ImVsZW1fZzgiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjcxIiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjkiIHg9IjgxIiB5PSIxNjMuMjkyIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGc5LS0+PGcgaWQ9ImVsZW1fZzkiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjEzNSIgeT0iMTQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSIxNDUiIHk9IjE2My4yOTIiPmc8L3RleHQ+PC9nPjwhLS1saW5rIHAgdG8gZzEtLT48ZyBpZD0ibGlua19wX2cxIj48cGF0aCBkPSJNMzI4LjI1LDYyLjI5NjkgQzMzOS43OTMsNjIuMjk2OSAzNTEuMzM2LDYyLjI5NjkgMzYyLjg3OSw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9InAtZzEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Ny4wLDcuMDsiLz48L2c+PCEtLWxpbmsgZzEgdG8gZzItLT48ZyBpZD0ibGlua19nMV9nMiI+PHBhdGggZD0iTTM5Mi41LDYyLjI5NjkgQzQwMy45ODQsNjIuMjk2OSA0MTUuNDY5LDYyLjI5NjkgNDI2Ljk1Myw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9ImcxLWcyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZzIgdG8gZzMtLT48ZyBpZD0ibGlua19nMl9nMyI+PHBhdGggZD0iTTQ1Niw2Mi4yOTY5IEM0NjcuNjAyLDYyLjI5NjkgNDc5LjIwMyw2Mi4yOTY5IDQ5MC44MDUsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnMi1nMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHAgdG8gbS0tPjxnIGlkPSJsaW5rX3BfbSI+PHBhdGggZD0iTTMxMy41LDgwLjUzNzkgQzMxMy41LDk3LjQ5ODYgMzEzLjUsMTIzLjI0MjQgMzEzLjUsMTQwLjE2NTIgIiBmaWxsPSJub25lIiBpZD0icC1tIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgbSB0byBnMC0tPjxnIGlkPSJsaW5rX21fZzAiPjxwYXRoIGQ9Ik0zMjkuNjMzLDE1OC4yOTY5IEMzNDEuMTM2LDE1OC4yOTY5IDM1Mi42MzksMTU4LjI5NjkgMzY0LjE0MSwxNTguMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtLWcwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PC9nPjwhLS1saW5rIGc0IHRvIGdsb2ItLT48ZyBpZD0ibGlua19nNF9nbG9iIj48cGF0aCBkPSJNMTY0LjIzNCw2Mi4yOTY5IEMxNzUuOTcxLDYyLjI5NjkgMTg3LjcwNyw2Mi4yOTY5IDE5OS40NDQsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnNC1nbG9iIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PC9nPjwhLS1saW5rIGc1IHRvIGc0LS0+PGcgaWQ9ImxpbmtfZzVfZzQiPjxwYXRoIGQ9Ik0xMDAsNjIuMjk2OSBDMTExLjYwMiw2Mi4yOTY5IDEyMy4yMDMsNjIuMjk2OSAxMzQuODA1LDYyLjI5NjkgIiBmaWxsPSJub25lIiBpZD0iZzUtZzQiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnNiB0byBnNS0tPjxnIGlkPSJsaW5rX2c2X2c1Ij48cGF0aCBkPSJNMzYuNSw2Mi4yOTY5IEM0Ny45ODQ0LDYyLjI5NjkgNTkuNDY4OCw2Mi4yOTY5IDcwLjk1MzEsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnNi1nNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGc2IHRvIGc3LS0+PGcgaWQ9ImxpbmtfZzZfZzciPjxwYXRoIGQ9Ik0yMS41LDgwLjUzNzkgQzIxLjUsOTcuNDk4NiAyMS41LDEyMy4yNDI0IDIxLjUsMTQwLjE2NTIgIiBmaWxsPSJub25lIiBpZD0iZzYtZzciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnNyB0byBnOC0tPjxnIGlkPSJsaW5rX2c3X2c4Ij48cGF0aCBkPSJNMzYuNSwxNTguMjk2OSBDNDcuOTg0NCwxNTguMjk2OSA1OS40Njg4LDE1OC4yOTY5IDcwLjk1MzEsMTU4LjI5NjkgIiBmaWxsPSJub25lIiBpZD0iZzctZzgiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnOCB0byBnOS0tPjxnIGlkPSJsaW5rX2c4X2c5Ij48cGF0aCBkPSJNMTAwLDE1OC4yOTY5IEMxMTEuNjAyLDE1OC4yOTY5IDEyMy4yMDMsMTU4LjI5NjkgMTM0LjgwNSwxNTguMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnOC1nOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1TUkM9W1JUMngyaThtNTBSV19KbjV3NXhmX1Y4R1dnekdqSHVCd09LUVM3S0hkNW5yQUJXd0VFWmMwbmQxanAxZlFURDJqbG5WSld4eWdUQ0xJbWdhQUo0TTFhYnNmODlRcVJvYlY0bmVqT1JNMTNrcERVUGVwOEs5cWRBUHFFdjY3M05wZGlQeVpHS1EycEtNUUltNk8xY0p5NnFVbDdkLWhaVC1rZHBVUHR3eXl6VVhZbVAwSE1QY2RVNk1jUjhsc2NIODNnMlphWWo3cE5NdkJxcG5XVmRlYkdLV1VtZ1h3S1EyMS1ZSEZsWTBfWDAybUExVjhmZldnRlA3Vzk1QXlIeTBdLS0+PC9nPjwvc3ZnPg==&quot;&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="golang" scheme="https://oldchan.net/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Golang深度解读：P</title>
    <link href="https://oldchan.net/2022/08/15/notes/golang/advanced/p/"/>
    <id>https://oldchan.net/2022/08/15/notes/golang/advanced/p/</id>
    <published>2022-08-15T02:20:24.000Z</published>
    <updated>2023-01-14T03:18:55.095Z</updated>
    
    <content type="html"><![CDATA[<p>通常，在各种技术文章中，P都是被定义成Processor，处理器？那么，Go定义的处理器与操作系统的处理器可以等价理解吗？两者具有相似的概念，但实现原理不同，<strong>系统线程</strong>基于<strong>CPU(操作系统的处理器)</strong>运行，Go定义的<strong>M</strong>基于<strong>系统线程</strong>创建，<strong>P(Processor)</strong>基于<strong>M</strong>运行。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIzMzdweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjI0M3B4O2hlaWdodDozMzdweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyNDMgMzM3IiB3aWR0aD0iMjQzcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IHAtLT48ZyBpZD0iZWxlbV9wIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSIxNi41IiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iMjYuNSIgeT0iMjkuOTk1MSI+UDwvdGV4dD48L2c+PCEtLWVudGl0eSBtLS0+PGcgaWQ9ImVsZW1fbSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzMiIgeD0iMTUiIHk9IjEwMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyIiB4PSIyNSIgeT0iMTI1Ljk5NTEiPk08L3RleHQ+PC9nPjwhLS1lbnRpdHkgZzAtLT48ZyBpZD0iZWxlbV9nMCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzOCIgeD0iODIiIHk9IjEwMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4IiB4PSI5MiIgeT0iMTI1Ljk5NTEiPmcwPC90ZXh0PjwvZz48IS0tZW50aXR5IGcxLS0+PGcgaWQ9ImVsZW1fZzEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjgwLjUiIHk9IjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSI5MC41IiB5PSIyOS45OTUxIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGcyLS0+PGcgaWQ9ImVsZW1fZzIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjE0NC41IiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iMTU0LjUiIHk9IjI5Ljk5NTEiPmc8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZzMtLT48ZyBpZD0iZWxlbV9nMyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIyOSIgeD0iMjA4LjUiIHk9IjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSIyMTguNSIgeT0iMjkuOTk1MSI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSB0aHJlYWQtLT48ZyBpZD0iZWxlbV90aHJlYWQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjciIHk9IjE5OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI4IiB4PSIxNyIgeT0iMjIxLjk5NTEiPue6v+eoizwvdGV4dD48L2c+PCEtLWVudGl0eSBjcHUtLT48ZyBpZD0iZWxlbV9jcHUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjciIHk9IjI5NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI4IiB4PSIxNyIgeT0iMzE3Ljk5NTEiPkNQVTwvdGV4dD48L2c+PCEtLWxpbmsgcCB0byBnMS0tPjxnIGlkPSJsaW5rX3BfZzEiPjxwYXRoIGQ9Ik00NS43NSwyNSBDNTcuMjkzLDI1IDY4LjgzNTksMjUgODAuMzc4OSwyNSAiIGZpbGw9Im5vbmUiIGlkPSJwLWcxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PC9nPjwhLS1saW5rIGcxIHRvIGcyLS0+PGcgaWQ9ImxpbmtfZzFfZzIiPjxwYXRoIGQ9Ik0xMTAsMjUgQzEyMS40ODQsMjUgMTMyLjk2OSwyNSAxNDQuNDUzLDI1ICIgZmlsbD0ibm9uZSIgaWQ9ImcxLWcyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZzIgdG8gZzMtLT48ZyBpZD0ibGlua19nMl9nMyI+PHBhdGggZD0iTTE3My41LDI1IEMxODUuMTAyLDI1IDE5Ni43MDMsMjUgMjA4LjMwNSwyNSAiIGZpbGw9Im5vbmUiIGlkPSJnMi1nMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHAgdG8gbS0tPjxnIGlkPSJsaW5rX3BfbSI+PHBhdGggZD0iTTMxLDQzLjI0MSBDMzEsNjAuMjAyIDMxLDg1Ljk0NSAzMSwxMDIuODY4ICIgZmlsbD0ibm9uZSIgaWQ9InAtbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIG0gdG8gZzAtLT48ZyBpZD0ibGlua19tX2cwIj48cGF0aCBkPSJNNDcuMTMyOCwxMjEgQzU4LjYzNTcsMTIxIDcwLjEzODYsMTIxIDgxLjY0MTUsMTIxICIgZmlsbD0ibm9uZSIgaWQ9Im0tZzAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Ny4wLDcuMDsiLz48L2c+PCEtLWxpbmsgbSB0byB0aHJlYWQtLT48ZyBpZD0ibGlua19tX3RocmVhZCI+PHBhdGggZD0iTTMxLDEzOS4yNDEgQzMxLDE1Ni4yMDIgMzEsMTgxLjk0NSAzMSwxOTguODY4ICIgZmlsbD0ibm9uZSIgaWQ9Im0tdGhyZWFkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgdGhyZWFkIHRvIGNwdS0tPjxnIGlkPSJsaW5rX3RocmVhZF9jcHUiPjxwYXRoIGQ9Ik0zMSwyMzUuMjQxIEMzMSwyNTIuMjAxNyAzMSwyNzcuOTQ1NSAzMSwyOTQuODY4MyAiIGZpbGw9Im5vbmUiIGlkPSJ0aHJlYWQtY3B1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bQXFmREJhZENJeXo5TEwwQUs1OThCNU9ldTJmMjJGYzJYTkFIWFQ4RG02QmYxWVkyNDM1M0I2OTZNQ0lDYVNNVXh6aF9WNEt0TUE4YWVvV3JDR0xQcVphVzUyb0pONTNBbkxNSU1HOElLLUJZQWIzR3FvdEFKQ3llcUdMUGNjd2UwRVNQU1FLUjhOWjY4QU13QVZkYlVSZjBOLUdZd0pCVzBkQVhDYjFoOEhIQzQ2V1owMDAwXS0tPjwvZz48L3N2Zz4="><p>当执行编写的Go代码时，Go会将运行上下文封装成G，等待运行的G会在P中排队，协程调度时，从P中获取到可运行的G，g0再将执行权让渡给G，然后进入用户代码逻辑。</p><a id="more"></a><h2 id="P与G"><a href="#P与G" class="headerlink" title="P与G"></a>P与G</h2><p>可运行G通过队列的方式保存于P中，P维护一份最大长度为256的本地队列，已退出的G也会保存到P中，待创建新的G时再次使用。</p><h3 id="G的创建"><a href="#G的创建" class="headerlink" title="G的创建"></a>G的创建</h3><p>G的创建采用<code>go</code>关键字实现。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 代码逻辑</span></span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>在编译过程中会将<code>go</code>关键字的操作，转换成调用<code>runtime.newproc()</code>函数的逻辑，然后通过<code>runtime.newproc1()</code>函数创建并初始化<code>g</code>结构，再回到<code>runtime.newproc()</code>函数，通过调用<code>runtime.runqput()</code>函数将新创建的G保存至本地队列中。</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a new g running fn.</span></span><br><span class="line"><span class="comment">// Put it on the queue of g's waiting to run.</span></span><br><span class="line"><span class="comment">// The compiler turns a go statement into a call to this.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newproc</span><span class="params">(fn *funcval)</span></span> &#123;</span><br><span class="line">gp := getg()</span><br><span class="line">pc := getcallerpc()</span><br><span class="line">systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">newg := newproc1(fn, gp, pc)</span><br><span class="line"></span><br><span class="line">_p_ := getg().m.p.ptr()</span><br><span class="line">runqput(_p_, newg, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> mainStarted &#123;</span><br><span class="line">wakep()</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>备注：采用<code>go</code>关键字创建的G，会直接保存在本地队列中，并设置成下一个G，等待调度</strong></p><h2 id="P与M"><a href="#P与M" class="headerlink" title="P与M"></a>P与M</h2><p>P提供了各种运行G所需要的辅助资源，为可运行G提供了队列服务，但只有P又无法处理这些可运行的G，所以P还需要与M进行绑定，形成M+P的组合，由M提供运行资源，这样才能保证可运行G的顺利执行。</p><p>与P形成绑定关系的M都是Worker M，要启动一个Worker M，通常需要先找到一个可用的P(<strong>空闲的P或非空闲的P绑定到新的M</strong>)，将P与M进行绑定，之后M才能进入调度状态。<br><strong>调度过程中，可以通过<code>runtime.startm()</code>函数启动M，当存在空闲中的M时(休眠状态)，则唤醒休眠中的M，如果没有空闲的M，则需要创建新的M</strong></p><h2 id="m0-g0-p0"><a href="#m0-g0-p0" class="headerlink" title="m0/g0/p0"></a>m0/g0/p0</h2><p>Go内核中有两个特殊的变量<code>m0</code>与<code>g0</code>，定义在<code>src/runtime/proc.go</code>文件中，进程在启动后，主线程会从程序的入口开始执行，这是进程中的第一个线程，而基于第一个线程创建的M就是<code>m0</code>，因此在Go内核初始化过程中，会将第一个线程的运行环境保存到<code>m0</code>中，而相对的创建M时需要分配<code>g0</code>的操作，在<code>m0</code>这里，直接使用的全局变量<code>g0</code>。</p><p>在一系列的初始化过程中，会执行到<code>runtime.schedinit()</code>函数，而函数内部又会初始化一次P的数量，主要通过<code>runtime.procresize()</code>函数来实现，该函数内，又会判断当前M是否绑定P，如果没有绑定，则将<code>allp[0]</code>中的P与M进行绑定，其中全局变量<code>allp</code>保存着所有P的指针地址。</p><h2 id="P的数量"><a href="#P的数量" class="headerlink" title="P的数量"></a>P的数量</h2><p>P的数量一般都会设置成与CPU核数相等，Go内核在启动时会自动初始化。<br>在<code>runtime.osinit()</code>函数中获取当前操作系统的CPU核数，并在<code>runtime.schedinit()</code>函数中进行P初始化设置，同时在设置之前，会尝试读取环境变量<code>GOMAXPROCS</code>来覆盖CPU核数。</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">runtime</span>.osinit() <span class="comment">// 获取CPU核数</span></span><br><span class="line"><span class="keyword">runtime</span>.schedinit()</span><br></pre></td></tr></table></figure><p>除此之外，还可以在开发过程中，通过<code>runtime.GOMAXPROCS()</code>函数对P的数量进行设置。</p><h2 id="P的职责"><a href="#P的职责" class="headerlink" title="P的职责"></a>P的职责</h2><p>通过P结构体的定义与Go内核调度逻辑可见，P的核心工作是在调度中维护G与M的使用关系，一般情况下，G只有在P中排队，才能合理的使用到M的运行资源。<br>P负责维护一份可运行G的队列，另外还会维护一份已退出G的队列(状态为Gdead的协程)，除此之外，还会维护G在运行过程中需要分配的内存，defer结构等等，不同的细节在后续章节中再深入分析。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通常，在各种技术文章中，P都是被定义成Processor，处理器？那么，Go定义的处理器与操作系统的处理器可以等价理解吗？两者具有相似的概念，但实现原理不同，&lt;strong&gt;系统线程&lt;/strong&gt;基于&lt;strong&gt;CPU(操作系统的处理器)&lt;/strong&gt;运行，Go定义的&lt;strong&gt;M&lt;/strong&gt;基于&lt;strong&gt;系统线程&lt;/strong&gt;创建，&lt;strong&gt;P(Processor)&lt;/strong&gt;基于&lt;strong&gt;M&lt;/strong&gt;运行。&lt;/p&gt;
&lt;img src=&quot;data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIzMzdweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjI0M3B4O2hlaWdodDozMzdweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyNDMgMzM3IiB3aWR0aD0iMjQzcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IHAtLT48ZyBpZD0iZWxlbV9wIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSIxNi41IiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iMjYuNSIgeT0iMjkuOTk1MSI+UDwvdGV4dD48L2c+PCEtLWVudGl0eSBtLS0+PGcgaWQ9ImVsZW1fbSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzMiIgeD0iMTUiIHk9IjEwMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyIiB4PSIyNSIgeT0iMTI1Ljk5NTEiPk08L3RleHQ+PC9nPjwhLS1lbnRpdHkgZzAtLT48ZyBpZD0iZWxlbV9nMCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzOCIgeD0iODIiIHk9IjEwMyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4IiB4PSI5MiIgeT0iMTI1Ljk5NTEiPmcwPC90ZXh0PjwvZz48IS0tZW50aXR5IGcxLS0+PGcgaWQ9ImVsZW1fZzEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjgwLjUiIHk9IjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSI5MC41IiB5PSIyOS45OTUxIj5nPC90ZXh0PjwvZz48IS0tZW50aXR5IGcyLS0+PGcgaWQ9ImVsZW1fZzIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMjkiIHg9IjE0NC41IiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iMTU0LjUiIHk9IjI5Ljk5NTEiPmc8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZzMtLT48ZyBpZD0iZWxlbV9nMyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIyOSIgeD0iMjA4LjUiIHk9IjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSI5IiB4PSIyMTguNSIgeT0iMjkuOTk1MSI+ZzwvdGV4dD48L2c+PCEtLWVudGl0eSB0aHJlYWQtLT48ZyBpZD0iZWxlbV90aHJlYWQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjciIHk9IjE5OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI4IiB4PSIxNyIgeT0iMjIxLjk5NTEiPue6v+eoizwvdGV4dD48L2c+PCEtLWVudGl0eSBjcHUtLT48ZyBpZD0iZWxlbV9jcHUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjciIHk9IjI5NSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI4IiB4PSIxNyIgeT0iMzE3Ljk5NTEiPkNQVTwvdGV4dD48L2c+PCEtLWxpbmsgcCB0byBnMS0tPjxnIGlkPSJsaW5rX3BfZzEiPjxwYXRoIGQ9Ik00NS43NSwyNSBDNTcuMjkzLDI1IDY4LjgzNTksMjUgODAuMzc4OSwyNSAiIGZpbGw9Im5vbmUiIGlkPSJwLWcxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PC9nPjwhLS1saW5rIGcxIHRvIGcyLS0+PGcgaWQ9ImxpbmtfZzFfZzIiPjxwYXRoIGQ9Ik0xMTAsMjUgQzEyMS40ODQsMjUgMTMyLjk2OSwyNSAxNDQuNDUzLDI1ICIgZmlsbD0ibm9uZSIgaWQ9ImcxLWcyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZzIgdG8gZzMtLT48ZyBpZD0ibGlua19nMl9nMyI+PHBhdGggZD0iTTE3My41LDI1IEMxODUuMTAyLDI1IDE5Ni43MDMsMjUgMjA4LjMwNSwyNSAiIGZpbGw9Im5vbmUiIGlkPSJnMi1nMyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIHAgdG8gbS0tPjxnIGlkPSJsaW5rX3BfbSI+PHBhdGggZD0iTTMxLDQzLjI0MSBDMzEsNjAuMjAyIDMxLDg1Ljk0NSAzMSwxMDIuODY4ICIgZmlsbD0ibm9uZSIgaWQ9InAtbSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIG0gdG8gZzAtLT48ZyBpZD0ibGlua19tX2cwIj48cGF0aCBkPSJNNDcuMTMyOCwxMjEgQzU4LjYzNTcsMTIxIDcwLjEzODYsMTIxIDgxLjY0MTUsMTIxICIgZmlsbD0ibm9uZSIgaWQ9Im0tZzAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Ny4wLDcuMDsiLz48L2c+PCEtLWxpbmsgbSB0byB0aHJlYWQtLT48ZyBpZD0ibGlua19tX3RocmVhZCI+PHBhdGggZD0iTTMxLDEzOS4yNDEgQzMxLDE1Ni4yMDIgMzEsMTgxLjk0NSAzMSwxOTguODY4ICIgZmlsbD0ibm9uZSIgaWQ9Im0tdGhyZWFkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgdGhyZWFkIHRvIGNwdS0tPjxnIGlkPSJsaW5rX3RocmVhZF9jcHUiPjxwYXRoIGQ9Ik0zMSwyMzUuMjQxIEMzMSwyNTIuMjAxNyAzMSwyNzcuOTQ1NSAzMSwyOTQuODY4MyAiIGZpbGw9Im5vbmUiIGlkPSJ0aHJlYWQtY3B1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bQXFmREJhZENJeXo5TEwwQUs1OThCNU9ldTJmMjJGYzJYTkFIWFQ4RG02QmYxWVkyNDM1M0I2OTZNQ0lDYVNNVXh6aF9WNEt0TUE4YWVvV3JDR0xQcVphVzUyb0pONTNBbkxNSU1HOElLLUJZQWIzR3FvdEFKQ3llcUdMUGNjd2UwRVNQU1FLUjhOWjY4QU13QVZkYlVSZjBOLUdZd0pCVzBkQVhDYjFoOEhIQzQ2V1owMDAwXS0tPjwvZz48L3N2Zz4=&quot;&gt;
&lt;p&gt;当执行编写的Go代码时，Go会将运行上下文封装成G，等待运行的G会在P中排队，协程调度时，从P中获取到可运行的G，g0再将执行权让渡给G，然后进入用户代码逻辑。&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="golang" scheme="https://oldchan.net/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Golang深度解读：M</title>
    <link href="https://oldchan.net/2022/07/24/notes/golang/advanced/m/"/>
    <id>https://oldchan.net/2022/07/24/notes/golang/advanced/m/</id>
    <published>2022-07-24T05:20:24.000Z</published>
    <updated>2022-07-25T05:25:14.813Z</updated>
    
    <content type="html"><![CDATA[<p>Go语言将线程抽象成M(Machine)，每个M都是可以独立运行的单元，M的数据结构中主要包含的是跟系统环境相关的字段。</p><p>Go语言将可执行的上下文保存在G(Goroutine)中，G的数据结构中主要包含跟执行环境相关的字段，包括寄存器值，栈地址、defer，panic的指针等等。</p><p>在<a href="/2022/07/10/notes/golang/advanced/g0/">《Golang深度解读：g0》</a>中，简单讲述了g0的基本信息和在调度中所负责的工作。最先了解g0，主要原因是g0才是真正意义上在线程上运行的逻辑，M在创建之后，系统环境相关的数据保存在M中，线程的执行数据保存在g0中，g0与普通用户协程共用相同的数据结构和计算逻辑，只是在内核调度过程中，需要区分g0与用户协程的部分边界。</p><a id="more"></a><h2 id="worker-m"><a href="#worker-m" class="headerlink" title="worker m"></a>worker m</h2><p>Go语言程序在执行过程中会创建多个M，但并不跟P的数量完全匹配，跟P绑定使用的M一般视为Worker Thread(为了统一概念，后面统一称Worker M)，即用户计算逻辑能使用到的线程，P数量的设置也直接影响用户协程的并行执行能力，关于P数量的设置可参考<code>runtime.GOMAXPROCS()</code>。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIxODJweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjY1MHB4O2hlaWdodDoxODJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA2NTAgMTgyIiB3aWR0aD0iNjUwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjExIiB4PSIyMTIuNzUiIHk9IjIyLjk5NTEiPueyvueugOeJiFdvcmtlciBN5bi46KeE5Yib5bu65rWB56iLPC90ZXh0PjwhLS1lbnRpdHkgd2FrZXAtLT48ZyBpZD0iZWxlbV93YWtlcCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMjkiIHg9IjciIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDkiIHg9IjE3IiB5PSI2Ny4yOTIiPnJ1bnRpbWUud2FrZXA8L3RleHQ+PC9nPjwhLS1lbnRpdHkgc3RhcnRtLS0+PGcgaWQ9ImVsZW1fc3RhcnRtIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEzMSIgeD0iMTcxIiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExIiB4PSIxODEiIHk9IjY3LjI5MiI+cnVudGltZS5zdGFydG08L3RleHQ+PC9nPjwhLS1lbnRpdHkgbmV3bS0tPjxnIGlkPSJlbGVtX25ld20iPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTI1IiB4PSIzMzciIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDUiIHg9IjM0NyIgeT0iNjcuMjkyIj5ydW50aW1lLm5ld208L3RleHQ+PC9nPjwhLS1lbnRpdHkgbmV3bTEtLT48ZyBpZD0iZWxlbV9uZXdtMSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzQiIHg9IjQ5Ny41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTE0IiB4PSI1MDcuNSIgeT0iNjcuMjkyIj5ydW50aW1lLm5ld20xPC90ZXh0PjwvZz48IS0tZW50aXR5IG5ld29zcHJvYy0tPjxnIGlkPSJlbGVtX25ld29zcHJvYyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNjAiIHg9IjQ4NC41IiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE0MCIgeD0iNDk0LjUiIHk9IjE2My4yOTIiPnJ1bnRpbWUubmV3b3Nwcm9jPC90ZXh0PjwvZz48IS0tZW50aXR5IHB0aHJlYWRfY3JlYXRlLS0+PGcgaWQ9ImVsZW1fcHRocmVhZF9jcmVhdGUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTMyIiB4PSIzMTcuNSIgeT0iMTQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTIiIHg9IjMyNy41IiB5PSIxNjMuMjkyIj5wdGhyZWFkX2NyZWF0ZTwvdGV4dD48L2c+PCEtLWVudGl0eSBtc3RhcnQtLT48ZyBpZD0iZWxlbV9tc3RhcnQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTMxIiB4PSIxNTEiIHk9IjE0MC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExIiB4PSIxNjEiIHk9IjE2My4yOTIiPnJ1bnRpbWUubXN0YXJ0PC90ZXh0PjwvZz48IS0tbGluayB3YWtlcCB0byBzdGFydG0tLT48ZyBpZD0ibGlua193YWtlcF9zdGFydG0iPjxwYXRoIGQ9Ik0xMzYuMjc1LDYyLjI5NjkgQzE0Ni4wNTUsNjIuMjk2OSAxNTUuODM0LDYyLjI5NjkgMTY1LjYxNCw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Indha2VwLXRvLXN0YXJ0bSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNzAuNzI4LDYyLjI5NjksMTYxLjcyOCw1OC4yOTY5LDE2NS43MjgsNjIuMjk2OSwxNjEuNzI4LDY2LjI5NjksMTcwLjcyOCw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgc3RhcnRtIHRvIG5ld20tLT48ZyBpZD0ibGlua19zdGFydG1fbmV3bSI+PHBhdGggZD0iTTMwMi4wODIsNjIuMjk2OSBDMzExLjkxMiw2Mi4yOTY5IDMyMS43NDEsNjIuMjk2OSAzMzEuNTcxLDYyLjI5NjkgIiBmaWxsPSJub25lIiBpZD0ic3RhcnRtLXRvLW5ld20iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzM2LjcxMSw2Mi4yOTY5LDMyNy43MTEsNTguMjk2OSwzMzEuNzExLDYyLjI5NjksMzI3LjcxMSw2Ni4yOTY5LDMzNi43MTEsNjIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIG5ld20gdG8gbmV3bTEtLT48ZyBpZD0ibGlua19uZXdtX25ld20xIj48cGF0aCBkPSJNNDYyLjAyLDYyLjI5NjkgQzQ3Mi4wMTksNjIuMjk2OSA0ODIuMDE5LDYyLjI5NjkgNDkyLjAxOCw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Im5ld20tdG8tbmV3bTEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDk3LjI0Nyw2Mi4yOTY5LDQ4OC4yNDcsNTguMjk2OSw0OTIuMjQ3LDYyLjI5NjksNDg4LjI0Nyw2Ni4yOTY5LDQ5Ny4yNDcsNjIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIG5ld20xIHRvIG5ld29zcHJvYy0tPjxnIGlkPSJsaW5rX25ld20xX25ld29zcHJvYyI+PHBhdGggZD0iTTU2NC41LDgwLjUzNzkgQzU2NC41LDk1Ljc3NiA1NjQuNSwxMTguMTAzOCA1NjQuNSwxMzQuNzU0NSAiIGZpbGw9Im5vbmUiIGlkPSJuZXdtMS10by1uZXdvc3Byb2MiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTY0LjUsMTQwLjE2NTIsNTY4LjUsMTMxLjE2NTIsNTY0LjUsMTM1LjE2NTIsNTYwLjUsMTMxLjE2NTIsNTY0LjUsMTQwLjE2NTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIHB0aHJlYWRfY3JlYXRlIHRvIG5ld29zcHJvYy0tPjxnIGlkPSJsaW5rX3B0aHJlYWRfY3JlYXRlX25ld29zcHJvYyI+PHBhdGggZD0iTTQ1NC43MzcsMTU4LjI5NjkgQzQ2NC41NDYsMTU4LjI5NjkgNDc0LjM1NiwxNTguMjk2OSA0ODQuMTY1LDE1OC4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9InB0aHJlYWRfY3JlYXRlLWJhY2t0by1uZXdvc3Byb2MiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDQ5LjYwNywxNTguMjk2OSw0NTguNjA3LDE2Mi4yOTY5LDQ1NC42MDcsMTU4LjI5NjksNDU4LjYwNywxNTQuMjk2OSw0NDkuNjA3LDE1OC4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLXJldmVyc2UgbGluayBtc3RhcnQgdG8gcHRocmVhZF9jcmVhdGUtLT48ZyBpZD0ibGlua19tc3RhcnRfcHRocmVhZF9jcmVhdGUiPjxwYXRoIGQ9Ik0yODcuMjk1LDE1OC4yOTY5IEMyOTcuMzA2LDE1OC4yOTY5IDMwNy4zMTYsMTU4LjI5NjkgMzE3LjMyNywxNTguMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtc3RhcnQtYmFja3RvLXB0aHJlYWRfY3JlYXRlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI4Mi4wNjEsMTU4LjI5NjksMjkxLjA2MSwxNjIuMjk2OSwyODcuMDYxLDE1OC4yOTY5LDI5MS4wNjEsMTU0LjI5NjksMjgyLjA2MSwxNTguMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1TUkM9W0FxZkRCYWRDSXl6OUxMMGdBaXFob1NuRHJJakZwNHVqSzU5OEI1TzBpeFlBQzlLS2JvR01iVUkycksyT3MxSmJmUFAzYjgwT2sxR09tYktPdWIySU5ybkdiOXlDS21SWDhJaWpBQ2FlSWFyQ1lLeTZhWU1mTzdNZUdqWkNwR0t4NndtT21rSllBaWFpMFFidWxjZFZ5dEtEcHBpeG1sRUJpYkVCNTdvVnhqWm5PZGRCcXV4UEp0VmxVaFFyeVZjQVJZS2tCZDM4QTQyMFJiNWNVYVE5aFhxaUEyMEtjWG11MzQyNFdXOE02S0VtYjI1Q0FZTV9GMHlZMF9La2QwTEphUEVRMWpBQnZiNUtCYm1MbjhTMF0tLT48L2c+PC9zdmc+"><p>Worker M的启动通常由<code>runtime.wakep()</code>开始，在执行<code>runtime.startm()</code>时，需要获取空闲状态的P和空闲状态的M，如果没有空闲状态的P，则不会继续创建流程，而如果没有空闲状态的M，则会执行<code>runtime.newm()</code>创建新的M。</p><p>M结构的内存分配与g0的初始化就在<code>runtime.newm()</code>中进行，函数<code>runtime.newosproc()</code>是Go抽象出来的统一接口，主要用来创建系统线程，通过条件编译的方式，在不同的平台上有不同的实现方式，如：darwin上底层执行的是<code>pthread_create</code>系统接口创建线程，而在windows上执行的是<code>CreateThread</code>系统接口，创建线程的同时，会将已经初始化完成的M结构的指针传递到对应的创建线程的系统接口中，由线程的启动回调负责在新线程中做后续的处理，直到流程执行至<code>runtime.mstart()</code>，新M的执行流程参考<a href="/2022/07/10/notes/golang/advanced/g0/">《Golang深度解读：g0》</a>。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyNzhweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjg1MHB4O2hlaWdodDoyNzhweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA4NTAgMjc4IiB3aWR0aD0iODUwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSIzNTguMjUiIHk9IjIyLjk5NTEiPueyvueugOeJiOiwg+W6pua1geeoi+WbvjwvdGV4dD48IS0tZW50aXR5IG1zdGFydC0tPjxnIGlkPSJlbGVtX21zdGFydCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzEiIHg9IjciIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTEiIHg9IjE3IiB5PSI2Ny4yOTIiPnJ1bnRpbWUubXN0YXJ0PC90ZXh0PjwvZz48IS0tZW50aXR5IG1zdGFydDAtLT48ZyBpZD0iZWxlbV9tc3RhcnQwIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE0MCIgeD0iMTczLjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAiIHg9IjE4My41IiB5PSI2Ny4yOTIiPnJ1bnRpbWUubXN0YXJ0MDwvdGV4dD48L2c+PCEtLWVudGl0eSBtc3RhcnQxLS0+PGcgaWQ9ImVsZW1fbXN0YXJ0MSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDAiIHg9IjM0OC41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSIzNTguNSIgeT0iNjcuMjkyIj5ydW50aW1lLm1zdGFydDE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgc2NoZWR1bGUtLT48ZyBpZD0iZWxlbV9zY2hlZHVsZSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDUiIHg9IjUyNCIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyNSIgeD0iNTM0IiB5PSI2Ny4yOTIiPnJ1bnRpbWUuc2NoZWR1bGU8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZXhlY3V0ZS0tPjxnIGlkPSJlbGVtX2V4ZWN1dGUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSI3MDQuNSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMCIgeD0iNzE0LjUiIHk9IjY3LjI5MiI+cnVudGltZS5leGVjdXRlPC90ZXh0PjwvZz48IS0tZW50aXR5IGdvZ28tLT48ZyBpZD0iZWxlbV9nb2dvIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjExOCIgeD0iNzE0LjUiIHk9IjE0MC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOTgiIHg9IjcyNC41IiB5PSIxNjMuMjkyIj5ydW50aW1lLmdvZ288L3RleHQ+PC9nPjwhLS1lbnRpdHkgbG9naWNhbC0tPjxnIGlkPSJlbGVtX2xvZ2ljYWwiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTMyIiB4PSI3MDcuNSIgeT0iMjM2LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMTIiIHg9IjcxNy41IiB5PSIyNTkuMjkyIj7nlKjmiLfku6PnoIHpgLvovpHpg6jliIY8L3RleHQ+PC9nPjwhLS1lbnRpdHkgR29zY2hlZC0tPjxnIGlkPSJlbGVtX0dvc2NoZWQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQ0IiB4PSI1MjcuNSIgeT0iMjM2LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjQiIHg9IjUzNy41IiB5PSIyNTkuMjkyIj5ydW50aW1lLkdvc2NoZWQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbWNhbGwtLT48ZyBpZD0iZWxlbV9tY2FsbCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMjAiIHg9IjUzOC41IiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEwMCIgeD0iNTQ4LjUiIHk9IjE2My4yOTIiPnJ1bnRpbWUubWNhbGw8L3RleHQ+PC9nPjwhLS1saW5rIG1zdGFydCB0byBtc3RhcnQwLS0+PGcgaWQ9ImxpbmtfbXN0YXJ0X21zdGFydDAiPjxwYXRoIGQ9Ik0xMzguMjk1LDYyLjI5NjkgQzE0OC4yMSw2Mi4yOTY5IDE1OC4xMjYsNjIuMjk2OSAxNjguMDQxLDYyLjI5NjkgIiBmaWxsPSJub25lIiBpZD0ibXN0YXJ0LXRvLW1zdGFydDAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTczLjIyNiw2Mi4yOTY5LDE2NC4yMjYsNTguMjk2OSwxNjguMjI2LDYyLjI5NjksMTY0LjIyNiw2Ni4yOTY5LDE3My4yMjYsNjIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIG1zdGFydDAgdG8gbXN0YXJ0MS0tPjxnIGlkPSJsaW5rX21zdGFydDBfbXN0YXJ0MSI+PHBhdGggZD0iTTMxMy41NjgsNjIuMjk2OSBDMzIzLjQ1OCw2Mi4yOTY5IDMzMy4zNDgsNjIuMjk2OSAzNDMuMjM3LDYyLjI5NjkgIiBmaWxsPSJub25lIiBpZD0ibXN0YXJ0MC10by1tc3RhcnQxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjM0OC40MDksNjIuMjk2OSwzMzkuNDA5LDU4LjI5NjksMzQzLjQwOSw2Mi4yOTY5LDMzOS40MDksNjYuMjk2OSwzNDguNDA5LDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBtc3RhcnQxIHRvIHNjaGVkdWxlLS0+PGcgaWQ9ImxpbmtfbXN0YXJ0MV9zY2hlZHVsZSI+PHBhdGggZD0iTTQ4OC43MjcsNjIuMjk2OSBDNDk4LjY0NSw2Mi4yOTY5IDUwOC41NjQsNjIuMjk2OSA1MTguNDgyLDYyLjI5NjkgIiBmaWxsPSJub25lIiBpZD0ibXN0YXJ0MS10by1zY2hlZHVsZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1MjMuNjY5LDYyLjI5NjksNTE0LjY2OSw1OC4yOTY5LDUxOC42NjksNjIuMjk2OSw1MTQuNjY5LDY2LjI5NjksNTIzLjY2OSw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgc2NoZWR1bGUgdG8gZXhlY3V0ZS0tPjxnIGlkPSJsaW5rX3NjaGVkdWxlX2V4ZWN1dGUiPjxwYXRoIGQ9Ik02NjkuMTYsNjIuMjk2OSBDNjc5LjA4OCw2Mi4yOTY5IDY4OS4wMTYsNjIuMjk2OSA2OTguOTQ1LDYyLjI5NjkgIiBmaWxsPSJub25lIiBpZD0ic2NoZWR1bGUtdG8tZXhlY3V0ZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MDQuMTM2LDYyLjI5NjksNjk1LjEzNiw1OC4yOTY5LDY5OS4xMzYsNjIuMjk2OSw2OTUuMTM2LDY2LjI5NjksNzA0LjEzNiw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZXhlY3V0ZSB0byBnb2dvLS0+PGcgaWQ9ImxpbmtfZXhlY3V0ZV9nb2dvIj48cGF0aCBkPSJNNzc0LjMxNyw4MC41Mzc5IEM3NzQuMTU0LDk1Ljc3NTkgNzczLjkxNywxMTguMTAzOSA3NzMuNzQsMTM0Ljc1NDkgIiBmaWxsPSJub25lIiBpZD0iZXhlY3V0ZS10by1nb2dvIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9Ijc3My42ODIsMTQwLjE2NDksNzc3Ljc3NjksMTMxLjIwNzcsNzczLjczNDksMTM1LjE2NTIsNzY5Ljc3NzQsMTMxLjEyMzEsNzczLjY4MiwxNDAuMTY0OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGdvZ28gdG8gbG9naWNhbC0tPjxnIGlkPSJsaW5rX2dvZ29fbG9naWNhbCI+PHBhdGggZD0iTTc3My41LDE3Ni41Mzc5IEM3NzMuNSwxOTEuNzc2IDc3My41LDIxNC4xMDM4IDc3My41LDIzMC43NTQ1ICIgZmlsbD0ibm9uZSIgaWQ9ImdvZ28tdG8tbG9naWNhbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3NzMuNSwyMzYuMTY1Miw3NzcuNSwyMjcuMTY1Miw3NzMuNSwyMzEuMTY1Miw3NjkuNSwyMjcuMTY1Miw3NzMuNSwyMzYuMTY1MiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgR29zY2hlZCB0byBsb2dpY2FsLS0+PGcgaWQ9ImxpbmtfR29zY2hlZF9sb2dpY2FsIj48cGF0aCBkPSJNNjc2LjU4NywyNTQuMjk2OSBDNjg2Ljg1NSwyNTQuMjk2OSA2OTcuMTIyLDI1NC4yOTY5IDcwNy4zOSwyNTQuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJHb3NjaGVkLWJhY2t0by1sb2dpY2FsIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjY3MS41NDcsMjU0LjI5NjksNjgwLjU0NywyNTguMjk2OSw2NzYuNTQ3LDI1NC4yOTY5LDY4MC41NDcsMjUwLjI5NjksNjcxLjU0NywyNTQuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgbWNhbGwgdG8gR29zY2hlZC0tPjxnIGlkPSJsaW5rX21jYWxsX0dvc2NoZWQiPjxwYXRoIGQ9Ik01OTguNzQxLDE4MS45NTkgQzU5OC45MTksMTk4LjYzNjggNTk5LjE1NiwyMjAuOTYxMSA1OTkuMzE4LDIzNi4xNjUyICIgZmlsbD0ibm9uZSIgaWQ9Im1jYWxsLWJhY2t0by1Hb3NjaGVkIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU5OC42ODMsMTc2LjUzNzksNTk0Ljc3OTEsMTg1LjU4LDU5OC43MzYzLDE4MS41Mzc2LDYwMi43Nzg3LDE4NS40OTQ3LDU5OC42ODMsMTc2LjUzNzkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIHNjaGVkdWxlIHRvIG1jYWxsLS0+PGcgaWQ9Imxpbmtfc2NoZWR1bGVfbWNhbGwiPjxwYXRoIGQ9Ik01OTYuOTgyLDg1Ljk1ODkgQzU5Ny4zMzcsMTAyLjYzNjkgNTk3LjgxMiwxMjQuOTYwOSA1OTguMTM1LDE0MC4xNjQ5ICIgZmlsbD0ibm9uZSIgaWQ9InNjaGVkdWxlLWJhY2t0by1tY2FsbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1OTYuODY3LDgwLjUzNzksNTkzLjA1ODIsODkuNjIwNCw1OTYuOTcyNyw4NS41MzY4LDYwMS4wNTY0LDg5LjQ1MTMsNTk2Ljg2Nyw4MC41Mzc5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bVFAzMVlpOG00OFJsVU9oR2tzOVZtRWktSHdkUGoxMlI5S3RQRklnMkwzbTl0bFFvaTIwem9SQW0yMGZ6NmNscUJSUVRKQUgycDI3cFhfLVJJVjhoNWtpZXV1QkhHMU1QSmdUaUVDcnJmN0gwZXZuUUlUR3BRRElaSGktbmk4VTVGWW9GNHBPZjEwRkU3Tm1XLXMxbmVJczdzZVRub0lLbWRVVzNQYmpUb2lGdno2cy12aFZQd0xmbFJla2dBUFMwMnlkSkUxQS1XSXlJTldLT1FrenRzdFBYRnppZkdkSWd1VGhWc2tuZFBiTFVWblJEU05WdmN2amd0TnBNMEk0czVHZmhlNUFVd0M3dWRZWE1kbmNZNkp3UXpfMlNVNzFUUDVYandxSS1Qd3E3S05LUm5VS0M1bWpNd21kc3NXcnFNTTJyTmw3TUVYR1pXRHJESENVenhIeTBdLS0+PC9nPjwvc3ZnPg=="><h3 id="m0"><a href="#m0" class="headerlink" title="m0"></a>m0</h3><p>Worker M通常是由其他M通过结构初始化并访问系统调用，执行线程创建接口创建出来，最后经过<code>runtime.mstart()</code>进入正常Worker M的计算逻辑，那第一个M是怎么来的呢？</p><p>在Go语言runtime包中，通过不同版本的汇编实现了不同平台上程序启动的<code>main()</code>函数入口，然后执行<code>runtime.rt0_go()</code>完成对Go程序的初始化，并使用全局定义的m0/g0初始化第一个M，并将<code>runtime.main()</code>函数地址传入<code>runtime.newproc()</code>创建第一个用户协程，再执行<code>runtime.mstart()</code>进行正常后续流程。</p><p>接下来的流程就比较熟悉了，m0进入调度循环，并启动第一个用户协程<code>runtime.main()</code>进行前期的初始化，再访问用户代码中的<code>main.main()</code>正式执行用户代码逻辑。</p><p><strong>注：m0也是正常的Worker M，只不过创建的流程不太一样</strong></p><h2 id="sysmon"><a href="#sysmon" class="headerlink" title="sysmon"></a>sysmon</h2><p>Go语言中除了负责执行用户协程的的一组Worker M之外，还有一个独立的监控M，称之为sysmon。</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemstack(<span class="name">func</span>() &#123;</span><br><span class="line">    newm(<span class="name">sysmon</span>, <span class="literal">nil</span>, <span class="number">-1</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>sysmon在m0初始化完，执行第一个协程<code>runtime.main()</code>时，在<code>runtime.main()</code>函数中被创建，因为sysmon不直接服务于用户协程，因此没有绑定可执行的P，没有绑定P的M，所有的执行流程都在g0中。sysmon主要负责完成Go程序在执行期间的一些协同工作，如：处理系统调用阻塞(syscall)、用户协程执行时间过长(关于Go程序的抢占调度方案后面再细致的剖析)，还有超时未poll network等等问题。</p><h2 id="template-thread"><a href="#template-thread" class="headerlink" title="template thread"></a>template thread</h2><p>在<code>runtime.newm()</code>的函数中，创建新的线程时，由于Linux之类的系统底层是通过类似fork的系统调用创建线程，当M处于locked状态或M是在CGO中创建，在fork时可能会复制很多不可预知的状态，于是使用到了template thread的处理机制，在不方便由当前M直接创建新M时，将创建任务传递到template thread中，让template thread负责创建新的M，并按正常流程启动。</p><p>template thread由<code>runtime.startTemplateThread()</code>创建，在m0初始化完，执行<code>runtime.main()</code>时，在CGO的检查项中执行<code>runtime.startTemplateThread()</code>创建template thread，另一处是<code>runtime.LockOSThread()</code>中，并且template thread也是不绑定P的。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Go语言将线程抽象成M(Machine)，每个M都是可以独立运行的单元，M的数据结构中主要包含的是跟系统环境相关的字段。&lt;/p&gt;
&lt;p&gt;Go语言将可执行的上下文保存在G(Goroutine)中，G的数据结构中主要包含跟执行环境相关的字段，包括寄存器值，栈地址、defer，panic的指针等等。&lt;/p&gt;
&lt;p&gt;在&lt;a href=&quot;/2022/07/10/notes/golang/advanced/g0/&quot;&gt;《Golang深度解读：g0》&lt;/a&gt;中，简单讲述了g0的基本信息和在调度中所负责的工作。最先了解g0，主要原因是g0才是真正意义上在线程上运行的逻辑，M在创建之后，系统环境相关的数据保存在M中，线程的执行数据保存在g0中，g0与普通用户协程共用相同的数据结构和计算逻辑，只是在内核调度过程中，需要区分g0与用户协程的部分边界。&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="golang" scheme="https://oldchan.net/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Golang深度解读：g0</title>
    <link href="https://oldchan.net/2022/07/10/notes/golang/advanced/g0/"/>
    <id>https://oldchan.net/2022/07/10/notes/golang/advanced/g0/</id>
    <published>2022-07-10T12:56:40.000Z</published>
    <updated>2022-07-21T12:31:36.386Z</updated>
    
    <content type="html"><![CDATA[<p>g0是Go语言中一种特殊协程，每个M都拥有一个g0协程，主要负责当前M上用户协程的调度工作，在执行<code>runtime.newm()</code>函数创建M时，会同时初始化g0协程。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIxODJweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjQwNnB4O2hlaWdodDoxODJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA0MDYgMTgyIiB3aWR0aD0iNDA2cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM3IiB4PSIxMjcuNzUiIHk9IjIyLjk5NTEiPmcwLU0tcC1nL2cvZy9nLy4uLjwvdGV4dD48IS0tZW50aXR5IG0tLT48ZyBpZD0iZWxlbV9tIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjMyIiB4PSIxMCIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyIiB4PSIyMCIgeT0iNjcuMjkyIj5NPC90ZXh0PjwvZz48IS0tZW50aXR5IHAtLT48ZyBpZD0iZWxlbV9wIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI3Ny41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iODcuNSIgeT0iNjcuMjkyIj5QPC90ZXh0PjwvZz48IS0tZW50aXR5IGcwLS0+PGcgaWQ9ImVsZW1fZzAiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzgiIHg9IjciIHk9IjE0MC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgiIHg9IjE3IiB5PSIxNjMuMjkyIj5nMDwvdGV4dD48L2c+PCEtLWVudGl0eSBnMS0tPjxnIGlkPSJlbGVtX2cxIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjM4IiB4PSIxNDIiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOCIgeD0iMTUyIiB5PSI2Ny4yOTIiPmcxPC90ZXh0PjwvZz48IS0tZW50aXR5IGcyLS0+PGcgaWQ9ImVsZW1fZzIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzciIHg9IjIxNS41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTciIHg9IjIyNS41IiB5PSI2Ny4yOTIiPmcyPC90ZXh0PjwvZz48IS0tZW50aXR5IGczLS0+PGcgaWQ9ImVsZW1fZzMiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzgiIHg9IjI4OCIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4IiB4PSIyOTgiIHk9IjY3LjI5MiI+ZzM8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZ04tLT48ZyBpZD0iZWxlbV9nTiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzOSIgeD0iMzYxLjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOSIgeD0iMzcxLjUiIHk9IjY3LjI5MiI+Z048L3RleHQ+PC9nPjwhLS1saW5rIG0gdG8gZzAtLT48ZyBpZD0ibGlua19tX2cwIj48cGF0aCBkPSJNMjYsODAuNTM3OSBDMjYsOTcuNDk4NiAyNiwxMjMuMjQyNCAyNiwxNDAuMTY1MiAiIGZpbGw9Im5vbmUiIGlkPSJtLWcwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgbSB0byBwLS0+PGcgaWQ9ImxpbmtfbV9wIj48cGF0aCBkPSJNNDIuMjQyMiw2Mi4yOTY5IEM1My45MDQyLDYyLjI5NjkgNjUuNTY2Miw2Mi4yOTY5IDc3LjIyODEsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtLXAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Ny4wLDcuMDsiLz48L2c+PCEtLWxpbmsgcCB0byBnMS0tPjxnIGlkPSJsaW5rX3BfZzEiPjxwYXRoIGQ9Ik0xMDYuNTU0Nyw2Mi4yOTY5IEMxMTYuNTc2LDYyLjI5NjkgMTI2LjU5Nyw2Mi4yOTY5IDEzNi42MTksNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJwLXRvLWcxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE0MS44NTksNjIuMjk2OSwxMzIuODU5LDU4LjI5NjksMTM2Ljg1OSw2Mi4yOTY5LDEzMi44NTksNjYuMjk2OSwxNDEuODU5LDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnMSB0byBnMi0tPjxnIGlkPSJsaW5rX2cxX2cyIj48cGF0aCBkPSJNMTgwLjEwNSw2Mi4yOTY5IEMxOTAuMTQ1LDYyLjI5NjkgMjAwLjE4NCw2Mi4yOTY5IDIxMC4yMjQsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnMS10by1nMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTUuNDc0LDYyLjI5NjksMjA2LjQ3NCw1OC4yOTY5LDIxMC40NzQsNjIuMjk2OSwyMDYuNDc0LDY2LjI5NjksMjE1LjQ3NCw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZzIgdG8gZzMtLT48ZyBpZD0ibGlua19nMl9nMyI+PHBhdGggZD0iTTI1Mi41MzUsNjIuMjk2OSBDMjYyLjU2LDYyLjI5NjkgMjcyLjU4NSw2Mi4yOTY5IDI4Mi42MSw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9ImcyLXRvLWczIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI4Ny44NTIsNjIuMjk2OSwyNzguODUyLDU4LjI5NjksMjgyLjg1Miw2Mi4yOTY5LDI3OC44NTIsNjYuMjk2OSwyODcuODUyLDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnMyB0byBnTi0tPjxnIGlkPSJsaW5rX2czX2dOIj48cGF0aCBkPSJNMzI2LjA3OCw2Mi4yOTY5IEMzMzYuMDY1LDYyLjI5NjkgMzQ2LjA1Myw2Mi4yOTY5IDM1Ni4wNCw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9ImczLXRvLWdOIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjEuMjYyLDYyLjI5NjksMzUyLjI2Miw1OC4yOTY5LDM1Ni4yNjIsNjIuMjk2OSwzNTIuMjYyLDY2LjI5NjksMzYxLjI2Miw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bTFN2QjJlS20zME5HVUxPSEVhLXJ4VG1UTURvMmc0SjFKd2M1al9yZHBTMk1aRXU5OEpTa0tuZkZ0WFRLbFNCbm5XRllIeURCZUlIa04tRXNHWURlQWhJMmphOGR3MmhxV1h1V1JLYy1LNC0xazk3SE1ZazAwbjVmbGR1ZHZWU3ZRT2VSaHVkbXdIWm9MY0FOY3gwZmltTXNQTlIweGhqX21GeTFdLS0+PC9nPjwvc3ZnPg=="><a id="more"></a><p>g0协程执行时使用系统栈，每个线程从启动开始往下执行，都属于g0的工作范围，直到运行至<code>runtime.gogo()</code>启动用户协程，g0的工作才算暂时告一段落。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIzOTNweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjg4MHB4O2hlaWdodDozOTNweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA4ODAgMzkzIiB3aWR0aD0iODgwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSIzNzMiIHk9IjIyLjk5NTEiPueyvueugOeJiOiwg+W6pua1geeoi+WbvjwvdGV4dD48IS0tZW50aXR5IG1zdGFydC0tPjxnIGlkPSJlbGVtX21zdGFydCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzEiIHg9IjciIHk9IjE1Ny4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExIiB4PSIxNyIgeT0iMTgwLjI5MiI+cnVudGltZS5tc3RhcnQ8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbXN0YXJ0MC0tPjxnIGlkPSJlbGVtX21zdGFydDAiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSIxNzMuNSIgeT0iMTU3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAiIHg9IjE4My41IiB5PSIxODAuMjkyIj5ydW50aW1lLm1zdGFydDA8L3RleHQ+PC9nPjwhLS1lbnRpdHkgbXN0YXJ0MS0tPjxnIGlkPSJlbGVtX21zdGFydDEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSIzNDguNSIgeT0iMTU3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAiIHg9IjM1OC41IiB5PSIxODAuMjkyIj5ydW50aW1lLm1zdGFydDE8L3RleHQ+PC9nPjwhLS1lbnRpdHkgc2NoZWR1bGUtLT48ZyBpZD0iZWxlbV9zY2hlZHVsZSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDUiIHg9IjUyNCIgeT0iMTU3LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUiIHg9IjUzNCIgeT0iMTgwLjI5MiI+cnVudGltZS5zY2hlZHVsZTwvdGV4dD48L2c+PCEtLWVudGl0eSBnbG9icnVucWdldC0tPjxnIGlkPSJlbGVtX2dsb2JydW5xZ2V0Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE3MSIgeD0iMjA5IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUxIiB4PSIyMTkiIHk9IjY3LjI5MiI+cnVudGltZS5nbG9icnVucWdldDwvdGV4dD48L2c+PCEtLWVudGl0eSBydW5xZ2V0LS0+PGcgaWQ9ImVsZW1fcnVucWdldCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzkiIHg9IjUyNyIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExOSIgeD0iNTM3IiB5PSI2Ny4yOTIiPnJ1bnRpbWUucnVucWdldDwvdGV4dD48L2c+PCEtLWVudGl0eSBmaW5kcnVubmFibGUtLT48ZyBpZD0iZWxlbV9maW5kcnVubmFibGUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTczIiB4PSI3MDEiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNTMiIHg9IjcxMSIgeT0iNjcuMjkyIj5ydW50aW1lLmZpbmRydW5uYWJsZTwvdGV4dD48L2c+PCEtLWVudGl0eSBleGVjdXRlLS0+PGcgaWQ9ImVsZW1fZXhlY3V0ZSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDAiIHg9IjcwNC41IiB5PSIxNTcuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMCIgeD0iNzE0LjUiIHk9IjE4MC4yOTIiPnJ1bnRpbWUuZXhlY3V0ZTwvdGV4dD48L2c+PCEtLWVudGl0eSBnb2dvLS0+PGcgaWQ9ImVsZW1fZ29nbyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMTgiIHg9IjcxMy41IiB5PSIyNTQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk4IiB4PSI3MjMuNSIgeT0iMjc3LjI5MiI+cnVudGltZS5nb2dvPC90ZXh0PjwvZz48IS0tZW50aXR5IGxvZ2ljYWwtLT48ZyBpZD0iZWxlbV9sb2dpY2FsIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEzMiIgeD0iNzA2LjUiIHk9IjM1MS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTEyIiB4PSI3MTYuNSIgeT0iMzc0LjI5MiI+55So5oi35Luj56CB6YC76L6R6YOo5YiGPC90ZXh0PjwvZz48IS0tZW50aXR5IEdvc2NoZWQtLT48ZyBpZD0iZWxlbV9Hb3NjaGVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE0NCIgeD0iNTI3LjUiIHk9IjM1MS4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI0IiB4PSI1MzcuNSIgeT0iMzc0LjI5MiI+cnVudGltZS5Hb3NjaGVkPC90ZXh0PjwvZz48IS0tZW50aXR5IG1jYWxsLS0+PGcgaWQ9ImVsZW1fbWNhbGwiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTIwIiB4PSI1MzkuNSIgeT0iMjU0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDAiIHg9IjU0OS41IiB5PSIyNzcuMjkyIj5ydW50aW1lLm1jYWxsPC90ZXh0PjwvZz48IS0tbGluayBtc3RhcnQgdG8gbXN0YXJ0MC0tPjxnIGlkPSJsaW5rX21zdGFydF9tc3RhcnQwIj48cGF0aCBkPSJNMTM4LjI5NSwxNzUuMjk2OSBDMTQ4LjIxLDE3NS4yOTY5IDE1OC4xMjYsMTc1LjI5NjkgMTY4LjA0MSwxNzUuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtc3RhcnQtdG8tbXN0YXJ0MCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIxNzMuMjI2LDE3NS4yOTY5LDE2NC4yMjYsMTcxLjI5NjksMTY4LjIyNiwxNzUuMjk2OSwxNjQuMjI2LDE3OS4yOTY5LDE3My4yMjYsMTc1LjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBtc3RhcnQwIHRvIG1zdGFydDEtLT48ZyBpZD0ibGlua19tc3RhcnQwX21zdGFydDEiPjxwYXRoIGQ9Ik0zMTMuNTY4LDE3NS4yOTY5IEMzMjMuNDU4LDE3NS4yOTY5IDMzMy4zNDgsMTc1LjI5NjkgMzQzLjIzNywxNzUuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtc3RhcnQwLXRvLW1zdGFydDEiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMzQ4LjQwOSwxNzUuMjk2OSwzMzkuNDA5LDE3MS4yOTY5LDM0My40MDksMTc1LjI5NjksMzM5LjQwOSwxNzkuMjk2OSwzNDguNDA5LDE3NS4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgbXN0YXJ0MSB0byBzY2hlZHVsZS0tPjxnIGlkPSJsaW5rX21zdGFydDFfc2NoZWR1bGUiPjxwYXRoIGQ9Ik00ODguNzI3LDE3NS4yOTY5IEM0OTguNjQ1LDE3NS4yOTY5IDUwOC41NjQsMTc1LjI5NjkgNTE4LjQ4MiwxNzUuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtc3RhcnQxLXRvLXNjaGVkdWxlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjUyMy42NjksMTc1LjI5NjksNTE0LjY2OSwxNzEuMjk2OSw1MTguNjY5LDE3NS4yOTY5LDUxNC42NjksMTc5LjI5NjksNTIzLjY2OSwxNzUuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgZmluZHJ1bm5hYmxlIHRvIHNjaGVkdWxlLS0+PGcgaWQ9ImxpbmtfZmluZHJ1bm5hYmxlX3NjaGVkdWxlIj48cGF0aCBkPSJNNzY2LjY4OSw4NC4yNzc5IEM3NTIuMzc5LDk3Ljg1NzkgNzMyLjQyNywxMTUuMTk2OSA3MTIuNSwxMjcuMjk2OSBDNjkyLjcxOSwxMzkuMzA3OSA2NjkuMzIxLDE0OS40NTg5IDY0OC43MzgsMTU3LjIxOTkgIiBmaWxsPSJub25lIiBpZD0iZmluZHJ1bm5hYmxlLWJhY2t0by1zY2hlZHVsZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3NzAuNTcxLDgwLjU1NDksNzYxLjMwNyw4My44OTg0LDc2Ni45NjI3LDg0LjAxNjEsNzY2Ljg0NSw4OS42NzE3LDc3MC41NzEsODAuNTU0OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iODUiIHg9IjczNi41IiB5PSIxMjMuMzYzOCI+My7mn6Xmib7lj6/miafooYxnPC90ZXh0PjwvZz48IS0tcmV2ZXJzZSBsaW5rIHJ1bnFnZXQgdG8gc2NoZWR1bGUtLT48ZyBpZD0ibGlua19ydW5xZ2V0X3NjaGVkdWxlIj48cGF0aCBkPSJNNTk2LjUsODUuNzY5OSBDNTk2LjUsMTA2Ljg0MjkgNTk2LjUsMTM3LjkwMDkgNTk2LjUsMTU3LjA3NDkgIiBmaWxsPSJub25lIiBpZD0icnVucWdldC1iYWNrdG8tc2NoZWR1bGUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTk2LjUsODAuNjQwOSw1OTIuNSw4OS42NDA5LDU5Ni41LDg1LjY0MDksNjAwLjUsODkuNjQwOSw1OTYuNSw4MC42NDA5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDYiIHg9IjU5Ny41IiB5PSIxMjMuMzYzOCI+Mi7ku47mnKzlnLBw5Lit6I635Y+WZzwvdGV4dD48L2c+PCEtLXJldmVyc2UgbGluayBnbG9icnVucWdldCB0byBzY2hlZHVsZS0tPjxnIGlkPSJsaW5rX2dsb2JydW5xZ2V0X3NjaGVkdWxlIj48cGF0aCBkPSJNMzAwLjAxOSw4NS41OTc5IEMzMDQuNyw5OS43NTA5IDMxMi44ODgsMTE3LjIzMzkgMzI2LjUsMTI3LjI5NjkgQzM5MS4zNjUsMTc1LjI0OTkgNDI2LjA3MiwxNDMuMjIyOSA1MDUuNSwxNTcuMjk2OSBDNTExLjM1NSwxNTguMzM0OSA1MTcuNDE5LDE1OS40MjY5IDUyMy41MDksMTYwLjUzNzkgIiBmaWxsPSJub25lIiBpZD0iZ2xvYnJ1bnFnZXQtYmFja3RvLXNjaGVkdWxlIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI5OC40NSw4MC41NTM5LDI5Ny4zMDU3LDkwLjMzNiwyOTkuOTM2MSw4NS4zMjc5LDMwNC45NDQyLDg3Ljk1ODMsMjk4LjQ1LDgwLjU1MzkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjEzIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI2MCIgeD0iMzI3LjUiIHk9IjEyMy4zNjM4Ij4xLuavj+aJp+ihjDYx5qyhZ+aXtu+8jOWImeS7juWFqOWxgOmYn+WIl+S4reiOt+WPljHmrKFnPC90ZXh0PjwvZz48IS0tbGluayBzY2hlZHVsZSB0byBleGVjdXRlLS0+PGcgaWQ9Imxpbmtfc2NoZWR1bGVfZXhlY3V0ZSI+PHBhdGggZD0iTTY2OS4xNiwxNzUuMjk2OSBDNjc5LjA4OCwxNzUuMjk2OSA2ODkuMDE2LDE3NS4yOTY5IDY5OC45NDUsMTc1LjI5NjkgIiBmaWxsPSJub25lIiBpZD0ic2NoZWR1bGUtdG8tZXhlY3V0ZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3MDQuMTM2LDE3NS4yOTY5LDY5NS4xMzYsMTcxLjI5NjksNjk5LjEzNiwxNzUuMjk2OSw2OTUuMTM2LDE3OS4yOTY5LDcwNC4xMzYsMTc1LjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBleGVjdXRlIHRvIGdvZ28tLT48ZyBpZD0ibGlua19leGVjdXRlX2dvZ28iPjxwYXRoIGQ9Ik03NzQuMTMzLDE5My43MjA5IEM3NzMuODA2LDIwOS4yNTU5IDc3My4zMjYsMjMyLjA3OTkgNzcyLjk3LDI0OC45NTE5ICIgZmlsbD0ibm9uZSIgaWQ9ImV4ZWN1dGUtdG8tZ29nbyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3NzIuODY1LDI1My45ODI5LDc3Ny4wNTQ0LDI0NS4wNjk1LDc3Mi45NzA3LDI0OC45ODQsNzY5LjA1NjIsMjQ0LjkwMDMsNzcyLjg2NSwyNTMuOTgyOSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGdvZ28gdG8gbG9naWNhbC0tPjxnIGlkPSJsaW5rX2dvZ29fbG9naWNhbCI+PHBhdGggZD0iTTc3Mi41LDI5MC43MjE0IEM3NzIuNSwzMDYuMjU1NCA3NzIuNSwzMjkuMDc5OCA3NzIuNSwzNDUuOTUyMyAiIGZpbGw9Im5vbmUiIGlkPSJnb2dvLXRvLWxvZ2ljYWwiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzcyLjUsMzUwLjk4MjksNzc2LjUsMzQxLjk4MjksNzcyLjUsMzQ1Ljk4MjksNzY4LjUsMzQxLjk4MjksNzcyLjUsMzUwLjk4MjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tcmV2ZXJzZSBsaW5rIEdvc2NoZWQgdG8gbG9naWNhbC0tPjxnIGlkPSJsaW5rX0dvc2NoZWRfbG9naWNhbCI+PHBhdGggZD0iTTY3Ni45NDYsMzY5LjI5NjkgQzY4Ni43NzEsMzY5LjI5NjkgNjk2LjU5NiwzNjkuMjk2OSA3MDYuNDIxLDM2OS4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Ikdvc2NoZWQtYmFja3RvLWxvZ2ljYWwiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNjcxLjgwOSwzNjkuMjk2OSw2ODAuODA5LDM3My4yOTY5LDY3Ni44MDksMzY5LjI5NjksNjgwLjgwOSwzNjUuMjk2OSw2NzEuODA5LDM2OS4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLXJldmVyc2UgbGluayBtY2FsbCB0byBHb3NjaGVkLS0+PGcgaWQ9ImxpbmtfbWNhbGxfR29zY2hlZCI+PHBhdGggZD0iTTU5OS41LDI5NS43NjE3IEM1OTkuNSwzMTIuNjYyNCA1OTkuNSwzMzUuNDgzNSA1OTkuNSwzNTAuOTgyOSAiIGZpbGw9Im5vbmUiIGlkPSJtY2FsbC1iYWNrdG8tR29zY2hlZCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1OTkuNSwyOTAuNzIxNCw1OTUuNSwyOTkuNzIxNCw1OTkuNSwyOTUuNzIxNCw2MDMuNSwyOTkuNzIxNCw1OTkuNSwyOTAuNzIxNCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1yZXZlcnNlIGxpbmsgc2NoZWR1bGUgdG8gbWNhbGwtLT48ZyBpZD0ibGlua19zY2hlZHVsZV9tY2FsbCI+PHBhdGggZD0iTTU5Ny4yMDksMTk4Ljc2MTkgQzU5Ny43NDMsMjE1LjY2MTkgNTk4LjQ2NCwyMzguNDgzOSA1OTguOTUzLDI1My45ODI5ICIgZmlsbD0ibm9uZSIgaWQ9InNjaGVkdWxlLWJhY2t0by1tY2FsbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1OTcuMDUsMTkzLjcyMDksNTkzLjMzNDksMjAyLjg0MjIsNTk3LjIwNzIsMTk4LjcxODQsNjAxLjMzMDksMjAyLjU5MDcsNTk3LjA1LDE5My43MjA5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bVkxCQkppOTA1RHR0QW9SaVFRV2NCYll1ekpqQTZLZ0pxY0FQSGZTR2VZY0hHNG9DUTJIMU9qR2tLRDE0Q01Cd0RTb3FoRm01b3BuOElHUGRDVlRDcHhidHhqbkozbmY4VHFtUldmcGRFeVlnR1JOTUdCZzdTYTFsMDBPTFJ2VWVhNTRMVGlrcVo0b0pvSGY2NVBQejZyQVRFQ1k0ZmtzTUtkbmlHalBXdllvSlB3Tl9vMmdNS3F3bmV2VHUyemFGaVdIdTJXcVZDSXQ3cWN2VHFzTGpmWTBoWUF6MjRpb05ZdVZ1bGhMZ0JmQmVTaktFU04xRW5SUGhNZVBrb21lVWtOR3VMQ1FuVEVmZmtpcmNsYVFBV1luNGh0c0Z1alRjdDBjSU1Ial9GdjZGTFhuVXVCaWVmb1pDNzQxTnRoRkNBaWVWUmVwYktLUGdkRElzb09zNzBiM01od1NLczlmazRVb2hQRkg4RVg3a0pxZGRFSGJ0Sk1hSWp3eTh6akpiZWFVNjRwb1NyUFRWQnFibFpsbE55ZnBDdHI0NGNhZ2NWTlIzV0tPY092Q0NGZHpfa1pZdUpVbFhpbjJfRExTdDhubUNEYU1mUWhrbVU5eW1kS1ZzLUI5eHVnR1NETmt6MFJ1NDhPcGJhTjRzaEFtQjJaVHYxRGJkQzFGZkJZZm9IbEpzMW0wMF0tLT48L2c+PC9zdmc+"><p>如图所示，Go语言中的协程调度总是不断地经历着类似的循环，以<code>runtime.Gosched()</code>让出调度的流程举例。</p><p>当M创建之后，会同时初始化g0，运行在不同的平台上时，程序兼容各平台特性，最终执行到<code>runtime.mstart()</code>正式启动g0的调度逻辑，再经过<code>runtime.mstart1()</code>进入到调度循环中，由<code>runtime.gogo()</code>启动用户协程，在用户逻辑中执行<code>runtime.Gosched()</code>让出执行权限，再经过<code>runtime.mcall()</code>回到g0的工作范围(<strong>这条流程下，刚刚执行过的协程会被放到全局队列中</strong>)。</p><h2 id="反复重用的栈帧"><a href="#反复重用的栈帧" class="headerlink" title="反复重用的栈帧"></a>反复重用的栈帧</h2><p>调度技术上，有不少细节的设计很有技巧，其中一个就是对于g0栈帧的管理。</p><p>g0采用的是无限递归的方式重复运行调度逻辑，正常的程序执行路径都是保存在栈内，按正常程序的编译结果，g0的协程栈会无限膨胀直到移除，因此Go语言对这里进行了一些优化，当执行到<code>runtime.mstart1()</code>时，g0会提前计算出一份协程栈的地址数据，保存在g0的结构中。<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_g_<span class="selector-class">.sched</span><span class="selector-class">.pc</span> = getcallerpc()</span><br><span class="line">_g_<span class="selector-class">.sched</span><span class="selector-class">.sp</span> = getcallersp()</span><br></pre></td></tr></table></figure></p><p>当g0执行到<code>runtime.gogo()</code>切换至用户协程时，并不会将当前g0的栈帧保存起来，而当用户协程经过<code>runtime.mcall()</code>回到g0时，再次加载的还是最初在<code>runtime.mstart1()</code>中计算出来的栈地址数据，通过这种技巧，反复将栈顶指针重置，从而实现栈帧的重复使用。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">TEXT runtime·mcall&lt;ABIInternal&gt;(SB), <span class="built_in">NOSPLIT</span>, <span class="number">$0</span>-<span class="number">8</span></span><br><span class="line"><span class="keyword">MOVQ</span><span class="built_in">AX</span>, <span class="built_in">DX</span>// <span class="built_in">DX</span> = fn</span><br><span class="line"></span><br><span class="line">// save state <span class="keyword">in</span> g-&gt;sched</span><br><span class="line"><span class="keyword">MOVQ</span><span class="number">0</span>(<span class="built_in">SP</span>), <span class="built_in">BX</span>// caller<span class="string">'s PC</span></span><br><span class="line"><span class="string">MOVQBX, (g_sched+gobuf_pc)(R14)</span></span><br><span class="line"><span class="string">LEAQfn+0(FP), BX// caller'</span>s <span class="built_in">SP</span></span><br><span class="line"><span class="keyword">MOVQ</span><span class="built_in">BX</span>, (g_sched+gobuf_sp)(<span class="built_in">R14</span>)</span><br><span class="line"><span class="keyword">MOVQ</span><span class="built_in">BP</span>, (g_sched+gobuf_bp)(<span class="built_in">R14</span>)</span><br><span class="line"></span><br><span class="line">// switch to m-&gt;g0 &amp; its stack, <span class="keyword">call</span> fn</span><br><span class="line"><span class="keyword">MOVQ</span>g_m(<span class="built_in">R14</span>), <span class="built_in">BX</span></span><br><span class="line"><span class="keyword">MOVQ</span>m_g0(<span class="built_in">BX</span>), <span class="built_in">SI</span>// <span class="built_in">SI</span> = g.m.g0</span><br><span class="line">CMPQ<span class="built_in">SI</span>, <span class="built_in">R14</span>// if g == m-&gt;g0 <span class="keyword">call</span> badmcall</span><br><span class="line"><span class="keyword">JNE</span>goodm</span><br><span class="line"><span class="keyword">JMP</span>runtime·badmcall(SB)</span><br><span class="line"><span class="symbol">goodm:</span></span><br><span class="line"><span class="keyword">MOVQ</span><span class="built_in">R14</span>, <span class="built_in">AX</span>// <span class="built_in">AX</span> (<span class="keyword">and</span> arg <span class="number">0</span>) = g</span><br><span class="line"><span class="keyword">MOVQ</span><span class="built_in">SI</span>, <span class="built_in">R14</span>// g = g.m.g0</span><br><span class="line">get_tls(<span class="built_in">CX</span>)// Set G <span class="keyword">in</span> TLS</span><br><span class="line"><span class="keyword">MOVQ</span><span class="built_in">R14</span>, g(<span class="built_in">CX</span>)</span><br><span class="line"><span class="keyword">MOVQ</span>(g_sched+gobuf_sp)(<span class="built_in">R14</span>), <span class="built_in">SP</span>// <span class="built_in">sp</span> = g0.sched.sp</span><br><span class="line">PUSHQ<span class="built_in">AX</span>// open <span class="meta">up</span> space for fn<span class="string">'s arg spill slot</span></span><br><span class="line"><span class="string">MOVQ0(DX), R12</span></span><br><span class="line"><span class="string">CALLR12// fn(g)</span></span><br><span class="line"><span class="string">POPQAX</span></span><br><span class="line"><span class="string">JMPruntime·badmcall2(SB)</span></span><br><span class="line"><span class="string">RET</span></span><br></pre></td></tr></table></figure><h2 id="优先提高并行度"><a href="#优先提高并行度" class="headerlink" title="优先提高并行度"></a>优先提高并行度</h2><p>Worker角色的M被创建时，默认都需要再创建另一个新的M，直至没有空闲的p为止。</p><p>这块的处理流程是每创建一个M，在执行调度时，如果当前M中<code>spinning</code>成员被标记为<code>true</code>，则尝试创建另一个M，采用全局变量<code>sched.nmspinning</code>控制创建流程，实现M的顺序创建。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;g0是Go语言中一种特殊协程，每个M都拥有一个g0协程，主要负责当前M上用户协程的调度工作，在执行&lt;code&gt;runtime.newm()&lt;/code&gt;函数创建M时，会同时初始化g0协程。&lt;/p&gt;
&lt;img src=&quot;data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIxODJweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjQwNnB4O2hlaWdodDoxODJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA0MDYgMTgyIiB3aWR0aD0iNDA2cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZm9udC13ZWlnaHQ9ImJvbGQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTM3IiB4PSIxMjcuNzUiIHk9IjIyLjk5NTEiPmcwLU0tcC1nL2cvZy9nLy4uLjwvdGV4dD48IS0tZW50aXR5IG0tLT48ZyBpZD0iZWxlbV9tIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjMyIiB4PSIxMCIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyIiB4PSIyMCIgeT0iNjcuMjkyIj5NPC90ZXh0PjwvZz48IS0tZW50aXR5IHAtLT48ZyBpZD0iZWxlbV9wIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjI5IiB4PSI3Ny41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iOSIgeD0iODcuNSIgeT0iNjcuMjkyIj5QPC90ZXh0PjwvZz48IS0tZW50aXR5IGcwLS0+PGcgaWQ9ImVsZW1fZzAiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzgiIHg9IjciIHk9IjE0MC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTgiIHg9IjE3IiB5PSIxNjMuMjkyIj5nMDwvdGV4dD48L2c+PCEtLWVudGl0eSBnMS0tPjxnIGlkPSJlbGVtX2cxIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjM4IiB4PSIxNDIiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOCIgeD0iMTUyIiB5PSI2Ny4yOTIiPmcxPC90ZXh0PjwvZz48IS0tZW50aXR5IGcyLS0+PGcgaWQ9ImVsZW1fZzIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzciIHg9IjIxNS41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTciIHg9IjIyNS41IiB5PSI2Ny4yOTIiPmcyPC90ZXh0PjwvZz48IS0tZW50aXR5IGczLS0+PGcgaWQ9ImVsZW1fZzMiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMzgiIHg9IjI4OCIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjE4IiB4PSIyOTgiIHk9IjY3LjI5MiI+ZzM8L3RleHQ+PC9nPjwhLS1lbnRpdHkgZ04tLT48ZyBpZD0iZWxlbV9nTiI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIzOSIgeD0iMzYxLjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxOSIgeD0iMzcxLjUiIHk9IjY3LjI5MiI+Z048L3RleHQ+PC9nPjwhLS1saW5rIG0gdG8gZzAtLT48ZyBpZD0ibGlua19tX2cwIj48cGF0aCBkPSJNMjYsODAuNTM3OSBDMjYsOTcuNDk4NiAyNiwxMjMuMjQyNCAyNiwxNDAuMTY1MiAiIGZpbGw9Im5vbmUiIGlkPSJtLWcwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgbSB0byBwLS0+PGcgaWQ9ImxpbmtfbV9wIj48cGF0aCBkPSJNNDIuMjQyMiw2Mi4yOTY5IEM1My45MDQyLDYyLjI5NjkgNjUuNTY2Miw2Mi4yOTY5IDc3LjIyODEsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJtLXAiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wO3N0cm9rZS1kYXNoYXJyYXk6Ny4wLDcuMDsiLz48L2c+PCEtLWxpbmsgcCB0byBnMS0tPjxnIGlkPSJsaW5rX3BfZzEiPjxwYXRoIGQ9Ik0xMDYuNTU0Nyw2Mi4yOTY5IEMxMTYuNTc2LDYyLjI5NjkgMTI2LjU5Nyw2Mi4yOTY5IDEzNi42MTksNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJwLXRvLWcxIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE0MS44NTksNjIuMjk2OSwxMzIuODU5LDU4LjI5NjksMTM2Ljg1OSw2Mi4yOTY5LDEzMi44NTksNjYuMjk2OSwxNDEuODU5LDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnMSB0byBnMi0tPjxnIGlkPSJsaW5rX2cxX2cyIj48cGF0aCBkPSJNMTgwLjEwNSw2Mi4yOTY5IEMxOTAuMTQ1LDYyLjI5NjkgMjAwLjE4NCw2Mi4yOTY5IDIxMC4yMjQsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJnMS10by1nMiIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyMTUuNDc0LDYyLjI5NjksMjA2LjQ3NCw1OC4yOTY5LDIxMC40NzQsNjIuMjk2OSwyMDYuNDc0LDY2LjI5NjksMjE1LjQ3NCw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgZzIgdG8gZzMtLT48ZyBpZD0ibGlua19nMl9nMyI+PHBhdGggZD0iTTI1Mi41MzUsNjIuMjk2OSBDMjYyLjU2LDYyLjI5NjkgMjcyLjU4NSw2Mi4yOTY5IDI4Mi42MSw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9ImcyLXRvLWczIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI4Ny44NTIsNjIuMjk2OSwyNzguODUyLDU4LjI5NjksMjgyLjg1Miw2Mi4yOTY5LDI3OC44NTIsNjYuMjk2OSwyODcuODUyLDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayBnMyB0byBnTi0tPjxnIGlkPSJsaW5rX2czX2dOIj48cGF0aCBkPSJNMzI2LjA3OCw2Mi4yOTY5IEMzMzYuMDY1LDYyLjI5NjkgMzQ2LjA1Myw2Mi4yOTY5IDM1Ni4wNCw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9ImczLXRvLWdOIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDtzdHJva2UtZGFzaGFycmF5OjcuMCw3LjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNjEuMjYyLDYyLjI5NjksMzUyLjI2Miw1OC4yOTY5LDM1Ni4yNjIsNjIuMjk2OSwzNTIuMjYyLDY2LjI5NjksMzYxLjI2Miw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLVNSQz1bTFN2QjJlS20zME5HVUxPSEVhLXJ4VG1UTURvMmc0SjFKd2M1al9yZHBTMk1aRXU5OEpTa0tuZkZ0WFRLbFNCbm5XRllIeURCZUlIa04tRXNHWURlQWhJMmphOGR3MmhxV1h1V1JLYy1LNC0xazk3SE1ZazAwbjVmbGR1ZHZWU3ZRT2VSaHVkbXdIWm9MY0FOY3gwZmltTXNQTlIweGhqX21GeTFdLS0+PC9nPjwvc3ZnPg==&quot;&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="golang" scheme="https://oldchan.net/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Golang深度解读</title>
    <link href="https://oldchan.net/2022/07/10/notes/golang/advanced/list/"/>
    <id>https://oldchan.net/2022/07/10/notes/golang/advanced/list/</id>
    <published>2022-07-10T12:50:40.000Z</published>
    <updated>2023-01-16T09:48:00.145Z</updated>
    
    <content type="html"><![CDATA[<h3 id="内核实现"><a href="#内核实现" class="headerlink" title="内核实现"></a>内核实现</h3><ul><li><a href="/2022/07/10/notes/golang/advanced/g0/">《Golang深度解读：g0》</a></li><li><a href="/2022/07/24/notes/golang/advanced/m/">《Golang深度解读：M》</a></li><li><a href="/2022/08/15/notes/golang/advanced/p/">《Golang深度解读：P》</a><a id="more"></a></li><li><a href="/2022/12/10/notes/golang/advanced/schedule/">《Golang深度解读：调度》</a></li><li><a href="/2023/01/15/notes/golang/advanced/boot/">《Golang深度解读：启动》</a></li><li>《Golang深度解读：syscall》</li></ul><h3 id="语法特性"><a href="#语法特性" class="headerlink" title="语法特性"></a>语法特性</h3><h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><ul><li>《Golang深度解读：func》</li></ul><h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><ul><li>《Golang深度解读：chan》</li><li>《Golang深度解读：slice》</li><li>《Golang深度解读：map》</li></ul><h3 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h3><ul><li>《Golang深度解读：待定》</li></ul><h3 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h3><ul><li>《Golang深度解读：Context》</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;内核实现&quot;&gt;&lt;a href=&quot;#内核实现&quot; class=&quot;headerlink&quot; title=&quot;内核实现&quot;&gt;&lt;/a&gt;内核实现&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;/2022/07/10/notes/golang/advanced/g0/&quot;&gt;《Golang深度解读：g0》&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2022/07/24/notes/golang/advanced/m/&quot;&gt;《Golang深度解读：M》&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/2022/08/15/notes/golang/advanced/p/&quot;&gt;《Golang深度解读：P》&lt;/a&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="golang" scheme="https://oldchan.net/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>6年前，决定不再继续精进PHP</title>
    <link href="https://oldchan.net/2022/06/15/opinion/give_up_the_php/"/>
    <id>https://oldchan.net/2022/06/15/opinion/give_up_the_php/</id>
    <published>2022-06-15T13:54:24.000Z</published>
    <updated>2022-07-13T05:12:14.009Z</updated>
    
    <content type="html"><![CDATA[<p>「选择某种技术作为谋生手段，需要观察市场的需求变化」</p><p>PHP经历了最高光的辉煌阶段，从1995年正式发布开始，经过二十多年的快速发展，才逐渐达到发展瓶颈。PHP最鲜亮的标志就是语言入门简单，功能迭代快速，配合健全的WEB套件组合(LAMP、LNMP)，开箱即用，它的特性很符合互联网行业快速发展的开发需要。</p><img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI0OXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NDA3cHg7aGVpZ2h0OjQ5cHg7YmFja2dyb3VuZDojRkZGRkZGOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNDA3IDQ5IiB3aWR0aD0iNDA3cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IHVzZXItLT48ZyBpZD0iZWxlbV91c2VyIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ4IiB4PSI3IiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjgiIHg9IjE3IiB5PSIyOS45OTUxIj7nlKjmiLc8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcHJvZHVjdC0tPjxnIGlkPSJlbGVtX3Byb2R1Y3QiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjkwIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjgiIHg9IjEwMCIgeT0iMjkuOTk1MSI+5Lqn5ZOBPC90ZXh0PjwvZz48IS0tZW50aXR5IGNvbXBhbnktLT48ZyBpZD0iZWxlbV9jb21wYW55Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ4IiB4PSIxNzMiIHk9IjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOCIgeD0iMTgzIiB5PSIyOS45OTUxIj7kvIHkuJo8L3RleHQ+PC9nPjwhLS1lbnRpdHkgdGVjaC0tPjxnIGlkPSJlbGVtX3RlY2giPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjI1NiIgeT0iNyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI4IiB4PSIyNjYiIHk9IjI5Ljk5NTEiPuaKgOiDvTwvdGV4dD48L2c+PCEtLWVudGl0eSB3b3JrZXItLT48ZyBpZD0iZWxlbV93b3JrZXIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjIiIHg9IjMzOSIgeT0iNyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQyIiB4PSIzNDkiIHk9IjI5Ljk5NTEiPuWKs+WKqOiAhTwvdGV4dD48L2c+PCEtLWxpbmsgdXNlciB0byBwcm9kdWN0LS0+PGcgaWQ9ImxpbmtfdXNlcl9wcm9kdWN0Ij48cGF0aCBkPSJNNTUuMzE2NCwyNSBDNjUuMDc2NywyNSA3NC44MzcsMjUgODQuNTk3MywyNSAiIGZpbGw9Im5vbmUiIGlkPSJ1c2VyLXRvLXByb2R1Y3QiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iODkuNzAxMywyNSw4MC43MDEzLDIxLDg0LjcwMTMsMjUsODAuNzAxMywyOSw4OS43MDEzLDI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgcHJvZHVjdCB0byBjb21wYW55LS0+PGcgaWQ9ImxpbmtfcHJvZHVjdF9jb21wYW55Ij48cGF0aCBkPSJNMTM4LjMxNiwyNSBDMTQ4LjA3NywyNSAxNTcuODM3LDI1IDE2Ny41OTcsMjUgIiBmaWxsPSJub25lIiBpZD0icHJvZHVjdC10by1jb21wYW55IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3Mi43MDEsMjUsMTYzLjcwMSwyMSwxNjcuNzAxLDI1LDE2My43MDEsMjksMTcyLjcwMSwyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGNvbXBhbnkgdG8gdGVjaC0tPjxnIGlkPSJsaW5rX2NvbXBhbnlfdGVjaCI+PHBhdGggZD0iTTIyMS4zMTYsMjUgQzIzMS4wNzcsMjUgMjQwLjgzNywyNSAyNTAuNTk3LDI1ICIgZmlsbD0ibm9uZSIgaWQ9ImNvbXBhbnktdG8tdGVjaCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNTUuNzAxLDI1LDI0Ni43MDEsMjEsMjUwLjcwMSwyNSwyNDYuNzAxLDI5LDI1NS43MDEsMjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayB0ZWNoIHRvIHdvcmtlci0tPjxnIGlkPSJsaW5rX3RlY2hfd29ya2VyIj48cGF0aCBkPSJNMzA0LjI1OCwyNSBDMzE0LjA5OSwyNSAzMjMuOTQsMjUgMzMzLjc4LDI1ICIgZmlsbD0ibm9uZSIgaWQ9InRlY2gtdG8td29ya2VyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjMzOC45MjcsMjUsMzI5LjkyNywyMSwzMzMuOTI3LDI1LDMyOS45MjcsMjksMzM4LjkyNywyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1TUkM9W0FxZkRCYWRDSXl6OUxOVy1QU01wWmtxQU85MU9oNTFRZDVoNExHSU5WUjloLVRGOVpOM1BXZ0J5YkRCYTRjRzVVbmdWeDlXNUx2MlNkcmtHYzVVOWZFMVBMeUVCdmhybTFJTWZvSGI4aWEteERaX2pNbDZZZUhLZ05QdlZiMHJxMDFWODZJMFh0UUJDejhtSU5Ka3VwTDBROEc2cDRLZVo5QzBzV0dXS1NvME0wMDAwXS0tPjwvZz48L3N2Zz4="><p>技能连接着企业与劳动者，用户处于需求链路的最前端，用户的需求决定了产品的形态，产品的形态决定了企业方向和经营方式，也同时决定了依赖资源的结构(包括对技术类资源的需求)。</p><a id="more"></a><p>互联网快速发展期间，由于投资家对行业的认可，资金的投入都比较宽裕，这种信心也是来自于用户体量的发展、市场规模的不断壮大。用户越来越多，需求旺盛，外部资金很充足的情况下，只要迭代速度够快就能赚钱。</p><p>随着互联网用户群体逐渐趋于饱和，基本的产品需求也开始饱和时，如果没有出现创新型变革，产品的迭代就会开始平缓，对于企业而言，一般会有三种选择：</p><ul><li>一是继续投入升级产品，提高收入</li><li>二是寻找新的用户群体，扩大收入</li><li>三是重构成本结构，优化技术，降低成本</li></ul><p>PHP就像是为这座名为“互联网”的初创城市添砖加瓦的劳动者，它动作轻快，建设效率很高，很快就能建成许多三层六层的小楼，并且很快吸引许多人入住。</p><p>PHP步入瓶颈，并非技术问题。更多的是技术特性不符合当前的市场需求，如同Python，因为人工智能算法的兴起，重新回归热度一样，因为<strong>市场需要这种技术</strong>。</p><p>几年前，感觉到行业这些变化，一边是不少人说工作不好找，另一边是培训机构疯狂地吸引更多的人进入这个行业，加上那几年成功的产品出现周期越来越长，于是就计划着寻找新的方向。</p><p>当时团队有转Java的途径，但最后还是选择了Go，随后的几年里，Go相关的技术栈发生了井喷似的发展，容器化技术，弹性调度，微服务技术等等。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;「选择某种技术作为谋生手段，需要观察市场的需求变化」&lt;/p&gt;
&lt;p&gt;PHP经历了最高光的辉煌阶段，从1995年正式发布开始，经过二十多年的快速发展，才逐渐达到发展瓶颈。PHP最鲜亮的标志就是语言入门简单，功能迭代快速，配合健全的WEB套件组合(LAMP、LNMP)，开箱即用，它的特性很符合互联网行业快速发展的开发需要。&lt;/p&gt;
&lt;img src=&quot;data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSI0OXB4IiBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJub25lIiBzdHlsZT0id2lkdGg6NDA3cHg7aGVpZ2h0OjQ5cHg7YmFja2dyb3VuZDojRkZGRkZGOyIgdmVyc2lvbj0iMS4xIiB2aWV3Qm94PSIwIDAgNDA3IDQ5IiB3aWR0aD0iNDA3cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48IS0tZW50aXR5IHVzZXItLT48ZyBpZD0iZWxlbV91c2VyIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ4IiB4PSI3IiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjgiIHg9IjE3IiB5PSIyOS45OTUxIj7nlKjmiLc8L3RleHQ+PC9nPjwhLS1lbnRpdHkgcHJvZHVjdC0tPjxnIGlkPSJlbGVtX3Byb2R1Y3QiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjkwIiB5PSI3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjgiIHg9IjEwMCIgeT0iMjkuOTk1MSI+5Lqn5ZOBPC90ZXh0PjwvZz48IS0tZW50aXR5IGNvbXBhbnktLT48ZyBpZD0iZWxlbV9jb21wYW55Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ4IiB4PSIxNzMiIHk9IjciLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyOCIgeD0iMTgzIiB5PSIyOS45OTUxIj7kvIHkuJo8L3RleHQ+PC9nPjwhLS1lbnRpdHkgdGVjaC0tPjxnIGlkPSJlbGVtX3RlY2giPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDgiIHg9IjI1NiIgeT0iNyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI4IiB4PSIyNjYiIHk9IjI5Ljk5NTEiPuaKgOiDvTwvdGV4dD48L2c+PCEtLWVudGl0eSB3b3JrZXItLT48ZyBpZD0iZWxlbV93b3JrZXIiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNjIiIHg9IjMzOSIgeT0iNyIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjQyIiB4PSIzNDkiIHk9IjI5Ljk5NTEiPuWKs+WKqOiAhTwvdGV4dD48L2c+PCEtLWxpbmsgdXNlciB0byBwcm9kdWN0LS0+PGcgaWQ9ImxpbmtfdXNlcl9wcm9kdWN0Ij48cGF0aCBkPSJNNTUuMzE2NCwyNSBDNjUuMDc2NywyNSA3NC44MzcsMjUgODQuNTk3MywyNSAiIGZpbGw9Im5vbmUiIGlkPSJ1c2VyLXRvLXByb2R1Y3QiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iODkuNzAxMywyNSw4MC43MDEzLDIxLDg0LjcwMTMsMjUsODAuNzAxMywyOSw4OS43MDEzLDI1IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLWxpbmsgcHJvZHVjdCB0byBjb21wYW55LS0+PGcgaWQ9ImxpbmtfcHJvZHVjdF9jb21wYW55Ij48cGF0aCBkPSJNMTM4LjMxNiwyNSBDMTQ4LjA3NywyNSAxNTcuODM3LDI1IDE2Ny41OTcsMjUgIiBmaWxsPSJub25lIiBpZD0icHJvZHVjdC10by1jb21wYW55IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3Mi43MDEsMjUsMTYzLjcwMSwyMSwxNjcuNzAxLDI1LDE2My43MDEsMjksMTcyLjcwMSwyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1saW5rIGNvbXBhbnkgdG8gdGVjaC0tPjxnIGlkPSJsaW5rX2NvbXBhbnlfdGVjaCI+PHBhdGggZD0iTTIyMS4zMTYsMjUgQzIzMS4wNzcsMjUgMjQwLjgzNywyNSAyNTAuNTk3LDI1ICIgZmlsbD0ibm9uZSIgaWQ9ImNvbXBhbnktdG8tdGVjaCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyNTUuNzAxLDI1LDI0Ni43MDEsMjEsMjUwLjcwMSwyNSwyNDYuNzAxLDI5LDI1NS43MDEsMjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tbGluayB0ZWNoIHRvIHdvcmtlci0tPjxnIGlkPSJsaW5rX3RlY2hfd29ya2VyIj48cGF0aCBkPSJNMzA0LjI1OCwyNSBDMzE0LjA5OSwyNSAzMjMuOTQsMjUgMzMzLjc4LDI1ICIgZmlsbD0ibm9uZSIgaWQ9InRlY2gtdG8td29ya2VyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjMzOC45MjcsMjUsMzI5LjkyNywyMSwzMzMuOTI3LDI1LDMyOS45MjcsMjksMzM4LjkyNywyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1TUkM9W0FxZkRCYWRDSXl6OUxOVy1QU01wWmtxQU85MU9oNTFRZDVoNExHSU5WUjloLVRGOVpOM1BXZ0J5YkRCYTRjRzVVbmdWeDlXNUx2MlNkcmtHYzVVOWZFMVBMeUVCdmhybTFJTWZvSGI4aWEteERaX2pNbDZZZUhLZ05QdlZiMHJxMDFWODZJMFh0UUJDejhtSU5Ka3VwTDBROEc2cDRLZVo5QzBzV0dXS1NvME0wMDAwXS0tPjwvZz48L3N2Zz4=&quot;&gt;
&lt;p&gt;技能连接着企业与劳动者，用户处于需求链路的最前端，用户的需求决定了产品的形态，产品的形态决定了企业方向和经营方式，也同时决定了依赖资源的结构(包括对技术类资源的需求)。&lt;/p&gt;
    
    </summary>
    
      <category term="长话" scheme="https://oldchan.net/categories/%E9%95%BF%E8%AF%9D/"/>
    
    
      <category term="思考" scheme="https://oldchan.net/tags/%E6%80%9D%E8%80%83/"/>
    
  </entry>
  
  <entry>
    <title>好的产品?</title>
    <link href="https://oldchan.net/2022/05/05/opinion/good_product/"/>
    <id>https://oldchan.net/2022/05/05/opinion/good_product/</id>
    <published>2022-05-05T08:00:38.000Z</published>
    <updated>2022-07-13T05:12:29.813Z</updated>
    
    <content type="html"><![CDATA[<p><strong>“功能强大”</strong></p><p>追求功能强大，似乎是一种魔咒，存在于专业人士的思维里，理所应当的，功能强大的产品能完成更多的可预料到的功能。</p><p>这种产品的价值，懂的人自然会懂，不懂的人却很难愿意为“多余”的功能支付成本。当缺少替代方案时，或许愿意追加成本，但假如出现了另一款类似功能的产品，并且功能简单到能满足用户需求，相对的，由于功能简单，研发投入的成本也会相应的低一些，需要用户支付的成本也会低一些，这个时候，用户又会怎么选择呢？</p><p>为什么总会做出一款功能强大到超出很多用户需求的产品呢？想想主要原因应该有以下几点</p><ol><li>产品功能足够丰富、强大，可以覆盖到更多的用户群体</li><li>更多专业的功能，能解决很多难度较高的问题</li><li>高端产品售价更高，利润更可观</li></ol><p>基于以上的类似原因，开发者一般会孜孜不倦地在各种专业、多余的功能上投入巨大的精力和成本，那么对于开发者而言，投入的成本又怎么收回呢？</p><a id="more"></a><p><strong>“概念较多、操作复杂、不够便捷”</strong></p><p>接手过一个项目，这个项目的业务层面上定义了很多很专业的概念，任何非专业的人在使用时都会提出大量的疑问，主要是询问类似：“***是什么意思？”之类的问题，项目也有一些对外的使用手册，但使用手册上仍然引用的是很多专业的名词。</p><p>经过如此反复的客户来咨询类似的问题，加上自己也在梳理项目时，发现确实有很多的复杂性概念需要项目的维护人员给出解释。于是与之前的项目负责人进行了一些沟通，得到了一句看似很合理却又不是很自然的一句话：“啊？这么简单，文档都写了，他们还看不懂？”</p><p>“知识的诅咒”，又称“专家盲点”，是一种认知偏差，指人在与他人交流的时候，下意识地假设对方拥有理解所需要的背景知识。在认知传授时，尽可能让自己意识到，对方可能什么都不懂。同样在设计产品时，也需有明确的目标用户定位，给予不同的上手引导，如：新手、使用过类似产品、骨灰级用户等等。</p><p>随着行业的逐步发展，当用户的使用习惯，操作心智也得到了培养之后，产品的引导就会更加容易一些，最开始的Android APP没有很统一的界面交互方案，也是慢慢地才统一到手机屏幕的下方，从此就成为了比较标准的交互布局。</p><p>总之而言，用户在实际使用产品之前，都应该尽可能地精简步骤，保证产品能尽快呈现到用户的面前，在用户心智中，实际使用产品之前的每个额外环节，可能每一个环节都会给产品减一次分。</p><p><strong>“用户成本”</strong></p><p>用户在使用一款产品时，总是期望获得一些东西，如：帮助类功能(主要是通过节省时间，精力，钱等完成某些事)、娱乐方式、比较好奇的内容、欢乐的心情、重要信息等等。</p><p>用户获取这些产品带来的效果的过程中，总是要付出一些时间，精力，钱财或者其他，这些都是用户的成本，而且投入越多，产品在用户心智中的价值需要大于或等于用户付出的成本，否则用户是不会那么乐意买单的。</p><p>用户对于产品的成本支出止于需求得到满足，更多的功能带来的多余成本支出，并非所有用户都愿意支付这部分溢价。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;“功能强大”&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;追求功能强大，似乎是一种魔咒，存在于专业人士的思维里，理所应当的，功能强大的产品能完成更多的可预料到的功能。&lt;/p&gt;
&lt;p&gt;这种产品的价值，懂的人自然会懂，不懂的人却很难愿意为“多余”的功能支付成本。当缺少替代方案时，或许愿意追加成本，但假如出现了另一款类似功能的产品，并且功能简单到能满足用户需求，相对的，由于功能简单，研发投入的成本也会相应的低一些，需要用户支付的成本也会低一些，这个时候，用户又会怎么选择呢？&lt;/p&gt;
&lt;p&gt;为什么总会做出一款功能强大到超出很多用户需求的产品呢？想想主要原因应该有以下几点&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;产品功能足够丰富、强大，可以覆盖到更多的用户群体&lt;/li&gt;
&lt;li&gt;更多专业的功能，能解决很多难度较高的问题&lt;/li&gt;
&lt;li&gt;高端产品售价更高，利润更可观&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;基于以上的类似原因，开发者一般会孜孜不倦地在各种专业、多余的功能上投入巨大的精力和成本，那么对于开发者而言，投入的成本又怎么收回呢？&lt;/p&gt;
    
    </summary>
    
      <category term="长话" scheme="https://oldchan.net/categories/%E9%95%BF%E8%AF%9D/"/>
    
    
  </entry>
  
  <entry>
    <title>互联网络与元宇宙</title>
    <link href="https://oldchan.net/2021/11/17/opinion/internet_and_metaverse/"/>
    <id>https://oldchan.net/2021/11/17/opinion/internet_and_metaverse/</id>
    <published>2021-11-17T04:44:09.000Z</published>
    <updated>2022-07-13T05:12:42.609Z</updated>
    
    <content type="html"><![CDATA[<p>上世纪60年代诞生的ARPANET，最初的目标是为了降低在战争时期，中心化控制机制带来的高风险问题，采用单点互联构建分布式去中心化网络可以大大降低系统风险。</p><p>之后，基于ARPANET的成果又诞生了互联网，用于解决ARPANET无法解决的<strong>“无法做到和个别计算机网络交流”</strong>问题。</p><p>再经过几十年的发展，又陆续诞生了许多基于TCP/IP协议产生的各种网络应用。</p><p>TCP/IP作为标准通信协议，基于TCP/IP协议互联的设备组成的网络即可称之为互联网。近几十年，发展最快的互联网应用莫过于Web网络，让信息分享越来越简单。</p><a id="more"></a><h2 id="元宇宙"><a href="#元宇宙" class="headerlink" title="元宇宙"></a>元宇宙</h2><p><strong>“或称为後設宇宙、形上宇宙、元界、超感空间、虚空间，被用来描述一个未来和去中心化的在线虚拟环境。”</strong></p><p>以上是<a href="https://zh.wikipedia.org/wiki/%E5%85%83%E5%AE%87%E5%AE%99" target="_blank" rel="noopener">维基百科</a>的简单定义，直观体会跟<strong>万物互联</strong>，<strong>全真互联</strong>精髓是一致的，但补充定义上更强调了进一步的交互方案，更像是类似<strong>《头号玩家》</strong>中描述的交互体验。</p><h2 id="始至终"><a href="#始至终" class="headerlink" title="始至终"></a>始至终</h2><p>互联网的发展自始至终的目标都很清晰：提升信息沟通效率，降低成本。如同人与人之间的对话，最低效的沟通莫过于驴唇不对马嘴，生物作为“意识+肢体”结合产生的个体，意识与意识之间需要透过肢体协作才能交流，又或者需要透过外部复杂环境才能交流(地理位置、语种、视听语言障碍等等)，这都是交流的成本。</p><p>互联网的出现之所以普及，在于它能让人足不出户，就可以和任何人交流(电话、短信、微信、QQ)，足不出户就可以和全世界的人一起互动娱乐，学习，乃至生活的方方面面，甚至会有人沉迷于互联网络的虚拟世界中。</p><p>对于商业公司而言，需要新鲜的故事才能满足公司运作的需要，才能更好的发展。但对于科技的发展，元宇宙的当前定义或许还不到最终目标的10%，如果互联网能以最高效的方式连接<strong>「意识」</strong>，最大程度上降低现实世界中的沟通成本，也许就是达到了发展的终极目标，小时候看《黑客帝国》时，就在想，这插一下网线，想做什么就能做什么，想学什么瞬间就会，多爽啊，<strong>脑机交互</strong>始终是未来的一个很大的研究课题。</p><p>想象一下：<strong>人们通过佩戴一个头盔，或者内嵌脑机交互芯片，又或者后脑勺有一个网口，随时随地，连睡觉时依然能保持正常的日常生活(当然是在一个开放的虚拟世界中)，我在地球，你在火星，透过虚拟世界，实现面对面沟通。</strong></p><h2 id="新的变化"><a href="#新的变化" class="headerlink" title="新的变化"></a>新的变化</h2><p>Q：元宇宙与WEB3.0？</p><p>A：元宇宙与WEB3.0是同级别产品，但元宇宙的应用包含的维度更广。</p><p>Q：互联网与元宇宙？</p><p>A：元宇宙的建设包含先前技术的方方面面，元宇宙需要基于现有互联网络进行建设。</p><p>Q：元宇宙只有一个吗？</p><p>A：元宇宙最可能的结构是存在多个，<strong>主宇宙</strong>与<strong>私有宇宙</strong>。</p><p>Q：元宇宙能带来哪些商业变革？</p><p>A：元宇宙会建设成类似平台的模式，用户进入元宇宙的成本不能太高，因此交互设备的价格需要能让大众接受或者付费进入(共享设备或按时计费)。在元宇宙中，会存在虚拟商家，用户与虚拟商家的交互会在现实中得到体现。既然存在多个元宇宙，那用户怎么选择呢，是不是还需要一个导航？</p><h2 id="版本迭代"><a href="#版本迭代" class="headerlink" title="版本迭代"></a>版本迭代</h2><h3 id="v1-0：肢体沟通，面对面沟通"><a href="#v1-0：肢体沟通，面对面沟通" class="headerlink" title="v1.0：肢体沟通，面对面沟通"></a>v1.0：肢体沟通，面对面沟通</h3><p>原始阶段，需要面对面沟通，并且语种能互相识别，或者尽量少的语言视听障碍。</p><p><img src="https://oldchan.net/s1/img/2021/11/17/0199d4dd592bb2d76e3a6968ec769362.png" alt></p><h3 id="v2-0：通信方案、设备，传输介质"><a href="#v2-0：通信方案、设备，传输介质" class="headerlink" title="v2.0：通信方案、设备，传输介质"></a>v2.0：通信方案、设备，传输介质</h3><p>存在中间传输层，如：书信，传信人，留言记录，电话，手机，im软件。</p><p><img src="https://oldchan.net/s1/img/2021/11/17/0b14be023e9f288051e878da40e7f5be.png" alt></p><p><img src="https://oldchan.net/s1/img/2021/11/17/18c526964f97346cc33497443951b9fe.png" alt></p><h3 id="v3-0：VR，视频，语音，仿生技术，增强现实技术"><a href="#v3-0：VR，视频，语音，仿生技术，增强现实技术" class="headerlink" title="v3.0：VR，视频，语音，仿生技术，增强现实技术"></a>v3.0：VR，视频，语音，仿生技术，增强现实技术</h3><p>主要目标是进一步解放手动操作，降低操作性，反馈体验更加真实，并进一步提升通信效率。</p><h4 id="一-操作技术"><a href="#一-操作技术" class="headerlink" title="一. 操作技术"></a>一. 操作技术</h4><ul><li>NLP(支持实时同声交互)</li><li>AI(交互容错)</li><li>肢体动作识别(辅助操作)</li></ul><h4 id="二-反馈技术"><a href="#二-反馈技术" class="headerlink" title="二. 反馈技术"></a>二. 反馈技术</h4><ul><li>VR</li><li>特效模拟</li><li>场景模拟</li><li>感官模拟</li></ul><h4 id="三-辅助技术"><a href="#三-辅助技术" class="headerlink" title="三. 辅助技术"></a>三. 辅助技术</h4><ul><li>3D建模</li></ul><h3 id="v4-0：脑机交互，虚拟世界与现实世界互联"><a href="#v4-0：脑机交互，虚拟世界与现实世界互联" class="headerlink" title="v4.0：脑机交互，虚拟世界与现实世界互联"></a>v4.0：脑机交互，虚拟世界与现实世界互联</h3><p>发展到这个阶段，只需要通过意识，便能完成交互。</p><p>其中最关键的两项技术：一项是<strong>脑机交互技术</strong>，另一项是<strong>高效率的无线通信技术</strong>。</p><h4 id="一-脑机交互技术"><a href="#一-脑机交互技术" class="headerlink" title="一. 脑机交互技术"></a>一. 脑机交互技术</h4><p>解读所有大脑信号，实现意识与世界(虚拟世界或现实世界)的交互，并将结果反馈给大脑。</p><h4 id="二-超长距离高效率的无线通信技术"><a href="#二-超长距离高效率的无线通信技术" class="headerlink" title="二. 超长距离高效率的无线通信技术"></a>二. 超长距离高效率的无线通信技术</h4><p>有线通信技术，在不断扩大规模的情况下，成本也会不断增加，同时也会遇到很多现实世界的局限，未来星际发展，难道要直连一条从地球到火星的网线吗？</p><p><img src="https://oldchan.net/s1/img/2021/11/17/971a1e7f61960521f5f75f471f569f6a.png" alt></p><h3 id="v5-0：《铳梦》，《超验骇客》"><a href="#v5-0：《铳梦》，《超验骇客》" class="headerlink" title="v5.0：《铳梦》，《超验骇客》"></a>v5.0：《铳梦》，《超验骇客》</h3><p>当意识的构成被彻底研究透彻，科技可以对意识加以干扰和修改，配合优于人类意识的AI系统，作为人而存在的个体是否还需要肉体？所有的意识组件都被电子系统替代，如<strong>忒修斯之船</strong>一样，我们还是我们，但我们却也不是原来的我们。</p><p>到这里，我们不经提出几个问题：</p><ol><li>人类还需要生殖繁衍吗？</li><li>人类意识与AI意识怎么共存？</li><li>在虚拟世界中，每一个具备意识的个体，这份意识可能出自人类，也可能是被系统创造出来的？</li><li>在虚拟世界中，由系统创造出来的AI意识是不是原住民？</li></ol><p>很多不错的科幻电影都描述了这些很可能会到来的未来，身体是束缚意识的枷锁，电影《超验骇客》中，<strong>威尔</strong>的意识第一次进入电脑，进入网络中时，感叹，思维从未如此轻松。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;上世纪60年代诞生的ARPANET，最初的目标是为了降低在战争时期，中心化控制机制带来的高风险问题，采用单点互联构建分布式去中心化网络可以大大降低系统风险。&lt;/p&gt;
&lt;p&gt;之后，基于ARPANET的成果又诞生了互联网，用于解决ARPANET无法解决的&lt;strong&gt;“无法做到和个别计算机网络交流”&lt;/strong&gt;问题。&lt;/p&gt;
&lt;p&gt;再经过几十年的发展，又陆续诞生了许多基于TCP/IP协议产生的各种网络应用。&lt;/p&gt;
&lt;p&gt;TCP/IP作为标准通信协议，基于TCP/IP协议互联的设备组成的网络即可称之为互联网。近几十年，发展最快的互联网应用莫过于Web网络，让信息分享越来越简单。&lt;/p&gt;
    
    </summary>
    
      <category term="长话" scheme="https://oldchan.net/categories/%E9%95%BF%E8%AF%9D/"/>
    
    
      <category term="元宇宙" scheme="https://oldchan.net/tags/%E5%85%83%E5%AE%87%E5%AE%99/"/>
    
  </entry>
  
  <entry>
    <title>微服务</title>
    <link href="https://oldchan.net/2021/05/18/arch/microservice/service/"/>
    <id>https://oldchan.net/2021/05/18/arch/microservice/service/</id>
    <published>2021-05-18T10:22:44.000Z</published>
    <updated>2022-06-02T12:47:44.815Z</updated>
    
    <content type="html"><![CDATA[<p><strong>产业分工</strong>是产品成长过程中的必经阶段，但凡产品具有不断壮大的机会，规模也会不断扩大，相应的工艺也会逐渐复杂，这种情况下，<strong>模块化生产</strong>就是必要的生产方式。</p><p>之前在创业群里，有连续创业并成功的大佬就说过：“我们平时买的包子，里面就包含很多道工序，有人负责种麦子，有人负责养猪，有人负责加工面粉，有人负责杀猪，最后早餐店里员工进行产品包装。”</p><p>应用到软件架构，这些内在本质是相通的。随着用户量的不断增长，架构应对的数据规模也会逐渐发生质变，为什么几十年前不会诞生微服务这类概念，因为在那个时候互联网还远远不够目前的规模庞大。</p><a id="more"></a><h2 id="SOA"><a href="#SOA" class="headerlink" title="SOA"></a>SOA</h2><p>SOA(Service-Oriented Architecture)是一种支持面向服务的架构风格，定义了将业务功能服务化的架构思想，但从各种材料中，都只看到<strong>“粗粒度，松耦合”</strong>的描述和一直被诟病的<strong>ESB</strong>组件。</p><p>SOA提出了服务化分工协作的思想，将完整的集中式架构进行了拆分，但在具体实现过程中，又保留了对现有系统的复用要求，因此才有ESB的存在，相比后来出现的微服务架构，SOA在整体架构上，有着服务化的理念却不够彻底。</p><h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><p>相比于SOA，很多有一定经验的架构师在最初接触微服务时，都会觉得两者在整体上何其相似。</p><p>在一篇技术文章里，有这么一段总结：</p><p>“SOA的服务拆分建立在已有系统的基础上，不打破原有系统的整体架构，在接口集成时做的接口服务粒度的拆分，SOA架构通过对已有业务或系统的梳理来发现可提供复用的系统组件或功能，并统一通过Webservice来暴露接口。而目前流行的微服务架构的微服务组件的拆分则是将现有系统和业务重构，按照微服务的设计思路，将业务或系统打散成单个微服务组件，并基于微服务组件进行集成和组装编排，来生成全新的单体应用。”</p><p>由此看来，SOA架构实际上是集中式架构向服务化架构演化的过渡阶段，这种架构在短期阶段更适合已具备一定规模的企业，能快速继承现有业务系统，实现快速上线。</p><p>微服务架构包含的基本设施一般可以规划为以下几个分类：</p><h3 id="链路治理"><a href="#链路治理" class="headerlink" title="链路治理"></a>链路治理</h3><p>从集中式架构演化成服务化架构，必然会带来链路问题，由于微服务架构的各个服务都具备单独治理/部署的能力，导致原本集中式架构中能够确保的通信质量，在微服务架构中就难以得到相同指标的保障，因此微服务基础设施中，链路层的组件相对其他分类要多一些。</p><p>服务发现、路由、跟踪、监控、容错，这几类关键技术会一直围绕着链路层不断展开。</p><h3 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h3><p>与SOA架构不同的设计在于，微服务对通信和链路的要求更加轻量，服务与服务之间通过统一的协议进行数据交换，一般会采用RPC方式进行通信，早期不少企业也会直接采用HTTP协议进行通信。</p><h3 id="统一网关"><a href="#统一网关" class="headerlink" title="统一网关"></a>统一网关</h3><p>所有的服务相互协作，共同组织成一个完整的产品架构，由统一的网关负责对外提供产品服务，负责鉴权等等。</p><h3 id="工程自动化"><a href="#工程自动化" class="headerlink" title="工程自动化"></a>工程自动化</h3><p>由于产品规模的扩大，服务的拆分，人工测试与部署存在明显的效率低下问题。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;产业分工&lt;/strong&gt;是产品成长过程中的必经阶段，但凡产品具有不断壮大的机会，规模也会不断扩大，相应的工艺也会逐渐复杂，这种情况下，&lt;strong&gt;模块化生产&lt;/strong&gt;就是必要的生产方式。&lt;/p&gt;
&lt;p&gt;之前在创业群里，有连续创业并成功的大佬就说过：“我们平时买的包子，里面就包含很多道工序，有人负责种麦子，有人负责养猪，有人负责加工面粉，有人负责杀猪，最后早餐店里员工进行产品包装。”&lt;/p&gt;
&lt;p&gt;应用到软件架构，这些内在本质是相通的。随着用户量的不断增长，架构应对的数据规模也会逐渐发生质变，为什么几十年前不会诞生微服务这类概念，因为在那个时候互联网还远远不够目前的规模庞大。&lt;/p&gt;
    
    </summary>
    
      <category term="架构" scheme="https://oldchan.net/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="微服务" scheme="https://oldchan.net/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>配置服务迁移</title>
    <link href="https://oldchan.net/2021/04/06/arch/middleware/configuration/"/>
    <id>https://oldchan.net/2021/04/06/arch/middleware/configuration/</id>
    <published>2021-04-06T10:22:44.000Z</published>
    <updated>2022-07-08T12:58:19.475Z</updated>
    
    <content type="html"><![CDATA[<p>关于迁移配置服务，早在2019年就有过计划，不过当时正忙于重构系统，所以也只在新系统里用过<code>qcm</code>，而在那时，考虑公司内部有太多的老项目，下线<code>qconf</code>时间自然就延期了。</p><p>去年云平台邮件通知，配置服务需要迁移，老版本的<code>qconf</code>需要下线，机房也要清退了，只能将现有手里项目都改用qcm。</p><a id="more"></a><h2 id="QConf与QCM"><a href="#QConf与QCM" class="headerlink" title="QConf与QCM"></a>QConf与QCM</h2><h3 id="QConf"><a href="#QConf" class="headerlink" title="QConf"></a>QConf</h3><p>“QConf是一个集中式配置管理工具，能实现配置信息对业务的完全透明化。”</p><p><strong>特点</strong></p><ul><li>基于<code>zookeeper</code></li><li>需要安装<code>agent</code>进程</li></ul><h3 id="QCM"><a href="#QCM" class="headerlink" title="QCM"></a>QCM</h3><p>“是一款在分布式架构环境中对应用配置进行集中管理和及时推送的服务。”</p><p><strong>特点</strong></p><ul><li>基于<code>etcd</code></li><li>在易用性方面相较<code>qconf</code>多了更多的改进</li><li>废弃<code>qconf</code>结构中使用的<code>agent</code>进程，改用扩展模块嵌入服务模式</li></ul><h2 id="前期调研的部分问题"><a href="#前期调研的部分问题" class="headerlink" title="前期调研的部分问题"></a>前期调研的部分问题</h2><p><strong>qcm扩展存在偶现不稳定问题</strong></p><p><code>qcm</code>的多种SDK版本都是从同一份lib源代码编译而成，经过SWIG生成各种语言可用的SDK扩展文件，最早在go项目中使用时，也是采用<code>cgo</code>的模式进行引用，但在实际运营过程中，就发现一些小问题，比如断网后，偶现的重连失败，后来也有其他团队同学反馈，进程在引入<code>qcm</code>扩展后，运行时间久了，会有一定概率crash。</p><p><strong>项目中存在大量需要修改的逻辑代码</strong></p><p>现有的很多服务，在接入<code>qconf</code>时，存在规范问题，比如有些逻辑中会直接引用<code>qconf</code>的原生接口，而又有些逻辑中，会单独封装类进行处理。</p><p><strong>使用qconf时就计划要优化的问题</strong></p><p>目前配置服务中，主要存储的都是服务运行期间的各种策略开关、接口校验token、ak/sk之类的数据，在使用<code>qconf</code>存储配置时，虽然本地会有一个<code>agent</code>可以缓存数据，但主要是存储于文件中，在<code>qcm</code>是引入扩展，继承了本地文件缓存的方案，但配置迁移前后会有很大改动。</p><p><strong>qcm.so文件有17M</strong></p><p>容器化部署服务，会去优化镜像的大小，<code>qcm</code>的扩展比服务的基础大小还要大，也没有专门的go代码包。</p><h2 id="系统改进原则"><a href="#系统改进原则" class="headerlink" title="系统改进原则"></a>系统改进原则</h2><ol><li>剥离对特定扩展或环境的依赖，尽量用简单的组件接口进行封装实现，最后是选择用<code>qcm</code>的<code>rest</code>API进行数据读取</li><li>代码逻辑中，对基础组件进行抽象，定义接口，再做迁移时，只需要有合适的具体代码实现即可，而不必修改大量的项目代码</li><li>少量/访问频率较高数据，尽量使用进程缓存</li></ol><h2 id="代码逻辑"><a href="#代码逻辑" class="headerlink" title="代码逻辑"></a>代码逻辑</h2><p>以php版本举例，go版本类似，针对<code>qcm</code>实现了<code>Qcm</code>、<code>QcmCluster</code>的两个模块，一个负责读取<code>qcm</code>节点数据，一个汇总多个<code>Qcm</code>类的实例，主要用于调度和提升数据可用性，调度时，总是优先读取同机房数据，如果出现机房内部网络问题，会尝试读取其他机房数据(内部机房都是光纤直连，延迟在毫秒级)。</p><p><strong>配置接口(php版)</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ConfigInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key, $value)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结构方案"><a href="#结构方案" class="headerlink" title="结构方案"></a>结构方案</h2><p><img src="https://oldchan.net/s1/img/2021/04/17/5000472b3c45a818b12ff3562ed4ef07.png" alt="数据流程图"></p><p><code>r</code>表示读取，<code>w</code>表示写入</p><ol><li>go项目选用开源工具统一管理内存(避免随处定义变量)，用来缓存数据decode之后的结果变量，并且周期性更新，缓存数据不设定过期时间，但上游数据读取失败，会记录错误并告警，读取成功则更新本地缓存</li><li>php中采用<code>apc</code>进行缓存，也是缓存decode之后的数据，同样是避免每一次都需要对原数据进行decode而带来的额外开销，不同的是php环境下，没有使用更新任务，而是在缓存上设置了过期时间，在处理请求时，处罚缓存失效事件，并同时更新<code>apc</code>。php缓存下，没有使用shm特性，数据量不大，内存完全吃的开，也避免多进程处理shm时使用到锁</li><li>redis缓存配置数据，主要是防止<code>qcm</code>故障问题，起到一定的容灾作用</li></ol><h2 id="数据监控"><a href="#数据监控" class="headerlink" title="数据监控"></a>数据监控</h2><p>工作中，遇到过数据不更新或者更新不及时问题，在使用<code>qconf</code>时，就遇到过<code>agent</code>进程异常退出，本地数据不更新问题，而定位问题总是打印出配置数据，人为检查数据是不是最新。</p><p>另一个目的，是希望对数据能做好实时的监控，所以在新的配置数据中，定义了一个数据结构</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ver"</span>: <span class="string">"1617160952"</span>,</span><br><span class="line">    <span class="attr">"format"</span>: <span class="string">"json"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="string">"原始配置"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写入配置时记录版本号，数据在服务中被读取时，可以根据对比版本号，选择是否decode并更新配置数据，也避免重复的配置解析，而目前服务中用到的metrics监控，也专门针对配置设置了指标项，可以在<code>grafana</code>中，实时快捷查看，各节点数据的生效情况，起到数据遥测的作用。</p><p><img src="https://oldchan.net/s1/img/2021/04/14/5b0995b485c903ccd4c612392231dd32.jpg" alt="metrics部分数据"></p><p>在对配置数据增加额外结构时，除了增加版本字段和原始数据结构类型字段外，还有压缩和加密的方法字段，主要是考虑传输问题和共有服务中的数据安全问题。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;关于迁移配置服务，早在2019年就有过计划，不过当时正忙于重构系统，所以也只在新系统里用过&lt;code&gt;qcm&lt;/code&gt;，而在那时，考虑公司内部有太多的老项目，下线&lt;code&gt;qconf&lt;/code&gt;时间自然就延期了。&lt;/p&gt;
&lt;p&gt;去年云平台邮件通知，配置服务需要迁移，老版本的&lt;code&gt;qconf&lt;/code&gt;需要下线，机房也要清退了，只能将现有手里项目都改用qcm。&lt;/p&gt;
    
    </summary>
    
      <category term="架构" scheme="https://oldchan.net/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="中间件" scheme="https://oldchan.net/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>最小化docker镜像(补充内容)</title>
    <link href="https://oldchan.net/2021/03/30/container/docker/minimum_ext/"/>
    <id>https://oldchan.net/2021/03/30/container/docker/minimum_ext/</id>
    <published>2021-03-30T12:58:58.000Z</published>
    <updated>2022-06-02T12:47:44.816Z</updated>
    
    <content type="html"><![CDATA[<p>基于之前写的一篇《最小化docker镜像》做一些补充，对用到的工具，做一些解释和对比。</p><a id="more"></a><h2 id="Go程序构建时的-ldflags编译选项"><a href="#Go程序构建时的-ldflags编译选项" class="headerlink" title="Go程序构建时的-ldflags编译选项"></a>Go程序构建时的<code>-ldflags</code>编译选项</h2><p>构建程序时，引入选项<code>-ldflags=&quot;-w -s&quot;</code>，平均单个文件大小减小20%左右</p><p><strong>Command:</strong> <code>go tool link</code> ↓<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">usage: link [options] main.o</span><br><span class="line">  -B note</span><br><span class="line">    add an ELF NT_GNU_BUILD_ID note when using ELF</span><br><span class="line">  -E entry</span><br><span class="line">    <span class="keyword">set</span> entry symbol <span class="keyword">name</span></span><br><span class="line">  -H <span class="keyword">type</span></span><br><span class="line">    <span class="keyword">set</span> header <span class="keyword">type</span></span><br><span class="line">  -I linker</span><br><span class="line">    <span class="keyword">use</span> linker <span class="keyword">as</span> ELF dynamic linker</span><br><span class="line">  -L <span class="keyword">directory</span></span><br><span class="line">    <span class="keyword">add</span> specified <span class="keyword">directory</span> <span class="keyword">to</span> <span class="keyword">library</span> <span class="keyword">path</span></span><br><span class="line">  -R quantum</span><br><span class="line">    <span class="keyword">set</span> address rounding quantum (<span class="keyword">default</span> <span class="number">-1</span>)</span><br><span class="line">  -T address</span><br><span class="line">    <span class="keyword">set</span> <span class="built_in">text</span> <span class="keyword">segment</span> address (<span class="keyword">default</span> <span class="number">-1</span>)</span><br><span class="line">  -Vprint <span class="keyword">version</span> <span class="keyword">and</span> <span class="keyword">exit</span></span><br><span class="line">  -X definition</span><br><span class="line">    <span class="keyword">add</span> <span class="keyword">string</span> <span class="keyword">value</span> definition <span class="keyword">of</span> the <span class="keyword">form</span> importpath.name=<span class="keyword">value</span></span><br><span class="line">  -adisassemble <span class="keyword">output</span></span><br><span class="line">  -buildid <span class="keyword">id</span></span><br><span class="line">    <span class="built_in">record</span> <span class="keyword">id</span> <span class="keyword">as</span> <span class="keyword">Go</span> toolchain <span class="keyword">build</span> <span class="keyword">id</span></span><br><span class="line">  -buildmode <span class="keyword">mode</span></span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">build</span> <span class="keyword">mode</span></span><br><span class="line">  -cdump <span class="keyword">call</span> graph</span><br><span class="line">  -compressdwarf</span><br><span class="line">    <span class="keyword">compress</span> DWARF <span class="keyword">if</span> possible (<span class="keyword">default</span> <span class="literal">true</span>)</span><br><span class="line">  -cpuprofile <span class="keyword">file</span></span><br><span class="line">    write cpu profile <span class="keyword">to</span> <span class="keyword">file</span></span><br><span class="line">  -d<span class="keyword">disable</span> dynamic executable</span><br><span class="line">  -debugtramp <span class="built_in">int</span></span><br><span class="line">    debug trampolines</span><br><span class="line">  -dumpdep</span><br><span class="line">    dump symbol dependency graph</span><br><span class="line">  -extar <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">archive</span> program <span class="keyword">for</span> buildmode=c-<span class="keyword">archive</span></span><br><span class="line">  -extld linker</span><br><span class="line">    <span class="keyword">use</span> linker <span class="keyword">when</span> linking <span class="keyword">in</span> <span class="keyword">external</span> <span class="keyword">mode</span></span><br><span class="line">  -extldflags flags</span><br><span class="line">    pass flags <span class="keyword">to</span> <span class="keyword">external</span> linker</span><br><span class="line">  -f<span class="keyword">ignore</span> <span class="keyword">version</span> mismatch</span><br><span class="line">  -g<span class="keyword">disable</span> <span class="keyword">go</span> <span class="keyword">package</span> <span class="keyword">data</span> checks</span><br><span class="line">  -hhalt <span class="keyword">on</span> <span class="keyword">error</span></span><br><span class="line">  -importcfg <span class="keyword">file</span></span><br><span class="line">    <span class="keyword">read</span> <span class="keyword">import</span> configuration <span class="keyword">from</span> <span class="keyword">file</span></span><br><span class="line">  -installsuffix suffix</span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">package</span> <span class="keyword">directory</span> suffix</span><br><span class="line">  -k symbol</span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">field</span> <span class="keyword">tracking</span> symbol</span><br><span class="line">  -libgcc <span class="keyword">string</span></span><br><span class="line">    compiler support lib <span class="keyword">for</span> internal linking; <span class="keyword">use</span> <span class="string">"none"</span> <span class="keyword">to</span> <span class="keyword">disable</span></span><br><span class="line">  -linkmode <span class="keyword">mode</span></span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">link</span> <span class="keyword">mode</span></span><br><span class="line">  -linkshared</span><br><span class="line">    <span class="keyword">link</span> against installed <span class="keyword">Go</span> <span class="keyword">shared</span> libraries</span><br><span class="line">  -memprofile <span class="keyword">file</span></span><br><span class="line">    write <span class="keyword">memory</span> profile <span class="keyword">to</span> <span class="keyword">file</span></span><br><span class="line">  -memprofilerate rate</span><br><span class="line">    <span class="keyword">set</span> runtime.MemProfileRate <span class="keyword">to</span> rate</span><br><span class="line">  -msan</span><br><span class="line">    <span class="keyword">enable</span> MSan <span class="keyword">interface</span></span><br><span class="line">  -ndump symbol <span class="keyword">table</span></span><br><span class="line">  -o <span class="keyword">file</span></span><br><span class="line">    write <span class="keyword">output</span> <span class="keyword">to</span> <span class="keyword">file</span></span><br><span class="line">  -pluginpath <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">full</span> <span class="keyword">path</span> <span class="keyword">name</span> <span class="keyword">for</span> <span class="keyword">plugin</span></span><br><span class="line">  -r <span class="keyword">path</span></span><br><span class="line">    <span class="keyword">set</span> the ELF dynamic linker <span class="keyword">search</span> <span class="keyword">path</span> <span class="keyword">to</span> dir1:dir2:...</span><br><span class="line">  -race</span><br><span class="line">    <span class="keyword">enable</span> race detector</span><br><span class="line">  -s<span class="keyword">disable</span> symbol <span class="keyword">table</span> // 删除符号表</span><br><span class="line">  -strictdups <span class="built_in">int</span></span><br><span class="line">    sanity <span class="keyword">check</span> <span class="keyword">duplicate</span> symbol <span class="keyword">contents</span> during <span class="keyword">object</span> <span class="keyword">file</span> reading (<span class="number">1</span>=warn <span class="number">2</span>=err).</span><br><span class="line">  -tmpdir <span class="keyword">directory</span></span><br><span class="line">    <span class="keyword">use</span> <span class="keyword">directory</span> <span class="keyword">for</span> <span class="keyword">temporary</span> files</span><br><span class="line">  -u<span class="keyword">reject</span> <span class="keyword">unsafe</span> packages</span><br><span class="line">  -vprint <span class="keyword">link</span> <span class="keyword">trace</span></span><br><span class="line">  -w<span class="keyword">disable</span> DWARF generation // 删除DWARF调试信息</span><br></pre></td></tr></table></figure></p><h2 id="UPX压缩工具"><a href="#UPX压缩工具" class="headerlink" title="UPX压缩工具"></a>UPX压缩工具</h2><p>“<a href="https://upx.github.io/" target="_blank" rel="noopener"><strong>UPX</strong></a> is a free, portable, extendable, high-performance executable packer for several executable formats.”</p><p>源代码: <a href="https://github.com/upx/upx" target="_blank" rel="noopener">https://github.com/upx/upx</a></p><p><strong>Command:</strong> <code>upx --help</code> ↓<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">                       Ultimate Packer for eXecutables</span><br><span class="line">                          Copyright (C) 1996 - 2020</span><br><span class="line">UPX 3.96        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 23rd 2020</span><br><span class="line"></span><br><span class="line">Usage: upx [-123456789dlthVL] [-qvfk] [-o file] file..</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  -<span class="ruby"><span class="number">1</span>     compress faster                   -<span class="number">9</span>    compress better</span></span><br><span class="line"><span class="ruby">  --best compress best (can be slow <span class="keyword">for</span> big files)</span></span><br><span class="line"><span class="ruby">  -d     decompress                        -l    list compressed file</span></span><br><span class="line"><span class="ruby">  -t     test compressed file              -V    display version number</span></span><br><span class="line"><span class="ruby">  -h     give this help                    -L    display software license</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="symbol">Options:</span></span></span><br><span class="line"><span class="ruby">  -q     be quiet                          -v    be verbose</span></span><br><span class="line"><span class="ruby">  -oFILE write output to <span class="string">'FILE'</span></span></span><br><span class="line"><span class="ruby">  -f     force compression of suspicious files</span></span><br><span class="line"><span class="ruby">  --no-color, --mono, --color, --no-progress   change look</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Compression tuning <span class="symbol">options:</span></span></span><br><span class="line"><span class="ruby">  --brute             try all available compression methods &amp; filters [slow]</span></span><br><span class="line"><span class="ruby">  --ultra-brute       try even more compression variants [very slow]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Backup <span class="symbol">options:</span></span></span><br><span class="line"><span class="ruby">  -k, --backup        keep backup files</span></span><br><span class="line"><span class="ruby">  --no-backup         no backup files [default]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Overlay <span class="symbol">options:</span></span></span><br><span class="line"><span class="ruby">  --overlay=copy      copy any extra data attached to the file [default]</span></span><br><span class="line"><span class="ruby">  --overlay=strip     strip any extra data attached to the file [DANGEROUS]</span></span><br><span class="line"><span class="ruby">  --overlay=skip      don<span class="string">'t compress a file with an overlay</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> djgpp2/<span class="symbol">coff:</span></span></span><br><span class="line"><span class="ruby">  --coff              produce COFF output [<span class="symbol">default:</span> EXE]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> dos/<span class="symbol">com:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8086</span>              make compressed com work on any <span class="number">8086</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> dos/<span class="symbol">exe:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8086</span>              make compressed exe work on any <span class="number">8086</span></span></span><br><span class="line"><span class="ruby">  --no-reloc          put no relocations <span class="keyword">in</span> to the exe header</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> dos/<span class="symbol">sys:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8086</span>              make compressed sys work on any <span class="number">8086</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> ps1/<span class="symbol">exe:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8</span>-bit             uses <span class="number">8</span> bit size compression [<span class="symbol">default:</span> <span class="number">32</span> bit]</span></span><br><span class="line"><span class="ruby">  --<span class="number">8</span>mib-ram          <span class="number">8</span> megabyte memory limit [<span class="symbol">default:</span> <span class="number">2</span> MiB]</span></span><br><span class="line"><span class="ruby">  --boot-only         disables client/host transfer compatibility</span></span><br><span class="line"><span class="ruby">  --no-align          don<span class="string">'t align to 2048 bytes [enables: --console-run]</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> watcom/<span class="symbol">le:</span></span></span><br><span class="line"><span class="ruby">  --le                produce LE output [<span class="symbol">default:</span> EXE]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> win32/pe, win64/pe, rtm32/pe &amp; arm/<span class="symbol">pe:</span></span></span><br><span class="line"><span class="ruby">  --compress-exports=<span class="number">0</span>    <span class="keyword">do</span> <span class="keyword">not</span> compress the export section</span></span><br><span class="line"><span class="ruby">  --compress-exports=<span class="number">1</span>    compress the export section [default]</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">0</span>      <span class="keyword">do</span> <span class="keyword">not</span> compress any icons</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">1</span>      compress all but the first icon</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">2</span>      compress all but the first icon directory [default]</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">3</span>      compress all icons</span></span><br><span class="line"><span class="ruby">  --compress-resources=<span class="number">0</span>  <span class="keyword">do</span> <span class="keyword">not</span> compress any resources at all</span></span><br><span class="line"><span class="ruby">  --keep-resource=list    <span class="keyword">do</span> <span class="keyword">not</span> compress resources specified by list</span></span><br><span class="line"><span class="ruby">  --strip-relocs=<span class="number">0</span>        <span class="keyword">do</span> <span class="keyword">not</span> strip relocations</span></span><br><span class="line"><span class="ruby">  --strip-relocs=<span class="number">1</span>        strip relocations [default]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> linux/<span class="symbol">elf:</span></span></span><br><span class="line"><span class="ruby">  --preserve-build-id     copy .gnu.note.build-id to compressed output</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">file..   executables to (de)compress</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">This version <span class="symbol">supports:</span></span></span><br><span class="line"><span class="ruby">    amd64-darwin.dylib                   dylib/amd64</span></span><br><span class="line"><span class="ruby">    amd64-darwin.macho                   macho/amd64</span></span><br><span class="line"><span class="ruby">    amd64-linux.elf                      linux/amd64</span></span><br><span class="line"><span class="ruby">    amd64-linux.kernel.vmlinux           vmlinux/amd64</span></span><br><span class="line"><span class="ruby">    amd64-win64.pe                       win64/pe</span></span><br><span class="line"><span class="ruby">    arm-darwin.macho                     macho/arm</span></span><br><span class="line"><span class="ruby">    arm-linux.elf                        linux/arm</span></span><br><span class="line"><span class="ruby">    arm-linux.kernel.vmlinux             vmlinux/arm</span></span><br><span class="line"><span class="ruby">    arm-linux.kernel.vmlinuz             vmlinuz/arm</span></span><br><span class="line"><span class="ruby">    arm-wince.pe                         arm/pe</span></span><br><span class="line"><span class="ruby">    arm64-darwin.macho                   macho/arm64</span></span><br><span class="line"><span class="ruby">    arm64-linux.elf                      linux/arm64</span></span><br><span class="line"><span class="ruby">    armeb-linux.elf                      linux/armeb</span></span><br><span class="line"><span class="ruby">    armeb-linux.kernel.vmlinux           vmlinux/armeb</span></span><br><span class="line"><span class="ruby">    fat-darwin.macho                     macho/fat</span></span><br><span class="line"><span class="ruby">    i086-dos16.com                       dos/com</span></span><br><span class="line"><span class="ruby">    i086-dos16.exe                       dos/exe</span></span><br><span class="line"><span class="ruby">    i086-dos16.sys                       dos/sys</span></span><br><span class="line"><span class="ruby">    i386-bsd.elf.execve                  bsd.exec/i386</span></span><br><span class="line"><span class="ruby">    i386-darwin.macho                    macho/i386</span></span><br><span class="line"><span class="ruby">    i386-dos32.djgpp2.coff               djgpp2/coff</span></span><br><span class="line"><span class="ruby">    i386-dos32.tmt.adam                  tmt/adam</span></span><br><span class="line"><span class="ruby">    i386-dos32.watcom.le                 watcom/le</span></span><br><span class="line"><span class="ruby">    i386-freebsd.elf                     freebsd/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.elf                       linux/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.elf.execve                linux.exec/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.elf.shell                 linux.sh/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.kernel.bvmlinuz           bvmlinuz/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.kernel.vmlinux            vmlinux/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.kernel.vmlinuz            vmlinuz/i386</span></span><br><span class="line"><span class="ruby">    i386-netbsd.elf                      netbsd/i386</span></span><br><span class="line"><span class="ruby">    i386-openbsd.elf                     openbsd/i386</span></span><br><span class="line"><span class="ruby">    i386-win32.pe                        win32/pe</span></span><br><span class="line"><span class="ruby">    m68k-atari.tos                       atari/tos</span></span><br><span class="line"><span class="ruby">    mips-linux.elf                       linux/mips</span></span><br><span class="line"><span class="ruby">    mipsel-linux.elf                     linux/mipsel</span></span><br><span class="line"><span class="ruby">    mipsel.r300<span class="number">0</span>-ps1                     ps1/exe</span></span><br><span class="line"><span class="ruby">    powerpc-darwin.macho                 macho/ppc32</span></span><br><span class="line"><span class="ruby">    powerpc-linux.elf                    linux/ppc32</span></span><br><span class="line"><span class="ruby">    powerpc-linux.kernel.vmlinux         vmlinux/ppc32</span></span><br><span class="line"><span class="ruby">    powerpc64-linux.elf                  linux/ppc64</span></span><br><span class="line"><span class="ruby">    powerpc64le-darwin.macho             macho/ppc64le</span></span><br><span class="line"><span class="ruby">    powerpc64le-linux.elf                linux/ppc64le</span></span><br><span class="line"><span class="ruby">    powerpc64le-linux.kernel.vmlinux     vmlinux/ppc64le</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">UPX comes with ABSOLUTELY NO WARRANTY; <span class="keyword">for</span> details visit <span class="symbol">https:</span>/<span class="regexp">/upx.github.io</span></span></span><br></pre></td></tr></table></figure></p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>压缩<strong>可执行文件</strong>，压缩后的文件依然是可执行文件，并不影响程序的执行</li><li>老牌压缩软件，稳定，跨平台支持最好</li><li>团队维护，开发人员依然活跃</li><li>压缩比一般在20%-30%，如：10M压缩至3M</li></ul><h2 id="Docker运行镜像"><a href="#Docker运行镜像" class="headerlink" title="Docker运行镜像"></a>Docker运行镜像</h2><h3 id="alpine"><a href="#alpine" class="headerlink" title="alpine"></a>alpine</h3><p>“Alpine Linux是一个面向安全的轻型的Linux发行版,基于Alpine Linux的超小型Docker镜像,大小只有5MB，并且可以访问比其他基于BusyBox的镜像更完整的包存储库。 Alpine Linux采用了 musl libc和busybox以减小系统的体积和运行时资源消耗，由于小巧、功能完备，非常适合用于作为容器的基础镜像。”</p><p><strong>特点</strong></p><ul><li>轻量型linux发行版本，包含基于busybox的一些常用工具集</li><li>初始镜像大小在5M左右</li></ul><h3 id="scratch"><a href="#scratch" class="headerlink" title="scratch"></a>scratch</h3><p>“an explicitly empty image, especially for building images <code>FROM scratch</code>“</p><p><strong>特点</strong></p><ul><li>docker的虚拟镜像，镜像大小接近于0</li><li>通过<code>FROM scratch</code>指令引用，没有真实镜像文件</li></ul><h2 id="关于选择Go服务依赖包"><a href="#关于选择Go服务依赖包" class="headerlink" title="关于选择Go服务依赖包"></a>关于选择Go服务依赖包</h2><p>“选择合适的，功能满足即可，不求大而全”</p><p>例:</p><p>采用一个功能齐全的配置解析包来解析yaml</p><p>服务 &lt; spf13/viper &lt; fsnotify &lt; golang.org/x/sys/unix</p><ul><li>编译大小: 8M</li></ul><p>服务 &lt; yaml.v2</p><ul><li>编译大小: 5M</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;基于之前写的一篇《最小化docker镜像》做一些补充，对用到的工具，做一些解释和对比。&lt;/p&gt;
    
    </summary>
    
      <category term="容器" scheme="https://oldchan.net/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="容器化" scheme="https://oldchan.net/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Go：实现类似class的析构函数</title>
    <link href="https://oldchan.net/2021/02/20/language/go/struct_like_class/"/>
    <id>https://oldchan.net/2021/02/20/language/go/struct_like_class/</id>
    <published>2021-02-20T08:58:58.000Z</published>
    <updated>2022-06-02T12:47:44.817Z</updated>
    
    <content type="html"><![CDATA[<p>Go提供的revicer满足函数简单的method操作结构，但并没有提供构造与析构的机制，在有些场景下，我们仍然需要一些能自动释放资源的逻辑。</p><p>在Go进程模型中，维护了一种叫<code>finalizer</code>的结构，当内存对象不可访问、需要被GC时，GC程序会检查对象关联的<code>finalizer</code>函数，如果有，则调用一次<code>finalizer</code>函数，并移除关联的<code>finalizer</code>函数，然后该对象再次变成可访问状态，当下一次，该对象再次被GC时，便会被释放并回收。</p><p>在<code>runtime</code>包中，对外暴露了一个函数<code>SetFinalizer</code>，用来设置关联的<code>finalizer</code>函数。</p><a id="more"></a><h2 id="函数-runtime-SetFinalizer"><a href="#函数-runtime-SetFinalizer" class="headerlink" title="函数: runtime.SetFinalizer"></a>函数: <code>runtime.SetFinalizer</code></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func SetFinalizer(obj <span class="class"><span class="keyword">interface</span></span>&#123;&#125;, finalizer <span class="class"><span class="keyword">interface</span></span>&#123;&#125;)</span><br></pre></td></tr></table></figure><!--more--><h2 id="构造与析构"><a href="#构造与析构" class="headerlink" title="构造与析构"></a>构造与析构</h2><ol><li>定义<code>Initializer</code>接口，约定初始化函数</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Initializer<span class="built_in"> interface </span>&#123;</span><br><span class="line">Init()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>定义<code>Finalizer</code>接口，约定析构函数</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Finalizer<span class="built_in"> interface </span>&#123;</span><br><span class="line">Delete()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>定义<code>InitObject</code>函数用来初始化对象</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sample: `InitObject(obj)`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitObject</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="comment">// 如果obj实现了Initializer</span></span><br><span class="line"><span class="keyword">if</span> ob, ok := obj.(Initializer); ok &#123;</span><br><span class="line">ob.Init()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果obj实现了Finalizer</span></span><br><span class="line"><span class="keyword">if</span> ob, ok := obj.(Finalizer); ok &#123;</span><br><span class="line">runtime.SetFinalizer(ob, <span class="function"><span class="keyword">func</span><span class="params">(ob Finalizer)</span></span> &#123;</span><br><span class="line">ob.Delete()</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sample <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Sample <span class="keyword">struct</span> &#123;</span><br><span class="line">*sample</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewSample returns a Sample.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSample</span><span class="params">()</span> *<span class="title">Sample</span></span> &#123;</span><br><span class="line"><span class="comment">// Private object</span></span><br><span class="line">s := &amp;sample&#123;&#125;</span><br><span class="line"><span class="comment">// Public object</span></span><br><span class="line">obj := &amp;Sample&#123;s&#125;</span><br><span class="line">&#123;</span><br><span class="line">InitObject(obj)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init方法会在NewSample时，跟随InitObject执行。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sample)</span> <span class="title">Init</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"initialized\n"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete方法会在NewSample返回的obj需要被GC时调用。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sample)</span> <span class="title">Delete</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"deleted\n"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ul><li>如果对象存在循环引用，可能永远都不会被GC</li><li><code>finalizer</code>设置的函数只会在GC时被调用</li><li><code>finalizer</code>函数不适合处理太多耗时逻辑</li><li><code>finalizer</code>函数延长了对象的生命周期，如果不必要，尽量不使用</li></ul><p>我在一些项目中用到了自己封装的包，但只有少部分场景下用到了<code>Delete()</code>。</p><h2 id="代码包：github-com-thecxx-jarvis"><a href="#代码包：github-com-thecxx-jarvis" class="headerlink" title="代码包：github.com/thecxx/jarvis"></a>代码包：<a href="https://github.com/thecxx/jarvis" target="_blank" rel="noopener">github.com/thecxx/jarvis</a></h2>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Go提供的revicer满足函数简单的method操作结构，但并没有提供构造与析构的机制，在有些场景下，我们仍然需要一些能自动释放资源的逻辑。&lt;/p&gt;
&lt;p&gt;在Go进程模型中，维护了一种叫&lt;code&gt;finalizer&lt;/code&gt;的结构，当内存对象不可访问、需要被GC时，GC程序会检查对象关联的&lt;code&gt;finalizer&lt;/code&gt;函数，如果有，则调用一次&lt;code&gt;finalizer&lt;/code&gt;函数，并移除关联的&lt;code&gt;finalizer&lt;/code&gt;函数，然后该对象再次变成可访问状态，当下一次，该对象再次被GC时，便会被释放并回收。&lt;/p&gt;
&lt;p&gt;在&lt;code&gt;runtime&lt;/code&gt;包中，对外暴露了一个函数&lt;code&gt;SetFinalizer&lt;/code&gt;，用来设置关联的&lt;code&gt;finalizer&lt;/code&gt;函数。&lt;/p&gt;
    
    </summary>
    
      <category term="编程" scheme="https://oldchan.net/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="go" scheme="https://oldchan.net/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>最小化docker镜像</title>
    <link href="https://oldchan.net/2020/04/20/container/docker/minimum/"/>
    <id>https://oldchan.net/2020/04/20/container/docker/minimum/</id>
    <published>2020-04-20T08:58:58.000Z</published>
    <updated>2022-07-08T12:58:19.475Z</updated>
    
    <content type="html"><![CDATA[<p>容器化架构方案中，Worker节点启动容器需要获取对应版本的镜像，不管是从本地加载镜像或发布镜像，还是从镜像仓库拉取镜像，镜像越小，越易于传输。</p><p><img src="https://oldchan.net/s1/img/2021/03/25/a7515e192dbb713154406040450b08a2.png" alt="运行镜像大小"></p><a id="more"></a><h2 id="如何构建最小化容器镜像？"><a href="#如何构建最小化容器镜像？" class="headerlink" title="如何构建最小化容器镜像？"></a>如何构建最小化容器镜像？</h2><h3 id="服务程序足够小"><a href="#服务程序足够小" class="headerlink" title="服务程序足够小"></a>服务程序足够小</h3><p>在编译服务程序时，大部分研发同学都会选择默认的方案进行编译，但对于go编程程序而言，还是有更多的优化空间的。</p><ol><li><strong>优化编译选项</strong></li></ol><ul><li>如果能不使用cgo尽量不使用，如果一定要使用cgo的情况下尽量使用静态编译</li><li>go build是可以采用-ldflags=”-w -s”选项去掉调试信息与符号表<ul><li>-w：去掉调试信息，得到的程序就不能用gdb调试</li><li>-s：去掉符号表，panic时候的stack trace就没有任何文件名/行号信息</li></ul></li></ul><ol start="2"><li><strong>使用压缩壳</strong></li></ol><ul><li>网上看到很多优化镜像大小的文章，但是，从来没有看到有人提到用压缩壳的方案，也许是因为自己以前有写过压缩壳和脱壳的经历，最后选用了老牌的UPX进行压缩(主要是发现居然有linux版本的UPX)，压缩比一般在20~30%左右，但有一个问题，压缩后的程序，导入符号表被加密了，无法在压缩后ldd出依赖库，当有依赖库需要一起部署时，需要在压缩前提取</li><li>如果采用压缩壳，建议在编译阶段，尽量都采用静态编译，这样打包在程序内部的依赖库也能被压缩</li><li>经过压缩的程序，启动运行时会比未压缩程序稍慢，在程序大小20M-30M左右时，直观感觉能延迟0.2秒</li></ul><p><img src="https://oldchan.net/s1/img/2021/03/25/df56510465acf8ae5abcf551916e72fc.png" alt="UPX压缩指标"></p><h3 id="镜像本身运行的基本环境足够小"><a href="#镜像本身运行的基本环境足够小" class="headerlink" title="镜像本身运行的基本环境足够小"></a>镜像本身运行的基本环境足够小</h3><p>优化镜像，可以在构建镜像时，分成两阶段处理，第一个阶段：<code>构建环境</code>，第二个阶段：<code>运行环境</code>。</p><ol><li><strong>构建环境</strong></li></ol><p>主要用于构建程序使用，一般是提前构建好的成套环境，事先安装好了一系列构建环节必备的工具，如：gcc、go、glibc等等，保证程序编译正确，而且构建镜像可以作为通用构建镜像使用。</p><ol start="2"><li><strong>运行环境</strong></li></ol><p>主要在构建结束后，将必要的服务程序与依赖文件复制到运行镜像中，最终将运行镜像打包提交至仓库，而运行镜像可采用scratch空镜像作为基础镜像构建，确保系统环境最小化。</p><h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><table><thead><tr><th>—</th><th style="text-align:center">build</th><th style="text-align:center">build -ldflags=’-w’</th><th style="text-align:center">upx -9</th></tr></thead><tbody><tr><td>程序文件</td><td style="text-align:center">33M</td><td style="text-align:center">28M</td><td style="text-align:center">8.8M</td></tr><tr><td>镜像大小</td><td style="text-align:center">37M</td><td style="text-align:center">32M</td><td style="text-align:center">12M</td></tr></tbody></table><p>镜像本身的大小在3~4M左右，当程序编译时，若采用’-s’编译选项，程序文件能进一步缩小化到25M左右，但再经过UPX压缩却效果不明显，最多只能进一步压到8M大小，而日常工作中，会需要保留一些日志数据，所以一般都只使用’-w’编译选项。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;容器化架构方案中，Worker节点启动容器需要获取对应版本的镜像，不管是从本地加载镜像或发布镜像，还是从镜像仓库拉取镜像，镜像越小，越易于传输。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://oldchan.net/s1/img/2021/03/25/a7515e192dbb713154406040450b08a2.png&quot; alt=&quot;运行镜像大小&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="容器" scheme="https://oldchan.net/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="容器化" scheme="https://oldchan.net/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>CPU的时间观念</title>
    <link href="https://oldchan.net/2020/03/11/os/cpu_and_time_management/"/>
    <id>https://oldchan.net/2020/03/11/os/cpu_and_time_management/</id>
    <published>2020-03-11T08:26:21.000Z</published>
    <updated>2022-07-08T12:58:19.475Z</updated>
    
    <content type="html"><![CDATA[<p>“Next”</p><p>“Next”</p><p>“Next”</p><p>“…”</p><p>对于CPU而言，存在的唯一意义就是永无休止地执行下一条指令和各种Jump，就像一个没有灵魂的时间管理大师一样，从每一次机器被启动开始便周而复始地践行着自己的使命：<strong>让系统里没有难做的任务</strong>。</p><h2 id="CPU，系统与应用"><a href="#CPU，系统与应用" class="headerlink" title="CPU，系统与应用"></a>CPU，系统与应用</h2><p>CPU：CPU的时间很紧张，以单核CPU为例，CPU自始至终只能执行一个任务，也并不会在意具体是谁的任务，可能是系统的任务，也有可能是某个应用的任务，只需要保证执行的指令都在物理内存上即可。</p><p>系统：系统组织软件与硬件资源，给应用提供一个稳定的环境来执行用户交代的任务。</p><p>应用：用户的任务逻辑经过编译器处理，由源代码翻译成机器码，并静态地保存在应用程序文件中，当系统执行应用程序时，会根据应用中的初始设置，将应用加载到内存中并执行。</p><h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>为满足多道编程，提高CPU的利用率，系统引入进程概念对任务资源进行管理。</p><p>系统每执行一次应用，就会创建一个进程，并将应用的静态机器码加载到进程的内存中，再从程序入口开始执行。</p><p>进程是应用执行过程中的真正实体，资源的容器。</p><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p><strong>线程是CPU的基本执行单位</strong>，同一个进程中可以包含一个或多个线程，多个线程共享进程的各种资源。除此之外，线程也具备一些独立维护的资源，如：调用栈，寄存器上下文，TLS等等。</p><p>将线程做为基本执行单元引入系统，能很大程度上降低进程级切换带来的性能开销，在很多操作系统中线程又被称之为<strong>轻量级进程</strong>，除了性能方面的改善之外，也为应用提供了并行执行任务的能力。</p><h2 id="线程切换"><a href="#线程切换" class="headerlink" title="线程切换"></a>线程切换</h2><p>“A thread is a path of execution within a process. A process can contain multiple threads.”</p><p>这是一篇技术文章中对于线程概念的总结，进程中包含应用的所有任务指令，线程可以从进程中任意可执行的内存位置开始执行指令。</p><p>假如某应用中存在类似如下几个函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_fun_A</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = get_a();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a + b = %d\n"</span>, a, <span class="number">11</span>, sum(a, <span class="number">11</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_fun_B</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = get_a();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a * b = %d\n"</span>, a, <span class="number">11</span>, mul(a, <span class="number">11</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mul</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_a</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>应用从main函数启动，分别创建了线程A从<code>thread_fun_A</code>开始执行和线程B从<code>thread_fun_B</code>开始执行，那两线程的执行路径分别是：</p><p>线程A：<code>thread_fun_A()</code>-&gt;<code>get_a()</code>-&gt;<code>sum()</code>-&gt;<code>printf()</code></p><p>线程B：<code>thread_fun_B()</code>-&gt;<code>get_a()</code>-&gt;<code>mul()</code>-&gt;<code>printf()</code></p><p>线程作为<strong>执行路径</strong>存在于系统的各进程和内核中，CPU作为执行人，需要频繁改变执行路径，时而在内核线程，时而在应用线程。</p><p><strong>那么，多线程系统中，CPU是怎么切换线程的呢？</strong></p><h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><p>系统一般会开放给应用程序很多有用的服务接口，应用基于这些接口可以实现很多有用的功能，比如最常见的读写文件，连接网络等等。</p><p>假如应用程序在执行某一个线程时，遇到需要写文件的操作，并且写的数据量较大，由于磁盘的性能弱于CPU，这时，在执行类似<code>fwrite</code>时，CPU就需要在内核调用中进入等待状态，等待磁盘操作完毕。很明显，这种情况下，CPU的使用率会明显下降，为了保证尽量少的出现这种情况，系统会挂起当前线程，并通过调度算法选择其他已就绪的线程供CPU继续执行，此时CPU的执行路径就发生了变化。</p><h3 id="放弃调度"><a href="#放弃调度" class="headerlink" title="放弃调度"></a>放弃调度</h3><p>跟系统调用类似，假如线程在执行过程中，并不需要调用系统执行具体功能，而是休眠一段时间或者等待某个信号产生再继续执行，会有类似<code>sleep</code>或<code>wait***</code>之类的系统接口调用，并进入挂起状态，此时CPU就会去执行其他就绪线程。</p><h3 id="时钟中断"><a href="#时钟中断" class="headerlink" title="时钟中断"></a>时钟中断</h3><p>有时，线程只需要执行某些算法代码，并不需要调用系统接口，假如算法复杂度较高，耗时较长，此时，CPU怎么保证执行线程时，不会被线程占用太多时间呢？因为其他线程的时间也是很宝贵的，CPU需要保证所有线程都能公平的被CPU执行。</p><p>为了防止CPU沉迷于某一个线程，系统在初始化的时候会初始化一个可编程的中断时钟，用来在线程执行超时时，向CPU产生一个中断，从而让CPU能够暂停线程的执行工作，回到内核，并调度其他线程。</p><hr><p><img src="https://oldchan.net/s1/img/2021/11/22/3892c458c06780d2c340c11ec505eeec.png" alt></p><p>CPU：“只要我够快，所有的线程都能得到满足😌”</p><p>进程：“我拥有应用执行过程中的所有资源，包括内存，句柄，线程执行路径等等”</p><p>线程：“我是进程的其中一条执行路径，CPU会按照我的指令执行”</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;“Next”&lt;/p&gt;
&lt;p&gt;“Next”&lt;/p&gt;
&lt;p&gt;“Next”&lt;/p&gt;
&lt;p&gt;“…”&lt;/p&gt;
&lt;p&gt;对于CPU而言，存在的唯一意义就是永无休止地执行下一条指令和各种Jump，就像一个没有灵魂的时间管理大师一样，从每一次机器被启动开始便周而复始地践行着自己的使命：&lt;st
      
    
    </summary>
    
      <category term="系统" scheme="https://oldchan.net/categories/%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="cpu" scheme="https://oldchan.net/tags/cpu/"/>
    
  </entry>
  
  <entry>
    <title>Redis：hash</title>
    <link href="https://oldchan.net/2018/09/23/notes/redis/type_hash/"/>
    <id>https://oldchan.net/2018/09/23/notes/redis/type_hash/</id>
    <published>2018-09-23T13:04:02.000Z</published>
    <updated>2022-06-02T12:47:44.822Z</updated>
    
    <content type="html"><![CDATA[<p>hash数据结构在redis缓存中应用比较广泛，一般数据集合都会采用hash结构来进行存储，比如: session数据、在线用户记录等等。</p><a id="more"></a><h2 id="hash的创建"><a href="#hash的创建" class="headerlink" title="hash的创建"></a>hash的创建</h2><p>使用hash时最常使用hset用来设置字段(“/src/t_hash.c”文件中)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hsetCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, created = <span class="number">0</span>;</span><br><span class="line">    robj *o;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((c-&gt;argc % <span class="number">2</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">"wrong number of arguments for HMSET"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((o = hashTypeLookupWriteOrCreate(c,c-&gt;argv[<span class="number">1</span>])) == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    hashTypeTryConversion(o,c-&gt;argv,<span class="number">2</span>,c-&gt;argc<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; c-&gt;argc; i += <span class="number">2</span>)</span><br><span class="line">        created += !hashTypeSet(o,c-&gt;argv[i]-&gt;ptr,c-&gt;argv[i+<span class="number">1</span>]-&gt;ptr,HASH_SET_COPY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* HMSET (deprecated) and HSET return value is different. */</span></span><br><span class="line">    <span class="keyword">char</span> *cmdname = c-&gt;argv[<span class="number">0</span>]-&gt;ptr;</span><br><span class="line">    <span class="keyword">if</span> (cmdname[<span class="number">1</span>] == <span class="string">'s'</span> || cmdname[<span class="number">1</span>] == <span class="string">'S'</span>) &#123;</span><br><span class="line">        <span class="comment">/* HSET */</span></span><br><span class="line">        addReplyLongLong(c, created);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* HMSET */</span></span><br><span class="line">        addReply(c, shared.ok);</span><br><span class="line">    &#125;</span><br><span class="line">    signalModifiedKey(c-&gt;db,c-&gt;argv[<span class="number">1</span>]);</span><br><span class="line">    notifyKeyspaceEvent(NOTIFY_HASH,<span class="string">"hset"</span>,c-&gt;argv[<span class="number">1</span>],c-&gt;db-&gt;id);</span><br><span class="line">    server.dirty++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>hset执行时，首先会检查k-v对的数量是否匹配</li><li>然后查询客户端对应的当前db，查找key对应结构(没有则创建一个ziplist的结构对象)</li><li>获取到结果，再通过<code>hashTypeTryConversion</code>函数尝试转换为dict结构(根据参数值大小决定)</li><li><code>hsetCommand</code>结构根据参数的数量，可以同时支持<code>hset</code>与<code>hmset</code></li></ul><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>参考: <a href="http://redisdoc.com/hash/index.html" target="_blank" rel="noopener">Hash</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;hash数据结构在redis缓存中应用比较广泛，一般数据集合都会采用hash结构来进行存储，比如: session数据、在线用户记录等等。&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="redis" scheme="https://oldchan.net/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>PE文件加载器</title>
    <link href="https://oldchan.net/2018/09/10/os/windows/pe_loader/"/>
    <id>https://oldchan.net/2018/09/10/os/windows/pe_loader/</id>
    <published>2018-09-10T13:39:49.000Z</published>
    <updated>2022-06-02T12:47:44.823Z</updated>
    
    <content type="html"><![CDATA[<p>分享一份自己之前总结以前的代码写的dll内存加载库C++版本<strong>项目要自行编译生成lib文件</strong></p><p>支持：</p><ol><li>Win32标准Dll </li><li>MFC Dll </li><li>易语言Dll </li><li>其他环境下生成的Dll<br><strong>但</strong> 不能加壳加密(原因跟加载方式有关，未添加至进程模块链表)</li></ol><a id="more"></a><h2 id="部分代码"><a href="#部分代码" class="headerlink" title="部分代码"></a>部分代码</h2><p>File: include/ldr.h<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* __ldr_header__ */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __LDR_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __LDR_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"image.d.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"image.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinNT.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> Current platform is not supported</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">PVOID</span> <span class="params">(__stdcall *<span class="keyword">malloc_t</span>)</span> <span class="params">(ULONG)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span>  <span class="params">(__stdcall *<span class="keyword">free_t</span>)</span>   <span class="params">(PVOID)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">PVOID   <span class="title">LdrLoadImage</span>      <span class="params">(PVOID Buffer, DWORD Size, <span class="keyword">malloc_t</span> m = <span class="literal">NULL</span>, <span class="keyword">free_t</span> f = <span class="literal">NULL</span>)</span></span>;</span><br><span class="line"><span class="function">PVOID   <span class="title">LdrGetProcAddress</span> <span class="params">(PVOID Addr, LPCSTR Name)</span></span>;</span><br><span class="line"><span class="function">VOID    <span class="title">LdrFreeImage</span>      <span class="params">(PVOID Addr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p><p>File: image/traps/GetModuleHandleW.asm</p><p>加入汇编代码主要是为了做中间层hook处理，否则非正常加载的模块部分接口不可用</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.386</span></span><br><span class="line"><span class="meta">.Model</span> flat, StdCall</span><br><span class="line"><span class="meta">Option</span> CaseMap: none</span><br><span class="line"> </span><br><span class="line">Include    trap.inc</span><br><span class="line"> </span><br><span class="line"><span class="meta">.Const</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">.Data</span>?</span><br><span class="line"> </span><br><span class="line"><span class="meta">.Data</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">.Code</span></span><br><span class="line"> </span><br><span class="line">GetModuleHandleWTrap Proc Uses <span class="built_in">Ebx</span> <span class="built_in">Ecx</span> <span class="built_in">Edx</span> <span class="built_in">Esi</span> <span class="built_in">Edi</span>, lpModuleName: <span class="built_in">Ptr</span> WCHAR</span><br><span class="line">    <span class="comment">; Mov Esi, 0x********</span></span><br><span class="line">    Mov_Esi_Information</span><br><span class="line">    <span class="comment">; Pointer to ImageInformation</span></span><br><span class="line">    <span class="meta">Assume</span> <span class="built_in">Esi</span>: <span class="built_in">Ptr</span> ImageInformation</span><br><span class="line"> </span><br><span class="line"><span class="meta">    .If</span> lpModuleName == <span class="number">0</span></span><br><span class="line">        <span class="keyword">Push</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].traps[SizeOf ImageTrap * TRAP_ID_GET_MODULE_HANDLE_W].procedure</span><br><span class="line"><span class="meta">    .Else</span></span><br><span class="line">        <span class="keyword">Lea</span> <span class="built_in">Ebx</span>, [<span class="built_in">Esi</span>].ModuleNameW</span><br><span class="line">        <span class="keyword">Push</span> <span class="built_in">Ebx</span></span><br><span class="line">        <span class="keyword">Push</span> lpModuleName</span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].apis.lstrcmpiW</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Cmp</span> <span class="built_in">Eax</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">Je</span> __COPY</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Lea</span> <span class="built_in">Ebx</span>, [<span class="built_in">Esi</span>].ModuleBaseNameW</span><br><span class="line">        <span class="keyword">Push</span> <span class="built_in">Ebx</span></span><br><span class="line">        <span class="keyword">Push</span> lpModuleName</span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].apis.lstrcmpiW  </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Cmp</span> <span class="built_in">Eax</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">Jne</span> __<span class="keyword">CALL</span></span><br><span class="line"> </span><br><span class="line"><span class="symbol">    __COPY:</span></span><br><span class="line">        <span class="keyword">Mov</span> <span class="built_in">Eax</span>, [<span class="built_in">Esi</span>].imagebase</span><br><span class="line">        <span class="keyword">Jmp</span> @F</span><br><span class="line"> </span><br><span class="line"><span class="symbol">    __CALL:</span>   </span><br><span class="line">        <span class="keyword">Push</span> lpModuleName</span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].traps[SizeOf ImageTrap * TRAP_ID_GET_MODULE_HANDLE_W].procedure</span><br><span class="line">    @@:</span><br><span class="line"><span class="meta">    .EndIf</span></span><br><span class="line"> </span><br><span class="line">    Return <span class="built_in">Eax</span></span><br><span class="line">GetModuleHandleWTrap EndP</span><br><span class="line"> </span><br><span class="line">End</span><br></pre></td></tr></table></figure><h2 id="使用接口-对应关系"><a href="#使用接口-对应关系" class="headerlink" title="使用接口(对应关系)"></a>使用接口(对应关系)</h2><ul><li>LdrLoadImage      = LoadLibrary</li><li>LdrGetProcAddress = GetProcAddress</li><li>LdrFreeImage      = FreeLibrary</li></ul><h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a href="https://github.com/kamichan/image" target="_blank" rel="noopener">https://github.com/thecxx/image</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;分享一份自己之前总结以前的代码写的dll内存加载库C++版本&lt;strong&gt;项目要自行编译生成lib文件&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;支持：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Win32标准Dll &lt;/li&gt;
&lt;li&gt;MFC Dll &lt;/li&gt;
&lt;li&gt;易语言Dll &lt;/li&gt;
&lt;li&gt;其他环境下生成的Dll&lt;br&gt;&lt;strong&gt;但&lt;/strong&gt; 不能加壳加密(原因跟加载方式有关，未添加至进程模块链表)&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="系统" scheme="https://oldchan.net/categories/%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="windows" scheme="https://oldchan.net/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>Redis：常用数据结构</title>
    <link href="https://oldchan.net/2018/09/10/notes/redis/types/"/>
    <id>https://oldchan.net/2018/09/10/notes/redis/types/</id>
    <published>2018-09-10T12:56:40.000Z</published>
    <updated>2022-06-02T12:47:44.822Z</updated>
    
    <content type="html"><![CDATA[<p>redis不仅支持最简单的k-v数据，还提供其他多种场景可用的数据结构: hash/list/set/zset等等。</p><ul><li><strong><a href="/2018/09/23/redis/type_hash/">hash</a></strong></li><li><strong><a href="#">list</a></strong></li><li><strong><a href="#">set</a></strong></li><li><strong><a href="#">zset</a></strong></li></ul><a id="more"></a><h2 id="redis数据存储"><a href="#redis数据存储" class="headerlink" title="redis数据存储"></a>redis数据存储</h2><p>redis维护的db数据结构<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">    dict *dict;                 <span class="comment">/* The keyspace for this DB */</span></span><br><span class="line">    dict *expires;              <span class="comment">/* Timeout of keys with a timeout set */</span></span><br><span class="line">    dict *blocking_keys;        <span class="comment">/* Keys with clients waiting for data (BLPOP)*/</span></span><br><span class="line">    dict *ready_keys;           <span class="comment">/* Blocked keys that received a PUSH */</span></span><br><span class="line">    dict *watched_keys;         <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></span><br><span class="line">    <span class="keyword">int</span> id;                     <span class="comment">/* Database ID */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> avg_ttl;          <span class="comment">/* Average TTL, just for stats */</span></span><br><span class="line">    <span class="built_in">list</span> *defrag_later;         <span class="comment">/* List of key names to attempt to defrag one by one, gradually. */</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure></p><ul><li>dict: 保存的是当前db中所有key的一个dict结构</li></ul><p>从一个指定db的dict结构中查找到对应<code>redisObject</code>结构的对象<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:LRU_BITS; <span class="comment">/* LRU time (relative to global lru_clock) or</span></span><br><span class="line"><span class="comment">                            * LFU data (least significant 8 bits frequency</span></span><br><span class="line"><span class="comment">                            * and most significant 16 bits access time). */</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure></p><ul><li>通过给定的命令，检查数据是否可操作</li><li>redis默认db数量为16</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;redis不仅支持最简单的k-v数据，还提供其他多种场景可用的数据结构: hash/list/set/zset等等。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;/2018/09/23/redis/type_hash/&quot;&gt;hash&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;#&quot;&gt;list&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;#&quot;&gt;set&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;#&quot;&gt;zset&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="redis" scheme="https://oldchan.net/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Go：语言监听进程退出信号</title>
    <link href="https://oldchan.net/2018/09/10/language/go/when_process_exit/"/>
    <id>https://oldchan.net/2018/09/10/language/go/when_process_exit/</id>
    <published>2018-09-10T11:14:30.000Z</published>
    <updated>2022-06-02T12:47:44.818Z</updated>
    
    <content type="html"><![CDATA[<p>项目中经常需要在进程退出时处理一些资源回收操作，打开的资源需要关闭，创建的临时数据需要销毁等等…</p><a id="more"></a><h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><p>通过<code>os/signal</code>包来获取进程信号接收管道，用一个goroutine来等待指定的信号</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"os/signal"</span></span><br><span class="line"><span class="string">"syscall"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">exitHandlers []<span class="function"><span class="keyword">func</span><span class="params">(os.Signal)</span></span></span><br><span class="line"><span class="function">)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// 捕获进程退出信号，执行回调</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">WhenExit</span><span class="params">(handler <span class="keyword">func</span>(os.Signal)</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(exitHandlers) == <span class="number">0</span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</span><br><span class="line">sigs := []os.Signal&#123;</span><br><span class="line">syscall.SIGHUP,</span><br><span class="line">syscall.SIGINT,</span><br><span class="line">syscall.SIGTERM,</span><br><span class="line">syscall.SIGQUIT,</span><br><span class="line">syscall.SIGUSR1,</span><br><span class="line">syscall.SIGUSR2,</span><br><span class="line">&#125;</span><br><span class="line">signal.Notify(ch, sigs...)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := &lt;-ch</span><br><span class="line"><span class="keyword">for</span> _, handler := <span class="keyword">range</span> exitHandlers &#123;</span><br><span class="line">handler(s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 增加退出回调</span></span><br><span class="line">exitHandlers = <span class="built_in">append</span>(exitHandlers, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WhenExit(<span class="function"><span class="keyword">func</span><span class="params">(sig os.Signal)</span></span> &#123;</span><br><span class="line">    <span class="comment">// @todo something</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;项目中经常需要在进程退出时处理一些资源回收操作，打开的资源需要关闭，创建的临时数据需要销毁等等…&lt;/p&gt;
    
    </summary>
    
      <category term="编程" scheme="https://oldchan.net/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="go" scheme="https://oldchan.net/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Redis：浅析redis启动流程</title>
    <link href="https://oldchan.net/2018/08/24/notes/redis/startup/"/>
    <id>https://oldchan.net/2018/08/24/notes/redis/startup/</id>
    <published>2018-08-24T02:42:16.000Z</published>
    <updated>2022-06-02T12:47:44.822Z</updated>
    
    <content type="html"><![CDATA[<p>阅读了下redis的源代码，了解一下服务的启动流程。</p><a id="more"></a><h2 id="程序入口main"><a href="#程序入口main" class="headerlink" title="程序入口main"></a>程序入口main</h2><p>main函数做为c语言程序入口，redis中的main函数在文件”/src/server.c”中</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> REDIS_TEST</span></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">3</span> &amp;&amp; !strcasecmp(argv[<span class="number">1</span>], <span class="string">"test"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"ziplist"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ziplistTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"quicklist"</span>)) &#123;</span><br><span class="line">            quicklistTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"intset"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> intsetTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"zipmap"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> zipmapTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"sha1test"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> sha1Test(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"util"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> utilTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"sds"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> sdsTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"endianconv"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> endianconvTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"crc64"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> crc64Test(argc, argv);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* test not found */</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to initialize our libraries, and the server configuration. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> INIT_SETPROCTITLE_REPLACEMENT</span></span><br><span class="line">    spt_init(argc, argv);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置本地化</span></span><br><span class="line">    setlocale(LC_COLLATE,<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置时区</span></span><br><span class="line">    tzset(); <span class="comment">/* Populates 'timezone' global. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// OOM保护机制的处理接口</span></span><br><span class="line">    zmalloc_set_oom_handler(redisOutOfMemoryHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成随机种子</span></span><br><span class="line">    srand(time(<span class="literal">NULL</span>)^getpid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取时间</span></span><br><span class="line">    gettimeofday(&amp;tv,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成一个随机16位长度字符串，用于后续使用生成hash(siphash)值时</span></span><br><span class="line">    <span class="keyword">char</span> hashseed[<span class="number">16</span>];</span><br><span class="line">    getRandomHexChars(hashseed,<span class="keyword">sizeof</span>(hashseed));</span><br><span class="line">    dictSetHashFunctionSeed((<span class="keyword">uint8_t</span>*)hashseed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测是否启用sentinel</span></span><br><span class="line">    server.sentinel_mode = checkForSentinelMode(argc,argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务器配置</span></span><br><span class="line">    initServerConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化模块系统</span></span><br><span class="line">    moduleInitModulesSystem();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Store the executable path and arguments in a safe place in order</span></span><br><span class="line"><span class="comment">     * to be able to restart the server later. */</span></span><br><span class="line">    server.executable = getAbsolutePath(argv[<span class="number">0</span>]);</span><br><span class="line">    server.exec_argv = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">char</span>*)*(argc+<span class="number">1</span>));</span><br><span class="line">    server.exec_argv[argc] = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; argc; j++) server.exec_argv[j] = zstrdup(argv[j]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要启动sentinel，则进行sentinel的初始化工作</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to init sentinel right now as parsing the configuration file</span></span><br><span class="line"><span class="comment">     * in sentinel mode will have the effect of populating the sentinel</span></span><br><span class="line"><span class="comment">     * data structures with master nodes to monitor. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.sentinel_mode) &#123;</span><br><span class="line">        initSentinelConfig();</span><br><span class="line">        initSentinel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如只需检测rdb/aof是否正常可用，则检测完退出启动流程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we need to start in redis-check-rdb/aof mode. We just execute</span></span><br><span class="line"><span class="comment">     * the program main. However the program is part of the Redis executable</span></span><br><span class="line"><span class="comment">     * so that we can easily execute an RDB check on loading errors. */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[<span class="number">0</span>],<span class="string">"redis-check-rdb"</span>) != <span class="literal">NULL</span>)</span><br><span class="line">        redis_check_rdb_main(argc,argv,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[<span class="number">0</span>],<span class="string">"redis-check-aof"</span>) != <span class="literal">NULL</span>)</span><br><span class="line">        redis_check_aof_main(argc,argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        j = <span class="number">1</span>; <span class="comment">/* First option to parse in argv[] */</span></span><br><span class="line">        sds options = sdsempty();</span><br><span class="line">        <span class="keyword">char</span> *configfile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查看版本/help相关操作，会在执行之后退出启动流程</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Handle special options --help and --version */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-v"</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--version"</span>) == <span class="number">0</span>) version();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--help"</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-h"</span>) == <span class="number">0</span>) usage();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--test-memory"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (argc == <span class="number">3</span>) &#123;</span><br><span class="line">                memtest(atoi(argv[<span class="number">2</span>]),<span class="number">50</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Please specify the amount of memory to test in megabytes.\n"</span>);</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Example: ./redis-server --test-memory 4096\n\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 命令行参数格式: --参数名(上面-v/-h等参数特殊处理除外)</span></span><br><span class="line">        <span class="comment">// 第一个参数必须是非"--"前缀格式才做为配置文件解析</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* First argument is the config file name? */</span></span><br><span class="line">        <span class="keyword">if</span> (argv[j][<span class="number">0</span>] != <span class="string">'-'</span> || argv[j][<span class="number">1</span>] != <span class="string">'-'</span>) &#123;</span><br><span class="line">            configfile = argv[j];</span><br><span class="line">            server.configfile = getAbsolutePath(configfile);</span><br><span class="line">            <span class="comment">/* Replace the config file in server.exec_argv with</span></span><br><span class="line"><span class="comment">             * its absolute path. */</span></span><br><span class="line">            zfree(server.exec_argv[j]);</span><br><span class="line">            server.exec_argv[j] = zstrdup(server.configfile);</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* All the other options are parsed and conceptually appended to the</span></span><br><span class="line"><span class="comment">         * configuration file. For instance --port 6380 will generate the</span></span><br><span class="line"><span class="comment">         * string "port 6380\n" to be parsed after the actual file name</span></span><br><span class="line"><span class="comment">         * is parsed, if any. */</span></span><br><span class="line">        <span class="keyword">while</span>(j != argc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (argv[j][<span class="number">0</span>] == <span class="string">'-'</span> &amp;&amp; argv[j][<span class="number">1</span>] == <span class="string">'-'</span>) &#123;</span><br><span class="line">                <span class="comment">/* Option name */</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[j], <span class="string">"--check-rdb"</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* Argument has no options, need to skip for parsing. */</span></span><br><span class="line">                    j++;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (sdslen(options)) options = sdscat(options,<span class="string">"\n"</span>);</span><br><span class="line">                options = sdscat(options,argv[j]+<span class="number">2</span>);</span><br><span class="line">                options = sdscat(options,<span class="string">" "</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* Option argument */</span></span><br><span class="line">                options = sdscatrepr(options,argv[j],<span class="built_in">strlen</span>(argv[j]));</span><br><span class="line">                options = sdscat(options,<span class="string">" "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (server.sentinel_mode &amp;&amp; configfile &amp;&amp; *configfile == <span class="string">'-'</span>) &#123;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">"Sentinel config from STDIN not allowed."</span>);</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">"Sentinel needs config file on disk to save state.  Exiting..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        resetServerSaveParams();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载配置文件，同时会将命令行参数追加到配置中，解析配置时会进行覆盖</span></span><br><span class="line">        loadServerConfig(configfile,options);</span><br><span class="line"></span><br><span class="line">        sdsfree(options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serverLog(LL_WARNING, <span class="string">"oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo"</span>);</span><br><span class="line">    serverLog(LL_WARNING,</span><br><span class="line">        <span class="string">"Redis version=%s, bits=%d, commit=%s, modified=%d, pid=%d, just started"</span>,</span><br><span class="line">            REDIS_VERSION,</span><br><span class="line">            (<span class="keyword">sizeof</span>(<span class="keyword">long</span>) == <span class="number">8</span>) ? <span class="number">64</span> : <span class="number">32</span>,</span><br><span class="line">            redisGitSHA1(),</span><br><span class="line">            strtol(redisGitDirty(),<span class="literal">NULL</span>,<span class="number">10</span>) &gt; <span class="number">0</span>,</span><br><span class="line">            (<span class="keyword">int</span>)getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">"Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf"</span>, argv[<span class="number">0</span>], server.sentinel_mode ? <span class="string">"sentinel"</span> : <span class="string">"redis"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">"Configuration loaded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否启用后台进程，如果启用则当前进程将在创建子进程成功之后退出</span></span><br><span class="line"></span><br><span class="line">    server.supervised = redisIsSupervised(server.supervised_mode);</span><br><span class="line">    <span class="keyword">int</span> background = server.daemonize &amp;&amp; !server.supervised;</span><br><span class="line">    <span class="keyword">if</span> (background) daemonize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务器各项结构</span></span><br><span class="line">    initServer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (background || server.pidfile) createPidFile();</span><br><span class="line">    redisSetProcTitle(argv[<span class="number">0</span>]);</span><br><span class="line">    redisAsciiArt();</span><br><span class="line">    checkTcpBacklogSettings();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!server.sentinel_mode) &#123;</span><br><span class="line">        <span class="comment">/* Things not needed when running in Sentinel mode. */</span></span><br><span class="line">        serverLog(LL_WARNING,<span class="string">"Server initialized"</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></span><br><span class="line">        linuxMemoryWarnings();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过模块队列加载模块</span></span><br><span class="line">        moduleLoadFromQueue();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过aof/rdb加载数据</span></span><br><span class="line">        loadDataFromDisk();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (server.cluster_enabled) &#123;</span><br><span class="line">            <span class="keyword">if</span> (verifyClusterConfigWithData() == C_ERR) &#123;</span><br><span class="line">                serverLog(LL_WARNING,</span><br><span class="line">                    <span class="string">"You can't have keys in a DB different than DB 0 when in "</span></span><br><span class="line">                    <span class="string">"Cluster mode. Exiting."</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (server.ipfd_count &gt; <span class="number">0</span>)</span><br><span class="line">            serverLog(LL_NOTICE,<span class="string">"Ready to accept connections"</span>);</span><br><span class="line">        <span class="keyword">if</span> (server.sofd &gt; <span class="number">0</span>)</span><br><span class="line">            serverLog(LL_NOTICE,<span class="string">"The server is now ready to accept connections at %s"</span>, server.unixsocket);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sentinelIsRunning();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Warning the user about suspicious maxmemory setting. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.maxmemory &gt; <span class="number">0</span> &amp;&amp; server.maxmemory &lt; <span class="number">1024</span>*<span class="number">1024</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">"WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?"</span>, server.maxmemory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入主循环的一次回调</span></span><br><span class="line">    aeSetBeforeSleepProc(server.el,beforeSleep);</span><br><span class="line">    <span class="comment">// 监听到事件之后的一次回调</span></span><br><span class="line">    aeSetAfterSleepProc(server.el,afterSleep);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启事件循环</span></span><br><span class="line">    aeMain(server.el);</span><br><span class="line"></span><br><span class="line">    aeDeleteEventLoop(server.el);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="事件循环aeMain"><a href="#事件循环aeMain" class="headerlink" title="事件循环aeMain"></a>事件循环aeMain</h2><p>服务启动之后，初始化完毕，就开始执行事件循环系统(“/src/ae.c”文件中)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">aeMain</span><span class="params">(aeEventLoop *eventLoop)</span> </span>&#123;</span><br><span class="line">    eventLoop-&gt;stop = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!eventLoop-&gt;stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventLoop-&gt;beforesleep != <span class="literal">NULL</span>)</span><br><span class="line">            eventLoop-&gt;beforesleep(eventLoop);</span><br><span class="line">        <span class="comment">// 处理事件</span></span><br><span class="line">        aeProcessEvents(eventLoop, AE_ALL_EVENTS|AE_CALL_AFTER_SLEEP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="循环前的beforesleep"><a href="#循环前的beforesleep" class="headerlink" title="循环前的beforesleep"></a>循环前的beforesleep</h2><p>关于<code>beforesleep</code>的代码也整理出来看看<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This function gets called every time Redis is entering the</span></span><br><span class="line"><span class="comment"> * main loop of the event driven library, that is, before to sleep</span></span><br><span class="line"><span class="comment"> * for ready file descriptors. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">beforeSleep</span><span class="params">(struct aeEventLoop *eventLoop)</span> </span>&#123;</span><br><span class="line">    UNUSED(eventLoop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Call the Redis Cluster before sleep function. Note that this function</span></span><br><span class="line"><span class="comment">     * may change the state of Redis Cluster (from ok to fail or vice versa),</span></span><br><span class="line"><span class="comment">     * so it's a good idea to call it before serving the unblocked clients</span></span><br><span class="line"><span class="comment">     * later in this function. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled) clusterBeforeSleep();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Key过期处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Run a fast expire cycle (the called function will return</span></span><br><span class="line"><span class="comment">     * ASAP if a fast cycle is not needed). */</span></span><br><span class="line">    <span class="keyword">if</span> (server.active_expire_enabled &amp;&amp; server.masterhost == <span class="literal">NULL</span>)</span><br><span class="line">        activeExpireCycle(ACTIVE_EXPIRE_CYCLE_FAST);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟slave库的联系/数据的同步等等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send all the slaves an ACK request if at least one client blocked</span></span><br><span class="line"><span class="comment">     * during the previous event loop iteration. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.get_ack_from_slaves) &#123;</span><br><span class="line">        robj *argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        argv[<span class="number">0</span>] = createStringObject(<span class="string">"REPLCONF"</span>,<span class="number">8</span>);</span><br><span class="line">        argv[<span class="number">1</span>] = createStringObject(<span class="string">"GETACK"</span>,<span class="number">6</span>);</span><br><span class="line">        argv[<span class="number">2</span>] = createStringObject(<span class="string">"*"</span>,<span class="number">1</span>); <span class="comment">/* Not used argument. */</span></span><br><span class="line">        replicationFeedSlaves(server.slaves, server.slaveseldb, argv, <span class="number">3</span>);</span><br><span class="line">        decrRefCount(argv[<span class="number">0</span>]);</span><br><span class="line">        decrRefCount(argv[<span class="number">1</span>]);</span><br><span class="line">        decrRefCount(argv[<span class="number">2</span>]);</span><br><span class="line">        server.get_ack_from_slaves = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理上一个循环中未响应完的处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Unblock all the clients blocked for synchronous replication</span></span><br><span class="line"><span class="comment">     * in WAIT. */</span></span><br><span class="line">    <span class="keyword">if</span> (listLength(server.clients_waiting_acks))</span><br><span class="line">        processClientsWaitingReplicas();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if there are clients unblocked by modules that implement</span></span><br><span class="line"><span class="comment">     * blocking commands. */</span></span><br><span class="line">    moduleHandleBlockedClients();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Try to process pending commands for clients that were just unblocked. */</span></span><br><span class="line">    <span class="keyword">if</span> (listLength(server.unblocked_clients))</span><br><span class="line">        processUnblockedClients();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// aof的处理(不是执行一条命令就追加一条，是在一个循环完，开始一个新的循环之前落地到磁盘)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write the AOF buffer on disk */</span></span><br><span class="line">    flushAppendOnlyFile(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle writes with pending output buffers. */</span></span><br><span class="line">    handleClientsWithPendingWrites();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Before we are going to sleep, let the threads access the dataset by</span></span><br><span class="line"><span class="comment">     * releasing the GIL. Redis main thread will not touch anything at this</span></span><br><span class="line"><span class="comment">     * time. */</span></span><br><span class="line">    <span class="keyword">if</span> (moduleCount()) moduleReleaseGIL();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="事件处理aeProcessEvents"><a href="#事件处理aeProcessEvents" class="headerlink" title="事件处理aeProcessEvents"></a>事件处理aeProcessEvents</h2><p>系统主要处理两种事件: 一种时间事件，一种网络事件<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Process every pending time event, then every pending file event</span></span><br><span class="line"><span class="comment"> * (that may be registered by time event callbacks just processed).</span></span><br><span class="line"><span class="comment"> * Without special flags the function sleeps until some file event</span></span><br><span class="line"><span class="comment"> * fires, or when the next time event occurs (if any).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If flags is 0, the function does nothing and returns.</span></span><br><span class="line"><span class="comment"> * if flags has AE_ALL_EVENTS set, all the kind of events are processed.</span></span><br><span class="line"><span class="comment"> * if flags has AE_FILE_EVENTS set, file events are processed.</span></span><br><span class="line"><span class="comment"> * if flags has AE_TIME_EVENTS set, time events are processed.</span></span><br><span class="line"><span class="comment"> * if flags has AE_DONT_WAIT set the function returns ASAP until all</span></span><br><span class="line"><span class="comment"> * if flags has AE_CALL_AFTER_SLEEP set, the aftersleep callback is called.</span></span><br><span class="line"><span class="comment"> * the events that's possible to process without to wait are processed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns the number of events processed. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aeProcessEvents</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> processed = <span class="number">0</span>, numevents;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Nothing to do? return ASAP */</span></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; AE_TIME_EVENTS) &amp;&amp; !(flags &amp; AE_FILE_EVENTS)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Note that we want call select() even if there are no</span></span><br><span class="line"><span class="comment">     * file events to process as long as we want to process time</span></span><br><span class="line"><span class="comment">     * events, in order to sleep until the next time event is ready</span></span><br><span class="line"><span class="comment">     * to fire. */</span></span><br><span class="line">    <span class="keyword">if</span> (eventLoop-&gt;maxfd != <span class="number">-1</span> ||</span><br><span class="line">        ((flags &amp; AE_TIME_EVENTS) &amp;&amp; !(flags &amp; AE_DONT_WAIT))) &#123;</span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line">        aeTimeEvent *shortest = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>, *<span class="title">tvp</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS &amp;&amp; !(flags &amp; AE_DONT_WAIT))</span><br><span class="line">            shortest = aeSearchNearestTimer(eventLoop);</span><br><span class="line">        <span class="keyword">if</span> (shortest) &#123;</span><br><span class="line">            <span class="keyword">long</span> now_sec, now_ms;</span><br><span class="line"></span><br><span class="line">            aeGetTime(&amp;now_sec, &amp;now_ms);</span><br><span class="line">            tvp = &amp;tv;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* How many milliseconds we need to wait for the next</span></span><br><span class="line"><span class="comment">             * time event to fire? */</span></span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> ms =</span><br><span class="line">                (shortest-&gt;when_sec - now_sec)*<span class="number">1000</span> +</span><br><span class="line">                shortest-&gt;when_ms - now_ms;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ms &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                tvp-&gt;tv_sec = ms/<span class="number">1000</span>;</span><br><span class="line">                tvp-&gt;tv_usec = (ms % <span class="number">1000</span>)*<span class="number">1000</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tvp-&gt;tv_sec = <span class="number">0</span>;</span><br><span class="line">                tvp-&gt;tv_usec = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* If we have to check for events but need to return</span></span><br><span class="line"><span class="comment">             * ASAP because of AE_DONT_WAIT we need to set the timeout</span></span><br><span class="line"><span class="comment">             * to zero */</span></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; AE_DONT_WAIT) &#123;</span><br><span class="line">                tv.tv_sec = tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                tvp = &amp;tv;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* Otherwise we can block */</span></span><br><span class="line">                tvp = <span class="literal">NULL</span>; <span class="comment">/* wait forever */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tvp是等待时间，是距离下一个最近的时间事件的时间距离</span></span><br><span class="line">        <span class="comment">// redis的循环事件是不等待的</span></span><br><span class="line">        <span class="comment">// aeProcessEvents(eventLoop, AE_ALL_EVENTS|AE_CALL_AFTER_SLEEP);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Call the multiplexing API, will return only on timeout or when</span></span><br><span class="line"><span class="comment">         * some event fires. */</span></span><br><span class="line">        numevents = aeApiPoll(eventLoop, tvp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* After sleep callback. */</span></span><br><span class="line">        <span class="keyword">if</span> (eventLoop-&gt;aftersleep != <span class="literal">NULL</span> &amp;&amp; flags &amp; AE_CALL_AFTER_SLEEP)</span><br><span class="line">            eventLoop-&gt;aftersleep(eventLoop);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numevents; j++) &#123;</span><br><span class="line">            aeFileEvent *fe = &amp;eventLoop-&gt;events[eventLoop-&gt;fired[j].fd];</span><br><span class="line">            <span class="keyword">int</span> mask = eventLoop-&gt;fired[j].mask;</span><br><span class="line">            <span class="keyword">int</span> fd = eventLoop-&gt;fired[j].fd;</span><br><span class="line">            <span class="keyword">int</span> fired = <span class="number">0</span>; <span class="comment">/* Number of events fired for current fd. */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Normally we execute the readable event first, and the writable</span></span><br><span class="line"><span class="comment">             * event laster. This is useful as sometimes we may be able</span></span><br><span class="line"><span class="comment">             * to serve the reply of a query immediately after processing the</span></span><br><span class="line"><span class="comment">             * query.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * However if AE_BARRIER is set in the mask, our application is</span></span><br><span class="line"><span class="comment">             * asking us to do the reverse: never fire the writable event</span></span><br><span class="line"><span class="comment">             * after the readable. In such a case, we invert the calls.</span></span><br><span class="line"><span class="comment">             * This is useful when, for instance, we want to do things</span></span><br><span class="line"><span class="comment">             * in the beforeSleep() hook, like fsynching a file to disk,</span></span><br><span class="line"><span class="comment">             * before replying to a client. */</span></span><br><span class="line">            <span class="keyword">int</span> invert = fe-&gt;mask &amp; AE_BARRIER;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Note the "fe-&gt;mask &amp; mask &amp; ..." code: maybe an already</span></span><br><span class="line"><span class="comment">             * processed event removed an element that fired and we still</span></span><br><span class="line"><span class="comment">             * didn't processed, so we check if the event is still valid.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * Fire the readable event if the call sequence is not</span></span><br><span class="line"><span class="comment">             * inverted. */</span></span><br><span class="line">            <span class="keyword">if</span> (!invert &amp;&amp; fe-&gt;mask &amp; mask &amp; AE_READABLE) &#123;</span><br><span class="line">                fe-&gt;rfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">                fired++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Fire the writable event. */</span></span><br><span class="line">            <span class="keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_WRITABLE) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!fired || fe-&gt;wfileProc != fe-&gt;rfileProc) &#123;</span><br><span class="line">                    fe-&gt;wfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">                    fired++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* If we have to invert the call, fire the readable event now</span></span><br><span class="line"><span class="comment">             * after the writable one. */</span></span><br><span class="line">            <span class="keyword">if</span> (invert &amp;&amp; fe-&gt;mask &amp; mask &amp; AE_READABLE) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!fired || fe-&gt;wfileProc != fe-&gt;rfileProc) &#123;</span><br><span class="line">                    fe-&gt;rfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">                    fired++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            processed++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Check time events */</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理时间事件</span></span><br><span class="line">        processed += processTimeEvents(eventLoop);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> processed; <span class="comment">/* return the number of processed file/time events */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="简单总结"><a href="#简单总结" class="headerlink" title="简单总结"></a>简单总结</h2><ul><li>主程序中进行各项程序初始化/服务初始化/模块初始化等等</li><li>系统初始化结束启动事件循环系统</li><li>对于客户端的相关读写操作均才用单线程模式处理</li><li>对于部分低级别任务采用后台线程异步处理</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;阅读了下redis的源代码，了解一下服务的启动流程。&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="redis" scheme="https://oldchan.net/tags/redis/"/>
    
  </entry>
  
</feed>
