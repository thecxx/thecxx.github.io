<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>KAMI</title>
  <icon>https://www.gravatar.com/avatar/6c7900dd6f48482682e7479769ab3e63</icon>
  <subtitle>士不可以不弘毅，任重而道远。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://oldchan.net/"/>
  <updated>2022-06-02T12:47:44.824Z</updated>
  <id>https://oldchan.net/</id>
  
  <author>
    <name>Kami</name>
    <email>thecxx@126.com</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>好的产品?</title>
    <link href="https://oldchan.net/2022/05/05/others/good_product/"/>
    <id>https://oldchan.net/2022/05/05/others/good_product/</id>
    <published>2022-05-05T08:00:38.000Z</published>
    <updated>2022-06-02T12:47:44.824Z</updated>
    
    <content type="html"><![CDATA[<p><strong>“功能强大”</strong></p><p>追求功能强大，似乎是一种魔咒，存在于专业人士的思维里，理所应当的，功能强大的产品能完成更多的可预料到的功能。</p><p>这种产品的价值，懂的人自然会懂，不懂的人却很难愿意为“多余”的功能支付成本。当缺少替代方案时，或许愿意追加成本，但假如出现了另一款类似功能的产品，并且功能简单到能满足用户需求，相对的，由于功能简单，研发投入的成本也会相应的低一些，需要用户支付的成本也会低一些，这个时候，用户又会怎么选择呢？</p><p>为什么总会做出一款功能强大到超出很多用户需求的产品呢？想想主要原因应该有以下几点</p><ol><li>产品功能足够丰富、强大，可以覆盖到更多的用户群体</li><li>更多专业的功能，能解决很多难度较高的问题</li><li>高端产品售价更高，利润更可观</li></ol><p>基于以上的类似原因，开发者一般会孜孜不倦地在各种专业、多余的功能上投入巨大的精力和成本，那么对于开发者而言，投入的成本又怎么收回呢？</p><a id="more"></a><p><strong>“概念较多、操作复杂、不够便捷”</strong></p><p>接手过一个项目，这个项目的业务层面上定义了很多很专业的概念，任何非专业的人在使用时都会提出大量的疑问，主要是询问类似：“***是什么意思？”之类的问题，项目也有一些对外的使用手册，但使用手册上仍然引用的是很多专业的名词。</p><p>经过如此反复的客户来咨询类似的问题，加上自己也在梳理项目时，发现确实有很多的复杂性概念需要项目的维护人员给出解释。于是与之前的项目负责人进行了一些沟通，得到了一句看似很合理却又不是很自然的一句话：“啊？这么简单，文档都写了，他们还看不懂？”</p><p>“知识的诅咒”，又称“专家盲点”，是一种认知偏差，指人在与他人交流的时候，下意识地假设对方拥有理解所需要的背景知识。在认知传授时，尽可能让自己意识到，对方可能什么都不懂。同样在设计产品时，也需有明确的目标用户定位，给予不同的上手引导，如：新手、使用过类似产品、骨灰级用户等等。</p><p>随着行业的逐步发展，当用户的使用习惯，操作心智也得到了培养之后，产品的引导就会更加容易一些，最开始的Android APP没有很统一的界面交互方案，也是慢慢地才统一到手机屏幕的下方，从此就成为了比较标准的交互布局。</p><p>总之而言，用户在实际使用产品之前，都应该尽可能地精简步骤，保证产品能尽快呈现到用户的面前，在用户心智中，实际使用产品之前的每个额外环节，可能每一个环节都会给产品减一次分。</p><p><strong>“用户成本”</strong></p><p>用户在使用一款产品时，总是期望获得一些东西，如：帮助类功能(主要是通过节省时间，精力，钱等完成某些事)、娱乐方式、比较好奇的内容、欢乐的心情、重要信息等等。</p><p>用户获取这些产品带来的效果的过程中，总是要付出一些时间，精力，钱财或者其他，这些都是用户的成本，而且投入越多，产品在用户心智中的价值需要大于或等于用户付出的成本，否则用户是不会那么乐意买单的。</p><p>用户对于产品的成本支出止于需求得到满足，更多的功能带来的多余成本支出，并非所有用户都愿意支付这部分溢价。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;“功能强大”&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;追求功能强大，似乎是一种魔咒，存在于专业人士的思维里，理所应当的，功能强大的产品能完成更多的可预料到的功能。&lt;/p&gt;
&lt;p&gt;这种产品的价值，懂的人自然会懂，不懂的人却很难愿意为“多余”的功能支付成本。当缺少替代方案时，或许愿意追加成本，但假如出现了另一款类似功能的产品，并且功能简单到能满足用户需求，相对的，由于功能简单，研发投入的成本也会相应的低一些，需要用户支付的成本也会低一些，这个时候，用户又会怎么选择呢？&lt;/p&gt;
&lt;p&gt;为什么总会做出一款功能强大到超出很多用户需求的产品呢？想想主要原因应该有以下几点&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;产品功能足够丰富、强大，可以覆盖到更多的用户群体&lt;/li&gt;
&lt;li&gt;更多专业的功能，能解决很多难度较高的问题&lt;/li&gt;
&lt;li&gt;高端产品售价更高，利润更可观&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;基于以上的类似原因，开发者一般会孜孜不倦地在各种专业、多余的功能上投入巨大的精力和成本，那么对于开发者而言，投入的成本又怎么收回呢？&lt;/p&gt;
    
    </summary>
    
      <category term="随笔" scheme="https://oldchan.net/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
  </entry>
  
  <entry>
    <title>互联网络与元宇宙</title>
    <link href="https://oldchan.net/2021/11/17/others/internet_and_metaverse/"/>
    <id>https://oldchan.net/2021/11/17/others/internet_and_metaverse/</id>
    <published>2021-11-17T04:44:09.000Z</published>
    <updated>2022-06-02T14:51:37.051Z</updated>
    
    <content type="html"><![CDATA[<p>上世纪60年代诞生的ARPANET，最初的目标是为了降低在战争时期，中心化控制机制带来的高风险问题，采用单点互联构建分布式去中心化网络可以大大降低系统风险。</p><p>之后，基于ARPANET的成果又诞生了互联网，用于解决ARPANET无法解决的<strong>“无法做到和个别计算机网络交流”</strong>问题。</p><p>再经过几十年的发展，又陆续诞生了许多基于TCP/IP协议产生的各种网络应用。</p><p>TCP/IP作为标准通信协议，基于TCP/IP协议互联的设备组成的网络即可称之为互联网。近几十年，发展最快的互联网应用莫过于Web网络，让信息分享越来越简单。</p><a id="more"></a><h2 id="元宇宙"><a href="#元宇宙" class="headerlink" title="元宇宙"></a>元宇宙</h2><p><strong>“或称为後設宇宙、形上宇宙、元界、超感空间、虚空间，被用来描述一个未来和去中心化的在线虚拟环境。”</strong></p><p>以上是<a href="https://zh.wikipedia.org/wiki/%E5%85%83%E5%AE%87%E5%AE%99" target="_blank" rel="noopener">维基百科</a>的简单定义，直观体会跟<strong>万物互联</strong>，<strong>全真互联</strong>精髓是一致的，但补充定义上更强调了进一步的交互方案，更像是类似<strong>《头号玩家》</strong>中描述的交互体验。</p><h2 id="始至终"><a href="#始至终" class="headerlink" title="始至终"></a>始至终</h2><p>互联网的发展自始至终的目标都很清晰：提升信息沟通效率，降低成本。如同人与人之间的对话，最低效的沟通莫过于驴唇不对马嘴，生物作为“意识+肢体”结合产生的个体，意识与意识之间需要透过肢体协作才能交流，又或者需要透过外部复杂环境才能交流(地理位置、语种、视听语言障碍等等)，这都是交流的成本。</p><p>互联网的出现之所以普及，在于它能让人足不出户，就可以和任何人交流(电话、短信、微信、QQ)，足不出户就可以和全世界的人一起互动娱乐，学习，乃至生活的方方面面，甚至会有人沉迷于互联网络的虚拟世界中。</p><p>对于商业公司而言，需要新鲜的故事才能满足公司运作的需要，才能更好的发展。但对于科技的发展，元宇宙的当前定义或许还不到最终目标的10%，如果互联网能以最高效的方式连接<strong>「意识」</strong>，最大程度上降低现实世界中的沟通成本，也许就是达到了发展的终极目标，小时候看《黑客帝国》时，就在想，这插一下网线，想做什么就能做什么，想学什么瞬间就会，多爽啊，<strong>脑机交互</strong>始终是未来的一个很大的研究课题。</p><p>想象一下：<strong>人们通过佩戴一个头盔，或者内嵌脑机交互芯片，又或者后脑勺有一个网口，随时随地，连睡觉时依然能保持正常的日常生活(当然是在一个开放的虚拟世界中)，我在地球，你在火星，透过虚拟世界，实现面对面沟通。</strong></p><h2 id="新的变化"><a href="#新的变化" class="headerlink" title="新的变化"></a>新的变化</h2><p>Q：元宇宙与WEB3.0？</p><p>A：元宇宙与WEB3.0是同级别产品，但元宇宙的应用包含的维度更广。</p><p>Q：互联网与元宇宙？</p><p>A：元宇宙的建设包含先前技术的方方面面，元宇宙需要基于现有互联网络进行建设。</p><p>Q：元宇宙只有一个吗？</p><p>A：元宇宙最可能的结构是存在多个，<strong>主宇宙</strong>与<strong>私有宇宙</strong>。</p><p>Q：元宇宙能带来哪些商业变革？</p><p>A：元宇宙会建设成类似平台的模式，用户进入元宇宙的成本不能太高，因此交互设备的价格需要能让大众接受或者付费进入(共享设备或按时计费)。在元宇宙中，会存在虚拟商家，用户与虚拟商家的交互会在现实中得到体现。既然存在多个元宇宙，那用户怎么选择呢，是不是还需要一个导航？</p><h2 id="版本迭代"><a href="#版本迭代" class="headerlink" title="版本迭代"></a>版本迭代</h2><h3 id="v1-0：肢体沟通，面对面沟通"><a href="#v1-0：肢体沟通，面对面沟通" class="headerlink" title="v1.0：肢体沟通，面对面沟通"></a>v1.0：肢体沟通，面对面沟通</h3><p>原始阶段，需要面对面沟通，并且语种能互相识别，或者尽量少的语言视听障碍。</p><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/11/17/0199d4dd592bb2d76e3a6968ec769362.png" alt></p><h3 id="v2-0：通信方案、设备，传输介质"><a href="#v2-0：通信方案、设备，传输介质" class="headerlink" title="v2.0：通信方案、设备，传输介质"></a>v2.0：通信方案、设备，传输介质</h3><p>存在中间传输层，如：书信，传信人，留言记录，电话，手机，im软件。</p><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/11/17/0b14be023e9f288051e878da40e7f5be.png" alt></p><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/11/17/18c526964f97346cc33497443951b9fe.png" alt></p><h3 id="v3-0：VR，视频，语音，仿生技术，增强现实技术"><a href="#v3-0：VR，视频，语音，仿生技术，增强现实技术" class="headerlink" title="v3.0：VR，视频，语音，仿生技术，增强现实技术"></a>v3.0：VR，视频，语音，仿生技术，增强现实技术</h3><p>主要目标是进一步解放手动操作，降低操作性，反馈体验更加真实，并进一步提升通信效率。</p><h4 id="一-操作技术"><a href="#一-操作技术" class="headerlink" title="一. 操作技术"></a>一. 操作技术</h4><ul><li>NLP(支持实时同声交互)</li><li>AI(交互容错)</li><li>肢体动作识别(辅助操作)</li></ul><h4 id="二-反馈技术"><a href="#二-反馈技术" class="headerlink" title="二. 反馈技术"></a>二. 反馈技术</h4><ul><li>VR</li><li>特效模拟</li><li>场景模拟</li><li>感官模拟</li></ul><h4 id="三-辅助技术"><a href="#三-辅助技术" class="headerlink" title="三. 辅助技术"></a>三. 辅助技术</h4><ul><li>3D建模</li></ul><h3 id="v4-0：脑机交互，虚拟世界与现实世界互联"><a href="#v4-0：脑机交互，虚拟世界与现实世界互联" class="headerlink" title="v4.0：脑机交互，虚拟世界与现实世界互联"></a>v4.0：脑机交互，虚拟世界与现实世界互联</h3><p>发展到这个阶段，只需要通过意识，便能完成交互。</p><p>其中最关键的两项技术：一项是<strong>脑机交互技术</strong>，另一项是<strong>高效率的无线通信技术</strong>。</p><h4 id="一-脑机交互技术"><a href="#一-脑机交互技术" class="headerlink" title="一. 脑机交互技术"></a>一. 脑机交互技术</h4><p>解读所有大脑信号，实现意识与世界(虚拟世界或现实世界)的交互，并将结果反馈给大脑。</p><h4 id="二-超长距离高效率的无线通信技术"><a href="#二-超长距离高效率的无线通信技术" class="headerlink" title="二. 超长距离高效率的无线通信技术"></a>二. 超长距离高效率的无线通信技术</h4><p>有线通信技术，在不断扩大规模的情况下，成本也会不断增加，同时也会遇到很多现实世界的局限，未来星际发展，难道要直连一条从地球到火星的网线吗？</p><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/11/17/971a1e7f61960521f5f75f471f569f6a.png" alt></p><h3 id="v5-0：《铳梦》，《超验骇客》"><a href="#v5-0：《铳梦》，《超验骇客》" class="headerlink" title="v5.0：《铳梦》，《超验骇客》"></a>v5.0：《铳梦》，《超验骇客》</h3><p>当意识的构成被彻底研究透彻，科技可以对意识加以干扰和修改，配合优于人类意识的AI系统，作为人而存在的个体是否还需要肉体？所有的意识组件都被电子系统替代，如<strong>忒修斯之船</strong>一样，我们还是我们，但我们却也不是原来的我们。</p><p>到这里，我们不经提出几个问题：</p><ol><li>人类还需要生殖繁衍吗？</li><li>人类意识与AI意识怎么共存？</li><li>在虚拟世界中，每一个具备意识的个体，这份意识可能出自人类，也可能是被系统创造出来的？</li><li>在虚拟世界中，由系统创造出来的AI意识是不是原住民？</li></ol><p>很多不错的科幻电影都描述了这些很可能会到来的未来，身体是束缚意识的枷锁，电影《超验骇客》中，<strong>威尔</strong>的意识第一次进入电脑，进入网络中时，感叹，思维从未如此轻松。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;上世纪60年代诞生的ARPANET，最初的目标是为了降低在战争时期，中心化控制机制带来的高风险问题，采用单点互联构建分布式去中心化网络可以大大降低系统风险。&lt;/p&gt;
&lt;p&gt;之后，基于ARPANET的成果又诞生了互联网，用于解决ARPANET无法解决的&lt;strong&gt;“无法做到和个别计算机网络交流”&lt;/strong&gt;问题。&lt;/p&gt;
&lt;p&gt;再经过几十年的发展，又陆续诞生了许多基于TCP/IP协议产生的各种网络应用。&lt;/p&gt;
&lt;p&gt;TCP/IP作为标准通信协议，基于TCP/IP协议互联的设备组成的网络即可称之为互联网。近几十年，发展最快的互联网应用莫过于Web网络，让信息分享越来越简单。&lt;/p&gt;
    
    </summary>
    
      <category term="随笔" scheme="https://oldchan.net/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="元宇宙" scheme="https://oldchan.net/tags/%E5%85%83%E5%AE%87%E5%AE%99/"/>
    
  </entry>
  
  <entry>
    <title>微服务</title>
    <link href="https://oldchan.net/2021/05/18/arch/microservice/service/"/>
    <id>https://oldchan.net/2021/05/18/arch/microservice/service/</id>
    <published>2021-05-18T10:22:44.000Z</published>
    <updated>2022-06-02T12:47:44.815Z</updated>
    
    <content type="html"><![CDATA[<p><strong>产业分工</strong>是产品成长过程中的必经阶段，但凡产品具有不断壮大的机会，规模也会不断扩大，相应的工艺也会逐渐复杂，这种情况下，<strong>模块化生产</strong>就是必要的生产方式。</p><p>之前在创业群里，有连续创业并成功的大佬就说过：“我们平时买的包子，里面就包含很多道工序，有人负责种麦子，有人负责养猪，有人负责加工面粉，有人负责杀猪，最后早餐店里员工进行产品包装。”</p><p>应用到软件架构，这些内在本质是相通的。随着用户量的不断增长，架构应对的数据规模也会逐渐发生质变，为什么几十年前不会诞生微服务这类概念，因为在那个时候互联网还远远不够目前的规模庞大。</p><a id="more"></a><h2 id="SOA"><a href="#SOA" class="headerlink" title="SOA"></a>SOA</h2><p>SOA(Service-Oriented Architecture)是一种支持面向服务的架构风格，定义了将业务功能服务化的架构思想，但从各种材料中，都只看到<strong>“粗粒度，松耦合”</strong>的描述和一直被诟病的<strong>ESB</strong>组件。</p><p>SOA提出了服务化分工协作的思想，将完整的集中式架构进行了拆分，但在具体实现过程中，又保留了对现有系统的复用要求，因此才有ESB的存在，相比后来出现的微服务架构，SOA在整体架构上，有着服务化的理念却不够彻底。</p><h2 id="微服务"><a href="#微服务" class="headerlink" title="微服务"></a>微服务</h2><p>相比于SOA，很多有一定经验的架构师在最初接触微服务时，都会觉得两者在整体上何其相似。</p><p>在一篇技术文章里，有这么一段总结：</p><p>“SOA的服务拆分建立在已有系统的基础上，不打破原有系统的整体架构，在接口集成时做的接口服务粒度的拆分，SOA架构通过对已有业务或系统的梳理来发现可提供复用的系统组件或功能，并统一通过Webservice来暴露接口。而目前流行的微服务架构的微服务组件的拆分则是将现有系统和业务重构，按照微服务的设计思路，将业务或系统打散成单个微服务组件，并基于微服务组件进行集成和组装编排，来生成全新的单体应用。”</p><p>由此看来，SOA架构实际上是集中式架构向服务化架构演化的过渡阶段，这种架构在短期阶段更适合已具备一定规模的企业，能快速继承现有业务系统，实现快速上线。</p><p>微服务架构包含的基本设施一般可以规划为以下几个分类：</p><h3 id="链路治理"><a href="#链路治理" class="headerlink" title="链路治理"></a>链路治理</h3><p>从集中式架构演化成服务化架构，必然会带来链路问题，由于微服务架构的各个服务都具备单独治理/部署的能力，导致原本集中式架构中能够确保的通信质量，在微服务架构中就难以得到相同指标的保障，因此微服务基础设施中，链路层的组件相对其他分类要多一些。</p><p>服务发现、路由、跟踪、监控、容错，这几类关键技术会一直围绕着链路层不断展开。</p><h3 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h3><p>与SOA架构不同的设计在于，微服务对通信和链路的要求更加轻量，服务与服务之间通过统一的协议进行数据交换，一般会采用RPC方式进行通信，早期不少企业也会直接采用HTTP协议进行通信。</p><h3 id="统一网关"><a href="#统一网关" class="headerlink" title="统一网关"></a>统一网关</h3><p>所有的服务相互协作，共同组织成一个完整的产品架构，由统一的网关负责对外提供产品服务，负责鉴权等等。</p><h3 id="工程自动化"><a href="#工程自动化" class="headerlink" title="工程自动化"></a>工程自动化</h3><p>由于产品规模的扩大，服务的拆分，人工测试与部署存在明显的效率低下问题。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;strong&gt;产业分工&lt;/strong&gt;是产品成长过程中的必经阶段，但凡产品具有不断壮大的机会，规模也会不断扩大，相应的工艺也会逐渐复杂，这种情况下，&lt;strong&gt;模块化生产&lt;/strong&gt;就是必要的生产方式。&lt;/p&gt;
&lt;p&gt;之前在创业群里，有连续创业并成功的大佬就说过：“我们平时买的包子，里面就包含很多道工序，有人负责种麦子，有人负责养猪，有人负责加工面粉，有人负责杀猪，最后早餐店里员工进行产品包装。”&lt;/p&gt;
&lt;p&gt;应用到软件架构，这些内在本质是相通的。随着用户量的不断增长，架构应对的数据规模也会逐渐发生质变，为什么几十年前不会诞生微服务这类概念，因为在那个时候互联网还远远不够目前的规模庞大。&lt;/p&gt;
    
    </summary>
    
      <category term="架构" scheme="https://oldchan.net/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="微服务" scheme="https://oldchan.net/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
  </entry>
  
  <entry>
    <title>配置服务迁移</title>
    <link href="https://oldchan.net/2021/04/06/arch/middleware/configuration/"/>
    <id>https://oldchan.net/2021/04/06/arch/middleware/configuration/</id>
    <published>2021-04-06T10:22:44.000Z</published>
    <updated>2022-06-02T14:51:37.059Z</updated>
    
    <content type="html"><![CDATA[<p>关于迁移配置服务，早在2019年就有过计划，不过当时正忙于重构系统，所以也只在新系统里用过<code>qcm</code>，而在那时，考虑公司内部有太多的老项目，下线<code>qconf</code>时间自然就延期了。</p><p>去年云平台邮件通知，配置服务需要迁移，老版本的<code>qconf</code>需要下线，机房也要清退了，只能将现有手里项目都改用qcm。</p><a id="more"></a><h2 id="QConf与QCM"><a href="#QConf与QCM" class="headerlink" title="QConf与QCM"></a>QConf与QCM</h2><h3 id="QConf"><a href="#QConf" class="headerlink" title="QConf"></a>QConf</h3><p>“QConf是一个集中式配置管理工具，能实现配置信息对业务的完全透明化。”</p><p><strong>特点</strong></p><ul><li>基于<code>zookeeper</code></li><li>需要安装<code>agent</code>进程</li></ul><h3 id="QCM"><a href="#QCM" class="headerlink" title="QCM"></a>QCM</h3><p>“是一款在分布式架构环境中对应用配置进行集中管理和及时推送的服务。”</p><p><strong>特点</strong></p><ul><li>基于<code>etcd</code></li><li>在易用性方面相较<code>qconf</code>多了更多的改进</li><li>废弃<code>qconf</code>结构中使用的<code>agent</code>进程，改用扩展模块嵌入服务模式</li></ul><h2 id="前期调研的部分问题"><a href="#前期调研的部分问题" class="headerlink" title="前期调研的部分问题"></a>前期调研的部分问题</h2><p><strong>qcm扩展存在偶现不稳定问题</strong></p><p><code>qcm</code>的多种SDK版本都是从同一份lib源代码编译而成，经过SWIG生成各种语言可用的SDK扩展文件，最早在go项目中使用时，也是采用<code>cgo</code>的模式进行引用，但在实际运营过程中，就发现一些小问题，比如断网后，偶现的重连失败，后来也有其他团队同学反馈，进程在引入<code>qcm</code>扩展后，运行时间久了，会有一定概率crash。</p><p><strong>项目中存在大量需要修改的逻辑代码</strong></p><p>现有的很多服务，在接入<code>qconf</code>时，存在规范问题，比如有些逻辑中会直接引用<code>qconf</code>的原生接口，而又有些逻辑中，会单独封装类进行处理。</p><p><strong>使用qconf时就计划要优化的问题</strong></p><p>目前配置服务中，主要存储的都是服务运行期间的各种策略开关、接口校验token、ak/sk之类的数据，在使用<code>qconf</code>存储配置时，虽然本地会有一个<code>agent</code>可以缓存数据，但主要是存储于文件中，在<code>qcm</code>是引入扩展，继承了本地文件缓存的方案，但配置迁移前后会有很大改动。</p><p><strong>qcm.so文件有17M</strong></p><p>容器化部署服务，会去优化镜像的大小，<code>qcm</code>的扩展比服务的基础大小还要大，也没有专门的go代码包。</p><h2 id="系统改进原则"><a href="#系统改进原则" class="headerlink" title="系统改进原则"></a>系统改进原则</h2><ol><li>剥离对特定扩展或环境的依赖，尽量用简单的组件接口进行封装实现，最后是选择用<code>qcm</code>的<code>rest</code>API进行数据读取</li><li>代码逻辑中，对基础组件进行抽象，定义接口，再做迁移时，只需要有合适的具体代码实现即可，而不必修改大量的项目代码</li><li>少量/访问频率较高数据，尽量使用进程缓存</li></ol><h2 id="代码逻辑"><a href="#代码逻辑" class="headerlink" title="代码逻辑"></a>代码逻辑</h2><p>以php版本举例，go版本类似，针对<code>qcm</code>实现了<code>Qcm</code>、<code>QcmCluster</code>的两个模块，一个负责读取<code>qcm</code>节点数据，一个汇总多个<code>Qcm</code>类的实例，主要用于调度和提升数据可用性，调度时，总是优先读取同机房数据，如果出现机房内部网络问题，会尝试读取其他机房数据(内部机房都是光纤直连，延迟在毫秒级)。</p><p><strong>配置接口(php版)</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ConfigInterface</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $key</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $value</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($key, $value)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结构方案"><a href="#结构方案" class="headerlink" title="结构方案"></a>结构方案</h2><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/04/17/5000472b3c45a818b12ff3562ed4ef07.png" alt="数据流程图"></p><p><code>r</code>表示读取，<code>w</code>表示写入</p><ol><li>go项目选用开源工具统一管理内存(避免随处定义变量)，用来缓存数据decode之后的结果变量，并且周期性更新，缓存数据不设定过期时间，但上游数据读取失败，会记录错误并告警，读取成功则更新本地缓存</li><li>php中采用<code>apc</code>进行缓存，也是缓存decode之后的数据，同样是避免每一次都需要对原数据进行decode而带来的额外开销，不同的是php环境下，没有使用更新任务，而是在缓存上设置了过期时间，在处理请求时，处罚缓存失效事件，并同时更新<code>apc</code>。php缓存下，没有使用shm特性，数据量不大，内存完全吃的开，也避免多进程处理shm时使用到锁</li><li>redis缓存配置数据，主要是防止<code>qcm</code>故障问题，起到一定的容灾作用</li></ol><h2 id="数据监控"><a href="#数据监控" class="headerlink" title="数据监控"></a>数据监控</h2><p>工作中，遇到过数据不更新或者更新不及时问题，在使用<code>qconf</code>时，就遇到过<code>agent</code>进程异常退出，本地数据不更新问题，而定位问题总是打印出配置数据，人为检查数据是不是最新。</p><p>另一个目的，是希望对数据能做好实时的监控，所以在新的配置数据中，定义了一个数据结构</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"ver"</span>: <span class="string">"1617160952"</span>,</span><br><span class="line">    <span class="attr">"format"</span>: <span class="string">"json"</span>,</span><br><span class="line">    <span class="attr">"value"</span>: <span class="string">"原始配置"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写入配置时记录版本号，数据在服务中被读取时，可以根据对比版本号，选择是否decode并更新配置数据，也避免重复的配置解析，而目前服务中用到的metrics监控，也专门针对配置设置了指标项，可以在<code>grafana</code>中，实时快捷查看，各节点数据的生效情况，起到数据遥测的作用。</p><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/04/14/5b0995b485c903ccd4c612392231dd32.jpg" alt="metrics部分数据"></p><p>在对配置数据增加额外结构时，除了增加版本字段和原始数据结构类型字段外，还有压缩和加密的方法字段，主要是考虑传输问题和共有服务中的数据安全问题。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;关于迁移配置服务，早在2019年就有过计划，不过当时正忙于重构系统，所以也只在新系统里用过&lt;code&gt;qcm&lt;/code&gt;，而在那时，考虑公司内部有太多的老项目，下线&lt;code&gt;qconf&lt;/code&gt;时间自然就延期了。&lt;/p&gt;
&lt;p&gt;去年云平台邮件通知，配置服务需要迁移，老版本的&lt;code&gt;qconf&lt;/code&gt;需要下线，机房也要清退了，只能将现有手里项目都改用qcm。&lt;/p&gt;
    
    </summary>
    
      <category term="架构" scheme="https://oldchan.net/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="中间件" scheme="https://oldchan.net/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
  </entry>
  
  <entry>
    <title>最小化docker镜像(补充内容)</title>
    <link href="https://oldchan.net/2021/03/30/container/docker/minimum_ext/"/>
    <id>https://oldchan.net/2021/03/30/container/docker/minimum_ext/</id>
    <published>2021-03-30T12:58:58.000Z</published>
    <updated>2022-06-02T12:47:44.816Z</updated>
    
    <content type="html"><![CDATA[<p>基于之前写的一篇《最小化docker镜像》做一些补充，对用到的工具，做一些解释和对比。</p><a id="more"></a><h2 id="Go程序构建时的-ldflags编译选项"><a href="#Go程序构建时的-ldflags编译选项" class="headerlink" title="Go程序构建时的-ldflags编译选项"></a>Go程序构建时的<code>-ldflags</code>编译选项</h2><p>构建程序时，引入选项<code>-ldflags=&quot;-w -s&quot;</code>，平均单个文件大小减小20%左右</p><p><strong>Command:</strong> <code>go tool link</code> ↓<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">usage: link [options] main.o</span><br><span class="line">  -B note</span><br><span class="line">    add an ELF NT_GNU_BUILD_ID note when using ELF</span><br><span class="line">  -E entry</span><br><span class="line">    <span class="keyword">set</span> entry symbol <span class="keyword">name</span></span><br><span class="line">  -H <span class="keyword">type</span></span><br><span class="line">    <span class="keyword">set</span> header <span class="keyword">type</span></span><br><span class="line">  -I linker</span><br><span class="line">    <span class="keyword">use</span> linker <span class="keyword">as</span> ELF dynamic linker</span><br><span class="line">  -L <span class="keyword">directory</span></span><br><span class="line">    <span class="keyword">add</span> specified <span class="keyword">directory</span> <span class="keyword">to</span> <span class="keyword">library</span> <span class="keyword">path</span></span><br><span class="line">  -R quantum</span><br><span class="line">    <span class="keyword">set</span> address rounding quantum (<span class="keyword">default</span> <span class="number">-1</span>)</span><br><span class="line">  -T address</span><br><span class="line">    <span class="keyword">set</span> <span class="built_in">text</span> <span class="keyword">segment</span> address (<span class="keyword">default</span> <span class="number">-1</span>)</span><br><span class="line">  -Vprint <span class="keyword">version</span> <span class="keyword">and</span> <span class="keyword">exit</span></span><br><span class="line">  -X definition</span><br><span class="line">    <span class="keyword">add</span> <span class="keyword">string</span> <span class="keyword">value</span> definition <span class="keyword">of</span> the <span class="keyword">form</span> importpath.name=<span class="keyword">value</span></span><br><span class="line">  -adisassemble <span class="keyword">output</span></span><br><span class="line">  -buildid <span class="keyword">id</span></span><br><span class="line">    <span class="built_in">record</span> <span class="keyword">id</span> <span class="keyword">as</span> <span class="keyword">Go</span> toolchain <span class="keyword">build</span> <span class="keyword">id</span></span><br><span class="line">  -buildmode <span class="keyword">mode</span></span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">build</span> <span class="keyword">mode</span></span><br><span class="line">  -cdump <span class="keyword">call</span> graph</span><br><span class="line">  -compressdwarf</span><br><span class="line">    <span class="keyword">compress</span> DWARF <span class="keyword">if</span> possible (<span class="keyword">default</span> <span class="literal">true</span>)</span><br><span class="line">  -cpuprofile <span class="keyword">file</span></span><br><span class="line">    write cpu profile <span class="keyword">to</span> <span class="keyword">file</span></span><br><span class="line">  -d<span class="keyword">disable</span> dynamic executable</span><br><span class="line">  -debugtramp <span class="built_in">int</span></span><br><span class="line">    debug trampolines</span><br><span class="line">  -dumpdep</span><br><span class="line">    dump symbol dependency graph</span><br><span class="line">  -extar <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">archive</span> program <span class="keyword">for</span> buildmode=c-<span class="keyword">archive</span></span><br><span class="line">  -extld linker</span><br><span class="line">    <span class="keyword">use</span> linker <span class="keyword">when</span> linking <span class="keyword">in</span> <span class="keyword">external</span> <span class="keyword">mode</span></span><br><span class="line">  -extldflags flags</span><br><span class="line">    pass flags <span class="keyword">to</span> <span class="keyword">external</span> linker</span><br><span class="line">  -f<span class="keyword">ignore</span> <span class="keyword">version</span> mismatch</span><br><span class="line">  -g<span class="keyword">disable</span> <span class="keyword">go</span> <span class="keyword">package</span> <span class="keyword">data</span> checks</span><br><span class="line">  -hhalt <span class="keyword">on</span> <span class="keyword">error</span></span><br><span class="line">  -importcfg <span class="keyword">file</span></span><br><span class="line">    <span class="keyword">read</span> <span class="keyword">import</span> configuration <span class="keyword">from</span> <span class="keyword">file</span></span><br><span class="line">  -installsuffix suffix</span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">package</span> <span class="keyword">directory</span> suffix</span><br><span class="line">  -k symbol</span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">field</span> <span class="keyword">tracking</span> symbol</span><br><span class="line">  -libgcc <span class="keyword">string</span></span><br><span class="line">    compiler support lib <span class="keyword">for</span> internal linking; <span class="keyword">use</span> <span class="string">"none"</span> <span class="keyword">to</span> <span class="keyword">disable</span></span><br><span class="line">  -linkmode <span class="keyword">mode</span></span><br><span class="line">    <span class="keyword">set</span> <span class="keyword">link</span> <span class="keyword">mode</span></span><br><span class="line">  -linkshared</span><br><span class="line">    <span class="keyword">link</span> against installed <span class="keyword">Go</span> <span class="keyword">shared</span> libraries</span><br><span class="line">  -memprofile <span class="keyword">file</span></span><br><span class="line">    write <span class="keyword">memory</span> profile <span class="keyword">to</span> <span class="keyword">file</span></span><br><span class="line">  -memprofilerate rate</span><br><span class="line">    <span class="keyword">set</span> runtime.MemProfileRate <span class="keyword">to</span> rate</span><br><span class="line">  -msan</span><br><span class="line">    <span class="keyword">enable</span> MSan <span class="keyword">interface</span></span><br><span class="line">  -ndump symbol <span class="keyword">table</span></span><br><span class="line">  -o <span class="keyword">file</span></span><br><span class="line">    write <span class="keyword">output</span> <span class="keyword">to</span> <span class="keyword">file</span></span><br><span class="line">  -pluginpath <span class="keyword">string</span></span><br><span class="line">    <span class="keyword">full</span> <span class="keyword">path</span> <span class="keyword">name</span> <span class="keyword">for</span> <span class="keyword">plugin</span></span><br><span class="line">  -r <span class="keyword">path</span></span><br><span class="line">    <span class="keyword">set</span> the ELF dynamic linker <span class="keyword">search</span> <span class="keyword">path</span> <span class="keyword">to</span> dir1:dir2:...</span><br><span class="line">  -race</span><br><span class="line">    <span class="keyword">enable</span> race detector</span><br><span class="line">  -s<span class="keyword">disable</span> symbol <span class="keyword">table</span> // 删除符号表</span><br><span class="line">  -strictdups <span class="built_in">int</span></span><br><span class="line">    sanity <span class="keyword">check</span> <span class="keyword">duplicate</span> symbol <span class="keyword">contents</span> during <span class="keyword">object</span> <span class="keyword">file</span> reading (<span class="number">1</span>=warn <span class="number">2</span>=err).</span><br><span class="line">  -tmpdir <span class="keyword">directory</span></span><br><span class="line">    <span class="keyword">use</span> <span class="keyword">directory</span> <span class="keyword">for</span> <span class="keyword">temporary</span> files</span><br><span class="line">  -u<span class="keyword">reject</span> <span class="keyword">unsafe</span> packages</span><br><span class="line">  -vprint <span class="keyword">link</span> <span class="keyword">trace</span></span><br><span class="line">  -w<span class="keyword">disable</span> DWARF generation // 删除DWARF调试信息</span><br></pre></td></tr></table></figure></p><h2 id="UPX压缩工具"><a href="#UPX压缩工具" class="headerlink" title="UPX压缩工具"></a>UPX压缩工具</h2><p>“<a href="https://upx.github.io/" target="_blank" rel="noopener"><strong>UPX</strong></a> is a free, portable, extendable, high-performance executable packer for several executable formats.”</p><p>源代码: <a href="https://github.com/upx/upx" target="_blank" rel="noopener">https://github.com/upx/upx</a></p><p><strong>Command:</strong> <code>upx --help</code> ↓<br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">                       Ultimate Packer for eXecutables</span><br><span class="line">                          Copyright (C) 1996 - 2020</span><br><span class="line">UPX 3.96        Markus Oberhumer, Laszlo Molnar &amp; John Reiser   Jan 23rd 2020</span><br><span class="line"></span><br><span class="line">Usage: upx [-123456789dlthVL] [-qvfk] [-o file] file..</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  -<span class="ruby"><span class="number">1</span>     compress faster                   -<span class="number">9</span>    compress better</span></span><br><span class="line"><span class="ruby">  --best compress best (can be slow <span class="keyword">for</span> big files)</span></span><br><span class="line"><span class="ruby">  -d     decompress                        -l    list compressed file</span></span><br><span class="line"><span class="ruby">  -t     test compressed file              -V    display version number</span></span><br><span class="line"><span class="ruby">  -h     give this help                    -L    display software license</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby"><span class="symbol">Options:</span></span></span><br><span class="line"><span class="ruby">  -q     be quiet                          -v    be verbose</span></span><br><span class="line"><span class="ruby">  -oFILE write output to <span class="string">'FILE'</span></span></span><br><span class="line"><span class="ruby">  -f     force compression of suspicious files</span></span><br><span class="line"><span class="ruby">  --no-color, --mono, --color, --no-progress   change look</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Compression tuning <span class="symbol">options:</span></span></span><br><span class="line"><span class="ruby">  --brute             try all available compression methods &amp; filters [slow]</span></span><br><span class="line"><span class="ruby">  --ultra-brute       try even more compression variants [very slow]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Backup <span class="symbol">options:</span></span></span><br><span class="line"><span class="ruby">  -k, --backup        keep backup files</span></span><br><span class="line"><span class="ruby">  --no-backup         no backup files [default]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Overlay <span class="symbol">options:</span></span></span><br><span class="line"><span class="ruby">  --overlay=copy      copy any extra data attached to the file [default]</span></span><br><span class="line"><span class="ruby">  --overlay=strip     strip any extra data attached to the file [DANGEROUS]</span></span><br><span class="line"><span class="ruby">  --overlay=skip      don<span class="string">'t compress a file with an overlay</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> djgpp2/<span class="symbol">coff:</span></span></span><br><span class="line"><span class="ruby">  --coff              produce COFF output [<span class="symbol">default:</span> EXE]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> dos/<span class="symbol">com:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8086</span>              make compressed com work on any <span class="number">8086</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> dos/<span class="symbol">exe:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8086</span>              make compressed exe work on any <span class="number">8086</span></span></span><br><span class="line"><span class="ruby">  --no-reloc          put no relocations <span class="keyword">in</span> to the exe header</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> dos/<span class="symbol">sys:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8086</span>              make compressed sys work on any <span class="number">8086</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> ps1/<span class="symbol">exe:</span></span></span><br><span class="line"><span class="ruby">  --<span class="number">8</span>-bit             uses <span class="number">8</span> bit size compression [<span class="symbol">default:</span> <span class="number">32</span> bit]</span></span><br><span class="line"><span class="ruby">  --<span class="number">8</span>mib-ram          <span class="number">8</span> megabyte memory limit [<span class="symbol">default:</span> <span class="number">2</span> MiB]</span></span><br><span class="line"><span class="ruby">  --boot-only         disables client/host transfer compatibility</span></span><br><span class="line"><span class="ruby">  --no-align          don<span class="string">'t align to 2048 bytes [enables: --console-run]</span></span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> watcom/<span class="symbol">le:</span></span></span><br><span class="line"><span class="ruby">  --le                produce LE output [<span class="symbol">default:</span> EXE]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> win32/pe, win64/pe, rtm32/pe &amp; arm/<span class="symbol">pe:</span></span></span><br><span class="line"><span class="ruby">  --compress-exports=<span class="number">0</span>    <span class="keyword">do</span> <span class="keyword">not</span> compress the export section</span></span><br><span class="line"><span class="ruby">  --compress-exports=<span class="number">1</span>    compress the export section [default]</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">0</span>      <span class="keyword">do</span> <span class="keyword">not</span> compress any icons</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">1</span>      compress all but the first icon</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">2</span>      compress all but the first icon directory [default]</span></span><br><span class="line"><span class="ruby">  --compress-icons=<span class="number">3</span>      compress all icons</span></span><br><span class="line"><span class="ruby">  --compress-resources=<span class="number">0</span>  <span class="keyword">do</span> <span class="keyword">not</span> compress any resources at all</span></span><br><span class="line"><span class="ruby">  --keep-resource=list    <span class="keyword">do</span> <span class="keyword">not</span> compress resources specified by list</span></span><br><span class="line"><span class="ruby">  --strip-relocs=<span class="number">0</span>        <span class="keyword">do</span> <span class="keyword">not</span> strip relocations</span></span><br><span class="line"><span class="ruby">  --strip-relocs=<span class="number">1</span>        strip relocations [default]</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">Options <span class="keyword">for</span> linux/<span class="symbol">elf:</span></span></span><br><span class="line"><span class="ruby">  --preserve-build-id     copy .gnu.note.build-id to compressed output</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">file..   executables to (de)compress</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">This version <span class="symbol">supports:</span></span></span><br><span class="line"><span class="ruby">    amd64-darwin.dylib                   dylib/amd64</span></span><br><span class="line"><span class="ruby">    amd64-darwin.macho                   macho/amd64</span></span><br><span class="line"><span class="ruby">    amd64-linux.elf                      linux/amd64</span></span><br><span class="line"><span class="ruby">    amd64-linux.kernel.vmlinux           vmlinux/amd64</span></span><br><span class="line"><span class="ruby">    amd64-win64.pe                       win64/pe</span></span><br><span class="line"><span class="ruby">    arm-darwin.macho                     macho/arm</span></span><br><span class="line"><span class="ruby">    arm-linux.elf                        linux/arm</span></span><br><span class="line"><span class="ruby">    arm-linux.kernel.vmlinux             vmlinux/arm</span></span><br><span class="line"><span class="ruby">    arm-linux.kernel.vmlinuz             vmlinuz/arm</span></span><br><span class="line"><span class="ruby">    arm-wince.pe                         arm/pe</span></span><br><span class="line"><span class="ruby">    arm64-darwin.macho                   macho/arm64</span></span><br><span class="line"><span class="ruby">    arm64-linux.elf                      linux/arm64</span></span><br><span class="line"><span class="ruby">    armeb-linux.elf                      linux/armeb</span></span><br><span class="line"><span class="ruby">    armeb-linux.kernel.vmlinux           vmlinux/armeb</span></span><br><span class="line"><span class="ruby">    fat-darwin.macho                     macho/fat</span></span><br><span class="line"><span class="ruby">    i086-dos16.com                       dos/com</span></span><br><span class="line"><span class="ruby">    i086-dos16.exe                       dos/exe</span></span><br><span class="line"><span class="ruby">    i086-dos16.sys                       dos/sys</span></span><br><span class="line"><span class="ruby">    i386-bsd.elf.execve                  bsd.exec/i386</span></span><br><span class="line"><span class="ruby">    i386-darwin.macho                    macho/i386</span></span><br><span class="line"><span class="ruby">    i386-dos32.djgpp2.coff               djgpp2/coff</span></span><br><span class="line"><span class="ruby">    i386-dos32.tmt.adam                  tmt/adam</span></span><br><span class="line"><span class="ruby">    i386-dos32.watcom.le                 watcom/le</span></span><br><span class="line"><span class="ruby">    i386-freebsd.elf                     freebsd/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.elf                       linux/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.elf.execve                linux.exec/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.elf.shell                 linux.sh/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.kernel.bvmlinuz           bvmlinuz/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.kernel.vmlinux            vmlinux/i386</span></span><br><span class="line"><span class="ruby">    i386-linux.kernel.vmlinuz            vmlinuz/i386</span></span><br><span class="line"><span class="ruby">    i386-netbsd.elf                      netbsd/i386</span></span><br><span class="line"><span class="ruby">    i386-openbsd.elf                     openbsd/i386</span></span><br><span class="line"><span class="ruby">    i386-win32.pe                        win32/pe</span></span><br><span class="line"><span class="ruby">    m68k-atari.tos                       atari/tos</span></span><br><span class="line"><span class="ruby">    mips-linux.elf                       linux/mips</span></span><br><span class="line"><span class="ruby">    mipsel-linux.elf                     linux/mipsel</span></span><br><span class="line"><span class="ruby">    mipsel.r300<span class="number">0</span>-ps1                     ps1/exe</span></span><br><span class="line"><span class="ruby">    powerpc-darwin.macho                 macho/ppc32</span></span><br><span class="line"><span class="ruby">    powerpc-linux.elf                    linux/ppc32</span></span><br><span class="line"><span class="ruby">    powerpc-linux.kernel.vmlinux         vmlinux/ppc32</span></span><br><span class="line"><span class="ruby">    powerpc64-linux.elf                  linux/ppc64</span></span><br><span class="line"><span class="ruby">    powerpc64le-darwin.macho             macho/ppc64le</span></span><br><span class="line"><span class="ruby">    powerpc64le-linux.elf                linux/ppc64le</span></span><br><span class="line"><span class="ruby">    powerpc64le-linux.kernel.vmlinux     vmlinux/ppc64le</span></span><br><span class="line"><span class="ruby"></span></span><br><span class="line"><span class="ruby">UPX comes with ABSOLUTELY NO WARRANTY; <span class="keyword">for</span> details visit <span class="symbol">https:</span>/<span class="regexp">/upx.github.io</span></span></span><br></pre></td></tr></table></figure></p><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>压缩<strong>可执行文件</strong>，压缩后的文件依然是可执行文件，并不影响程序的执行</li><li>老牌压缩软件，稳定，跨平台支持最好</li><li>团队维护，开发人员依然活跃</li><li>压缩比一般在20%-30%，如：10M压缩至3M</li></ul><h2 id="Docker运行镜像"><a href="#Docker运行镜像" class="headerlink" title="Docker运行镜像"></a>Docker运行镜像</h2><h3 id="alpine"><a href="#alpine" class="headerlink" title="alpine"></a>alpine</h3><p>“Alpine Linux是一个面向安全的轻型的Linux发行版,基于Alpine Linux的超小型Docker镜像,大小只有5MB，并且可以访问比其他基于BusyBox的镜像更完整的包存储库。 Alpine Linux采用了 musl libc和busybox以减小系统的体积和运行时资源消耗，由于小巧、功能完备，非常适合用于作为容器的基础镜像。”</p><p><strong>特点</strong></p><ul><li>轻量型linux发行版本，包含基于busybox的一些常用工具集</li><li>初始镜像大小在5M左右</li></ul><h3 id="scratch"><a href="#scratch" class="headerlink" title="scratch"></a>scratch</h3><p>“an explicitly empty image, especially for building images <code>FROM scratch</code>“</p><p><strong>特点</strong></p><ul><li>docker的虚拟镜像，镜像大小接近于0</li><li>通过<code>FROM scratch</code>指令引用，没有真实镜像文件</li></ul><h2 id="关于选择Go服务依赖包"><a href="#关于选择Go服务依赖包" class="headerlink" title="关于选择Go服务依赖包"></a>关于选择Go服务依赖包</h2><p>“选择合适的，功能满足即可，不求大而全”</p><p>例:</p><p>采用一个功能齐全的配置解析包来解析yaml</p><p>服务 &lt; spf13/viper &lt; fsnotify &lt; golang.org/x/sys/unix</p><ul><li>编译大小: 8M</li></ul><p>服务 &lt; yaml.v2</p><ul><li>编译大小: 5M</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;基于之前写的一篇《最小化docker镜像》做一些补充，对用到的工具，做一些解释和对比。&lt;/p&gt;
    
    </summary>
    
      <category term="容器" scheme="https://oldchan.net/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="容器化" scheme="https://oldchan.net/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Go：实现类似class的析构函数</title>
    <link href="https://oldchan.net/2021/02/20/language/go/struct_like_class/"/>
    <id>https://oldchan.net/2021/02/20/language/go/struct_like_class/</id>
    <published>2021-02-20T08:58:58.000Z</published>
    <updated>2022-06-02T12:47:44.817Z</updated>
    
    <content type="html"><![CDATA[<p>Go提供的revicer满足函数简单的method操作结构，但并没有提供构造与析构的机制，在有些场景下，我们仍然需要一些能自动释放资源的逻辑。</p><p>在Go进程模型中，维护了一种叫<code>finalizer</code>的结构，当内存对象不可访问、需要被GC时，GC程序会检查对象关联的<code>finalizer</code>函数，如果有，则调用一次<code>finalizer</code>函数，并移除关联的<code>finalizer</code>函数，然后该对象再次变成可访问状态，当下一次，该对象再次被GC时，便会被释放并回收。</p><p>在<code>runtime</code>包中，对外暴露了一个函数<code>SetFinalizer</code>，用来设置关联的<code>finalizer</code>函数。</p><a id="more"></a><h2 id="函数-runtime-SetFinalizer"><a href="#函数-runtime-SetFinalizer" class="headerlink" title="函数: runtime.SetFinalizer"></a>函数: <code>runtime.SetFinalizer</code></h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func SetFinalizer(obj <span class="class"><span class="keyword">interface</span></span>&#123;&#125;, finalizer <span class="class"><span class="keyword">interface</span></span>&#123;&#125;)</span><br></pre></td></tr></table></figure><!--more--><h2 id="构造与析构"><a href="#构造与析构" class="headerlink" title="构造与析构"></a>构造与析构</h2><ol><li>定义<code>Initializer</code>接口，约定初始化函数</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Initializer<span class="built_in"> interface </span>&#123;</span><br><span class="line">Init()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>定义<code>Finalizer</code>接口，约定析构函数</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type Finalizer<span class="built_in"> interface </span>&#123;</span><br><span class="line">Delete()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>定义<code>InitObject</code>函数用来初始化对象</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sample: `InitObject(obj)`</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitObject</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"><span class="comment">// 如果obj实现了Initializer</span></span><br><span class="line"><span class="keyword">if</span> ob, ok := obj.(Initializer); ok &#123;</span><br><span class="line">ob.Init()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果obj实现了Finalizer</span></span><br><span class="line"><span class="keyword">if</span> ob, ok := obj.(Finalizer); ok &#123;</span><br><span class="line">runtime.SetFinalizer(ob, <span class="function"><span class="keyword">func</span><span class="params">(ob Finalizer)</span></span> &#123;</span><br><span class="line">ob.Delete()</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sample <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Sample <span class="keyword">struct</span> &#123;</span><br><span class="line">*sample</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewSample returns a Sample.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSample</span><span class="params">()</span> *<span class="title">Sample</span></span> &#123;</span><br><span class="line"><span class="comment">// Private object</span></span><br><span class="line">s := &amp;sample&#123;&#125;</span><br><span class="line"><span class="comment">// Public object</span></span><br><span class="line">obj := &amp;Sample&#123;s&#125;</span><br><span class="line">&#123;</span><br><span class="line">InitObject(obj)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Init方法会在NewSample时，跟随InitObject执行。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sample)</span> <span class="title">Init</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"initialized\n"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Delete方法会在NewSample返回的obj需要被GC时调用。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sample)</span> <span class="title">Delete</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">"deleted\n"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><ul><li>如果对象存在循环引用，可能永远都不会被GC</li><li><code>finalizer</code>设置的函数只会在GC时被调用</li><li><code>finalizer</code>函数不适合处理太多耗时逻辑</li><li><code>finalizer</code>函数延长了对象的生命周期，如果不必要，尽量不使用</li></ul><p>我在一些项目中用到了自己封装的包，但只有少部分场景下用到了<code>Delete()</code>。</p><h2 id="代码包：github-com-thecxx-jarvis"><a href="#代码包：github-com-thecxx-jarvis" class="headerlink" title="代码包：github.com/thecxx/jarvis"></a>代码包：<a href="https://github.com/thecxx/jarvis" target="_blank" rel="noopener">github.com/thecxx/jarvis</a></h2>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Go提供的revicer满足函数简单的method操作结构，但并没有提供构造与析构的机制，在有些场景下，我们仍然需要一些能自动释放资源的逻辑。&lt;/p&gt;
&lt;p&gt;在Go进程模型中，维护了一种叫&lt;code&gt;finalizer&lt;/code&gt;的结构，当内存对象不可访问、需要被GC时，GC程序会检查对象关联的&lt;code&gt;finalizer&lt;/code&gt;函数，如果有，则调用一次&lt;code&gt;finalizer&lt;/code&gt;函数，并移除关联的&lt;code&gt;finalizer&lt;/code&gt;函数，然后该对象再次变成可访问状态，当下一次，该对象再次被GC时，便会被释放并回收。&lt;/p&gt;
&lt;p&gt;在&lt;code&gt;runtime&lt;/code&gt;包中，对外暴露了一个函数&lt;code&gt;SetFinalizer&lt;/code&gt;，用来设置关联的&lt;code&gt;finalizer&lt;/code&gt;函数。&lt;/p&gt;
    
    </summary>
    
      <category term="编程" scheme="https://oldchan.net/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="go" scheme="https://oldchan.net/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>最小化docker镜像</title>
    <link href="https://oldchan.net/2020/04/20/container/docker/minimum/"/>
    <id>https://oldchan.net/2020/04/20/container/docker/minimum/</id>
    <published>2020-04-20T08:58:58.000Z</published>
    <updated>2022-06-02T14:51:37.055Z</updated>
    
    <content type="html"><![CDATA[<p>容器化架构方案中，Worker节点启动容器需要获取对应版本的镜像，不管是从本地加载镜像或发布镜像，还是从镜像仓库拉取镜像，镜像越小，越易于传输。</p><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/03/25/a7515e192dbb713154406040450b08a2.png" alt="运行镜像大小"></p><a id="more"></a><h2 id="如何构建最小化容器镜像？"><a href="#如何构建最小化容器镜像？" class="headerlink" title="如何构建最小化容器镜像？"></a>如何构建最小化容器镜像？</h2><h3 id="服务程序足够小"><a href="#服务程序足够小" class="headerlink" title="服务程序足够小"></a>服务程序足够小</h3><p>在编译服务程序时，大部分研发同学都会选择默认的方案进行编译，但对于go编程程序而言，还是有更多的优化空间的。</p><ol><li><strong>优化编译选项</strong></li></ol><ul><li>如果能不使用cgo尽量不使用，如果一定要使用cgo的情况下尽量使用静态编译</li><li>go build是可以采用-ldflags=”-w -s”选项去掉调试信息与符号表<ul><li>-w：去掉调试信息，得到的程序就不能用gdb调试</li><li>-s：去掉符号表，panic时候的stack trace就没有任何文件名/行号信息</li></ul></li></ul><ol start="2"><li><strong>使用压缩壳</strong></li></ol><ul><li>网上看到很多优化镜像大小的文章，但是，从来没有看到有人提到用压缩壳的方案，也许是因为自己以前有写过压缩壳和脱壳的经历，最后选用了老牌的UPX进行压缩(主要是发现居然有linux版本的UPX)，压缩比一般在20~30%左右，但有一个问题，压缩后的程序，导入符号表被加密了，无法在压缩后ldd出依赖库，当有依赖库需要一起部署时，需要在压缩前提取</li><li>如果采用压缩壳，建议在编译阶段，尽量都采用静态编译，这样打包在程序内部的依赖库也能被压缩</li><li>经过压缩的程序，启动运行时会比未压缩程序稍慢，在程序大小20M-30M左右时，直观感觉能延迟0.2秒</li></ul><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/03/25/df56510465acf8ae5abcf551916e72fc.png" alt="UPX压缩指标"></p><h3 id="镜像本身运行的基本环境足够小"><a href="#镜像本身运行的基本环境足够小" class="headerlink" title="镜像本身运行的基本环境足够小"></a>镜像本身运行的基本环境足够小</h3><p>优化镜像，可以在构建镜像时，分成两阶段处理，第一个阶段：<code>构建环境</code>，第二个阶段：<code>运行环境</code>。</p><ol><li><strong>构建环境</strong></li></ol><p>主要用于构建程序使用，一般是提前构建好的成套环境，事先安装好了一系列构建环节必备的工具，如：gcc、go、glibc等等，保证程序编译正确，而且构建镜像可以作为通用构建镜像使用。</p><ol start="2"><li><strong>运行环境</strong></li></ol><p>主要在构建结束后，将必要的服务程序与依赖文件复制到运行镜像中，最终将运行镜像打包提交至仓库，而运行镜像可采用scratch空镜像作为基础镜像构建，确保系统环境最小化。</p><h3 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h3><table><thead><tr><th>—</th><th style="text-align:center">build</th><th style="text-align:center">build -ldflags=’-w’</th><th style="text-align:center">upx -9</th></tr></thead><tbody><tr><td>程序文件</td><td style="text-align:center">33M</td><td style="text-align:center">28M</td><td style="text-align:center">8.8M</td></tr><tr><td>镜像大小</td><td style="text-align:center">37M</td><td style="text-align:center">32M</td><td style="text-align:center">12M</td></tr></tbody></table><p>镜像本身的大小在3~4M左右，当程序编译时，若采用’-s’编译选项，程序文件能进一步缩小化到25M左右，但再经过UPX压缩却效果不明显，最多只能进一步压到8M大小，而日常工作中，会需要保留一些日志数据，所以一般都只使用’-w’编译选项。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;容器化架构方案中，Worker节点启动容器需要获取对应版本的镜像，不管是从本地加载镜像或发布镜像，还是从镜像仓库拉取镜像，镜像越小，越易于传输。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/03/25/a7515e192dbb713154406040450b08a2.png&quot; alt=&quot;运行镜像大小&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="容器" scheme="https://oldchan.net/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="容器化" scheme="https://oldchan.net/tags/%E5%AE%B9%E5%99%A8%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>CPU的时间观念</title>
    <link href="https://oldchan.net/2020/03/11/os/cpu_and_time_management/"/>
    <id>https://oldchan.net/2020/03/11/os/cpu_and_time_management/</id>
    <published>2020-03-11T08:26:21.000Z</published>
    <updated>2022-06-02T14:51:37.064Z</updated>
    
    <content type="html"><![CDATA[<p>“Next”</p><p>“Next”</p><p>“Next”</p><p>“…”</p><p>对于CPU而言，存在的唯一意义就是永无休止地执行下一条指令和各种Jump，就像一个没有灵魂的时间管理大师一样，从每一次机器被启动开始便周而复始地践行着自己的使命：<strong>让系统里没有难做的任务</strong>。</p><h2 id="CPU，系统与应用"><a href="#CPU，系统与应用" class="headerlink" title="CPU，系统与应用"></a>CPU，系统与应用</h2><p>CPU：CPU的时间很紧张，以单核CPU为例，CPU自始至终只能执行一个任务，也并不会在意具体是谁的任务，可能是系统的任务，也有可能是某个应用的任务，只需要保证执行的指令都在物理内存上即可。</p><p>系统：系统组织软件与硬件资源，给应用提供一个稳定的环境来执行用户交代的任务。</p><p>应用：用户的任务逻辑经过编译器处理，由源代码翻译成机器码，并静态地保存在应用程序文件中，当系统执行应用程序时，会根据应用中的初始设置，将应用加载到内存中并执行。</p><h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>为满足多道编程，提高CPU的利用率，系统引入进程概念对任务资源进行管理。</p><p>系统每执行一次应用，就会创建一个进程，并将应用的静态机器码加载到进程的内存中，再从程序入口开始执行。</p><p>进程是应用执行过程中的真正实体，资源的容器。</p><h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p><strong>线程是CPU的基本执行单位</strong>，同一个进程中可以包含一个或多个线程，多个线程共享进程的各种资源。除此之外，线程也具备一些独立维护的资源，如：调用栈，寄存器上下文，TLS等等。</p><p>将线程做为基本执行单元引入系统，能很大程度上降低进程级切换带来的性能开销，在很多操作系统中线程又被称之为<strong>轻量级进程</strong>，除了性能方面的改善之外，也为应用提供了并行执行任务的能力。</p><h2 id="线程切换"><a href="#线程切换" class="headerlink" title="线程切换"></a>线程切换</h2><p>“A thread is a path of execution within a process. A process can contain multiple threads.”</p><p>这是一篇技术文章中对于线程概念的总结，进程中包含应用的所有任务指令，线程可以从进程中任意可执行的内存位置开始执行指令。</p><p>假如某应用中存在类似如下几个函数：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_fun_A</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = get_a();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a + b = %d\n"</span>, a, <span class="number">11</span>, sum(a, <span class="number">11</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_fun_B</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = get_a();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a * b = %d\n"</span>, a, <span class="number">11</span>, mul(a, <span class="number">11</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mul</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_a</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>应用从main函数启动，分别创建了线程A从<code>thread_fun_A</code>开始执行和线程B从<code>thread_fun_B</code>开始执行，那两线程的执行路径分别是：</p><p>线程A：<code>thread_fun_A()</code>-&gt;<code>get_a()</code>-&gt;<code>sum()</code>-&gt;<code>printf()</code></p><p>线程B：<code>thread_fun_B()</code>-&gt;<code>get_a()</code>-&gt;<code>mul()</code>-&gt;<code>printf()</code></p><p>线程作为<strong>执行路径</strong>存在于系统的各进程和内核中，CPU作为执行人，需要频繁改变执行路径，时而在内核线程，时而在应用线程。</p><p><strong>那么，多线程系统中，CPU是怎么切换线程的呢？</strong></p><h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><p>系统一般会开放给应用程序很多有用的服务接口，应用基于这些接口可以实现很多有用的功能，比如最常见的读写文件，连接网络等等。</p><p>假如应用程序在执行某一个线程时，遇到需要写文件的操作，并且写的数据量较大，由于磁盘的性能弱于CPU，这时，在执行类似<code>fwrite</code>时，CPU就需要在内核调用中进入等待状态，等待磁盘操作完毕。很明显，这种情况下，CPU的使用率会明显下降，为了保证尽量少的出现这种情况，系统会挂起当前线程，并通过调度算法选择其他已就绪的线程供CPU继续执行，此时CPU的执行路径就发生了变化。</p><h3 id="放弃调度"><a href="#放弃调度" class="headerlink" title="放弃调度"></a>放弃调度</h3><p>跟系统调用类似，假如线程在执行过程中，并不需要调用系统执行具体功能，而是休眠一段时间或者等待某个信号产生再继续执行，会有类似<code>sleep</code>或<code>wait***</code>之类的系统接口调用，并进入挂起状态，此时CPU就会去执行其他就绪线程。</p><h3 id="时钟中断"><a href="#时钟中断" class="headerlink" title="时钟中断"></a>时钟中断</h3><p>有时，线程只需要执行某些算法代码，并不需要调用系统接口，假如算法复杂度较高，耗时较长，此时，CPU怎么保证执行线程时，不会被线程占用太多时间呢？因为其他线程的时间也是很宝贵的，CPU需要保证所有线程都能公平的被CPU执行。</p><p>为了防止CPU沉迷于某一个线程，系统在初始化的时候会初始化一个可编程的中断时钟，用来在线程执行超时时，向CPU产生一个中断，从而让CPU能够暂停线程的执行工作，回到内核，并调度其他线程。</p><hr><p><img src="https://fastly.jsdelivr.net/gh/thecxx/s1/img/2021/11/22/3892c458c06780d2c340c11ec505eeec.png" alt></p><p>CPU：“只要我够快，所有的线程都能得到满足😌”</p><p>进程：“我拥有应用执行过程中的所有资源，包括内存，句柄，线程执行路径等等”</p><p>线程：“我是进程的其中一条执行路径，CPU会按照我的指令执行”</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;“Next”&lt;/p&gt;
&lt;p&gt;“Next”&lt;/p&gt;
&lt;p&gt;“Next”&lt;/p&gt;
&lt;p&gt;“…”&lt;/p&gt;
&lt;p&gt;对于CPU而言，存在的唯一意义就是永无休止地执行下一条指令和各种Jump，就像一个没有灵魂的时间管理大师一样，从每一次机器被启动开始便周而复始地践行着自己的使命：&lt;st
      
    
    </summary>
    
      <category term="系统" scheme="https://oldchan.net/categories/%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="cpu" scheme="https://oldchan.net/tags/cpu/"/>
    
  </entry>
  
  <entry>
    <title>Redis：hash</title>
    <link href="https://oldchan.net/2018/09/23/notes/redis/type_hash/"/>
    <id>https://oldchan.net/2018/09/23/notes/redis/type_hash/</id>
    <published>2018-09-23T13:04:02.000Z</published>
    <updated>2022-06-02T12:47:44.822Z</updated>
    
    <content type="html"><![CDATA[<p>hash数据结构在redis缓存中应用比较广泛，一般数据集合都会采用hash结构来进行存储，比如: session数据、在线用户记录等等。</p><a id="more"></a><h2 id="hash的创建"><a href="#hash的创建" class="headerlink" title="hash的创建"></a>hash的创建</h2><p>使用hash时最常使用hset用来设置字段(“/src/t_hash.c”文件中)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hsetCommand</span><span class="params">(client *c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, created = <span class="number">0</span>;</span><br><span class="line">    robj *o;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((c-&gt;argc % <span class="number">2</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        addReplyError(c,<span class="string">"wrong number of arguments for HMSET"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((o = hashTypeLookupWriteOrCreate(c,c-&gt;argv[<span class="number">1</span>])) == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    hashTypeTryConversion(o,c-&gt;argv,<span class="number">2</span>,c-&gt;argc<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; c-&gt;argc; i += <span class="number">2</span>)</span><br><span class="line">        created += !hashTypeSet(o,c-&gt;argv[i]-&gt;ptr,c-&gt;argv[i+<span class="number">1</span>]-&gt;ptr,HASH_SET_COPY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* HMSET (deprecated) and HSET return value is different. */</span></span><br><span class="line">    <span class="keyword">char</span> *cmdname = c-&gt;argv[<span class="number">0</span>]-&gt;ptr;</span><br><span class="line">    <span class="keyword">if</span> (cmdname[<span class="number">1</span>] == <span class="string">'s'</span> || cmdname[<span class="number">1</span>] == <span class="string">'S'</span>) &#123;</span><br><span class="line">        <span class="comment">/* HSET */</span></span><br><span class="line">        addReplyLongLong(c, created);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* HMSET */</span></span><br><span class="line">        addReply(c, shared.ok);</span><br><span class="line">    &#125;</span><br><span class="line">    signalModifiedKey(c-&gt;db,c-&gt;argv[<span class="number">1</span>]);</span><br><span class="line">    notifyKeyspaceEvent(NOTIFY_HASH,<span class="string">"hset"</span>,c-&gt;argv[<span class="number">1</span>],c-&gt;db-&gt;id);</span><br><span class="line">    server.dirty++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><ul><li>hset执行时，首先会检查k-v对的数量是否匹配</li><li>然后查询客户端对应的当前db，查找key对应结构(没有则创建一个ziplist的结构对象)</li><li>获取到结果，再通过<code>hashTypeTryConversion</code>函数尝试转换为dict结构(根据参数值大小决定)</li><li><code>hsetCommand</code>结构根据参数的数量，可以同时支持<code>hset</code>与<code>hmset</code></li></ul><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>参考: <a href="http://redisdoc.com/hash/index.html" target="_blank" rel="noopener">Hash</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;hash数据结构在redis缓存中应用比较广泛，一般数据集合都会采用hash结构来进行存储，比如: session数据、在线用户记录等等。&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="redis" scheme="https://oldchan.net/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>PE文件加载器</title>
    <link href="https://oldchan.net/2018/09/10/os/windows/pe_loader/"/>
    <id>https://oldchan.net/2018/09/10/os/windows/pe_loader/</id>
    <published>2018-09-10T13:39:49.000Z</published>
    <updated>2022-06-02T12:47:44.823Z</updated>
    
    <content type="html"><![CDATA[<p>分享一份自己之前总结以前的代码写的dll内存加载库C++版本<strong>项目要自行编译生成lib文件</strong></p><p>支持：</p><ol><li>Win32标准Dll </li><li>MFC Dll </li><li>易语言Dll </li><li>其他环境下生成的Dll<br><strong>但</strong> 不能加壳加密(原因跟加载方式有关，未添加至进程模块链表)</li></ol><a id="more"></a><h2 id="部分代码"><a href="#部分代码" class="headerlink" title="部分代码"></a>部分代码</h2><p>File: include/ldr.h<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* __ldr_header__ */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __LDR_H__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __LDR_H__</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _DEBUG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"image.d.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">"image.lib"</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _WIN32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;WinNT.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span> Current platform is not supported</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">PVOID</span> <span class="params">(__stdcall *<span class="keyword">malloc_t</span>)</span> <span class="params">(ULONG)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">VOID</span>  <span class="params">(__stdcall *<span class="keyword">free_t</span>)</span>   <span class="params">(PVOID)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">PVOID   <span class="title">LdrLoadImage</span>      <span class="params">(PVOID Buffer, DWORD Size, <span class="keyword">malloc_t</span> m = <span class="literal">NULL</span>, <span class="keyword">free_t</span> f = <span class="literal">NULL</span>)</span></span>;</span><br><span class="line"><span class="function">PVOID   <span class="title">LdrGetProcAddress</span> <span class="params">(PVOID Addr, LPCSTR Name)</span></span>;</span><br><span class="line"><span class="function">VOID    <span class="title">LdrFreeImage</span>      <span class="params">(PVOID Addr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p><p>File: image/traps/GetModuleHandleW.asm</p><p>加入汇编代码主要是为了做中间层hook处理，否则非正常加载的模块部分接口不可用</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">.386</span></span><br><span class="line"><span class="meta">.Model</span> flat, StdCall</span><br><span class="line"><span class="meta">Option</span> CaseMap: none</span><br><span class="line"> </span><br><span class="line">Include    trap.inc</span><br><span class="line"> </span><br><span class="line"><span class="meta">.Const</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">.Data</span>?</span><br><span class="line"> </span><br><span class="line"><span class="meta">.Data</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">.Code</span></span><br><span class="line"> </span><br><span class="line">GetModuleHandleWTrap Proc Uses <span class="built_in">Ebx</span> <span class="built_in">Ecx</span> <span class="built_in">Edx</span> <span class="built_in">Esi</span> <span class="built_in">Edi</span>, lpModuleName: <span class="built_in">Ptr</span> WCHAR</span><br><span class="line">    <span class="comment">; Mov Esi, 0x********</span></span><br><span class="line">    Mov_Esi_Information</span><br><span class="line">    <span class="comment">; Pointer to ImageInformation</span></span><br><span class="line">    <span class="meta">Assume</span> <span class="built_in">Esi</span>: <span class="built_in">Ptr</span> ImageInformation</span><br><span class="line"> </span><br><span class="line"><span class="meta">    .If</span> lpModuleName == <span class="number">0</span></span><br><span class="line">        <span class="keyword">Push</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].traps[SizeOf ImageTrap * TRAP_ID_GET_MODULE_HANDLE_W].procedure</span><br><span class="line"><span class="meta">    .Else</span></span><br><span class="line">        <span class="keyword">Lea</span> <span class="built_in">Ebx</span>, [<span class="built_in">Esi</span>].ModuleNameW</span><br><span class="line">        <span class="keyword">Push</span> <span class="built_in">Ebx</span></span><br><span class="line">        <span class="keyword">Push</span> lpModuleName</span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].apis.lstrcmpiW</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Cmp</span> <span class="built_in">Eax</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">Je</span> __COPY</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Lea</span> <span class="built_in">Ebx</span>, [<span class="built_in">Esi</span>].ModuleBaseNameW</span><br><span class="line">        <span class="keyword">Push</span> <span class="built_in">Ebx</span></span><br><span class="line">        <span class="keyword">Push</span> lpModuleName</span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].apis.lstrcmpiW  </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Cmp</span> <span class="built_in">Eax</span>, <span class="number">0</span></span><br><span class="line">        <span class="keyword">Jne</span> __<span class="keyword">CALL</span></span><br><span class="line"> </span><br><span class="line"><span class="symbol">    __COPY:</span></span><br><span class="line">        <span class="keyword">Mov</span> <span class="built_in">Eax</span>, [<span class="built_in">Esi</span>].imagebase</span><br><span class="line">        <span class="keyword">Jmp</span> @F</span><br><span class="line"> </span><br><span class="line"><span class="symbol">    __CALL:</span>   </span><br><span class="line">        <span class="keyword">Push</span> lpModuleName</span><br><span class="line">        <span class="keyword">Call</span> [<span class="built_in">Esi</span>].traps[SizeOf ImageTrap * TRAP_ID_GET_MODULE_HANDLE_W].procedure</span><br><span class="line">    @@:</span><br><span class="line"><span class="meta">    .EndIf</span></span><br><span class="line"> </span><br><span class="line">    Return <span class="built_in">Eax</span></span><br><span class="line">GetModuleHandleWTrap EndP</span><br><span class="line"> </span><br><span class="line">End</span><br></pre></td></tr></table></figure><h2 id="使用接口-对应关系"><a href="#使用接口-对应关系" class="headerlink" title="使用接口(对应关系)"></a>使用接口(对应关系)</h2><ul><li>LdrLoadImage      = LoadLibrary</li><li>LdrGetProcAddress = GetProcAddress</li><li>LdrFreeImage      = FreeLibrary</li></ul><h2 id="项目地址"><a href="#项目地址" class="headerlink" title="项目地址"></a>项目地址</h2><p><a href="https://github.com/kamichan/image" target="_blank" rel="noopener">https://github.com/thecxx/image</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;分享一份自己之前总结以前的代码写的dll内存加载库C++版本&lt;strong&gt;项目要自行编译生成lib文件&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;支持：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Win32标准Dll &lt;/li&gt;
&lt;li&gt;MFC Dll &lt;/li&gt;
&lt;li&gt;易语言Dll &lt;/li&gt;
&lt;li&gt;其他环境下生成的Dll&lt;br&gt;&lt;strong&gt;但&lt;/strong&gt; 不能加壳加密(原因跟加载方式有关，未添加至进程模块链表)&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="系统" scheme="https://oldchan.net/categories/%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="windows" scheme="https://oldchan.net/tags/windows/"/>
    
  </entry>
  
  <entry>
    <title>Redis：常用数据结构</title>
    <link href="https://oldchan.net/2018/09/10/notes/redis/types/"/>
    <id>https://oldchan.net/2018/09/10/notes/redis/types/</id>
    <published>2018-09-10T12:56:40.000Z</published>
    <updated>2022-06-02T12:47:44.822Z</updated>
    
    <content type="html"><![CDATA[<p>redis不仅支持最简单的k-v数据，还提供其他多种场景可用的数据结构: hash/list/set/zset等等。</p><ul><li><strong><a href="/2018/09/23/redis/type_hash/">hash</a></strong></li><li><strong><a href="#">list</a></strong></li><li><strong><a href="#">set</a></strong></li><li><strong><a href="#">zset</a></strong></li></ul><a id="more"></a><h2 id="redis数据存储"><a href="#redis数据存储" class="headerlink" title="redis数据存储"></a>redis数据存储</h2><p>redis维护的db数据结构<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisDb</span> &#123;</span></span><br><span class="line">    dict *dict;                 <span class="comment">/* The keyspace for this DB */</span></span><br><span class="line">    dict *expires;              <span class="comment">/* Timeout of keys with a timeout set */</span></span><br><span class="line">    dict *blocking_keys;        <span class="comment">/* Keys with clients waiting for data (BLPOP)*/</span></span><br><span class="line">    dict *ready_keys;           <span class="comment">/* Blocked keys that received a PUSH */</span></span><br><span class="line">    dict *watched_keys;         <span class="comment">/* WATCHED keys for MULTI/EXEC CAS */</span></span><br><span class="line">    <span class="keyword">int</span> id;                     <span class="comment">/* Database ID */</span></span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> avg_ttl;          <span class="comment">/* Average TTL, just for stats */</span></span><br><span class="line">    <span class="built_in">list</span> *defrag_later;         <span class="comment">/* List of key names to attempt to defrag one by one, gradually. */</span></span><br><span class="line">&#125; redisDb;</span><br></pre></td></tr></table></figure></p><ul><li>dict: 保存的是当前db中所有key的一个dict结构</li></ul><p>从一个指定db的dict结构中查找到对应<code>redisObject</code>结构的对象<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">redisObject</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> type:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> encoding:<span class="number">4</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> lru:LRU_BITS; <span class="comment">/* LRU time (relative to global lru_clock) or</span></span><br><span class="line"><span class="comment">                            * LFU data (least significant 8 bits frequency</span></span><br><span class="line"><span class="comment">                            * and most significant 16 bits access time). */</span></span><br><span class="line">    <span class="keyword">int</span> refcount;</span><br><span class="line">    <span class="keyword">void</span> *ptr;</span><br><span class="line">&#125; robj;</span><br></pre></td></tr></table></figure></p><ul><li>通过给定的命令，检查数据是否可操作</li><li>redis默认db数量为16</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;redis不仅支持最简单的k-v数据，还提供其他多种场景可用的数据结构: hash/list/set/zset等等。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;/2018/09/23/redis/type_hash/&quot;&gt;hash&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;#&quot;&gt;list&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;#&quot;&gt;set&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&quot;#&quot;&gt;zset&lt;/a&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="redis" scheme="https://oldchan.net/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Go：语言监听进程退出信号</title>
    <link href="https://oldchan.net/2018/09/10/language/go/when_process_exit/"/>
    <id>https://oldchan.net/2018/09/10/language/go/when_process_exit/</id>
    <published>2018-09-10T11:14:30.000Z</published>
    <updated>2022-06-02T12:47:44.818Z</updated>
    
    <content type="html"><![CDATA[<p>项目中经常需要在进程退出时处理一些资源回收操作，打开的资源需要关闭，创建的临时数据需要销毁等等…</p><a id="more"></a><h2 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a>实现过程</h2><p>通过<code>os/signal</code>包来获取进程信号接收管道，用一个goroutine来等待指定的信号</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"os/signal"</span></span><br><span class="line"><span class="string">"syscall"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">exitHandlers []<span class="function"><span class="keyword">func</span><span class="params">(os.Signal)</span></span></span><br><span class="line"><span class="function">)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// 捕获进程退出信号，执行回调</span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">WhenExit</span><span class="params">(handler <span class="keyword">func</span>(os.Signal)</span>)</span> &#123;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(exitHandlers) == <span class="number">0</span> &#123;</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</span><br><span class="line">sigs := []os.Signal&#123;</span><br><span class="line">syscall.SIGHUP,</span><br><span class="line">syscall.SIGINT,</span><br><span class="line">syscall.SIGTERM,</span><br><span class="line">syscall.SIGQUIT,</span><br><span class="line">syscall.SIGUSR1,</span><br><span class="line">syscall.SIGUSR2,</span><br><span class="line">&#125;</span><br><span class="line">signal.Notify(ch, sigs...)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := &lt;-ch</span><br><span class="line"><span class="keyword">for</span> _, handler := <span class="keyword">range</span> exitHandlers &#123;</span><br><span class="line">handler(s)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 增加退出回调</span></span><br><span class="line">exitHandlers = <span class="built_in">append</span>(exitHandlers, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WhenExit(<span class="function"><span class="keyword">func</span><span class="params">(sig os.Signal)</span></span> &#123;</span><br><span class="line">    <span class="comment">// @todo something</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;项目中经常需要在进程退出时处理一些资源回收操作，打开的资源需要关闭，创建的临时数据需要销毁等等…&lt;/p&gt;
    
    </summary>
    
      <category term="编程" scheme="https://oldchan.net/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
      <category term="go" scheme="https://oldchan.net/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Redis：浅析redis启动流程</title>
    <link href="https://oldchan.net/2018/08/24/notes/redis/startup/"/>
    <id>https://oldchan.net/2018/08/24/notes/redis/startup/</id>
    <published>2018-08-24T02:42:16.000Z</published>
    <updated>2022-06-02T12:47:44.822Z</updated>
    
    <content type="html"><![CDATA[<p>阅读了下redis的源代码，了解一下服务的启动流程。</p><a id="more"></a><h2 id="程序入口main"><a href="#程序入口main" class="headerlink" title="程序入口main"></a>程序入口main</h2><p>main函数做为c语言程序入口，redis中的main函数在文件”/src/server.c”中</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> REDIS_TEST</span></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">3</span> &amp;&amp; !strcasecmp(argv[<span class="number">1</span>], <span class="string">"test"</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"ziplist"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ziplistTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"quicklist"</span>)) &#123;</span><br><span class="line">            quicklistTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"intset"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> intsetTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"zipmap"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> zipmapTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"sha1test"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> sha1Test(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"util"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> utilTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"sds"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> sdsTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"endianconv"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> endianconvTest(argc, argv);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!strcasecmp(argv[<span class="number">2</span>], <span class="string">"crc64"</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> crc64Test(argc, argv);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">/* test not found */</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to initialize our libraries, and the server configuration. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> INIT_SETPROCTITLE_REPLACEMENT</span></span><br><span class="line">    spt_init(argc, argv);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置本地化</span></span><br><span class="line">    setlocale(LC_COLLATE,<span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置时区</span></span><br><span class="line">    tzset(); <span class="comment">/* Populates 'timezone' global. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// OOM保护机制的处理接口</span></span><br><span class="line">    zmalloc_set_oom_handler(redisOutOfMemoryHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成随机种子</span></span><br><span class="line">    srand(time(<span class="literal">NULL</span>)^getpid());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取时间</span></span><br><span class="line">    gettimeofday(&amp;tv,<span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成一个随机16位长度字符串，用于后续使用生成hash(siphash)值时</span></span><br><span class="line">    <span class="keyword">char</span> hashseed[<span class="number">16</span>];</span><br><span class="line">    getRandomHexChars(hashseed,<span class="keyword">sizeof</span>(hashseed));</span><br><span class="line">    dictSetHashFunctionSeed((<span class="keyword">uint8_t</span>*)hashseed);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检测是否启用sentinel</span></span><br><span class="line">    server.sentinel_mode = checkForSentinelMode(argc,argv);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务器配置</span></span><br><span class="line">    initServerConfig();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化模块系统</span></span><br><span class="line">    moduleInitModulesSystem();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Store the executable path and arguments in a safe place in order</span></span><br><span class="line"><span class="comment">     * to be able to restart the server later. */</span></span><br><span class="line">    server.executable = getAbsolutePath(argv[<span class="number">0</span>]);</span><br><span class="line">    server.exec_argv = zmalloc(<span class="keyword">sizeof</span>(<span class="keyword">char</span>*)*(argc+<span class="number">1</span>));</span><br><span class="line">    server.exec_argv[argc] = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; argc; j++) server.exec_argv[j] = zstrdup(argv[j]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果需要启动sentinel，则进行sentinel的初始化工作</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* We need to init sentinel right now as parsing the configuration file</span></span><br><span class="line"><span class="comment">     * in sentinel mode will have the effect of populating the sentinel</span></span><br><span class="line"><span class="comment">     * data structures with master nodes to monitor. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.sentinel_mode) &#123;</span><br><span class="line">        initSentinelConfig();</span><br><span class="line">        initSentinel();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如只需检测rdb/aof是否正常可用，则检测完退出启动流程</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if we need to start in redis-check-rdb/aof mode. We just execute</span></span><br><span class="line"><span class="comment">     * the program main. However the program is part of the Redis executable</span></span><br><span class="line"><span class="comment">     * so that we can easily execute an RDB check on loading errors. */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[<span class="number">0</span>],<span class="string">"redis-check-rdb"</span>) != <span class="literal">NULL</span>)</span><br><span class="line">        redis_check_rdb_main(argc,argv,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(argv[<span class="number">0</span>],<span class="string">"redis-check-aof"</span>) != <span class="literal">NULL</span>)</span><br><span class="line">        redis_check_aof_main(argc,argv);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        j = <span class="number">1</span>; <span class="comment">/* First option to parse in argv[] */</span></span><br><span class="line">        sds options = sdsempty();</span><br><span class="line">        <span class="keyword">char</span> *configfile = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查看版本/help相关操作，会在执行之后退出启动流程</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Handle special options --help and --version */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-v"</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--version"</span>) == <span class="number">0</span>) version();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--help"</span>) == <span class="number">0</span> ||</span><br><span class="line">            <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"-h"</span>) == <span class="number">0</span>) usage();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">"--test-memory"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (argc == <span class="number">3</span>) &#123;</span><br><span class="line">                memtest(atoi(argv[<span class="number">2</span>]),<span class="number">50</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Please specify the amount of memory to test in megabytes.\n"</span>);</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">"Example: ./redis-server --test-memory 4096\n\n"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 命令行参数格式: --参数名(上面-v/-h等参数特殊处理除外)</span></span><br><span class="line">        <span class="comment">// 第一个参数必须是非"--"前缀格式才做为配置文件解析</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* First argument is the config file name? */</span></span><br><span class="line">        <span class="keyword">if</span> (argv[j][<span class="number">0</span>] != <span class="string">'-'</span> || argv[j][<span class="number">1</span>] != <span class="string">'-'</span>) &#123;</span><br><span class="line">            configfile = argv[j];</span><br><span class="line">            server.configfile = getAbsolutePath(configfile);</span><br><span class="line">            <span class="comment">/* Replace the config file in server.exec_argv with</span></span><br><span class="line"><span class="comment">             * its absolute path. */</span></span><br><span class="line">            zfree(server.exec_argv[j]);</span><br><span class="line">            server.exec_argv[j] = zstrdup(server.configfile);</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* All the other options are parsed and conceptually appended to the</span></span><br><span class="line"><span class="comment">         * configuration file. For instance --port 6380 will generate the</span></span><br><span class="line"><span class="comment">         * string "port 6380\n" to be parsed after the actual file name</span></span><br><span class="line"><span class="comment">         * is parsed, if any. */</span></span><br><span class="line">        <span class="keyword">while</span>(j != argc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (argv[j][<span class="number">0</span>] == <span class="string">'-'</span> &amp;&amp; argv[j][<span class="number">1</span>] == <span class="string">'-'</span>) &#123;</span><br><span class="line">                <span class="comment">/* Option name */</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[j], <span class="string">"--check-rdb"</span>)) &#123;</span><br><span class="line">                    <span class="comment">/* Argument has no options, need to skip for parsing. */</span></span><br><span class="line">                    j++;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (sdslen(options)) options = sdscat(options,<span class="string">"\n"</span>);</span><br><span class="line">                options = sdscat(options,argv[j]+<span class="number">2</span>);</span><br><span class="line">                options = sdscat(options,<span class="string">" "</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* Option argument */</span></span><br><span class="line">                options = sdscatrepr(options,argv[j],<span class="built_in">strlen</span>(argv[j]));</span><br><span class="line">                options = sdscat(options,<span class="string">" "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (server.sentinel_mode &amp;&amp; configfile &amp;&amp; *configfile == <span class="string">'-'</span>) &#123;</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">"Sentinel config from STDIN not allowed."</span>);</span><br><span class="line">            serverLog(LL_WARNING,</span><br><span class="line">                <span class="string">"Sentinel needs config file on disk to save state.  Exiting..."</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        resetServerSaveParams();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加载配置文件，同时会将命令行参数追加到配置中，解析配置时会进行覆盖</span></span><br><span class="line">        loadServerConfig(configfile,options);</span><br><span class="line"></span><br><span class="line">        sdsfree(options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serverLog(LL_WARNING, <span class="string">"oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo"</span>);</span><br><span class="line">    serverLog(LL_WARNING,</span><br><span class="line">        <span class="string">"Redis version=%s, bits=%d, commit=%s, modified=%d, pid=%d, just started"</span>,</span><br><span class="line">            REDIS_VERSION,</span><br><span class="line">            (<span class="keyword">sizeof</span>(<span class="keyword">long</span>) == <span class="number">8</span>) ? <span class="number">64</span> : <span class="number">32</span>,</span><br><span class="line">            redisGitSHA1(),</span><br><span class="line">            strtol(redisGitDirty(),<span class="literal">NULL</span>,<span class="number">10</span>) &gt; <span class="number">0</span>,</span><br><span class="line">            (<span class="keyword">int</span>)getpid());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">1</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">"Warning: no config file specified, using the default config. In order to specify a config file use %s /path/to/%s.conf"</span>, argv[<span class="number">0</span>], server.sentinel_mode ? <span class="string">"sentinel"</span> : <span class="string">"redis"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        serverLog(LL_WARNING, <span class="string">"Configuration loaded"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否启用后台进程，如果启用则当前进程将在创建子进程成功之后退出</span></span><br><span class="line"></span><br><span class="line">    server.supervised = redisIsSupervised(server.supervised_mode);</span><br><span class="line">    <span class="keyword">int</span> background = server.daemonize &amp;&amp; !server.supervised;</span><br><span class="line">    <span class="keyword">if</span> (background) daemonize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化服务器各项结构</span></span><br><span class="line">    initServer();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (background || server.pidfile) createPidFile();</span><br><span class="line">    redisSetProcTitle(argv[<span class="number">0</span>]);</span><br><span class="line">    redisAsciiArt();</span><br><span class="line">    checkTcpBacklogSettings();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!server.sentinel_mode) &#123;</span><br><span class="line">        <span class="comment">/* Things not needed when running in Sentinel mode. */</span></span><br><span class="line">        serverLog(LL_WARNING,<span class="string">"Server initialized"</span>);</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> __linux__</span></span><br><span class="line">        linuxMemoryWarnings();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过模块队列加载模块</span></span><br><span class="line">        moduleLoadFromQueue();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过aof/rdb加载数据</span></span><br><span class="line">        loadDataFromDisk();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (server.cluster_enabled) &#123;</span><br><span class="line">            <span class="keyword">if</span> (verifyClusterConfigWithData() == C_ERR) &#123;</span><br><span class="line">                serverLog(LL_WARNING,</span><br><span class="line">                    <span class="string">"You can't have keys in a DB different than DB 0 when in "</span></span><br><span class="line">                    <span class="string">"Cluster mode. Exiting."</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (server.ipfd_count &gt; <span class="number">0</span>)</span><br><span class="line">            serverLog(LL_NOTICE,<span class="string">"Ready to accept connections"</span>);</span><br><span class="line">        <span class="keyword">if</span> (server.sofd &gt; <span class="number">0</span>)</span><br><span class="line">            serverLog(LL_NOTICE,<span class="string">"The server is now ready to accept connections at %s"</span>, server.unixsocket);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sentinelIsRunning();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Warning the user about suspicious maxmemory setting. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.maxmemory &gt; <span class="number">0</span> &amp;&amp; server.maxmemory &lt; <span class="number">1024</span>*<span class="number">1024</span>) &#123;</span><br><span class="line">        serverLog(LL_WARNING,<span class="string">"WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?"</span>, server.maxmemory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进入主循环的一次回调</span></span><br><span class="line">    aeSetBeforeSleepProc(server.el,beforeSleep);</span><br><span class="line">    <span class="comment">// 监听到事件之后的一次回调</span></span><br><span class="line">    aeSetAfterSleepProc(server.el,afterSleep);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 开启事件循环</span></span><br><span class="line">    aeMain(server.el);</span><br><span class="line"></span><br><span class="line">    aeDeleteEventLoop(server.el);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="事件循环aeMain"><a href="#事件循环aeMain" class="headerlink" title="事件循环aeMain"></a>事件循环aeMain</h2><p>服务启动之后，初始化完毕，就开始执行事件循环系统(“/src/ae.c”文件中)<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">aeMain</span><span class="params">(aeEventLoop *eventLoop)</span> </span>&#123;</span><br><span class="line">    eventLoop-&gt;stop = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (!eventLoop-&gt;stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventLoop-&gt;beforesleep != <span class="literal">NULL</span>)</span><br><span class="line">            eventLoop-&gt;beforesleep(eventLoop);</span><br><span class="line">        <span class="comment">// 处理事件</span></span><br><span class="line">        aeProcessEvents(eventLoop, AE_ALL_EVENTS|AE_CALL_AFTER_SLEEP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="循环前的beforesleep"><a href="#循环前的beforesleep" class="headerlink" title="循环前的beforesleep"></a>循环前的beforesleep</h2><p>关于<code>beforesleep</code>的代码也整理出来看看<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This function gets called every time Redis is entering the</span></span><br><span class="line"><span class="comment"> * main loop of the event driven library, that is, before to sleep</span></span><br><span class="line"><span class="comment"> * for ready file descriptors. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">beforeSleep</span><span class="params">(struct aeEventLoop *eventLoop)</span> </span>&#123;</span><br><span class="line">    UNUSED(eventLoop);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Call the Redis Cluster before sleep function. Note that this function</span></span><br><span class="line"><span class="comment">     * may change the state of Redis Cluster (from ok to fail or vice versa),</span></span><br><span class="line"><span class="comment">     * so it's a good idea to call it before serving the unblocked clients</span></span><br><span class="line"><span class="comment">     * later in this function. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.cluster_enabled) clusterBeforeSleep();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Key过期处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Run a fast expire cycle (the called function will return</span></span><br><span class="line"><span class="comment">     * ASAP if a fast cycle is not needed). */</span></span><br><span class="line">    <span class="keyword">if</span> (server.active_expire_enabled &amp;&amp; server.masterhost == <span class="literal">NULL</span>)</span><br><span class="line">        activeExpireCycle(ACTIVE_EXPIRE_CYCLE_FAST);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 跟slave库的联系/数据的同步等等</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send all the slaves an ACK request if at least one client blocked</span></span><br><span class="line"><span class="comment">     * during the previous event loop iteration. */</span></span><br><span class="line">    <span class="keyword">if</span> (server.get_ack_from_slaves) &#123;</span><br><span class="line">        robj *argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">        argv[<span class="number">0</span>] = createStringObject(<span class="string">"REPLCONF"</span>,<span class="number">8</span>);</span><br><span class="line">        argv[<span class="number">1</span>] = createStringObject(<span class="string">"GETACK"</span>,<span class="number">6</span>);</span><br><span class="line">        argv[<span class="number">2</span>] = createStringObject(<span class="string">"*"</span>,<span class="number">1</span>); <span class="comment">/* Not used argument. */</span></span><br><span class="line">        replicationFeedSlaves(server.slaves, server.slaveseldb, argv, <span class="number">3</span>);</span><br><span class="line">        decrRefCount(argv[<span class="number">0</span>]);</span><br><span class="line">        decrRefCount(argv[<span class="number">1</span>]);</span><br><span class="line">        decrRefCount(argv[<span class="number">2</span>]);</span><br><span class="line">        server.get_ack_from_slaves = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理上一个循环中未响应完的处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Unblock all the clients blocked for synchronous replication</span></span><br><span class="line"><span class="comment">     * in WAIT. */</span></span><br><span class="line">    <span class="keyword">if</span> (listLength(server.clients_waiting_acks))</span><br><span class="line">        processClientsWaitingReplicas();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check if there are clients unblocked by modules that implement</span></span><br><span class="line"><span class="comment">     * blocking commands. */</span></span><br><span class="line">    moduleHandleBlockedClients();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Try to process pending commands for clients that were just unblocked. */</span></span><br><span class="line">    <span class="keyword">if</span> (listLength(server.unblocked_clients))</span><br><span class="line">        processUnblockedClients();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// aof的处理(不是执行一条命令就追加一条，是在一个循环完，开始一个新的循环之前落地到磁盘)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Write the AOF buffer on disk */</span></span><br><span class="line">    flushAppendOnlyFile(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Handle writes with pending output buffers. */</span></span><br><span class="line">    handleClientsWithPendingWrites();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Before we are going to sleep, let the threads access the dataset by</span></span><br><span class="line"><span class="comment">     * releasing the GIL. Redis main thread will not touch anything at this</span></span><br><span class="line"><span class="comment">     * time. */</span></span><br><span class="line">    <span class="keyword">if</span> (moduleCount()) moduleReleaseGIL();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="事件处理aeProcessEvents"><a href="#事件处理aeProcessEvents" class="headerlink" title="事件处理aeProcessEvents"></a>事件处理aeProcessEvents</h2><p>系统主要处理两种事件: 一种时间事件，一种网络事件<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Process every pending time event, then every pending file event</span></span><br><span class="line"><span class="comment"> * (that may be registered by time event callbacks just processed).</span></span><br><span class="line"><span class="comment"> * Without special flags the function sleeps until some file event</span></span><br><span class="line"><span class="comment"> * fires, or when the next time event occurs (if any).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If flags is 0, the function does nothing and returns.</span></span><br><span class="line"><span class="comment"> * if flags has AE_ALL_EVENTS set, all the kind of events are processed.</span></span><br><span class="line"><span class="comment"> * if flags has AE_FILE_EVENTS set, file events are processed.</span></span><br><span class="line"><span class="comment"> * if flags has AE_TIME_EVENTS set, time events are processed.</span></span><br><span class="line"><span class="comment"> * if flags has AE_DONT_WAIT set the function returns ASAP until all</span></span><br><span class="line"><span class="comment"> * if flags has AE_CALL_AFTER_SLEEP set, the aftersleep callback is called.</span></span><br><span class="line"><span class="comment"> * the events that's possible to process without to wait are processed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The function returns the number of events processed. */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">aeProcessEvents</span><span class="params">(aeEventLoop *eventLoop, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> processed = <span class="number">0</span>, numevents;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Nothing to do? return ASAP */</span></span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; AE_TIME_EVENTS) &amp;&amp; !(flags &amp; AE_FILE_EVENTS)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Note that we want call select() even if there are no</span></span><br><span class="line"><span class="comment">     * file events to process as long as we want to process time</span></span><br><span class="line"><span class="comment">     * events, in order to sleep until the next time event is ready</span></span><br><span class="line"><span class="comment">     * to fire. */</span></span><br><span class="line">    <span class="keyword">if</span> (eventLoop-&gt;maxfd != <span class="number">-1</span> ||</span><br><span class="line">        ((flags &amp; AE_TIME_EVENTS) &amp;&amp; !(flags &amp; AE_DONT_WAIT))) &#123;</span><br><span class="line">        <span class="keyword">int</span> j;</span><br><span class="line">        aeTimeEvent *shortest = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>, *<span class="title">tvp</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS &amp;&amp; !(flags &amp; AE_DONT_WAIT))</span><br><span class="line">            shortest = aeSearchNearestTimer(eventLoop);</span><br><span class="line">        <span class="keyword">if</span> (shortest) &#123;</span><br><span class="line">            <span class="keyword">long</span> now_sec, now_ms;</span><br><span class="line"></span><br><span class="line">            aeGetTime(&amp;now_sec, &amp;now_ms);</span><br><span class="line">            tvp = &amp;tv;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* How many milliseconds we need to wait for the next</span></span><br><span class="line"><span class="comment">             * time event to fire? */</span></span><br><span class="line">            <span class="keyword">long</span> <span class="keyword">long</span> ms =</span><br><span class="line">                (shortest-&gt;when_sec - now_sec)*<span class="number">1000</span> +</span><br><span class="line">                shortest-&gt;when_ms - now_ms;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ms &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                tvp-&gt;tv_sec = ms/<span class="number">1000</span>;</span><br><span class="line">                tvp-&gt;tv_usec = (ms % <span class="number">1000</span>)*<span class="number">1000</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                tvp-&gt;tv_sec = <span class="number">0</span>;</span><br><span class="line">                tvp-&gt;tv_usec = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* If we have to check for events but need to return</span></span><br><span class="line"><span class="comment">             * ASAP because of AE_DONT_WAIT we need to set the timeout</span></span><br><span class="line"><span class="comment">             * to zero */</span></span><br><span class="line">            <span class="keyword">if</span> (flags &amp; AE_DONT_WAIT) &#123;</span><br><span class="line">                tv.tv_sec = tv.tv_usec = <span class="number">0</span>;</span><br><span class="line">                tvp = &amp;tv;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* Otherwise we can block */</span></span><br><span class="line">                tvp = <span class="literal">NULL</span>; <span class="comment">/* wait forever */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// tvp是等待时间，是距离下一个最近的时间事件的时间距离</span></span><br><span class="line">        <span class="comment">// redis的循环事件是不等待的</span></span><br><span class="line">        <span class="comment">// aeProcessEvents(eventLoop, AE_ALL_EVENTS|AE_CALL_AFTER_SLEEP);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Call the multiplexing API, will return only on timeout or when</span></span><br><span class="line"><span class="comment">         * some event fires. */</span></span><br><span class="line">        numevents = aeApiPoll(eventLoop, tvp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* After sleep callback. */</span></span><br><span class="line">        <span class="keyword">if</span> (eventLoop-&gt;aftersleep != <span class="literal">NULL</span> &amp;&amp; flags &amp; AE_CALL_AFTER_SLEEP)</span><br><span class="line">            eventLoop-&gt;aftersleep(eventLoop);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; numevents; j++) &#123;</span><br><span class="line">            aeFileEvent *fe = &amp;eventLoop-&gt;events[eventLoop-&gt;fired[j].fd];</span><br><span class="line">            <span class="keyword">int</span> mask = eventLoop-&gt;fired[j].mask;</span><br><span class="line">            <span class="keyword">int</span> fd = eventLoop-&gt;fired[j].fd;</span><br><span class="line">            <span class="keyword">int</span> fired = <span class="number">0</span>; <span class="comment">/* Number of events fired for current fd. */</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Normally we execute the readable event first, and the writable</span></span><br><span class="line"><span class="comment">             * event laster. This is useful as sometimes we may be able</span></span><br><span class="line"><span class="comment">             * to serve the reply of a query immediately after processing the</span></span><br><span class="line"><span class="comment">             * query.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * However if AE_BARRIER is set in the mask, our application is</span></span><br><span class="line"><span class="comment">             * asking us to do the reverse: never fire the writable event</span></span><br><span class="line"><span class="comment">             * after the readable. In such a case, we invert the calls.</span></span><br><span class="line"><span class="comment">             * This is useful when, for instance, we want to do things</span></span><br><span class="line"><span class="comment">             * in the beforeSleep() hook, like fsynching a file to disk,</span></span><br><span class="line"><span class="comment">             * before replying to a client. */</span></span><br><span class="line">            <span class="keyword">int</span> invert = fe-&gt;mask &amp; AE_BARRIER;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Note the "fe-&gt;mask &amp; mask &amp; ..." code: maybe an already</span></span><br><span class="line"><span class="comment">             * processed event removed an element that fired and we still</span></span><br><span class="line"><span class="comment">             * didn't processed, so we check if the event is still valid.</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             * Fire the readable event if the call sequence is not</span></span><br><span class="line"><span class="comment">             * inverted. */</span></span><br><span class="line">            <span class="keyword">if</span> (!invert &amp;&amp; fe-&gt;mask &amp; mask &amp; AE_READABLE) &#123;</span><br><span class="line">                fe-&gt;rfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">                fired++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Fire the writable event. */</span></span><br><span class="line">            <span class="keyword">if</span> (fe-&gt;mask &amp; mask &amp; AE_WRITABLE) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!fired || fe-&gt;wfileProc != fe-&gt;rfileProc) &#123;</span><br><span class="line">                    fe-&gt;wfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">                    fired++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* If we have to invert the call, fire the readable event now</span></span><br><span class="line"><span class="comment">             * after the writable one. */</span></span><br><span class="line">            <span class="keyword">if</span> (invert &amp;&amp; fe-&gt;mask &amp; mask &amp; AE_READABLE) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!fired || fe-&gt;wfileProc != fe-&gt;rfileProc) &#123;</span><br><span class="line">                    fe-&gt;rfileProc(eventLoop,fd,fe-&gt;clientData,mask);</span><br><span class="line">                    fired++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            processed++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Check time events */</span></span><br><span class="line">    <span class="keyword">if</span> (flags &amp; AE_TIME_EVENTS)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理时间事件</span></span><br><span class="line">        processed += processTimeEvents(eventLoop);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> processed; <span class="comment">/* return the number of processed file/time events */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h2 id="简单总结"><a href="#简单总结" class="headerlink" title="简单总结"></a>简单总结</h2><ul><li>主程序中进行各项程序初始化/服务初始化/模块初始化等等</li><li>系统初始化结束启动事件循环系统</li><li>对于客户端的相关读写操作均才用单线程模式处理</li><li>对于部分低级别任务采用后台线程异步处理</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;阅读了下redis的源代码，了解一下服务的启动流程。&lt;/p&gt;
    
    </summary>
    
      <category term="笔记" scheme="https://oldchan.net/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="redis" scheme="https://oldchan.net/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>静态博客实现动态交互</title>
    <link href="https://oldchan.net/2017/08/30/others/interaction/"/>
    <id>https://oldchan.net/2017/08/30/others/interaction/</id>
    <published>2017-08-30T06:05:57.000Z</published>
    <updated>2022-06-02T12:47:44.824Z</updated>
    
    <content type="html"><![CDATA[<p>静态博客没有动态的脚本，都是html/js/css形式的文件组成，想要实现动态的交互，需要借助第三方的一些渠道来实现。在之前，我的博客都是使用<del><strong><a href="#">多说</a></strong>(服务已经关闭)</del>来做动态评论，但是今天发现多说原来已经关闭了，于是重新找了一个替代服务：<strong><a href="//changyan.kuaizhan.com">搜狐畅言</a></strong>。</p><a id="more"></a><h2 id="申请畅言帐号"><a href="#申请畅言帐号" class="headerlink" title="申请畅言帐号"></a>申请畅言帐号</h2><p>首先，进去<a href="//changyan.kuaizhan.com">搜狐畅言</a>注册帐号，按照提示，一步一步对自己的站点做好配置，主要的一点是，畅言的站点必须备案过，还要过审核还能正常使用，不然只能使用15天。</p><h2 id="安装畅言代码"><a href="#安装畅言代码" class="headerlink" title="安装畅言代码"></a>安装畅言代码</h2><p>对于外挂式评论功能模块，都会提供一份嵌入代码，畅言也在帐号的管理后台提供了一份嵌入代码，代码提供三中平台使用，PC、WAP、自适应，我选择使用自适应的那份代码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--PC和WAP自适应版--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"SOHUCS"</span> &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"> </span></span><br><span class="line"><span class="undefined">  (function()&#123; </span></span><br><span class="line"><span class="undefined">    var appid = '畅言帐号提供的应用ID'; </span></span><br><span class="line"><span class="undefined">    var conf  = '畅言帐号提供的配置ID'; </span></span><br><span class="line"><span class="undefined">    var width = window.innerWidth || document.documentElement.clientWidth; </span></span><br><span class="line"><span class="undefined">    if (width &lt; 960) &#123; </span></span><br><span class="line"><span class="xml">      window.document.write('<span class="tag">&lt;<span class="name">script</span> <span class="attr">id</span>=<span class="string">"changyan_mobile_js"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&amp;conf=' + conf + '"</span>&gt;</span><span class="xml"><span class="tag">&lt;<span class="name">\</span>/<span class="attr">script</span>&gt;</span>');</span></span></span><br><span class="line"><span class="undefined">    &#125; else &#123;</span></span><br><span class="line"><span class="undefined">        var loadJs=function(d, a) &#123;</span></span><br><span class="line"><span class="undefined">            var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;</span></span><br><span class="line"><span class="undefined">            var b = document.createElement("script");</span></span><br><span class="line"><span class="undefined">                b.setAttribute("type","text/javascript");</span></span><br><span class="line"><span class="undefined">                b.setAttribute("charset","UTF-8");</span></span><br><span class="line"><span class="undefined">                b.setAttribute("src",d);</span></span><br><span class="line"><span class="undefined">            if(typeof a === "function") &#123;</span></span><br><span class="line"><span class="undefined">                if(window.attachEvent) &#123;</span></span><br><span class="line"><span class="undefined">                    b.onreadystatechange = function() &#123;</span></span><br><span class="line"><span class="undefined">                        var e = b.readyState;</span></span><br><span class="line"><span class="undefined">                        if(e === "loaded" || e === "complete") &#123;</span></span><br><span class="line"><span class="undefined">                            b.onreadystatechange = null;</span></span><br><span class="line"><span class="undefined">                            a()</span></span><br><span class="line"><span class="undefined">                        &#125;</span></span><br><span class="line"><span class="undefined">                    &#125;</span></span><br><span class="line"><span class="undefined">                &#125; else &#123;</span></span><br><span class="line"><span class="undefined">                    b.onload =a</span></span><br><span class="line"><span class="undefined">                &#125;</span></span><br><span class="line"><span class="undefined">            &#125;</span></span><br><span class="line"><span class="undefined">            c.appendChild(b)</span></span><br><span class="line"><span class="undefined">        &#125;;</span></span><br><span class="line"><span class="undefined">        loadJs("https://changyan.sohu.com/upload/changyan.js", function() &#123;</span></span><br><span class="line"><span class="undefined">            window.changyan.api.config(&#123;appid:appid,conf:conf&#125;)</span></span><br><span class="line"><span class="undefined">        &#125;);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;)();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以上代码，嵌入到需要使用评论框的地方即可。</p><h2 id="评论管理"><a href="#评论管理" class="headerlink" title="评论管理"></a>评论管理</h2><p>到这里，任何在博客里评论的内容都能通过畅言的后台进行管理了，另外畅言还提供一些其他的互动功能，包括任务、点赞之类的功能也比较丰富。其次，畅言还提供一个chrome扩展用来方便的直接在博客页面管理评论。</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;静态博客没有动态的脚本，都是html/js/css形式的文件组成，想要实现动态的交互，需要借助第三方的一些渠道来实现。在之前，我的博客都是使用&lt;del&gt;&lt;strong&gt;&lt;a href=&quot;#&quot;&gt;多说&lt;/a&gt;&lt;/strong&gt;(服务已经关闭)&lt;/del&gt;来做动态评论，但是今天发现多说原来已经关闭了，于是重新找了一个替代服务：&lt;strong&gt;&lt;a href=&quot;//changyan.kuaizhan.com&quot;&gt;搜狐畅言&lt;/a&gt;&lt;/strong&gt;。&lt;/p&gt;
    
    </summary>
    
      <category term="随笔" scheme="https://oldchan.net/categories/%E9%9A%8F%E7%AC%94/"/>
    
    
      <category term="博客" scheme="https://oldchan.net/tags/%E5%8D%9A%E5%AE%A2/"/>
    
  </entry>
  
  <entry>
    <title>ShellCode For LoadLibrary</title>
    <link href="https://oldchan.net/2016/05/12/os/windows/shellcode/"/>
    <id>https://oldchan.net/2016/05/12/os/windows/shellcode/</id>
    <published>2016-05-12T02:28:28.000Z</published>
    <updated>2022-06-02T12:47:44.823Z</updated>
    
    <content type="html"><![CDATA[<ul><li>方便快速注入插件，又增加可移植性，将必要的系统接口通过参数传递到函数内</li><li>使用时正确初始化参数，然后将函数的内存code与参数一起拷贝到指定进程中</li><li><code>LoadClientLibrary</code>使用裸函数约定，结束标志方便定位函数总内存长度</li></ul><a id="more"></a><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(push, 1)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    DWORD   SizeOfParameter: <span class="number">32</span>;</span><br><span class="line">    CHAR    Buffer[<span class="number">1024</span>];</span><br><span class="line">&#125; CALLBACK_PROC_PARAMETER, *PCALLBACK_PROC_PARAMETER;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 系统接口 */</span></span><br><span class="line">    HMODULE (WINAPI *LoadLibrary)(__IN LPCSTR);</span><br><span class="line">    FARPROC (WINAPI *GetProcAddress)(__IN HMODULE, __IN LPCSTR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注入信息 */</span></span><br><span class="line">    CHAR InjectLibrary[MAX_PATH];</span><br><span class="line">    CHAR  InjectProcedure[<span class="number">100</span>];</span><br><span class="line">    CALLBACK_PROC_PARAMETER CommandLine;</span><br><span class="line"></span><br><span class="line">&#125; REMOTE_THREAD_PARAM, *PREMOTE_THREAD_PARAM;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(pop)</span></span><br><span class="line"></span><br><span class="line">__<span class="function">NAKED BOOL WINAPI <span class="title">LoadClientLibrary</span><span class="params">(__IN PREMOTE_THREAD_PARAM lpThreadParameter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 函数开始</span></span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp, esp</span><br><span class="line">        <span class="comment">// 分配变量</span></span><br><span class="line">        sub esp, <span class="number">0x08</span></span><br><span class="line">        <span class="comment">// [ebp - 0x04]: ClientLibrary</span></span><br><span class="line">        <span class="comment">// [ebp - 0x08]: ClientProcedure</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 程序代码</span></span><br><span class="line">        xor eax, eax</span><br><span class="line"></span><br><span class="line">        push ebx</span><br><span class="line">        push ecx</span><br><span class="line">        push edx</span><br><span class="line">        push edi</span><br><span class="line">        push esi</span><br><span class="line"></span><br><span class="line">        mov esi, lpThreadParameter</span><br><span class="line">        lea eax, [esi + <span class="number">0x08</span>]</span><br><span class="line">        </span><br><span class="line">        push eax</span><br><span class="line">        call [esi]</span><br><span class="line"></span><br><span class="line">        cmp eax, <span class="number">0</span></span><br><span class="line">        je __EXIT_LABEL</span><br><span class="line"></span><br><span class="line">        mov [ebp - <span class="number">0x04</span>], eax</span><br><span class="line"></span><br><span class="line">        lea eax, [esi + <span class="number">0x0000010C</span>]</span><br><span class="line">        push eax</span><br><span class="line">        push [ebp - <span class="number">0x04</span>]</span><br><span class="line">        call [esi + <span class="number">0x04</span>]</span><br><span class="line"></span><br><span class="line">        cmp eax, <span class="number">0</span></span><br><span class="line">        je __EXIT_LABEL</span><br><span class="line">        </span><br><span class="line">        mov [ebp - <span class="number">0x08</span>], eax</span><br><span class="line"></span><br><span class="line">        lea eax, [esi + <span class="number">0x00000170</span>]</span><br><span class="line">        push eax</span><br><span class="line">        call [ebp - <span class="number">0x08</span>]</span><br><span class="line"></span><br><span class="line">__EXIT_LABEL:</span><br><span class="line">        pop esi</span><br><span class="line">        pop edi</span><br><span class="line">        pop edx</span><br><span class="line">        pop ecx</span><br><span class="line">        pop ebx</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 销毁变量</span></span><br><span class="line">        add esp, <span class="number">0x08</span></span><br><span class="line">        <span class="comment">// 函数结束</span></span><br><span class="line">        mov esp, ebp</span><br><span class="line">        pop ebp</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 返回并清除堆栈参数</span></span><br><span class="line">        ret <span class="number">0x04</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 结束标志</span></span><br><span class="line">    __asm</span><br><span class="line">    &#123;</span><br><span class="line">        __emit <span class="number">0x19</span></span><br><span class="line">        __emit <span class="number">0x90</span></span><br><span class="line">        __emit <span class="number">0x04</span></span><br><span class="line">        __emit <span class="number">0x03</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;ul&gt;
&lt;li&gt;方便快速注入插件，又增加可移植性，将必要的系统接口通过参数传递到函数内&lt;/li&gt;
&lt;li&gt;使用时正确初始化参数，然后将函数的内存code与参数一起拷贝到指定进程中&lt;/li&gt;
&lt;li&gt;&lt;code&gt;LoadClientLibrary&lt;/code&gt;使用裸函数约定，结束标志方便定位函数总内存长度&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="系统" scheme="https://oldchan.net/categories/%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="注入" scheme="https://oldchan.net/tags/%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>Windows系统服务描述表</title>
    <link href="https://oldchan.net/2014/09/13/os/windows/ke_service_descriptor_table/"/>
    <id>https://oldchan.net/2014/09/13/os/windows/ke_service_descriptor_table/</id>
    <published>2014-09-13T07:47:35.000Z</published>
    <updated>2022-06-02T12:47:44.823Z</updated>
    
    <content type="html"><![CDATA[<p>Win32下获取系统服务描述表的方法</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PSYSTEM_SERVICE_DESCRIPTOR_TABLE <span class="title">KeGetServiceDescriptorTable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 结果值</span></span><br><span class="line">    PSYSTEM_SERVICE_DESCRIPTOR_TABLE ServiceDescriptorTable = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    __asm </span><br><span class="line">    &#123;</span><br><span class="line">        push eax</span><br><span class="line">        push ebx</span><br><span class="line">        push OffsetKthreadServiceTable</span><br><span class="line">        call OffsetGet</span><br><span class="line">        mov ebx, eax</span><br><span class="line">        mov eax, dword ptr fs:[<span class="number">0x124</span>]</span><br><span class="line">        add eax, ebx</span><br><span class="line">        mov eax, dword ptr [eax]</span><br><span class="line">        mov ServiceDescriptorTable,eax </span><br><span class="line">        pop ebx</span><br><span class="line">        pop eax</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ServiceDescriptorTable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>OffsetGet这个自定义函数是为了兼容多系统版本，根据常量OffsetKthreadServiceTable的值来获取对应偏移</li><li>在驱动入口函数DriverEntry中获取的是SSDT，<a href="//www.baidu.com/s?wd=DeviceIoControl">DeviceIoControl</a>访问时，获取的是才是完整版<a href="//www.baidu.com/s?wd=KeServiceDescriptorTable">KeServiceDescriptorTable</a></li></ul><a id="more"></a><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="comment">/* 获取系统服务描述表(SSDT Shadow)                                        */</span></span><br><span class="line"><span class="comment">/************************************************************************/</span></span><br><span class="line"><span class="function">PSERVICE_TABLE_DESCRIPTOR <span class="title">KeGetServiceDescriptorTableShadow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    PUCHAR Pos;</span><br><span class="line">    PUCHAR BeginPos = (PUCHAR)KeAddSystemServiceTable;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> PSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTableShadow = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 返回现有值</span></span><br><span class="line">    <span class="keyword">if</span>(KeServiceDescriptorTableShadow)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> KeServiceDescriptorTableShadow;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Search</span></span><br><span class="line">    <span class="keyword">for</span>(Pos = BeginPos; Pos &lt; BeginPos + PAGE_SIZE; ++Pos)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!MmIsAddressValid(Pos))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        KeServiceDescriptorTableShadow = (PSERVICE_TABLE_DESCRIPTOR)(*(PULONG)Pos);</span><br><span class="line">        <span class="keyword">if</span> (!MmIsAddressValid((PVOID)KeServiceDescriptorTableShadow))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">memcmp</span>((PVOID)KeServiceDescriptorTableShadow, &amp;KeServiceDescriptorTable[<span class="number">0</span>], <span class="keyword">sizeof</span>(SERVICE_TABLE_DESCRIPTOR)) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((PVOID)KeServiceDescriptorTableShadow == (PVOID)&amp;KeServiceDescriptorTable[<span class="number">0</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> KeServiceDescriptorTableShadow;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> KeServiceDescriptorTableShadow = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>2016年新加的获取方式，用的比较多</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Win32下获取系统服务描述表的方法&lt;/p&gt;
&lt;figure class=&quot;highlight c&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;PSYSTEM_SERVICE_DESCRIPTOR_TABLE &lt;span class=&quot;title&quot;&gt;KeGetServiceDescriptorTable&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// 结果值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    PSYSTEM_SERVICE_DESCRIPTOR_TABLE ServiceDescriptorTable = &lt;span class=&quot;literal&quot;&gt;NULL&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    __asm &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        push eax&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        push ebx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        push OffsetKthreadServiceTable&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        call OffsetGet&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        mov ebx, eax&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        mov eax, dword ptr fs:[&lt;span class=&quot;number&quot;&gt;0x124&lt;/span&gt;]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        add eax, ebx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        mov eax, dword ptr [eax]&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        mov ServiceDescriptorTable,	eax &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pop ebx&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        pop eax&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; ServiceDescriptorTable;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;ul&gt;
&lt;li&gt;OffsetGet这个自定义函数是为了兼容多系统版本，根据常量OffsetKthreadServiceTable的值来获取对应偏移&lt;/li&gt;
&lt;li&gt;在驱动入口函数DriverEntry中获取的是SSDT，&lt;a href=&quot;//www.baidu.com/s?wd=DeviceIoControl&quot;&gt;DeviceIoControl&lt;/a&gt;访问时，获取的是才是完整版&lt;a href=&quot;//www.baidu.com/s?wd=KeServiceDescriptorTable&quot;&gt;KeServiceDescriptorTable&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="系统" scheme="https://oldchan.net/categories/%E7%B3%BB%E7%BB%9F/"/>
    
    
      <category term="windows" scheme="https://oldchan.net/tags/windows/"/>
    
  </entry>
  
</feed>
