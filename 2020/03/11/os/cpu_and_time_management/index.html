<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="士不可以不弘毅，任重而道远。"><title>CPU的时间观念 | KAMI</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/prettify/prettify.css"><script type="text/javascript" src="//fastly.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//fastly.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//fastly.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//fastly.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CPU的时间观念</h1><a id="logo" href="/.">KAMI</a><p class="description">士不可以不弘毅，任重而道远。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/guestbook/"><i class="fa fa-book"> 留言</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CPU的时间观念</h1><div class="post-meta">Mar 11 2020<span> | </span><span class="category"><a href="/categories/系统/">系统</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.4k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 5</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU，系统与应用"><span class="toc-number">1.</span> <span class="toc-text">CPU，系统与应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#进程与线程"><span class="toc-number">2.</span> <span class="toc-text">进程与线程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#进程"><span class="toc-number">2.1.</span> <span class="toc-text">进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程"><span class="toc-number">2.2.</span> <span class="toc-text">线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#线程切换"><span class="toc-number">3.</span> <span class="toc-text">线程切换</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统调用"><span class="toc-number">3.1.</span> <span class="toc-text">系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#放弃调度"><span class="toc-number">3.2.</span> <span class="toc-text">放弃调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#时钟中断"><span class="toc-number">3.3.</span> <span class="toc-text">时钟中断</span></a></li></ol></li></ol></div></div><div class="post-content"><p>“Next”</p>
<p>“Next”</p>
<p>“Next”</p>
<p>“…”</p>
<p>对于CPU而言，存在的唯一意义就是永无休止地执行下一条指令和各种Jump，就像一个没有灵魂的时间管理大师一样，从每一次机器被启动开始便周而复始地践行着自己的使命：<strong>让系统里没有难做的任务</strong>。</p>
<h2 id="CPU，系统与应用"><a href="#CPU，系统与应用" class="headerlink" title="CPU，系统与应用"></a>CPU，系统与应用</h2><p>CPU：CPU的时间很紧张，以单核CPU为例，CPU自始至终只能执行一个任务，也并不会在意具体是谁的任务，可能是系统的任务，也有可能是某个应用的任务，只需要保证执行的指令都在物理内存上即可。</p>
<p>系统：系统组织软件与硬件资源，给应用提供一个稳定的环境来执行用户交代的任务。</p>
<p>应用：用户的任务逻辑经过编译器处理，由源代码翻译成机器码，并静态地保存在应用程序文件中，当系统执行应用程序时，会根据应用中的初始设置，将应用加载到内存中并执行。</p>
<h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p>为满足多道编程，提高CPU的利用率，系统引入进程概念对任务资源进行管理。</p>
<p>系统每执行一次应用，就会创建一个进程，并将应用的静态机器码加载到进程的内存中，再从程序入口开始执行。</p>
<p>进程是应用执行过程中的真正实体，资源的容器。</p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p><strong>线程是CPU的基本执行单位</strong>，同一个进程中可以包含一个或多个线程，多个线程共享进程的各种资源。除此之外，线程也具备一些独立维护的资源，如：调用栈，寄存器上下文，TLS等等。</p>
<p>将线程做为基本执行单元引入系统，能很大程度上降低进程级切换带来的性能开销，在很多操作系统中线程又被称之为<strong>轻量级进程</strong>，除了性能方面的改善之外，也为应用提供了并行执行任务的能力。</p>
<h2 id="线程切换"><a href="#线程切换" class="headerlink" title="线程切换"></a>线程切换</h2><p>“A thread is a path of execution within a process. A process can contain multiple threads.”</p>
<p>这是一篇技术文章中对于线程概念的总结，进程中包含应用的所有任务指令，线程可以从进程中任意可执行的内存位置开始执行指令。</p>
<p>假如某应用中存在类似如下几个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_fun_A</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = get_a();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a + b = %d\n"</span>, a, <span class="number">11</span>, sum(a, <span class="number">11</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_fun_B</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = get_a();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a * b = %d\n"</span>, a, <span class="number">11</span>, mul(a, <span class="number">11</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mul</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_a</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>应用从main函数启动，分别创建了线程A从<code>thread_fun_A</code>开始执行和线程B从<code>thread_fun_B</code>开始执行，那两线程的执行路径分别是：</p>
<p>线程A：<code>thread_fun_A()</code>-&gt;<code>get_a()</code>-&gt;<code>sum()</code>-&gt;<code>printf()</code></p>
<p>线程B：<code>thread_fun_B()</code>-&gt;<code>get_a()</code>-&gt;<code>mul()</code>-&gt;<code>printf()</code></p>
<p>线程作为<strong>执行路径</strong>存在于系统的各进程和内核中，CPU作为执行人，需要频繁改变执行路径，时而在内核线程，时而在应用线程。</p>
<p><strong>那么，多线程系统中，CPU是怎么切换线程的呢？</strong></p>
<h3 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h3><p>系统一般会开放给应用程序很多有用的服务接口，应用基于这些接口可以实现很多有用的功能，比如最常见的读写文件，连接网络等等。</p>
<p>假如应用程序在执行某一个线程时，遇到需要写文件的操作，并且写的数据量较大，由于磁盘的性能弱于CPU，这时，在执行类似<code>fwrite</code>时，CPU就需要在内核调用中进入等待状态，等待磁盘操作完毕。很明显，这种情况下，CPU的使用率会明显下降，为了保证尽量少的出现这种情况，系统会挂起当前线程，并通过调度算法选择其他已就绪的线程供CPU继续执行，此时CPU的执行路径就发生了变化。</p>
<h3 id="放弃调度"><a href="#放弃调度" class="headerlink" title="放弃调度"></a>放弃调度</h3><p>跟系统调用类似，假如线程在执行过程中，并不需要调用系统执行具体功能，而是休眠一段时间或者等待某个信号产生再继续执行，会有类似<code>sleep</code>或<code>wait***</code>之类的系统接口调用，并进入挂起状态，此时CPU就会去执行其他就绪线程。</p>
<h3 id="时钟中断"><a href="#时钟中断" class="headerlink" title="时钟中断"></a>时钟中断</h3><p>有时，线程只需要执行某些算法代码，并不需要调用系统接口，假如算法复杂度较高，耗时较长，此时，CPU怎么保证执行线程时，不会被线程占用太多时间呢？因为其他线程的时间也是很宝贵的，CPU需要保证所有线程都能公平的被CPU执行。</p>
<p>为了防止CPU沉迷于某一个线程，系统在初始化的时候会初始化一个可编程的中断时钟，用来在线程执行超时时，向CPU产生一个中断，从而让CPU能够暂停线程的执行工作，回到内核，并调度其他线程。</p>
<hr>
<p><img src="https://oldchan.net/s1/img/2021/11/22/3892c458c06780d2c340c11ec505eeec.png" alt></p>
<p>CPU：“只要我够快，所有的线程都能得到满足😌”</p>
<p>进程：“我拥有应用执行过程中的所有资源，包括内存，句柄，线程执行路径等等”</p>
<p>线程：“我是进程的其中一条执行路径，CPU会按照我的指令执行”</p>
</div><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://oldchan.net/2020/03/11/os/cpu_and_time_management/" data-id="cl60b8inf000shku3w4ad9od3" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACNElEQVR42u3aS66DMAwF0O5/07zpk/rh3iStRDgZIQSUQyXLsf14xOv4t/6feT5+vv7dvZ/PP76xMDAwLss4Pq78tdrnP1/z7jh5AgYGxh0Y734+Ca+f70rY7W9hYGBg5I9eG3YxMDAwfsNoN6XJEzAwMDDyTWzy6DztGyvMLdiLY2BgXJCRV91/f/yV/gYGBsalGEe5kqCZnG+LdCdvhYGBsTUjD3BjDchlpbQkDcXAwNiU0W5Z203mfMEuaXliYGDchzG2mcxHvpK2ZfshXgRcDAyMrRljW9OZMFrnsDN5KwYGxmUZ+ZBEPpAx1gRNzpx8egwMjE0ZbcAdK5Dldw1+UAwMjK0ZbSo2VoZrhzbyQHzyz2BgYGzNmCmiFWWysjkafXQMDIztGPlLz4fgvAGQJI4nnVgMDIyNGG1LMk8f8+eMDVvUHQ8MDIzLMvL8MSnrzwTZfLDjxRkMDIytGS2gLZPlSedYYloPXmBgYFyckSd8bSo5lnQOhmYMDIzbMNYetwnoFAYDA2NTRp6QJWlifk3bSDhJTDEwMG7DaJO5mZGvtpB3kshiYGDcgNFua+fHNcbKaidzbRgYGNsxjnLNtzPHAn2dFGJgYGzEWBCt45A9FojzZBQDA2Nvxtog245uLBu8wMDAuAGjDXxj+JkB1qIHi4GBgREMT+SNhGXBGgMDA+MLoxjzKeaLTSwGBsbWjCRctkNdM0lhO/yKgYGxN6PdOrZhtC2l5cU+DAyMGzD+AODr2xnxM5k1AAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/cpu/"><i class="fa fa-tag"></i>cpu</a></div><div class="post-nav"><a class="pre" href="/2020/04/20/container/docker/minimum/">最小化docker镜像</a><a class="next" href="/2018/09/23/notes/redis/type_hash/">Redis：hash</a></div><div id="tcomment"></div><script src="https://fastly.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js"></script><script>twikoo.init({
  envId: 'thecxx-1gxw7szk895715fd',
  el: '#tcomment',
  region: 'ap-shanghai',
  path: ''
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/容器/">容器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统/">系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/长话/">长话</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/思考/" style="font-size: 15px;">思考</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/元宇宙/" style="font-size: 15px;">元宇宙</a> <a href="/tags/cpu/" style="font-size: 15px;">cpu</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/中间件/" style="font-size: 15px;">中间件</a> <a href="/tags/容器化/" style="font-size: 15px;">容器化</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/注入/" style="font-size: 15px;">注入</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/07/24/notes/golang/advanced/m/">Golang深度解读：M</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/10/notes/golang/advanced/g0/">Golang深度解读：g0</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/15/opinion/give_up_the_php/">6年前，决定不再继续精进PHP</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/05/opinion/good_product/">好的产品?</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/17/opinion/internet_and_metaverse/">互联网络与元宇宙</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/18/arch/microservice/service/">微服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/06/arch/middleware/configuration/">配置服务迁移</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/30/container/docker/minimum_ext/">最小化docker镜像(补充内容)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/20/language/go/struct_like_class/">Go：实现类似class的析构函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/20/container/docker/minimum/">最小化docker镜像</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">KAMI.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//fastly.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/prettify.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-render.js?v=1.0.0"></script></div></body></html>