<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="士不可以不弘毅，任重而道远。"><title>Golang深度解读：M | KAMI</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/prettify/prettify.css"><script type="text/javascript" src="//fastly.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script type="text/javascript" src="//fastly.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//fastly.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//fastly.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Golang深度解读：M</h1><a id="logo" href="/.">KAMI</a><p class="description">士不可以不弘毅，任重而道远。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/guestbook/"><i class="fa fa-book"> 留言</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Golang深度解读：M</h1><div class="post-meta">Jul 24 2022<span> | </span><span class="category"><a href="/categories/笔记/">笔记</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.2k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 4</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#worker-m"><span class="toc-number">1.</span> <span class="toc-text">worker m</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#m0"><span class="toc-number">1.1.</span> <span class="toc-text">m0</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sysmon"><span class="toc-number">2.</span> <span class="toc-text">sysmon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#template-thread"><span class="toc-number">3.</span> <span class="toc-text">template thread</span></a></li></ol></div></div><div class="post-content"><p>Go语言将线程抽象成M(Machine)，每个M都是可以独立运行的单元，M的数据结构中主要包含的是跟系统环境相关的字段。</p>
<p>Go语言将可执行的上下文保存在G(Goroutine)中，G的数据结构中主要包含跟执行环境相关的字段，包括寄存器值，栈地址、defer，panic的指针等等。</p>
<p>在<a href="/2022/07/10/notes/golang/advanced/g0/">《Golang深度解读：g0》</a>中，简单讲述了g0的基本信息和在调度中所负责的工作。最先了解g0，主要原因是g0才是真正意义上在线程上运行的逻辑，M在创建之后，系统环境相关的数据保存在M中，线程的执行数据保存在g0中，g0与普通用户协程共用相同的数据结构和计算逻辑，只是在内核调度过程中，需要区分g0与用户协程的部分边界。</p>
<a id="more"></a>
<h2 id="worker-m"><a href="#worker-m" class="headerlink" title="worker m"></a>worker m</h2><p>Go语言程序在执行过程中会创建多个M，但并不跟P的数量完全匹配，跟P绑定使用的M一般视为Worker Thread(为了统一概念，后面统一称Worker M)，即用户计算逻辑能使用到的线程，P数量的设置也直接影响用户协程的并行执行能力，关于P数量的设置可参考<code>runtime.GOMAXPROCS()</code>。</p>
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIxODJweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjY1MHB4O2hlaWdodDoxODJweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA2NTAgMTgyIiB3aWR0aD0iNjUwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBoZWlnaHQ9IjI2LjI5NjkiIGlkPSJfdGl0bGUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDAwO3N0cm9rZS13aWR0aDoxLjA7ZmlsbDpub25lOyIgd2lkdGg9IjIyMSIgeD0iMjA3Ljc1IiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjIxMSIgeD0iMjEyLjc1IiB5PSIyMi45OTUxIj7nsr7nroDniYhXb3JrZXIgTeW4uOinhOWIm+W7uua1geeoizwvdGV4dD48IS0tTUQ1PVs5ZTllYzdiOWU1NmU0YWFmN2M3YjUwNTNiZmJmNzRmOF0KZW50aXR5IHdha2VwLS0+PGcgaWQ9ImVsZW1fd2FrZXAiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTI5IiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA5IiB4PSIxNyIgeT0iNjcuMjkyIj5ydW50aW1lLndha2VwPC90ZXh0PjwvZz48IS0tTUQ1PVtkNmRhMjE2MjU1NTNlZTNhNWE3YmEyOTBhYTVkOGVkNl0KZW50aXR5IHN0YXJ0bS0tPjxnIGlkPSJlbGVtX3N0YXJ0bSI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMzEiIHg9IjE3MSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMSIgeD0iMTgxIiB5PSI2Ny4yOTIiPnJ1bnRpbWUuc3RhcnRtPC90ZXh0PjwvZz48IS0tTUQ1PVtmODU1OWQ2OTQ2YTRhNTE2ZWQ2NDY2NTUzNDg2ZTFmM10KZW50aXR5IG5ld20tLT48ZyBpZD0iZWxlbV9uZXdtIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEyNSIgeD0iMzM3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTA1IiB4PSIzNDciIHk9IjY3LjI5MiI+cnVudGltZS5uZXdtPC90ZXh0PjwvZz48IS0tTUQ1PVswYmNmZDNiMjYyZWEzYzM2NjFlN2ZkZjUzYjRkMWI1M10KZW50aXR5IG5ld20xLS0+PGcgaWQ9ImVsZW1fbmV3bTEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTM0IiB4PSI0OTcuNSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExNCIgeD0iNTA3LjUiIHk9IjY3LjI5MiI+cnVudGltZS5uZXdtMTwvdGV4dD48L2c+PCEtLU1ENT1bOTExMzM3Zjg1ZTNjM2ExZWIxMGQ4MzhhNjFhMzM1MmVdCmVudGl0eSBuZXdvc3Byb2MtLT48ZyBpZD0iZWxlbV9uZXdvc3Byb2MiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTYwIiB4PSI0ODQuNSIgeT0iMTQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxNDAiIHg9IjQ5NC41IiB5PSIxNjMuMjkyIj5ydW50aW1lLm5ld29zcHJvYzwvdGV4dD48L2c+PCEtLU1ENT1bODdhZTI2ZDRiYmE2YTA5MmRlZDY0ODEyYTQ4M2IzZjFdCmVudGl0eSBwdGhyZWFkX2NyZWF0ZS0tPjxnIGlkPSJlbGVtX3B0aHJlYWRfY3JlYXRlIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEzMiIgeD0iMzE3LjUiIHk9IjE0MC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTEyIiB4PSIzMjcuNSIgeT0iMTYzLjI5MiI+cHRocmVhZF9jcmVhdGU8L3RleHQ+PC9nPjwhLS1NRDU9W2Q2YWY5ZjU1ZjBmNjM3YTdmY2IzOTI5NDI4OTJjOGQ5XQplbnRpdHkgbXN0YXJ0LS0+PGcgaWQ9ImVsZW1fbXN0YXJ0Ij48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEzMSIgeD0iMTUxIiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjExMSIgeD0iMTYxIiB5PSIxNjMuMjkyIj5ydW50aW1lLm1zdGFydDwvdGV4dD48L2c+PCEtLU1ENT1bOWI4ZGVmZWZhYmYzNWE5Mzc5ZTE1Y2VkNmUwMGM4YjldCmxpbmsgd2FrZXAgdG8gc3RhcnRtLS0+PGcgaWQ9Imxpbmtfd2FrZXBfc3RhcnRtIj48cGF0aCBkPSJNMTM2LjI3NSw2Mi4yOTY5IEMxNDYuMDU1LDYyLjI5NjkgMTU1LjgzNCw2Mi4yOTY5IDE2NS42MTQsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJ3YWtlcC10by1zdGFydG0iIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iMTcwLjcyOCw2Mi4yOTY5LDE2MS43MjgsNTguMjk2OSwxNjUuNzI4LDYyLjI5NjksMTYxLjcyOCw2Ni4yOTY5LDE3MC43MjgsNjIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1NRDU9W2ZmNGE2OGNmMTYzMzZlMTUyNDgxZjY4NTNkMGIxNDRiXQpsaW5rIHN0YXJ0bSB0byBuZXdtLS0+PGcgaWQ9Imxpbmtfc3RhcnRtX25ld20iPjxwYXRoIGQ9Ik0zMDIuMDgyLDYyLjI5NjkgQzMxMS45MTIsNjIuMjk2OSAzMjEuNzQxLDYyLjI5NjkgMzMxLjU3MSw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9InN0YXJ0bS10by1uZXdtIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjMzNi43MTEsNjIuMjk2OSwzMjcuNzExLDU4LjI5NjksMzMxLjcxMSw2Mi4yOTY5LDMyNy43MTEsNjYuMjk2OSwzMzYuNzExLDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tTUQ1PVswNWU4MGEyMTRlZWE0ZTZhOTY2ZDkzMmNkZTYyNThmMV0KbGluayBuZXdtIHRvIG5ld20xLS0+PGcgaWQ9ImxpbmtfbmV3bV9uZXdtMSI+PHBhdGggZD0iTTQ2Mi4wMiw2Mi4yOTY5IEM0NzIuMDE5LDYyLjI5NjkgNDgyLjAxOSw2Mi4yOTY5IDQ5Mi4wMTgsNjIuMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJuZXdtLXRvLW5ld20xIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ5Ny4yNDcsNjIuMjk2OSw0ODguMjQ3LDU4LjI5NjksNDkyLjI0Nyw2Mi4yOTY5LDQ4OC4yNDcsNjYuMjk2OSw0OTcuMjQ3LDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tTUQ1PVsyODk2ZDRjNWVjZDY3MzQ1MmMwMGQ1NjMxOGMzN2I3MF0KbGluayBuZXdtMSB0byBuZXdvc3Byb2MtLT48ZyBpZD0ibGlua19uZXdtMV9uZXdvc3Byb2MiPjxwYXRoIGQ9Ik01NjQuNSw4MC41Mzc5IEM1NjQuNSw5NS43NzYgNTY0LjUsMTE4LjEwMzggNTY0LjUsMTM0Ljc1NDUgIiBmaWxsPSJub25lIiBpZD0ibmV3bTEtdG8tbmV3b3Nwcm9jIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjU2NC41LDE0MC4xNjUyLDU2OC41LDEzMS4xNjUyLDU2NC41LDEzNS4xNjUyLDU2MC41LDEzMS4xNjUyLDU2NC41LDE0MC4xNjUyIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLU1ENT1bMDFhOGE0ZTM3MDg2NmI0ZDNiOTFiNDM2ZTFmYjFmNjRdCnJldmVyc2UgbGluayBwdGhyZWFkX2NyZWF0ZSB0byBuZXdvc3Byb2MtLT48ZyBpZD0ibGlua19wdGhyZWFkX2NyZWF0ZV9uZXdvc3Byb2MiPjxwYXRoIGQ9Ik00NTQuNzM3LDE1OC4yOTY5IEM0NjQuNTQ2LDE1OC4yOTY5IDQ3NC4zNTYsMTU4LjI5NjkgNDg0LjE2NSwxNTguMjk2OSAiIGZpbGw9Im5vbmUiIGlkPSJwdGhyZWFkX2NyZWF0ZS1iYWNrdG8tbmV3b3Nwcm9jIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjQ0OS42MDcsMTU4LjI5NjksNDU4LjYwNywxNjIuMjk2OSw0NTQuNjA3LDE1OC4yOTY5LDQ1OC42MDcsMTU0LjI5NjksNDQ5LjYwNywxNTguMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1NRDU9Wzk0NDMwYjQyNDZiMzk0NWY0NGNmZGRiMWVlMDUyODhiXQpyZXZlcnNlIGxpbmsgbXN0YXJ0IHRvIHB0aHJlYWRfY3JlYXRlLS0+PGcgaWQ9ImxpbmtfbXN0YXJ0X3B0aHJlYWRfY3JlYXRlIj48cGF0aCBkPSJNMjg3LjI5NSwxNTguMjk2OSBDMjk3LjMwNiwxNTguMjk2OSAzMDcuMzE2LDE1OC4yOTY5IDMxNy4zMjcsMTU4LjI5NjkgIiBmaWxsPSJub25lIiBpZD0ibXN0YXJ0LWJhY2t0by1wdGhyZWFkX2NyZWF0ZSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIyODIuMDYxLDE1OC4yOTY5LDI5MS4wNjEsMTYyLjI5NjksMjg3LjA2MSwxNTguMjk2OSwyOTEuMDYxLDE1NC4yOTY5LDI4Mi4wNjEsMTU4LjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tTUQ1PVsyZWQ3NTFlNjZiMWYwZWNhMjc0YzA3YTBiYjBhNGRlZl0KQHN0YXJ0dW1sDQpyZWN0YW5nbGUgInJ1bnRpbWUud2FrZXAiIGFzIHdha2VwDQpyZWN0YW5nbGUgInJ1bnRpbWUuc3RhcnRtIiBhcyBzdGFydG0NCnJlY3RhbmdsZSAicnVudGltZS5uZXdtIiBhcyBuZXdtDQpyZWN0YW5nbGUgInJ1bnRpbWUubmV3bTEiIGFzIG5ld20xDQpyZWN0YW5nbGUgInJ1bnRpbWUubmV3b3Nwcm9jIiBhcyBuZXdvc3Byb2MNCnJlY3RhbmdsZSAicHRocmVhZF9jcmVhdGUiIGFzIHB0aHJlYWRfY3JlYXRlDQpyZWN0YW5nbGUgInJ1bnRpbWUubXN0YXJ0IiBhcyBtc3RhcnQNCg0KdGl0bGUgIueyvueugOeJiFdvcmtlciBN5bi46KeE5Yib5bu65rWB56iLIg0KDQp3YWtlcCAgICAgICAtcmlnaHQtPiBzdGFydG0NCnN0YXJ0bSAgICAgIC1yaWdodC0+IG5ld20NCm5ld20gICAgICAgIC1yaWdodC0+IG5ld20xDQpuZXdtMSAgICAgICAtZG93bi0+IG5ld29zcHJvYw0KbmV3b3Nwcm9jICAgICAgIC1sZWZ0LT4gcHRocmVhZF9jcmVhdGUNCnB0aHJlYWRfY3JlYXRlIC1sZWZ0LT4gbXN0YXJ0DQpAZW5kdW1sDQoKUGxhbnRVTUwgdmVyc2lvbiAxLjIwMjIuN2JldGEyKFVua25vd24gY29tcGlsZSB0aW1lKQooR1BMIHNvdXJjZSBkaXN0cmlidXRpb24pCkphdmEgUnVudGltZTogSmF2YShUTSkgU0UgUnVudGltZSBFbnZpcm9ubWVudApKVk06IEphdmEgSG90U3BvdChUTSkgNjQtQml0IFNlcnZlciBWTQpEZWZhdWx0IEVuY29kaW5nOiBVVEYtOApMYW5ndWFnZTogZW4KQ291bnRyeTogVVMKLS0+PC9nPjwvc3ZnPg==">
<p>Worker M的启动通常由<code>runtime.wakep()</code>开始，在执行<code>runtime.startm()</code>时，需要获取空闲状态的P和空闲状态的M，如果没有空闲状态的P，则不会继续创建流程，而如果没有空闲状态的M，则会执行<code>runtime.newm()</code>创建新的M。</p>
<p>M结构的内存分配与g0的初始化就在<code>runtime.newm()</code>中进行，函数<code>runtime.newosproc()</code>是Go抽象出来的统一接口，主要用来创建系统线程，通过条件编译的方式，在不同的平台上有不同的实现方式，如：darwin上底层执行的是<code>pthread_create</code>系统接口创建线程，而在windows上执行的是<code>CreateThread</code>系统接口，创建线程的同时，会将已经初始化完成的M结构的指针传递到对应的创建线程的系统接口中，由线程的启动回调负责在新线程中做后续的处理，直到流程执行至<code>runtime.mstart()</code>，新M的执行流程参考<a href="/2022/07/10/notes/golang/advanced/g0/">《Golang深度解读：g0》</a>。</p>
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyNzhweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjg1MHB4O2hlaWdodDoyNzhweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCA4NTAgMjc4IiB3aWR0aD0iODUwcHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48cmVjdCBoZWlnaHQ9IjI2LjI5NjkiIGlkPSJfdGl0bGUiIHN0eWxlPSJzdHJva2U6IzAwMDAwMDAwO3N0cm9rZS13aWR0aDoxLjA7ZmlsbDpub25lOyIgd2lkdGg9IjEzMCIgeD0iMzUzLjI1IiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZvbnQtd2VpZ2h0PSJib2xkIiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMCIgeD0iMzU4LjI1IiB5PSIyMi45OTUxIj7nsr7nroDniYjosIPluqbmtYHnqIvlm748L3RleHQ+PCEtLU1ENT1bZDZhZjlmNTVmMGY2MzdhN2ZjYjM5Mjk0Mjg5MmM4ZDldCmVudGl0eSBtc3RhcnQtLT48ZyBpZD0iZWxlbV9tc3RhcnQiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTMxIiB4PSI3IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTExIiB4PSIxNyIgeT0iNjcuMjkyIj5ydW50aW1lLm1zdGFydDwvdGV4dD48L2c+PCEtLU1ENT1bN2FlYWU5MzA3MjI0MjZjZjliY2Q5NmM0OGVhY2Y4NGVdCmVudGl0eSBtc3RhcnQwLS0+PGcgaWQ9ImVsZW1fbXN0YXJ0MCI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxNDAiIHg9IjE3My41IiB5PSI0NC4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTIwIiB4PSIxODMuNSIgeT0iNjcuMjkyIj5ydW50aW1lLm1zdGFydDA8L3RleHQ+PC9nPjwhLS1NRDU9WzQwNjk0OGE5ZTA0ODliMzQyYzg4NWFjNGQ0NTljOGZjXQplbnRpdHkgbXN0YXJ0MS0tPjxnIGlkPSJlbGVtX21zdGFydDEiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQwIiB4PSIzNDguNSIgeT0iNDQuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjEyMCIgeD0iMzU4LjUiIHk9IjY3LjI5MiI+cnVudGltZS5tc3RhcnQxPC90ZXh0PjwvZz48IS0tTUQ1PVs3M2NhOTZiYTUxMzhiN2JiMzNkYmExZGEzZDBlNDcwZF0KZW50aXR5IHNjaGVkdWxlLS0+PGcgaWQ9ImVsZW1fc2NoZWR1bGUiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTQ1IiB4PSI1MjQiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjUiIHg9IjUzNCIgeT0iNjcuMjkyIj5ydW50aW1lLnNjaGVkdWxlPC90ZXh0PjwvZz48IS0tTUQ1PVs0YWNhODZmNzgxNTMwOGQ1YmU5YWM2ZDYxNjQwNjBmY10KZW50aXR5IGV4ZWN1dGUtLT48ZyBpZD0iZWxlbV9leGVjdXRlIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE0MCIgeD0iNzA0LjUiIHk9IjQ0LjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMjAiIHg9IjcxNC41IiB5PSI2Ny4yOTIiPnJ1bnRpbWUuZXhlY3V0ZTwvdGV4dD48L2c+PCEtLU1ENT1bMGI2M2ExYjk1NzIxOTFiYTFhMWFhMjgyYWE4YmE0Y2NdCmVudGl0eSBnb2dvLS0+PGcgaWQ9ImVsZW1fZ29nbyI+PHJlY3QgZmlsbD0iI0YxRjFGMSIgaGVpZ2h0PSIzNi4yOTY5IiByeD0iMi41IiByeT0iMi41IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTsiIHdpZHRoPSIxMTgiIHg9IjcxNC41IiB5PSIxNDAuMjk2OSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9Ijk4IiB4PSI3MjQuNSIgeT0iMTYzLjI5MiI+cnVudGltZS5nb2dvPC90ZXh0PjwvZz48IS0tTUQ1PVs1Mjk4MjRhNDViZGE4OGIzZDYxNTQxOTFkZjMxNzc5NF0KZW50aXR5IGxvZ2ljYWwtLT48ZyBpZD0iZWxlbV9sb2dpY2FsIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjEzMiIgeD0iNzA3LjUiIHk9IjIzNi4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTEyIiB4PSI3MTcuNSIgeT0iMjU5LjI5MiI+55So5oi35Luj56CB6YC76L6R6YOo5YiGPC90ZXh0PjwvZz48IS0tTUQ1PVtmZjM4MmViNzVmODExYTUyZDAyN2U2OGNlNDM3ZmZjMV0KZW50aXR5IEdvc2NoZWQtLT48ZyBpZD0iZWxlbV9Hb3NjaGVkIj48cmVjdCBmaWxsPSIjRjFGMUYxIiBoZWlnaHQ9IjM2LjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjE0NCIgeD0iNTI3LjUiIHk9IjIzNi4yOTY5Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTI0IiB4PSI1MzcuNSIgeT0iMjU5LjI5MiI+cnVudGltZS5Hb3NjaGVkPC90ZXh0PjwvZz48IS0tTUQ1PVtiZDM2ZDE2N2M1ZGE4MTYwYjQ0N2Y0NDU3YjVhOTYyMV0KZW50aXR5IG1jYWxsLS0+PGcgaWQ9ImVsZW1fbWNhbGwiPjxyZWN0IGZpbGw9IiNGMUYxRjEiIGhlaWdodD0iMzYuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iMTIwIiB4PSI1MzguNSIgeT0iMTQwLjI5NjkiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIxMDAiIHg9IjU0OC41IiB5PSIxNjMuMjkyIj5ydW50aW1lLm1jYWxsPC90ZXh0PjwvZz48IS0tTUQ1PVthYjQ3M2I2NzA1NWMwM2Y0ZjBkNTJmNDlkODAyMDE1Y10KbGluayBtc3RhcnQgdG8gbXN0YXJ0MC0tPjxnIGlkPSJsaW5rX21zdGFydF9tc3RhcnQwIj48cGF0aCBkPSJNMTM4LjI5NSw2Mi4yOTY5IEMxNDguMjEsNjIuMjk2OSAxNTguMTI2LDYyLjI5NjkgMTY4LjA0MSw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydC10by1tc3RhcnQwIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjE3My4yMjYsNjIuMjk2OSwxNjQuMjI2LDU4LjI5NjksMTY4LjIyNiw2Mi4yOTY5LDE2NC4yMjYsNjYuMjk2OSwxNzMuMjI2LDYyLjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tTUQ1PVtmNTE1ZDg1ZGQ0ODA5NmJkNTNkNjAyMTJiNjVhMDI5Nl0KbGluayBtc3RhcnQwIHRvIG1zdGFydDEtLT48ZyBpZD0ibGlua19tc3RhcnQwX21zdGFydDEiPjxwYXRoIGQ9Ik0zMTMuNTY4LDYyLjI5NjkgQzMyMy40NTgsNjIuMjk2OSAzMzMuMzQ4LDYyLjI5NjkgMzQzLjIzNyw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydDAtdG8tbXN0YXJ0MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSIzNDguNDA5LDYyLjI5NjksMzM5LjQwOSw1OC4yOTY5LDM0My40MDksNjIuMjk2OSwzMzkuNDA5LDY2LjI5NjksMzQ4LjQwOSw2Mi4yOTY5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLU1ENT1bYjE4ZjAxMDc4YjZjYTQwOWZjNmVmZTU2ZTQ5ZDVhZmJdCmxpbmsgbXN0YXJ0MSB0byBzY2hlZHVsZS0tPjxnIGlkPSJsaW5rX21zdGFydDFfc2NoZWR1bGUiPjxwYXRoIGQ9Ik00ODguNzI3LDYyLjI5NjkgQzQ5OC42NDUsNjIuMjk2OSA1MDguNTY0LDYyLjI5NjkgNTE4LjQ4Miw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9Im1zdGFydDEtdG8tc2NoZWR1bGUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTIzLjY2OSw2Mi4yOTY5LDUxNC42NjksNTguMjk2OSw1MTguNjY5LDYyLjI5NjksNTE0LjY2OSw2Ni4yOTY5LDUyMy42NjksNjIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1NRDU9WzhmN2Y2NjYwMTUxMzkwMDVkY2VhNTFiYWE3YjRlZjA4XQpsaW5rIHNjaGVkdWxlIHRvIGV4ZWN1dGUtLT48ZyBpZD0ibGlua19zY2hlZHVsZV9leGVjdXRlIj48cGF0aCBkPSJNNjY5LjE2LDYyLjI5NjkgQzY3OS4wODgsNjIuMjk2OSA2ODkuMDE2LDYyLjI5NjkgNjk4Ljk0NSw2Mi4yOTY5ICIgZmlsbD0ibm9uZSIgaWQ9InNjaGVkdWxlLXRvLWV4ZWN1dGUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzA0LjEzNiw2Mi4yOTY5LDY5NS4xMzYsNTguMjk2OSw2OTkuMTM2LDYyLjI5NjksNjk1LjEzNiw2Ni4yOTY5LDcwNC4xMzYsNjIuMjk2OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1NRDU9W2M3ZTgxOTA3ZGU2NWJhZTM5NjY2YjQzNDkwZTVjMmVkXQpsaW5rIGV4ZWN1dGUgdG8gZ29nby0tPjxnIGlkPSJsaW5rX2V4ZWN1dGVfZ29nbyI+PHBhdGggZD0iTTc3NC4zMTcsODAuNTM3OSBDNzc0LjE1NCw5NS43NzU5IDc3My45MTcsMTE4LjEwMzkgNzczLjc0LDEzNC43NTQ5ICIgZmlsbD0ibm9uZSIgaWQ9ImV4ZWN1dGUtdG8tZ29nbyIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI3NzMuNjgyLDE0MC4xNjQ5LDc3Ny43NzY5LDEzMS4yMDc3LDc3My43MzQ5LDEzNS4xNjUyLDc2OS43Nzc0LDEzMS4xMjMxLDc3My42ODIsMTQwLjE2NDkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tTUQ1PVtlNWYwYWI4YjBmNDExNDU5YTlmZWM0NTg5MmVlYjBkZl0KbGluayBnb2dvIHRvIGxvZ2ljYWwtLT48ZyBpZD0ibGlua19nb2dvX2xvZ2ljYWwiPjxwYXRoIGQ9Ik03NzMuNSwxNzYuNTM3OSBDNzczLjUsMTkxLjc3NiA3NzMuNSwyMTQuMTAzOCA3NzMuNSwyMzAuNzU0NSAiIGZpbGw9Im5vbmUiIGlkPSJnb2dvLXRvLWxvZ2ljYWwiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNzczLjUsMjM2LjE2NTIsNzc3LjUsMjI3LjE2NTIsNzczLjUsMjMxLjE2NTIsNzY5LjUsMjI3LjE2NTIsNzczLjUsMjM2LjE2NTIiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tTUQ1PVtmZjQ5MmNhMTk2MDA5MDMwYmQwZDk4ZjI3MjUwZmJmMF0KcmV2ZXJzZSBsaW5rIEdvc2NoZWQgdG8gbG9naWNhbC0tPjxnIGlkPSJsaW5rX0dvc2NoZWRfbG9naWNhbCI+PHBhdGggZD0iTTY3Ni41ODcsMjU0LjI5NjkgQzY4Ni44NTUsMjU0LjI5NjkgNjk3LjEyMiwyNTQuMjk2OSA3MDcuMzksMjU0LjI5NjkgIiBmaWxsPSJub25lIiBpZD0iR29zY2hlZC1iYWNrdG8tbG9naWNhbCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI2NzEuNTQ3LDI1NC4yOTY5LDY4MC41NDcsMjU4LjI5NjksNjc2LjU0NywyNTQuMjk2OSw2ODAuNTQ3LDI1MC4yOTY5LDY3MS41NDcsMjU0LjI5NjkiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjwvZz48IS0tTUQ1PVtkMmRkNzkyYmM2ODg2N2Y0NmM5NGFhNTBlODFhNzQ1N10KcmV2ZXJzZSBsaW5rIG1jYWxsIHRvIEdvc2NoZWQtLT48ZyBpZD0ibGlua19tY2FsbF9Hb3NjaGVkIj48cGF0aCBkPSJNNTk4Ljc0MSwxODEuOTU5IEM1OTguOTE5LDE5OC42MzY4IDU5OS4xNTYsMjIwLjk2MTEgNTk5LjMxOCwyMzYuMTY1MiAiIGZpbGw9Im5vbmUiIGlkPSJtY2FsbC1iYWNrdG8tR29zY2hlZCIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PHBvbHlnb24gZmlsbD0iIzE4MTgxOCIgcG9pbnRzPSI1OTguNjgzLDE3Ni41Mzc5LDU5NC43NzkxLDE4NS41OCw1OTguNzM2MywxODEuNTM3Niw2MDIuNzc4NywxODUuNDk0Nyw1OTguNjgzLDE3Ni41Mzc5IiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48L2c+PCEtLU1ENT1bYWRkMGIyNDAxZDE1ZmMzMjAzN2QxNmI4ODJlZmIwMDRdCnJldmVyc2UgbGluayBzY2hlZHVsZSB0byBtY2FsbC0tPjxnIGlkPSJsaW5rX3NjaGVkdWxlX21jYWxsIj48cGF0aCBkPSJNNTk2Ljk4Miw4NS45NTg5IEM1OTcuMzM3LDEwMi42MzY5IDU5Ny44MTIsMTI0Ljk2MDkgNTk4LjEzNSwxNDAuMTY0OSAiIGZpbGw9Im5vbmUiIGlkPSJzY2hlZHVsZS1iYWNrdG8tbWNhbGwiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNTk2Ljg2Nyw4MC41Mzc5LDU5My4wNTgyLDg5LjYyMDQsNTk2Ljk3MjcsODUuNTM2OCw2MDEuMDU2NCw4OS40NTEzLDU5Ni44NjcsODAuNTM3OSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PC9nPjwhLS1NRDU9WzU1NGRmMDQwNDc4MWEyYzBlNmZmMjQ5MDYzYmU2MDAzXQpAc3RhcnR1bWwNCnJlY3RhbmdsZSAicnVudGltZS5tc3RhcnQiIGFzIG1zdGFydA0KcmVjdGFuZ2xlICJydW50aW1lLm1zdGFydDAiIGFzIG1zdGFydDANCnJlY3RhbmdsZSAicnVudGltZS5tc3RhcnQxIiBhcyBtc3RhcnQxDQpyZWN0YW5nbGUgInJ1bnRpbWUuc2NoZWR1bGUiIGFzIHNjaGVkdWxlDQpyZWN0YW5nbGUgInJ1bnRpbWUuZXhlY3V0ZSIgYXMgZXhlY3V0ZQ0KcmVjdGFuZ2xlICJydW50aW1lLmdvZ28iIGFzIGdvZ28NCnJlY3RhbmdsZSAi55So5oi35Luj56CB6YC76L6R6YOo5YiGIiBhcyBsb2dpY2FsDQpyZWN0YW5nbGUgInJ1bnRpbWUuR29zY2hlZCIgYXMgR29zY2hlZA0KcmVjdGFuZ2xlICJydW50aW1lLm1jYWxsIiBhcyBtY2FsbA0KDQp0aXRsZSAi57K+566A54mI6LCD5bqm5rWB56iL5Zu+Ig0KDQptc3RhcnQgICAgICAtcmlnaHQtPiBtc3RhcnQwDQptc3RhcnQwICAgICAtcmlnaHQtPiBtc3RhcnQxDQptc3RhcnQxICAgICAtcmlnaHQtPiBzY2hlZHVsZQ0Kc2NoZWR1bGUgICAgLXJpZ2h0LT4gZXhlY3V0ZQ0KZXhlY3V0ZSAgICAgLWRvd24tPiBnb2dvDQpnb2dvICAgICAgICAtZG93bi0+IGxvZ2ljYWwNCmxvZ2ljYWwgICAgIC1sZWZ0LT4gR29zY2hlZA0KR29zY2hlZCAgICAgLXVwLT4gICBtY2FsbA0KbWNhbGwgICAgICAgLXVwLT4gICBzY2hlZHVsZQ0KQGVuZHVtbA0KClBsYW50VU1MIHZlcnNpb24gMS4yMDIyLjdiZXRhMihVbmtub3duIGNvbXBpbGUgdGltZSkKKEdQTCBzb3VyY2UgZGlzdHJpYnV0aW9uKQpKYXZhIFJ1bnRpbWU6IEphdmEoVE0pIFNFIFJ1bnRpbWUgRW52aXJvbm1lbnQKSlZNOiBKYXZhIEhvdFNwb3QoVE0pIDY0LUJpdCBTZXJ2ZXIgVk0KRGVmYXVsdCBFbmNvZGluZzogVVRGLTgKTGFuZ3VhZ2U6IGVuCkNvdW50cnk6IFVTCi0tPjwvZz48L3N2Zz4=">
<h3 id="m0"><a href="#m0" class="headerlink" title="m0"></a>m0</h3><p>Worker M通常是由其他M通过结构初始化并访问系统调用，执行线程创建接口创建出来，最后经过<code>runtime.mstart()</code>进入正常Worker M的计算逻辑，那第一个M是怎么来的呢？</p>
<p>在Go语言runtime包中，通过不同版本的汇编实现了不同平台上程序启动的<code>main()</code>函数入口，然后执行<code>runtime.rt0_go()</code>完成对Go程序的初始化，并使用全局定义的m0/g0初始化第一个M，并将<code>runtime.main()</code>函数地址传入<code>runtime.newproc()</code>创建第一个用户协程，再执行<code>runtime.mstart()</code>进行正常后续流程。</p>
<p>接下来的流程就比较熟悉了，m0进入调度循环，并启动第一个用户协程<code>runtime.main()</code>进行前期的初始化，再访问用户代码中的<code>main.main()</code>正式执行用户代码逻辑。</p>
<p><strong>注：m0也是正常的Worker M，只不过创建的流程不太一样</strong></p>
<h2 id="sysmon"><a href="#sysmon" class="headerlink" title="sysmon"></a>sysmon</h2><p>Go语言中除了负责执行用户协程的的一组Worker M之外，还有一个独立的监控M，称之为sysmon。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemstack(<span class="name">func</span>() &#123;</span><br><span class="line">    newm(<span class="name">sysmon</span>, <span class="literal">nil</span>, <span class="number">-1</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>sysmon在m0初始化完，执行第一个协程<code>runtime.main()</code>时，在<code>runtime.main()</code>函数中被创建，因为sysmon不直接服务于用户协程，因此没有绑定可执行的P，没有绑定P的M，所有的执行流程都在g0中。sysmon主要负责完成Go程序在执行期间的一些协同工作，如：处理系统调用阻塞(syscall)、用户协程执行时间过长(关于Go程序的抢占调度方案后面再细致的剖析)，还有超时未poll network等等问题。</p>
<h2 id="template-thread"><a href="#template-thread" class="headerlink" title="template thread"></a>template thread</h2><p>在<code>runtime.newm()</code>的函数中，创建新的线程时，由于Linux之类的系统底层是通过类似fork的系统调用创建线程，当M处于locked状态或M是在CGO中创建，在fork时可能会复制很多不可预知的状态，于是使用到了template thread的处理机制，在不方便由当前M直接创建新M时，将创建任务传递到template thread中，让template thread负责创建新的M，并按正常流程启动。</p>
<p>template thread由<code>runtime.startTemplateThread()</code>创建，在m0初始化完，执行<code>runtime.main()</code>时，在CGO的检查项中执行<code>runtime.startTemplateThread()</code>创建template thread，另一处是<code>runtime.LockOSThread()</code>中，并且template thread也是不绑定P的。</p>
</div><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://oldchan.net/2022/07/24/notes/golang/advanced/m/" data-id="cl60b8iu0002khku350vpd00x" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACI0lEQVR42u3aQW6DQAwF0Nz/0um2iwLfNqkU81hVLTDzqGR5bL9e8fX+dZ3/Jv9r8tTNFwYGxtcy3qdXcs/5U0dvqH6OozdgYGA8h3EUwfIQmSx/tGKy1sWeMTAwMA4WnofO6roYGBgYNwfBVnjFwMDAmBxie8W4ZKO9wzMGBsZzGHnV/f9//kh/AwMD46sYvXJ/9YDaC9yFXWFgYKxm5AHuHJMPTEwOwxf7wcDAWMqYF9HOYb2k8Dy4v+79NhgYGF/CmCxWDY69j3LRYMDAwHgAY9KwvDdZ7KWJGBgYuxnngSwBzMtqyUBGBMPAwHgAo9cSqI5WVDdaGK3AwMBYzfifIDsvtEVBGQMDYzUjCb45u5cC5qtcrI6BgbGOkQfTalhMksh5AoqBgbGbUQ2anxhj7Q1bYGBgPIdR7Qn2BimqyGqPEgMD4zmMSZk+2WL12eYQBgYGxjpGb1SrmjgmpNGwBQYGxmrG5EiZh8h8BDYf17j4n2BgYCxl5BvKU8BJCyEJ/RctTAwMjHWMXtNxnvY1B7/y1BADA2M1I08Ze2liYYvJGzAwMJYy3sVrXuOqHmWj0IyBgbGaUQ1zeQGuWrz7eOKIgYHx5Yz8gDov3987ahbVAjEwMBYxegfO/J78M/V2i4GBgVEdwsgbkHe9DQMDA2MeEPNRjORY+8edGBgYD2DkgxR56X8yalYu3mFgYKxm9MLopLmYf4K88YCBgbGU8QN4QXRytAmo9AAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/golang/"><i class="fa fa-tag"></i>golang</a></div><div class="post-nav"><a class="next" href="/2022/07/10/notes/golang/advanced/g0/">Golang深度解读：g0</a></div><div id="tcomment"></div><script src="https://fastly.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js"></script><script>twikoo.init({
  envId: 'thecxx-1gxw7szk895715fd',
  el: '#tcomment',
  region: 'ap-shanghai',
  path: ''
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/容器/">容器</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统/">系统</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/长话/">长话</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/go/" style="font-size: 15px;">go</a> <a href="/tags/思考/" style="font-size: 15px;">思考</a> <a href="/tags/博客/" style="font-size: 15px;">博客</a> <a href="/tags/元宇宙/" style="font-size: 15px;">元宇宙</a> <a href="/tags/cpu/" style="font-size: 15px;">cpu</a> <a href="/tags/微服务/" style="font-size: 15px;">微服务</a> <a href="/tags/中间件/" style="font-size: 15px;">中间件</a> <a href="/tags/容器化/" style="font-size: 15px;">容器化</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/windows/" style="font-size: 15px;">windows</a> <a href="/tags/注入/" style="font-size: 15px;">注入</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/07/24/notes/golang/advanced/m/">Golang深度解读：M</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/07/10/notes/golang/advanced/g0/">Golang深度解读：g0</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/06/15/opinion/give_up_the_php/">6年前，决定不再继续精进PHP</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/05/05/opinion/good_product/">好的产品?</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/17/opinion/internet_and_metaverse/">互联网络与元宇宙</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/05/18/arch/microservice/service/">微服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/04/06/arch/middleware/configuration/">配置服务迁移</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/30/container/docker/minimum_ext/">最小化docker镜像(补充内容)</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/02/20/language/go/struct_like_class/">Go：实现类似class的析构函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/20/container/docker/minimum/">最小化docker镜像</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">KAMI.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//fastly.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//fastly.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/prettify.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script><script type="text/javascript" src="/js/codeblock-render.js?v=1.0.0"></script></div></body></html>